{"RowError":"","RowState":2,"Table":{"CaseSensitive":false,"IsInitialized":true,"RemotingFormat":0,"ChildRelations":[],"Columns":["Column1"],"Constraints":[],"DataSet":{"RemotingFormat":0,"SchemaSerializationMode":1,"CaseSensitive":false,"DefaultViewManager":"System.Data.DataViewManagerListItemTypeDescriptor","EnforceConstraints":true,"DataSetName":"NewDataSet","Namespace":"","Prefix":"","ExtendedProperties":"System.Data.PropertyCollection","HasErrors":false,"IsInitialized":true,"Locale":"pt-BR","Site":null,"Relations":"","Tables":"Table","Container":null,"DesignMode":false},"DefaultView":["System.Data.DataRowView"],"DisplayExpression":"","ExtendedProperties":{},"HasErrors":false,"Locale":{"Parent":"pt","LCID":1046,"KeyboardLayoutId":1046,"Name":"pt-BR","IetfLanguageTag":"pt-BR","DisplayName":"Portuguˆs (Brasil)","NativeName":"portuguˆs (Brasil)","EnglishName":"Portuguese (Brazil)","TwoLetterISOLanguageName":"pt","ThreeLetterISOLanguageName":"por","ThreeLetterWindowsLanguageName":"PTB","CompareInfo":"CompareInfo - pt-BR","TextInfo":"TextInfo - pt-BR","IsNeutralCulture":false,"CultureTypes":70,"NumberFormat":"System.Globalization.NumberFormatInfo","DateTimeFormat":"System.Globalization.DateTimeFormatInfo","Calendar":"System.Globalization.GregorianCalendar","OptionalCalendars":"System.Globalization.GregorianCalendar","UseUserOverride":true,"IsReadOnly":false},"MinimumCapacity":50,"ParentRelations":[],"PrimaryKey":[],"Rows":["System.Data.DataRow"],"TableName":"Table","Namespace":"","Prefix":"","Site":null,"Container":null,"DesignMode":false},"ItemArray":["\r\n\r\n\r\n\r\n\r\nCREATE PROC [dbo].[SBO_SP_TransactionNotification] \r\n\r\n@object_type nvarchar(20), \t\t\t\t-- SBO Object Type\r\n@transaction_type nchar(1),\t\t\t-- [A]dd, [U]pdate, [D]elete, [C]ancel, C[L]ose\r\n@num_of_cols_in_key int,\r\n@list_of_key_cols_tab_del nvarchar(255),\r\n@list_of_cols_val_tab_del nvarchar(255)\r\n\r\nAS\r\n\r\nbegin\r\n\r\n-- Return values\r\ndeclare @error  int\t\t\t\t-- Result (0 for no error)\r\ndeclare @error_message nvarchar (200) \t\t-- Error string to be displayed\r\nselect @error = 0\r\nselect @error_message = N\u0027Ok\u0027\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--\tADD\tYOUR\tCODE\tHERE\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 12/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto na DEV. NOTA FISCAL DE ENTRADA\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF(@object_type = \u002719\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\r\n\t\r\n\tDECLARE @ControllerInt121220253 INT;\r\n\tSET @ControllerInt121220253 = 0;\r\n\r\n\tDECLARE @QtyLines121220253 INT\r\n\tSET @QtyLines121220253 = (SELECT COUNT(T0.DocEntry) FROM RPC1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto121220253 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn121220253 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt121220253 \u003c @QtyLines121220253)\r\n\tBEGIN\r\n\t\t\r\n\t\tSET @CodImposto121220253 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\t\tFROM RPC1 T0 \r\n\t\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt121220253);\r\n\r\n\t\t\tSET @CstCodeIn121220253 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\t\tSET @CstCodeIn121220253 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto121220253\r\n\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\r\n\t\t\tIF(@CstCodeIn121220253 IS NOT NULL AND @CstCodeIn121220253 \u003c\u003e \u0027\u0027)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\tUPDATE RPC1\r\n\t\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn121220253\r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND LineNum = @ControllerInt121220253;\r\n\r\n\t\t\tEND\r\n\r\n\t\t\tSET @ControllerInt121220253 = @ControllerInt121220253 + 1\r\n\r\n\r\n\tEND\r\n\r\n\r\n\r\n\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 12/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto na NOTA FISCAL DE ENTRADA E NOTA FISCAL DE RECEBIMENTO FUTURO\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF(@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\t\r\n\tDECLARE @ControllerInt121220252 INT;\r\n\tSET @ControllerInt121220252 = 0;\r\n\r\n\tDECLARE @QtyLines121220252 INT\r\n\tSET @QtyLines121220252 = (SELECT COUNT(T0.DocEntry) FROM PCH1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto121220252 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn121220252 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt121220252 \u003c @QtyLines121220252)\r\n\tBEGIN\r\n\r\n\t\t\t\r\n\t\t\tSET @CodImposto121220252 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\t\tFROM PCH1 T0 \r\n\t\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt121220252);\r\n\r\n\t\t\tSET @CstCodeIn121220252 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\t\tSET @CstCodeIn121220252 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto121220252\r\n\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\r\n\t\t\tIF(@CstCodeIn121220252 IS NOT NULL AND @CstCodeIn121220252 \u003c\u003e \u0027\u0027)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\tUPDATE PCH1\r\n\t\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn121220252\r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND LineNum = @ControllerInt121220252;\r\n\r\n\t\t\tEND\r\n\r\n\t\t\tSET @ControllerInt121220252 = @ControllerInt121220252 + 1\r\n\r\n\tEND\r\n\r\n\r\nEND\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 12/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto no DEVOLU€AO DE MERCADORIA\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF(@object_type = \u002721\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\r\n\r\n\tDECLARE @ControllerInt121220251 INT;\r\n\tSET @ControllerInt121220251 = 0;\r\n\r\n\tDECLARE @QtyLines121220251 INT\r\n\tSET @QtyLines121220251 = (SELECT COUNT(T0.DocEntry) FROM RPD1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto121220251 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn121220251 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt121220251 \u003c @QtyLines121220251)\r\n\tBEGIN\r\n\r\n\r\n\t\tSET @CodImposto121220251 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\t\tFROM RPD1 T0 \r\n\t\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt121220251);\r\n\r\n\t\t\tSET @CstCodeIn121220251 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\t\tSET @CstCodeIn121220251 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto121220251\r\n\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\r\n\t\t\tIF(@CstCodeIn121220251 IS NOT NULL AND @CstCodeIn121220251 \u003c\u003e \u0027\u0027)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\tUPDATE RPD1\r\n\t\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn121220251\r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND LineNum = @ControllerInt121220251;\r\n\r\n\t\t\tEND\r\n\r\n\t\t\tSET @ControllerInt121220251 = @ControllerInt121220251 + 1\r\n\r\n\tEND\r\n\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 12/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto no RECEBIMENTO DE MERCADORIA\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF(@object_type = \u002720\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\r\n\tDECLARE @ControllerInt12122025 INT;\r\n\tSET @ControllerInt12122025 = 0;\r\n\r\n\tDECLARE @QtyLines12122025 INT\r\n\tSET @QtyLines12122025 = (SELECT COUNT(T0.DocEntry) FROM PDN1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto12122025 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn12122025 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt12122025 \u003c @QtyLines12122025)\r\n\tBEGIN\r\n\r\n\t\t\tSET @CodImposto12122025 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\t\tFROM PDN1 T0 \r\n\t\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt12122025);\r\n\r\n\t\t\tSET @CstCodeIn12122025 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\t\tSET @CstCodeIn12122025 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto12122025\r\n\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\r\n\t\t\tIF(@CstCodeIn12122025 IS NOT NULL AND @CstCodeIn12122025 \u003c\u003e \u0027\u0027)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\tUPDATE PDN1\r\n\t\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn12122025\r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND LineNum = @ControllerInt12122025;\r\n\r\n\t\t\tEND\r\n\r\n\t\t\tSET @ControllerInt12122025 = @ControllerInt12122025 + 1\r\n\r\n\tEND\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 20/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto na DEV. nota fiscal de saida\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF(@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\r\nDECLARE @ControllerInt201220251 INT;\r\n\tSET @ControllerInt201220251 = 0;\r\n\r\n\tDECLARE @QtyLines201220251 INT\r\n\tSET @QtyLines201220251 = (SELECT COUNT(T0.DocEntry) FROM RIN1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto201220251 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn201220251 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt201220251 \u003c @QtyLines201220251)\r\n\tBEGIN\r\n\r\n\t\tSET @CodImposto201220251 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\tFROM RIN1 T0 \r\n\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt201220251);\r\n\r\n\r\n\t    SET @CstCodeIn201220251 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\tSET @CstCodeIn201220251 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto201220251\r\n\t\t\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\t\t\r\n\r\n\t\tIF(@CstCodeIn201220251 IS NOT NULL AND @CstCodeIn201220251 \u003c\u003e \u0027\u0027)\r\n\t\tBEGIN\r\n\r\n\t\t\tUPDATE RIN1\r\n\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn201220251\r\n\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\tAND LineNum = @ControllerInt201220251;\r\n\r\n\t\tEND\r\n\r\n\r\n\t\tSET @ControllerInt201220251 = @ControllerInt201220251 + 1\r\n\r\n\tEND\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 20/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto na nota fiscal de saida\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF(@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\r\n\tDECLARE @ControllerInt20122025 INT;\r\n\tSET @ControllerInt20122025 = 0;\r\n\r\n\tDECLARE @QtyLines20122025 INT\r\n\tSET @QtyLines20122025 = (SELECT COUNT(T0.DocEntry) FROM INV1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto20122025 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn20122025 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt20122025 \u003c @QtyLines20122025)\r\n\tBEGIN\r\n\r\n\t\tSET @CodImposto20122025 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\tFROM INV1 T0 \r\n\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt20122025);\r\n\r\n\r\n\t    SET @CstCodeIn20122025 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\tSET @CstCodeIn20122025 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto20122025\r\n\t\t\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\t\t\r\n\r\n\t\tIF(@CstCodeIn20122025 IS NOT NULL AND @CstCodeIn20122025 \u003c\u003e \u0027\u0027)\r\n\t\tBEGIN\r\n\r\n\t\t\tUPDATE INV1\r\n\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn20122025\r\n\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\tAND LineNum = @ControllerInt20122025;\r\n\r\n\t\tEND\r\n\r\n\r\n\t\tSET @ControllerInt20122025 = @ControllerInt20122025 + 1\r\n\r\n\tEND\r\n\r\n\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 09/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto no pedido\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF(@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\t\r\n\tDECLARE @ControllerInt09122025 INT;\r\n\tSET @ControllerInt09122025 = 0;\r\n\r\n\tDECLARE @QtyLines09122025 INT\r\n\tSET @QtyLines09122025 = (SELECT COUNT(T0.DocEntry) FROM RDR1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto09122025 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn09122025 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt09122025 \u003c @QtyLines09122025)\r\n\tBEGIN\r\n\r\n\t\tSET @CodImposto09122025 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\tFROM RDR1 T0 \r\n\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt09122025);\r\n\r\n\r\n\t    SET @CstCodeIn09122025 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\tSET @CstCodeIn09122025 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto09122025\r\n\t\t\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\t\t\r\n\r\n\t\tIF(@CstCodeIn09122025 IS NOT NULL AND @CstCodeIn09122025 \u003c\u003e \u0027\u0027)\r\n\t\tBEGIN\r\n\r\n\t\t\tUPDATE RDR1\r\n\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn09122025\r\n\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\tAND LineNum = @ControllerInt09122025;\r\n\r\n\t\tEND\r\n\r\n\r\n\t\tSET @ControllerInt09122025 = @ControllerInt09122025 + 1\r\n\r\n\tEND\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 11/11/2025\r\n-- Description: Bloco criado para travar qualquer fatura de adiantamento que nao venha de um pedido de compras\r\n-- GLPI IDs: 19287\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF(@object_type = \u0027204\u0027) and (@transaction_type in (\u0027A\u0027))\r\nBEGIN\r\n\t\r\n\r\n\tIF NOT EXISTS(\r\n\tSELECT \r\n\t\tT0.DocEntry,\r\n\t\tT0.UserSign,\r\n\t\tT1.Department\r\n\tFROM ODPO T0\r\n\tINNER JOIN OUSR T1\r\n\t   ON T1.USERID = T0.UserSign\r\n\tWHERE T1.Department IN(9,13)\r\n\tAND T0.DocEntry = @list_of_cols_val_tab_del\r\n\t)\r\n\tBEGIN\r\n\t\t\r\n\t\tIF NOT EXISTS(\r\n\t\tSELECT T1.BaseEntry,\r\n\t\tT1.BaseType\r\n\t\tFROM ODPO T0\r\n\t\tINNER JOIN DPO1 T1\r\n\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\tAND T1.BaseType = 22)\r\n\t\tBEGIN\t\r\n\r\n\t\t\tSET @error = -11112025\r\n\t\t\tSET @error_message = \u0027Nao ‚ possivel lan‡ar este adiantamento, contate o administrador!\u0027;\r\n\t\t\tSELECT @error, @error_message;\r\n\r\n\r\n\t\tEND\r\n\r\n\r\n\tEND\r\n\r\n\r\n\t\r\n\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 06/07/2025\r\n-- Description: Bloco criado para criar travas somente em campos especificos de documentos.\r\n-- GLPI IDs: 18689, 18570\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--// - INICIO - CONTROLE DE CAMPOS PARA A DEVOLU€AO DE NOTA FISCAL DE SAIDA//--\r\n---TABELA DE CONTROLE\r\n\r\n\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027))\r\nBEGIN\r\n\t\r\n\tIF EXISTS(SELECT \r\n\t\t\t\t\t T0.DocDueDate,\r\n\t\t\t\t\t GETDATE() AS \u0027Hoje\u0027,\r\n\t\t\t\t\t T0.U_CorrecaoContabil\r\n\t\t\t\tFROM ORIN T0 \r\n\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND CAST(T0.DocDueDate AS DATE) \u003c CAST(GETDATE() AS DATE)\r\n\t\t\t\tAND (T0.U_CorrecaoContabil \u003c\u003e \u0027Y\u0027 OR T0.U_CorrecaoContabil IS NULL)\r\n\t\t\t\t)\r\n\tBEGIN\r\n\t\t\r\n\t\tSET @error = -01082025\r\n\t\tSET @error_message = \u0027Aten‡ao data de Vencimento divergente da data de Hoje, Contate o administrador!\u0027;\r\n\t\tSELECT @error, @error_message;\r\n\r\n\tEND\r\n\tELSE\r\n\tBEGIN\r\n\r\n\t\t/*INSERE O REGISTRO ATUAL*/\r\n\t\tINSERT INTO FAL_ORIN_CONTROLLER(\r\n\t\tDocEntry,\r\n\t\tCardCode,\r\n\t\tCardName,\r\n\t\tCreateDate,\r\n\t\tDocDate,\r\n\t\tDocDueDate,\r\n\t\tTaxDate,\r\n\t\tDocStatus,\r\n\t\tUserSign\r\n\t\t)\r\n\t\tSELECT \r\n\t\tDocEntry,\r\n\t\tCardCode,\r\n\t\tCardName,\r\n\t\tCreateDate,\r\n\t\tDocDate,\r\n\t\tDocDueDate,\r\n\t\tTaxDate,\r\n\t\tDocStatus,\r\n\t\tUserSign\r\n\t\tFROM ORIN T0\r\n\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del;\r\n\r\n\tEND\r\n\t\r\n\t\r\n\t \r\nEND\r\n\r\n\r\n--TRANSACTION DE VERIFICA€AO DE ALTERA€AO DO CAMPO\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027U\u0027))\r\nBEGIN\r\n\t\t\r\n\t\t\r\n\t\tIF NOT EXISTS(SELECT T0.DocDueDate,\r\n\t\t\t\t\t\t\t   T1.DocDueDate\r\n\t\t\t\t\t\tFROM ORIN T0\r\n\t\t\t\t\t\tINNER JOIN FAL_ORIN_CONTROLLER T1 \r\n\t\t\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\t\t\t   AND T1.DocDueDate = T0.DocDueDate\r\n\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t)\r\n\t\tBEGIN\r\n\t\t\t\r\n\t\t\tIF NOT EXISTS(\r\n\t\t\tSELECT T0.DocDueDate\r\n\t\t\tFROM ORIN T0\r\n\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\tAND (T0.DocDueDate \u003e= GETDATE() OR T0.U_CorrecaoContabil = \u0027Y\u0027))\r\n\t\t\tBEGIN\r\n\t\t\t\t\r\n\t\t\t\t\tSET @error = -01082025\r\n\t\t\t\t\tSET @error_message = \u0027Aten‡ao data de Vencimento divergente da data de Hoje ou retroativa, Contate o administrador!\u0027;\r\n\t\t\t\t\tSELECT @error, @error_message;\r\n\r\n\t\t\tEND\r\n\r\n\r\n\t\tEND\r\n\r\n\r\n\r\n\t\tIF EXISTS(SELECT * \r\n\t\tFROM FAL_ORIN_CONTROLLER T1\r\n\t\tWHERE T1.DocEntry IN (SELECT T0.DocEntry\r\n\t\t\t\t\t\t\t\tFROM ORIN T0\r\n\t\t\t\t\t\t\t\tWHERE T0.DocStatus = \u0027C\u0027))\r\n\t\tBEGIN\r\n\t\t\t\r\n\t\t\tDELETE \r\n\t\t\tFROM FAL_ORIN_CONTROLLER \r\n\t\t\tWHERE DocEntry IN (SELECT T0.DocEntry\r\n\t\t\t\t\t\t\t\tFROM ORIN T0\r\n\t\t\t\t\t\t\t\tWHERE T0.DocStatus = \u0027C\u0027)\r\n\r\n\r\n\t\tEND\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n\r\n--// - FIM - CONTROLE DE CAMPOS PARA A DEVOLU€AO DE NOTA FISCAL DE SAIDA//--\r\n\r\n--// - INICIO - CONTROLE DE CAMPOS PARA A NOTA FISCAL DE ENTRADA\r\n\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027))\r\nBEGIN\r\n\r\n\t\r\n\tIF EXISTS(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\t T0.DocDueDate,\r\n\t\t\t\t\t T1.DueDate,\r\n\t\t\t\t\t GETDATE() AS \u0027Hoje\u0027,\r\n\t\t\t\t\t T0.U_CorrecaoContabil\r\n\t\t\t\tFROM OPCH T0 \r\n\t\t\t\tINNER JOIN PCH6 T1\r\n\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\tWHERE (CAST(T0.DocDueDate AS DATE) \u003c CAST(GETDATE() AS DATE) OR (T1.DueDate \u003c CAST(GETDATE() AS DATE) AND T1.Status = \u0027O\u0027))\r\n\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND (T0.U_CorrecaoContabil \u003c\u003e \u0027Y\u0027 OR T0.U_CorrecaoContabil IS NULL)\r\n\r\n\t\t\t\t)\r\n\tBEGIN\r\n\r\n\r\n\t\tSET @error = -01082025\r\n\t\tSET @error_message = \u0027Aten‡ao data de Vencimento divergente da data de Hoje, Contate o administrador!\u0027;\r\n\t\tSELECT @error, @error_message;\r\n\r\n\tEND\r\n\tELSE\r\n\tBEGIN\r\n\t\t\r\n\t\t/*INSERE O REGISTRO ATUAL*/\r\n\t\tINSERT INTO FAL_OPCH_CONTROLLER(\r\n\t\tDocEntry,\r\n\t\tCardCode,\r\n\t\tCardName,\r\n\t\tCreateDate,\r\n\t\tDocDate,\r\n\t\tDocDueDate,\r\n\t\tTaxDate,\r\n\t\tDocStatus,\r\n\t\tUserSign,\r\n\t\tDataParcela\r\n\t\t)\r\n\t\tSELECT \r\n\t\tT0.DocEntry,\r\n\t\tT0.CardCode,\r\n\t\tT0.CardName,\r\n\t\tT0.CreateDate,\r\n\t\tT0.DocDate,\r\n\t\tT0.DocDueDate,\r\n\t\tT0.TaxDate,\r\n\t\tT0.DocStatus,\r\n\t\tT0.UserSign,\r\n\t\tT1.DueDate AS \u0027DataParcela\u0027\r\n\t\tFROM OPCH T0\r\n\t\tINNER JOIN PCH6 T1\r\n\t    ON T1.DocEntry = T0.DocEntry\r\n\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del;\r\n\r\n\tEND\r\n\r\n\r\nEND\r\n\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027U\u0027))\r\nBEGIN\t\r\n\r\n\r\n\t\t/*VERIFICA SE HOUVE ALTERA€AO NOS CAMPOS DE DATA DE VENCIMENTO/PARCELA */\r\n\t\tIF NOT EXISTS(SELECT T0.DocDueDate,\r\n\t\t\t\t\t\t\t   T1.DocDueDate,\r\n\t\t\t\t\t\t\t    T2.DueDate\r\n\t\t\t\t\t\tFROM OPCH T0\r\n\t\t\t\t\t\tINNER JOIN PCH6 T2\r\n\t\t\t\t\t\t   ON T2.DocEntry = T0.DocEntry\r\n\t\t\t\t\t\tINNER JOIN FAL_OPCH_CONTROLLER T1 \r\n\t\t\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\t\t\t   AND T1.DocDueDate = T0.DocDueDate\r\n\t\t\t\t\t\t   AND T1.DataParcela = T2.DueDate\r\n\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t)\r\n\r\n\r\n\r\n\t\tBEGIN\r\n\r\n\t\t\tIF NOT EXISTS(\r\n\r\n\t\t\tSELECT *\r\n\t\t\tFROM OPCH T0\r\n\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\tAND T0.DocStatus = \u0027C\u0027\r\n\t\t\tAND T0.U_CorrecaoContabil = \u0027Y\u0027\r\n\r\n\t\t\t\r\n\t\t\t)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\t/*SE AS DATAS (PARCELA/VENCIMENTO) FOREM MAIOR QUE A DATA DE HOJE, DEIXA PASSAR */\r\n\t\t\t\tIF NOT EXISTS(\r\n\t\t\t\tSELECT T0.DocDueDate\r\n\t\t\t\tFROM OPCH T0\r\n\t\t\t\tINNER JOIN PCH6 T1\r\n\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\r\n\t\t\t\tAND ((T0.DocDueDate \u003e= GETDATE() \r\n\t\t\t\tAND T1.DueDate \u003e= GETDATE()) OR  T0.U_CorrecaoContabil = \u0027Y\u0027)\r\n\r\n\t\t\t\t)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\r\n\t\t\t\t\t\tSET @error = -01082025\r\n\t\t\t\t\t\tSET @error_message = \u0027Aten‡ao data de Vencimento divergente da data de Hoje ou retroativa, Contate o administrador!\u0027;\r\n\t\t\t\t\t\tSELECT @error, @error_message;\r\n\r\n\t\t\t\tEND\r\n\r\n\r\n\r\n\t\t\tEND\r\n\r\n\r\n\r\n\t\t\t\r\n\r\n\r\n\t\tEND\r\n\r\n\t\t\r\n\t\tIF EXISTS(SELECT * \r\n\t\tFROM FAL_OPCH_CONTROLLER T1\r\n\t\tWHERE T1.DocEntry IN (SELECT T0.DocEntry\r\n\t\t\t\t\t\t\t\tFROM OPCH T0\r\n\t\t\t\t\t\t\t\tWHERE T0.DocStatus = \u0027C\u0027))\r\n\t\tBEGIN\r\n\t\t\t\r\n\t\t\tDELETE \r\n\t\t\tFROM FAL_OPCH_CONTROLLER \r\n\t\t\tWHERE DocEntry IN (SELECT T0.DocEntry\r\n\t\t\t\t\t\t\t\tFROM OPCH T0\r\n\t\t\t\t\t\t\t\tWHERE T0.DocStatus = \u0027C\u0027)\r\n\r\n\r\n\t\tEND\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n--// - FIM - CONTROLE DE CAMPOS PARA A DEVOLU€AO DE NOTA FISCAL DE SAIDA//--\r\n\r\n\r\n--// - INICIO - CONTROLE DE CAMPOS PARA FATURA DE ADIANTAMENTO\r\n\r\nIF (@object_type = \u0027204\u0027) and (@transaction_type in (\u0027A\u0027))\r\nBEGIN\t\r\n\r\n\t\r\n\tIF EXISTS(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\t T0.DocDueDate,\r\n\t\t\t\t\t T1.DueDate,\r\n\t\t\t\t\t GETDATE() AS \u0027Hoje\u0027,\r\n\t\t\t\t\t T0.U_CorrecaoContabil\r\n\t\t\t\tFROM ODPO T0 \r\n\t\t\t\tINNER JOIN DPO6 T1\r\n\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\tWHERE (CAST(T0.DocDueDate AS DATE) \u003c CAST(GETDATE() AS DATE) OR (T1.DueDate \u003c CAST(GETDATE() AS DATE) AND T1.Status = \u0027O\u0027))\r\n\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND (T0.U_CorrecaoContabil \u003c\u003e \u0027Y\u0027 OR T0.U_CorrecaoContabil IS NULL)\r\n\r\n\t\t\t\t)\r\n\tBEGIN\r\n\r\n\r\n\t\tSET @error = -30092025\r\n\t\tSET @error_message = \u0027Aten‡ao data de Vencimento divergente da data de Hoje, Contate o administrador!\u0027;\r\n\t\tSELECT @error, @error_message;\r\n\r\n\tEND\r\n\tELSE\t\r\n\tBEGIN\r\n\r\n\r\n\t\t/*INSERE O REGISTRO ATUAL*/\r\n\t\tINSERT INTO FAL_ODPO_CONTROLLER(\r\n\t\tDocEntry,\r\n\t\tCardCode,\r\n\t\tCardName,\r\n\t\tCreateDate,\r\n\t\tDocDate,\r\n\t\tDocDueDate,\r\n\t\tTaxDate,\r\n\t\tDocStatus,\r\n\t\tUserSign,\r\n\t\tDataParcela\r\n\t\t)\r\n\t\tSELECT \r\n\t\tT0.DocEntry,\r\n\t\tT0.CardCode,\r\n\t\tT0.CardName,\r\n\t\tT0.CreateDate,\r\n\t\tT0.DocDate,\r\n\t\tT0.DocDueDate,\r\n\t\tT0.TaxDate,\r\n\t\tT0.DocStatus,\r\n\t\tT0.UserSign,\r\n\t\tT1.DueDate AS \u0027DataParcela\u0027\r\n\t\tFROM ODPO T0\r\n\t\tINNER JOIN DPO6 T1\r\n\t    ON T1.DocEntry = T0.DocEntry\r\n\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del;\r\n\r\n\r\n\r\n\tEND\r\n\r\nEND\r\n\r\nIF (@object_type = \u0027204\u0027) and (@transaction_type in (\u0027U\u0027))\r\nBEGIN\t\r\n\r\n/*VERIFICA SE HOUVE ALTERA€AO NOS CAMPOS DE DATA DE VENCIMENTO/PARCELA */\r\n\t\tIF NOT EXISTS(SELECT T0.DocDueDate,\r\n\t\t\t\t\t\t\t   T1.DocDueDate,\r\n\t\t\t\t\t\t\t    T2.DueDate\r\n\t\t\t\t\t\tFROM ODPO T0\r\n\t\t\t\t\t\tINNER JOIN DPO6 T2\r\n\t\t\t\t\t\t   ON T2.DocEntry = T0.DocEntry\r\n\t\t\t\t\t\tINNER JOIN FAL_ODPO_CONTROLLER T1 \r\n\t\t\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\t\t\t   AND T1.DocDueDate = T0.DocDueDate\r\n\t\t\t\t\t\t   AND T1.DataParcela = T2.DueDate\r\n\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t)\r\n\r\n\r\n\r\n\t\tBEGIN\r\n\r\n\t\t\tIF NOT EXISTS(\r\n\r\n\t\t\tSELECT *\r\n\t\t\tFROM ODPO T0\r\n\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\tAND T0.DocStatus = \u0027C\u0027\r\n\t\t\tAND T0.U_CorrecaoContabil = \u0027Y\u0027\r\n\r\n\t\t\t\r\n\t\t\t)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\t/*SE AS DATAS (PARCELA/VENCIMENTO) FOREM MAIOR QUE A DATA DE HOJE, DEIXA PASSAR */\r\n\t\t\t\tIF NOT EXISTS(\r\n\t\t\t\tSELECT T0.DocDueDate\r\n\t\t\t\tFROM ODPO T0\r\n\t\t\t\tINNER JOIN DPO6 T1\r\n\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\r\n\t\t\t\tAND ((T0.DocDueDate \u003e= GETDATE() \r\n\t\t\t\tAND T1.DueDate \u003e= GETDATE()) OR  T0.U_CorrecaoContabil = \u0027Y\u0027)\r\n\r\n\t\t\t\t)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\r\n\t\t\t\t\t\tSET @error = -01082025\r\n\t\t\t\t\t\tSET @error_message = \u0027Aten‡ao data de Vencimento divergente da data de Hoje ou retroativa, Contate o administrador!\u0027;\r\n\t\t\t\t\t\tSELECT @error, @error_message;\r\n\r\n\t\t\t\tEND\r\n\r\n\r\n\r\n\t\t\tEND\r\n\r\n\r\n\r\n\t\t\t\r\n\r\n\r\n\t\tEND\r\n\r\n\t\t\r\n\t\tIF EXISTS(SELECT * \r\n\t\tFROM FAL_ODPO_CONTROLLER T1\r\n\t\tWHERE T1.DocEntry IN (SELECT T0.DocEntry\r\n\t\t\t\t\t\t\t\tFROM ODPO T0\r\n\t\t\t\t\t\t\t\tWHERE T0.DocStatus = \u0027C\u0027))\r\n\t\tBEGIN\r\n\t\t\t\r\n\t\t\tDELETE \r\n\t\t\tFROM FAL_ODPO_CONTROLLER \r\n\t\t\tWHERE DocEntry IN (SELECT T0.DocEntry\r\n\t\t\t\t\t\t\t\tFROM ODPO T0\r\n\t\t\t\t\t\t\t\tWHERE T0.DocStatus = \u0027C\u0027)\r\n\r\n\r\n\t\tEND\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Bruno Cassiano \r\n-- Create date: 10/06/2025\r\n-- Update \t\t27/06/2025\r\n-- Description: Trava UNIFICADA para impedir a inser‡ao ou atualiza‡ao de documentos fiscais com data de vencimento retroativa,\r\n--              incluindo valida‡ao de presta‡oes individuais e exce‡ao para usu rio espec¡fico (279).\r\n-- GLPI IDs: 18689, 18570\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n/*\r\nIF @object_type IN (N\u002718\u0027, N\u002719\u0027, N\u002714\u0027) AND @transaction_type IN (N\u0027A\u0027, N\u0027U\u0027)\r\nBEGIN\r\n    DECLARE @DocDueDateA DATE;\r\n    DECLARE @DocTypeName NVARCHAR(100);\r\n    DECLARE @CurrentUserID_A INT;\r\n\r\n    \r\n    IF @object_type = N\u002718\u0027\r\n    BEGIN\r\n        SELECT @DocDueDateA = T0.DocDueDate, @CurrentUserID_A = IIF(@transaction_type = \u0027A\u0027, T0.UserSign, T0.UserSign2) FROM OPCH T0 WHERE T0.DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocTypeName = N\u0027Fatura de Fornecedor\u0027;\r\n    END\r\n    ELSE IF @object_type = N\u002719\u0027\r\n    BEGIN\r\n        SELECT @DocDueDateA = T0.DocDueDate, @CurrentUserID_A = IIF(@transaction_type = \u0027A\u0027, T0.UserSign, T0.UserSign2) FROM ORPC T0 WHERE T0.DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocTypeName = N\u0027Nota de Cr‚dito de Compra\u0027;\r\n    END\r\n    ELSE IF @object_type = N\u002714\u0027\r\n    BEGIN\r\n        SELECT @DocDueDateA = T0.DocDueDate, @CurrentUserID_A = IIF(@transaction_type = \u0027A\u0027, T0.UserSign, T0.UserSign2) FROM ORIN T0 WHERE T0.DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocTypeName = N\u0027Nota de Cr‚dito de Venda\u0027;\r\n    END;\r\n\r\n    \r\n    IF (@DocDueDateA \u003c CAST(GETDATE() AS DATE) AND (@CurrentUserID_A \u003c\u003e 276 OR @CurrentUserID_A \u003c\u003e 283))\r\n    BEGIN\r\n        SET @error = -110;\r\n        SET @error_message = N\u0027Nao ‚ permitido inserir/atualizar um(a) \u0027 + @DocTypeName + N\u0027 com data de vencimento inferior … data atual.\u0027;\r\n        SELECT @error, @error_message;\r\n    END;\r\nEND;\r\n\r\n\r\n\r\n\r\n\r\n\r\nIF @object_type IN (N\u002713\u0027, N\u002718\u0027, N\u002719\u0027, N\u002714\u0027) AND @transaction_type IN (N\u0027A\u0027, N\u0027U\u0027)\r\nBEGIN\r\n    DECLARE @Vencidas INT = 0;\r\n    DECLARE @DocInstallmentTypeName NVARCHAR(100);\r\n    DECLARE @CurrentUserID_B INT;\r\n\r\n    \r\n    IF @object_type = N\u002713\u0027 \r\n    BEGIN\r\n        SELECT @Vencidas = COUNT(*) FROM INV6 WHERE DocEntry = @list_of_cols_val_tab_del AND DueDate \u003c CAST(GETDATE() AS DATE);\r\n        SELECT @CurrentUserID_B = IIF(@transaction_type = \u0027A\u0027, UserSign, UserSign2) FROM OINV WHERE DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocInstallmentTypeName = N\u0027Fatura de Cliente\u0027;\r\n    END\r\n    ELSE IF @object_type = N\u002718\u0027 \r\n    BEGIN\r\n        SELECT @Vencidas = COUNT(*) FROM PCH6 WHERE DocEntry = @list_of_cols_val_tab_del AND DueDate \u003c CAST(GETDATE() AS DATE);\r\n        SELECT @CurrentUserID_B = IIF(@transaction_type = \u0027A\u0027, UserSign, UserSign2) FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocInstallmentTypeName = N\u0027Fatura de Fornecedor\u0027;\r\n    END\r\n    ELSE IF @object_type = N\u002719\u0027 \r\n    BEGIN\r\n        SELECT @Vencidas = COUNT(*) FROM RPC6 WHERE DocEntry = @list_of_cols_val_tab_del AND DueDate \u003c CAST(GETDATE() AS DATE);\r\n        SELECT @CurrentUserID_B = IIF(@transaction_type = \u0027A\u0027, UserSign, UserSign2) FROM ORPC WHERE DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocInstallmentTypeName = N\u0027Nota de Cr‚dito de Compra\u0027;\r\n    END\r\n    ELSE IF @object_type = N\u002714\u0027 \r\n    BEGIN\r\n        SELECT @Vencidas = COUNT(*) FROM RIN6 WHERE DocEntry = @list_of_cols_val_tab_del AND DueDate \u003c CAST(GETDATE() AS DATE);\r\n        SELECT @CurrentUserID_B = IIF(@transaction_type = \u0027A\u0027, UserSign, UserSign2) FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocInstallmentTypeName = N\u0027Nota de Cr‚dito de Venda\u0027;\r\n    END;\r\n\r\n    \r\n    IF (@Vencidas \u003e 0 AND (@CurrentUserID_B \u003c\u003e 276 OR @CurrentUserID_B \u003c\u003e 283))\r\n    BEGIN\r\n        SET @error = -111;\r\n        SET @error_message = N\u0027Nao ‚ permitido criar/atualizar \u0027 + @DocInstallmentTypeName + N\u0027 com presta‡oes com data de vencimento inferior … data atual.\u0027;\r\n        SELECT @error, @error_message;\r\n    END;\r\nEND;\r\n\r\n\r\n\r\n*/\r\n/*\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo Gomes\r\n-- Create date: 20/05/2025\r\n-- Description:\ttrava criada para quando o SAC Lan‡ar o pedido nao deixar lan‡ar no deposito 02.03\r\n-- GLPI ID:  18530\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\n\r\n\tIF EXISTS(\r\n\r\n\tSELECT T3.WhsCode\r\n\tFROM ORDR T0\r\n\tINNER JOIN OUSR T1\r\n\t   ON T1.USERID = T0.UserSign\r\n\tINNER JOIN OUSR T2\r\n\t   ON T2.USERID = T0.UserSign\r\n\tINNER JOIN RDR1 T3\r\n\t   ON T3.DocEntry = T0.DocEntry\r\n\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\tAND ((T1.Department = 12 OR T2.Department = 12) AND T3.WhsCode = \u002702.03\u0027)\r\n\t\r\n\t)\r\n\r\n\tBEGIN\r\n\r\n\t\r\n\t\tSET @error = -18530;\r\n\t\tSET @error_message = \u0027Aten‡ao! Dep¢sito nao ‚ permitido para o usu rio de lan‡amento!\u0027;\r\n\t\tSELECT @error, @error_message;\r\n\r\n\r\n\tEND\r\n\t\r\n\r\nEND \r\n\r\n*/\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo Gomes\r\n-- Create date: 17/04/2025\r\n-- Description:\ttrava criada para quando o SAC Lan‡ar o pedido, informe o canal de atendimento na ABA SAC\r\n-- GLPI ID:  ---\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\n\r\n\tDECLARE @UserSingSAC170425 INT;\r\n\tSET @UserSingSAC170425 = (SELECT T0.UserSign\r\n\t\t\t\t\t\tFROM ORDR T0\r\n\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @DepartmentSAC170425 INT;\r\n\tSET @DepartmentSAC170425 = (SELECT T0.Department\r\n\t\t\t\t\t\t\tFROM OUSR T0\r\n\t\t\t\t\t\t\tWHERE T0.USERID = @UserSingSAC170425)\t\r\n\r\n\tIF(@DepartmentSAC170425 = 12)\r\n\tBEGIN\r\n\t\r\n\t\t\t\t\tIF NOT EXISTS(SELECT T0.U_CanalAtendimento\r\n\t\t\t\t\tFROM ORDR T0\r\n\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\t\tAND T0.U_CanalAtendimento IS NOT NULL)\r\n\t\t\t\t\tBEGIN \r\n\t\t\t\t\t\r\n\t\t\t\t\t\tSET @error = -18108;\r\n\t\t\t\t\t\tSET @error_message = \u0027Aten‡ao! informe o Canal de Atendimento na aba SAC para prosseguir com o pedido.\u0027;\r\n\t\t\t\t\t\tSELECT @error, @error_message;\r\n\r\n\t\t\t\t\tEND\r\n\r\n\r\n\r\n\tEND\r\n\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END \r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo\r\n-- Create date: 17/02/2025\r\n-- Description:\ttrava criada para quando o cliente flegar SN URGENTE ser obrigat¢rio o preenchimento do campo grau de urgencia na solicita‡ao DE compra\r\n-- GLPI ID:  18108\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF @transaction_type IN (\u0027A\u0027, \u0027U\u0027) AND  @object_type = \u00271470000113\u0027 \r\nBEGIN\r\n\r\n\t\t\t\tIF EXISTS(\r\n\r\n\t\t\t\tSELECT T0.U_RAL_Urgente,\r\n\t\t\t\t\t   T0.U_RAL_GRAU_URGENCIA\r\n\t\t\t\tFROM OPRQ T0 \r\n\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND T0.U_RAL_Urgente = \u0027Y\u0027\r\n\t\t\t\tAND T0.U_RAL_GRAU_URGENCIA NOT IN(0,3)\r\n\t\t\t\t\r\n\t\t\t\t)\r\n\r\n\t\t\t\tBEGIN \r\n\r\n\t\t\t\t\r\n\t\t\t\t\tSET @error = -18108;\r\n\t\t\t\t\tSET @error_message = \u0027Aten‡ao! Documento Definido com Urgencia, Necessario Definir um Grau para prosseguir.\u0027;\r\n\t\t\t\t\tSELECT @error, @error_message;\r\n\r\n\r\n\t\t\t\tEND \r\n\t\t\t\t\r\n\t\t\t\t\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END \r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo/Henrique\r\n-- Create date: 01/10/2024\r\n-- Description:\ttrava criada para impedir a inser‡ao de documentos com valores divergentes em KG, se baseando na nota fiscal de saida, se nao houver documento referenciado, considera o pre‡o de lista\r\n-- GLPI ID:  17552\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--IF @transaction_type IN (\u0027A\u0027, \u0027U\u0027) AND @object_type = \u002714\u0027 \r\n--BEGIN\r\n\r\n\t\r\n--\tIF EXISTS (\r\n--\t\t\t\t\tSELECT *\r\n--FROM (\r\n--\t\t\t\t\t--traz somente Devolu‡oes que nao tem nf de venda referenciada\r\n--\t\t\t\t\tSELECT\r\n--\t\t\t\t\tT0.ItemCode, \r\n--\t\t\t\t\tT1.ItmsGrpCod,\r\n--\t\t\t\t\tT0.Quantity,\r\n--\t\t\t\t\tT0.Price,\r\n--\t\t\t\t\tT0.Weight1 \u0027Peso Linha\u0027, \r\n--\t\t\t\t\tt2.Weight1 \u0027Peso UDM\u0027,\r\n--\t\t\t\t\tT0.Price/ NULLIF(T2.Weight1,0) \u0027Pre‡o KG NF\u0027, \r\n--\t\t\t\t\tT6.Price \u0027Pre‡o de Lista\u0027,\r\n--\t\t\t\t\tT1.SWeight1,\r\n--\t\t\t\t\tt6.Price / NULLIF(t1.SWeight1,0) \u0027Pre‡o por kg Lista\u0027,\r\n--\t\t\t\t\t(((T0.Price/ NULLIF(T2.Weight1,0)) / NULLIF((t6.Price / NULLIF(t1.SWeight1,0)),0)  ) * 100) - 100 AS \u0027Porcentagem\u0027,\r\n--\t\t\t\t\tnull \u0027RefDoc\u0027,null \u0027Pre‡o por kg venda\u0027 \t\r\n--\t\t\t\t\tFROM RIN1 T0\r\n--\t\t\t\t\tINNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode\r\n--\t\t\t\t\tINNER JOIN OUOM T2 ON T0.UomCode = T2.UomCode\r\n--\t\t\t\t\tINNER JOIN ORIN T3 on T0.DocEntry = T3.DocEntry\r\n--\t\t\t\t\tINNER JOIN OCRD T4 ON T3.CardCode = T4.CardCode\r\n--\t\t\t\t\tINNER JOIN OPLN T5 ON T4.ListNum = T5.ListNum\r\n--\t\t\t\t\tINNER JOIN ITM1 T6 on T5.ListNum = T6.PriceList AND T0.ItemCode = T6.ItemCode\r\n--\t\t\t\t\tLEFT JOIN RIN21 T7 on T0.DocEntry = T7.DocEntry\r\n--\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del  AND T7.RefDocEntr is null\r\n \r\n--\t\t\t\t\tUNION ALL\r\n--\t\t\t\t\t---TRAZ SOMENTE AS DEVOLU€oES COM NF REFERENCIADA\r\n--\t\t\t\t\tSELECT\r\n--\t\t\t\t\tT0.ItemCode, \r\n--\t\t\t\t\tT1.ItmsGrpCod,\r\n--\t\t\t\t\tT0.Quantity,\r\n--\t\t\t\t\tT0.Price,\r\n--\t\t\t\t\tT0.Weight1 \u0027Peso Linha\u0027, \r\n--\t\t\t\t\tt2.Weight1 \u0027Peso UDM\u0027,\r\n--\t\t\t\t\tT0.Price/ NULLIF(T2.Weight1,0) \u0027Pre‡o KG NF\u0027, \r\n--\t\t\t\t\tT6.Price \u0027Pre‡o de Lista\u0027,\r\n--\t\t\t\t\tT1.SWeight1,\r\n--\t\t\t\t\tt6.Price / NULLIF(t1.SWeight1,0) \u0027Pre‡o po25r kg Lista\u0027,\r\n--\t\t\t\t\t(((T0.Price/ NULLIF(T2.Weight1,0)) / COALESCE(T9.price /NULLIF(T10.weight1,0),NULLIF((t6.Price / NULLIF(t1.SWeight1,0)),0))   ) * 100) - 100 AS \u0027Porcentagem\u0027,\r\n--\t\t\t\t\tT7.RefDocNum,T9.price /NULLIF(T10.weight1,0) \u0027Pre‡o por kg venda\u0027\r\n--\t\t\t\t\tFROM RIN1 T0\r\n--\t\t\t\t\tINNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode\r\n--\t\t\t\t\tINNER JOIN OUOM T2 ON T0.UomCode = T2.UomCode\r\n--\t\t\t\t\tINNER JOIN ORIN T3 on T0.DocEntry = T3.DocEntry\r\n--\t\t\t\t\tINNER JOIN OCRD T4 ON T3.CardCode = T4.CardCode\r\n--\t\t\t\t\tINNER JOIN OPLN T5 ON T4.ListNum = T5.ListNum\r\n--\t\t\t\t\tINNER JOIN ITM1 T6 on T5.ListNum = T6.PriceList AND T0.ItemCode = T6.ItemCode\r\n--\t\t\t\t\tINNER JOIN RIN21 T7 ON T0.DocEntry = T7.DocEntry\r\n--\t\t\t\t\tINNER JOIN OINV T8 ON T7.RefDocNum = T8.DocEntry\r\n--\t\t\t\t\tINNER JOIN INV1 T9 ON T8.DocEntry = T9.DocEntry AND T0.ItemCode = T9.ItemCode\r\n--\t\t\t\t\tINNER JOIN OUOM T10 ON T9.UomCode = T10.UomCode\r\n--\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n--\t\t\t\t\t) A\r\n--\t\t\t\t\tWHERE (A.ItmsGrpCod = 117 AND (A.Porcentagem \u003e= 40 OR A.Porcentagem \u003c= -40)) \r\n--\t\t\t\t\tOR (A.ItmsGrpCod \u003c\u003e 117 AND (A.Porcentagem \u003e= 10 OR A.Porcentagem \u003c= -10))\r\n \r\n\r\n--\t\t)\r\n--\t\tBEGIN \r\n\r\n\t\t\r\n--\t\t\tSET @error = -17552;\r\n--\t\t\tSET @error_message = \u0027Documento com Divergencia em 10% ou 40% Referente ao Pre‡o de Liste ou Nota Referenciada em KG\u0027;\r\n--\t\t\tSELECT @error, @error_message;\r\n\r\n--\t\tEND \r\n\r\n\t\r\n--END\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END \r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo Prado\r\n-- Create date: 19/09/2024\r\n-- Description:\tTrava criada para impedir que o documento seja atualizado se houver vinculo com remessa no bankplus\r\n-- GLPI ID:  17516\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*\r\nIF ((@object_type = \u002714\u0027) AND (@transaction_type IN (\u0027U\u0027,\u0027D\u0027,\u0027C\u0027))) -- DEVOLU€AO DE NOTA FISCAL DE SAIDA\r\nBEGIN\r\n\r\n\tDECLARE @val_NR_Transf VARCHAR(254);\r\n\tDECLARE @val_Arc_Vinc VARCHAR(254);\r\n\t\r\n\tIF EXISTS (\r\n\r\n\t\tSELECT * \r\n\t\tFROM (\r\n\t\tSELECT \r\n\t\t\t   T1.NumeroInterno,\r\n\t\t\t   T2.NrTransferencia,\r\n\t\t\t   (SELECT T0.NomeDoArquivo\r\n\t\t\t\t\tFROM [dbo].[IV_IB_OrdemDePagamento] T0\r\n\t\t\t\t\tWHERE T0.Codigo = T2.CodigoDaOrdemDePagamento) AS \u0027ArquivoVinculado\u0027,\r\n\t\t\t\t(SELECT T0.Status\r\n\t\t\t\t\tFROM [dbo].[IV_IB_OrdemDePagamento] T0\r\n\t\t\t\t\tWHERE T0.Codigo = T2.CodigoDaOrdemDePagamento) AS \u0027Status\u0027\r\n\t\tFROM [dbo].[IV_IB_TransferenciaParaCliente] T0\r\n\t\tINNER JOIN [dbo].[IV_IB_TransferenciaParaClienteParcela] T1\r\n\t\t   ON T1.TransferenciaId = T0.Id\r\n\t\tINNER JOIN [dbo].[IV_IB_PagamentosDaOrdemDePagamento] T2\r\n\t\t   ON T2.TecId = T1.TransferenciaId)T100\r\n\t\tWHERE T100.NumeroInterno = @list_of_cols_val_tab_del\r\n\t\tAND T100.Status = 2\r\n\t)\r\n\r\n\tBEGIN\r\n\r\n\t\tSET @val_NR_Transf = (SELECT T100.NrTransferencia\r\n\t\t\t\t\t\t\t\tFROM (\r\n\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t   T1.NumeroInterno,\r\n\t\t\t\t\t\t\t\t\t   T2.NrTransferencia,\r\n\t\t\t\t\t\t\t\t\t   (SELECT T0.NomeDoArquivo\r\n\t\t\t\t\t\t\t\t\t\t\tFROM [dbo].[IV_IB_OrdemDePagamento] T0\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE T0.Codigo = T2.CodigoDaOrdemDePagamento) AS \u0027ArquivoVinculado\u0027,\r\n\t\t\t\t\t\t\t\t\t\t(SELECT T0.Status\r\n\t\t\t\t\t\t\t\t\t\t\tFROM [dbo].[IV_IB_OrdemDePagamento] T0\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE T0.Codigo = T2.CodigoDaOrdemDePagamento) AS \u0027Status\u0027\r\n\t\t\t\t\t\t\t\tFROM [dbo].[IV_IB_TransferenciaParaCliente] T0\r\n\t\t\t\t\t\t\t\tINNER JOIN [dbo].[IV_IB_TransferenciaParaClienteParcela] T1\r\n\t\t\t\t\t\t\t\t   ON T1.TransferenciaId = T0.Id\r\n\t\t\t\t\t\t\t\tINNER JOIN [dbo].[IV_IB_PagamentosDaOrdemDePagamento] T2\r\n\t\t\t\t\t\t\t\t   ON T2.TecId = T1.TransferenciaId)T100\r\n\t\t\t\t\t\t\t\tWHERE T100.NumeroInterno = @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\tAND T100.Status = 2)\r\n\r\n\t\tSET @val_Arc_Vinc = (SELECT T100.ArquivoVinculado\r\n\t\t\t\t\t\t\t\tFROM (\r\n\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t   T1.NumeroInterno,\r\n\t\t\t\t\t\t\t\t\t   T2.NrTransferencia,\r\n\t\t\t\t\t\t\t\t\t   (SELECT T0.NomeDoArquivo\r\n\t\t\t\t\t\t\t\t\t\t\tFROM [dbo].[IV_IB_OrdemDePagamento] T0\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE T0.Codigo = T2.CodigoDaOrdemDePagamento) AS \u0027ArquivoVinculado\u0027,\r\n\t\t\t\t\t\t\t\t\t\t(SELECT T0.Status\r\n\t\t\t\t\t\t\t\t\t\t\tFROM [dbo].[IV_IB_OrdemDePagamento] T0\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE T0.Codigo = T2.CodigoDaOrdemDePagamento) AS \u0027Status\u0027\r\n\t\t\t\t\t\t\t\tFROM [dbo].[IV_IB_TransferenciaParaCliente] T0\r\n\t\t\t\t\t\t\t\tINNER JOIN [dbo].[IV_IB_TransferenciaParaClienteParcela] T1\r\n\t\t\t\t\t\t\t\t   ON T1.TransferenciaId = T0.Id\r\n\t\t\t\t\t\t\t\tINNER JOIN [dbo].[IV_IB_PagamentosDaOrdemDePagamento] T2\r\n\t\t\t\t\t\t\t\t   ON T2.TecId = T1.TransferenciaId)T100\r\n\t\t\t\t\t\t\t\tWHERE T100.NumeroInterno = @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\tAND T100.Status = 2)\r\n\r\n\r\n\t\tSET @error = -17516;\r\n\t\tSET @error_message = CONCAT(\u0027Aten‡ao! Este Documento possui vinculo com Remessa no BankPlus, Transferencia: \u0027, @val_NR_Transf, \u0027, Arquivo: \u0027, @val_Arc_Vinc, \u0027, Contate o Financeiro.\u0027);\r\n\t\tSELECT @error, @error_message;\r\n\r\n\tEND\t\r\n\r\n\r\nEND\r\n*/\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo Prado\r\n-- Create date: 12/09/2024\r\n-- Description:\tTrava criada para impedir que seja cadastrado ou alterado os itinerarios por outros usuarios se nao os permitidos.\r\n-- GLPI ID: 17490\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--IF ((@object_type = \u0027BIM_ITINERARIO\u0027) AND (@transaction_type IN (\u0027A\u0027,\u0027U\u0027,\u0027D\u0027,\u0027C\u0027,\u0027L\u0027))) -- ORDEM DE CARGA - ITINERARIO\r\n--BEGIN\r\n\r\n--\tDECLARE @UserCad INT;\r\n\r\n--\t-- Busca o UserSign do documento\r\n--\tSET @UserCad = (SELECT T1.UserSign\r\n--\t\t\t\t\t\tFROM [@BIM_ITINERARIO] T0\r\n--\t\t\t\t\t\tINNER JOIN [@ABIM_ITINERARIO] T1\r\n--\t\t\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n--\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n--\t\t\t\t\t\tAND T1.LogInst IN(SELECT MAX(T1x.LogInst)\r\n--\t\t\t\t\t\t\t\t\t\t\tFROM [@BIM_ITINERARIO] T0x\r\n--\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [@ABIM_ITINERARIO] T1x\r\n--\t\t\t\t\t\t\t\t\t\t\t   ON T1x.DocEntry = T0x.DocEntry\r\n--\t\t\t\t\t\t\t\t\t\t\tWHERE T0x.DocEntry = T0.DocEntry));\r\n\r\n--\t-- Verifica se @UserCad nao ‚ NULL e nao est  na lista de usu rios permitidos\r\n--\tIF (@UserCad IS NULL OR @UserCad NOT IN\r\n--\t\t(SELECT T0.USERID\r\n--\t\t\tFROM OUSR T0\r\n--\t\t\tWHERE T0.USER_CODE LIKE \u0027%kely.carneiro%\u0027 \r\n--\t\t\t\tOR T0.USER_CODE LIKE \u0027%ronaldo.azevedo%\u0027))\r\n--\tBEGIN \r\n--\t\tSET @error = -17490;\r\n--\t\tSET @error_message = \u0027Aten‡ao! Este Documento so pode ser Criado/Atualizado/Deletado/Cancelado por usu rios com permissao! Contate o administrador.\u0027;\r\n--\t\tSELECT @error, @error_message;\r\n--\tEND;\r\n\r\n--END;\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo Prado\r\n-- Create date: 01/08/2024\r\n-- Description:\tTrava criada para impedir que documentos com a mesma Nf sejam Lan‡ados na Fatura de adiantamento de contas a pagar\r\n-- GLPI ID: 17252\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF ((@object_type = \u0027204\u0027) AND (@transaction_type IN (\u0027A\u0027,\u0027U\u0027))) -- CONTROLE DE DEVOLU€OES ARM\r\nBEGIN\r\n\r\n\tDECLARE @NF_Compra INT;\r\n\tDECLARE @Quantidade INT;\r\n\tDECLARE @Doc_Vinculado INT;\r\n\r\n\tSET @NF_Compra = (SELECT T0.U_NF_Compra\r\n\t\t\t\t\t  FROM ODPO T0\r\n\t\t\t\t\t  WHERE T0.DocEntry = @list_of_cols_val_tab_del);\r\n\r\n\tSET @Quantidade = (SELECT COUNT(*) AS Quantidade\r\n\t\t\t\t\t   FROM ODPO T1\r\n\t\t\t\t\t   WHERE T1.U_NF_Compra = @NF_Compra\r\n\t\t\t\t\t   AND T1.DocEntry \u003c\u003e @list_of_cols_val_tab_del);\r\n\r\n\t\r\n\tIF (@Quantidade \u003e= 1)\r\n\r\n\tBEGIN\r\n\r\n\t\tSET @Doc_Vinculado = (SELECT MAX(T1.DocEntry)\r\n\t\tFROM ODPO T1\r\n\t\tWHERE T1.U_NF_Compra = @NF_Compra)\r\n\r\n\r\n\t\tSET @Error = -17252;\r\n\t\tSET @Error_Message = CONCAT(\u0027Aten‡ao! Existe Documento vinculado a esta Nota Fiscal Informada, Verifique o valor do campo \"Nota Fiscal de Compra\" ou o Documento: \u0027, @Doc_Vinculado);\r\n\t\tSELECT @Error, @Error_Message;\r\n\t\r\n\r\n\tEND \r\n\r\n\r\nEND\r\n\r\n-------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo Prado\r\n-- Create date: 18/07/2024\r\n-- Description:\tTrava criada para impedir que haja divergencia do lan‡amento do controle x Dev Nfe\r\n-- GLPI ID:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF ((@object_type = \u0027CTRLARM\u0027) AND (@transaction_type IN (\u0027A\u0027,\u0027U\u0027))) -- CONTROLE DE DEVOLU€OES ARM\r\nBEGIN\r\n\r\n\tIF EXISTS (SELECT * \r\n\t\t\t\tFROM (\r\n\t\t\t\tSELECT T0.ItemCode AS \u0027ItemCodeNf\u0027,\r\n\t\t\t\t\t   T2.U_ItemCode AS \u0027ItemCodeControl\u0027\r\n\t\t\t\tFROM RIN1 T0\r\n\t\t\t\tINNER JOIN [@RAL_CONTROLE_DEVOL] T1\r\n\t\t\t\t   ON T1.U_Nf_Devolucao = T0.DocEntry\r\n\t\t\t\tLEFT JOIN [@RAL_CONTROLE_DEVOL1] T2\r\n\t\t\t\t   ON T2.DocEntry = T1.DocEntry AND T2.U_ItemCode = T0.ItemCode\r\n\t\t\t\tWHERE T1.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\t)T100\r\n\t\t\t\tWHERE T100.ItemCodeControl IS NULL) \r\n\tBEGIN\r\n\r\n        SET @Error = -1\r\n        SET @Error_Message = \u0027Aten‡ao! Divergencia de Lan‡amento, Verifique a quantidades de Item na Nota X Controle de Devolu‡ao ou Referencie o item e Preencha o campo Observa‡oes\u0027 \r\n        SELECT @Error, @Error_Message\r\n\r\n\tEND \r\n\r\nEND\r\n\r\n\r\n\r\n-- Author: Bruno Cassiano\r\n-- Create date: 24/05/2024\r\n-- Description:\tTrava criada para impedir produtos com valor acima de 30% ao pre‡o de lista\r\n-- GLPI ID:16972\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*\r\nIF ((@object_type = \u002717\u0027) AND (@transaction_type IN (\u0027A\u0027,\u0027U\u0027))) -- PEDIDO DE VENDA\r\nBEGIN\r\n    IF EXISTS (\r\n        SELECT *\r\n        FROM (\r\n            SELECT \r\n                T1.ItemCode,\r\n                T1.Price AS \u0027PrecoVenda\u0027,\r\n                T3.PriceList,\r\n                T3.Price AS \u0027PrecoLista\u0027,\r\n                T1.Price - T3.Price AS \u0027ConvertPrice\u0027,\r\n                CAST(CASE WHEN T3.Price \u003c\u003e 0 THEN (T1.Price / T3.Price) * 100 ELSE NULL END AS NUMERIC(10,2)) AS \u0027Porcent\u0027\r\n             \r\n            FROM ORDR T0\r\n            INNER JOIN RDR1 T1 ON T1.DocEntry = T0.DocEntry\r\n            INNER JOIN OCRD T2 ON T2.CardCode = T0.CardCode\r\n            INNER JOIN ITM1 T3 ON T3.PriceList = T2.ListNum AND T3.ItemCode = T1.ItemCode\r\n            WHERE \r\n                T0.DocEntry = @list_of_cols_val_tab_del \r\n               \r\n        ) T100\r\n        WHERE \r\n            (T100.Porcent \u003e 130)  -- Verifica se o pre‡o de venda ‚ mais de 30% acima do pre‡o de lista\r\n           \r\n    )\r\n    BEGIN\r\n        -- SETANDO A MENSAGEM DE ERRO NA TELA\r\n        SET @Error = -16972\r\n        SET @Error_Message = \u0027Pre‡o de venda maior que 30% acima do pre‡o de lista. Verifique!\u0027 \r\n        SELECT @Error, @Error_Message\r\n    END\r\nEND\r\n*/\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 15/05/2024\r\n-- Description:\tTrava criada para impedir a inser‡ao de notas fiscais de entrada com valor 0\r\n-- GLPI ID:16506\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002718\u0027 = Nota Fiscal Entrada\r\nBEGIN\r\n\r\n\tDECLARE @Utilizacao16506 INT\r\n\r\n\tSET @Utilizacao16506 = (SELECT DISTINCT T0.Usage ----DISTINCT USADO SOMENTE POR CONTA DE TRANSFERENCIAS! DOCUMENTOS DE TRASFERENCIAS OU SAO 60 PARA TODAS AS LINHAS OU 61\r\n\t\t\t\t\t\t    FROM PCH1 T0\r\n\t\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\tAND T0.Usage IN(60,61))\r\n\t\r\n\tIF @Utilizacao16506 IN (60, 61)\r\n\tBEGIN \r\n\r\n\t\tIF EXISTS(SELECT T1.LineTotal\r\n\t\t\t\t  FROM (SELECT T0.LineTotal\r\n\t\t\t\t\t\tFROM PCH1 T0\r\n\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del)T1\r\n\t\t\t\t  WHERE T1.LineTotal \u003c= 0)\r\n\r\n\t\tBEGIN\r\n\t\t\tSET @Error =-16506\r\n\t\t\tSET @Error_Message = \u0027Aten‡ao, Linha com valor 0 ou Nulo. insira um valor valido para prosseguir!\u0027 \r\n\t\t\tSELECT @error, @error_message\t\r\n\r\n\t\tEND\r\n\tEND\r\n\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Author Update: Bruno Cassiano\r\n-- Create date: 15/05/2024\r\n-- Update Date: 23/09/2024\r\n-- Description: Trava criada para barrar pre‡os com mais de 5% de \r\n---desconto baseado no pre‡o de lista do PN(apenas cadastros manuais, edi esta fora da regra)\r\n-- Acrescentado regra para desconsiderar a kelly.\r\n-- Retirado usu rio de Larissa\r\n-- Documentos: Cota‡ao\r\n-- GLPI ID : 16908\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF ((@object_type = \u002723\u0027) AND (@transaction_type IN (\u0027A\u0027,\u0027U\u0027))) ----COTACAO DE VENDA\r\nBEGIN \r\n\r\n  IF EXISTS(SELECT * \r\n          \tFROM (\r\n          \tSELECT T1.ItemCode,\r\n              \t\t  T1.Price AS \u0027PrecoVenda\u0027,\r\n              \t\t  T3.PriceList,\r\n              \t\t  T3.Price AS \u0027PrecoLista\u0027,\r\n              \t\t  T3.Price - T1.Price AS \u0027ConvertPrice\u0027,\r\n              \t\t  CAST(CASE WHEN T3.Price \u003c\u003e 0 THEN (T1.Price / T3.Price) * 100 ELSE NULL END AS NUMERIC(10,2)) AS \u0027Porcent\u0027,\r\n              \t\t T0.Comments,\r\n              \t\t  T0.U_SPS_ID_NEOGRID \r\n          \t  FROM OQUT T0\r\n          \t  INNER JOIN QUT1 T1 ON T1.DocEntry = T0.DocEntry \r\n          \t  INNER JOIN OCRD T2 ON T2.CardCode = T0.CardCode\r\n          \t  INNER JOIN ITM1 T3 ON T3.PriceList = T2.ListNum AND T3.ItemCode = T1.ItemCode\r\n          \t  WHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n          \t  AND T0.U_AHS_SapUserCode = \u0027None\u0027\r\n\t\t\t  AND T0.UserSign \u003c\u003e 14\r\n\t\t\t  AND T0.UserSign2 \u003c\u003e 14\r\n\t\t\t  AND T0.UserSign \u003c\u003e 260\r\n\t\t\t  AND T0.UserSign2 \u003c\u003e 260\r\n\t\t\t  )T100\r\n          \t  WHERE (T100.Porcent \u003c 95 OR T100.Porcent IS NULL)\r\n          \t  AND (T100.Comments NOT LIKE \u0027%Gerado via integra‡ao EDI%\u0027 OR T100.Comments IS NULL OR T100.U_SPS_ID_NEOGRID IS NULL)\r\n\r\n  ) ---FIM DO IF EXISTIS\r\n\r\n  BEGIN\r\n\r\n    ----------SETANDO A MENSAGEM DE ERRO NA TELA\r\n    SET @Error =-16908\r\n    SET @Error_Message = \u0027Linha com desconto maior que 5% Verifique!\u0027 \r\n    SELECT @error, @error_message\r\n\r\n  END\r\n\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 05/10/2023\r\n-- Update date: 13/11/2023\r\n-- Description:\tAtualizar o campo U_DescFinBP para ajustar o desconto financeiro no bankplus\r\n-- Comentado por conta da nova versao do add-on em produ‡ao. (WMS)\r\n-- GLPI ID:\r\n-- GLPI ID Atualiza‡oes:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*\r\nIF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002713\u0027 = Nota Fiscal Saida\r\nBEGIN\r\n\tDECLARE @CardCodeNF NVarchar (20)\r\n\t\r\n\tDECLARE @DescontoFinanceiroNF Decimal(10,2) SET @DescontoFinanceiroNF = 0\r\n\t\r\n\r\n\tSET @CardCodeNF  = (SELECT CardCode FROM OINV WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\r\n\tSET @DescontoFinanceiroNF = (SELECT U_MW_DESFIN FROM OCRD WHERE CardCode = @CardCodeNF)\r\n\t\r\n\t\tBEGIN\t\t\t\r\n\t\t\tUPDATE OINV \r\n\t\t\t\tSET   U_DescFinBP  = @DescontoFinanceiroNF,U_MW_DESCONTO  = @DescontoFinanceiroNF  WHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\tEND \r\n\t\t\r\nEND;\r\n*/\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\tBruno Cassiano\r\n-- Create date: 14/10/2022\r\n-- Update Date: \r\n-- Description: Trava de data de 5 dias de vencimento para ap¢lice de seguro da transportadora.\r\n-- Documentos: Ordem de Carga\r\n-- GLPI ID : 14240\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027BIM_ORDEMCARGA\u0027) and (@transaction_type in (\u0027U\u0027)) --\u0027BIM_ORDEMCARGA\u0027 = ORDEM DE CARGA\r\nBEGIN\r\n\r\nDECLARE @CodTransportadora Varchar(10) = (SELECT U_Transportadora FROM [@BIM_ORDEMCARGA] WHERE Docentry = @list_of_cols_val_tab_del)\r\nDECLARE @DiasRestantesApolice Numeric = 0\r\n\r\n\tIF (@CodTransportadora IS NOT NULL AND @CodTransportadora \u003c\u003e\u0027\u0027) \r\n\tBEGIN\r\n\t\r\n\tSET @DiasRestantesApolice = (SELECT DATEDIFF(DAY, GETDATE(), U_DataApoliceFinal) FROM OCRD WHERE CardCode = @CodTransportadora)\r\n\t\r\n\t\tIF(@DiasRestantesApolice IS NOT NULL AND @DiasRestantesApolice \u003c= 5)\r\n\t\tBEGIN\r\n\t\r\n\t\t\tSET @Error =-14240\r\n\t\t\tSET @Error_Message = \u0027A transportadora selecionada, est  com data da ap¢lice vencida ou a vencer!\u0027 \r\n\t\t\tSELECT @error, @error_message\t\r\n\r\n\t\tEND\r\n\r\n\tEND\t\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\tHenrique Santos\t\r\n-- Create date: 19/09/2022 \r\n-- Description: Trava de pedido com valor minimo por regiao\r\n-- Documentos: Pedido de Venda \r\n-- GLPI ID : 14141\r\n\r\n-- Author:\tVinicius Palmagnani Faria\r\n-- Update date: 18/10/2022\r\n-- Description: Bloquear apenas o departamento de vendas, nos itens PA e utiliza‡ao VENDA-REVENDA \r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027)) --\u002717\u0027 = Pedido de venda\r\n\r\nBEGIN\r\n\r\n\tDECLARE @Linhas14141 Numeric = (SELECT Count(*)FROM RDR1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @Cont14141 Numeric = 0\r\n\r\n\tDECLARE @UserSign14141 int = (SELECT UserSign FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @Dep14141 int = (SELECT Department FROM OUSR WHERE USERID = @UserSign14141)\r\n\r\n\tDECLARE @Usage14141 Nvarchar (255)\r\n\r\n\tDECLARE @GrupoItem14141 Nvarchar (255)\r\n\r\n\tDECLARE @ValorPedido14141 Numeric(10,2) = (SELECT DocTotal FROM ORDR WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @ValorMinReg14141 Numeric(10,2) set @ValorMinReg14141 = 0\r\n\r\n\tDECLARE @RegiaoPedMin14141 Varchar (max) = (SELECT T1.Name FROM OCRD T0 INNER JOIN [@MW_MICRO] T1 ON T1.Code = T0.U_MW_MICRO \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = (SELECT CardCode FROM ORDR WHERE DocNum = @list_of_cols_val_tab_del))\r\n\r\n\t\tWHILE(@Cont14141 \u003c @Linhas14141)\r\n\t\t\tBEGIN\r\n\t\t\t\tIF (@Dep14141 = 1)\r\n\r\n\t\t\t\t\tSET @Usage14141 = (SELECT Usage FROM RDR1 WHERE LineNum = @Cont14141 AND DocEntry = @list_of_cols_val_tab_del)\r\n\t\t\t\t\tIF (@Usage14141 = 17)\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tSET @GrupoItem14141 = (SELECT T1.ItmsGrpCod FROM RDR1 T0 INNER JOIN OITM T1 ON T1.ItemCode = T0.ItemCode\r\n\t\t\t\t\t\t\t\t\t\t\t   WHERE T0.LineNum = @Cont14141 AND T0.DocEntry = @list_of_cols_val_tab_del)\r\n\t\t\t\t\t\tIF @GrupoItem14141 IN (116,117,118) \r\n\t\t\t\t\t\tBEGIN\r\n\r\n\t\t\t\t\t\t\tSET @ValorMinReg14141 = (SELECT U_ValorMinimo FROM [@RAL_PEDMINIMOREG] WHERE U_Regiao = @RegiaoPedMin14141)\r\n\t\t\t\t\t\t\tIF(@ValorPedido14141 \u003c @ValorMinReg14141)\r\n\t\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\t\t\tSET @Error =-14141\r\n\t\t\t\t\t\t\t\t\tSET @Error_Message = \u0027Valor m¡nimo para o pedido ‚ \u0027 + cast(@ValorMinReg14141 as varchar)\r\n\t\t\t\t\t\t\t\t\tSELECT @error, @error_message\r\n\r\n\t\t\t\t\t\t\tEND--VALOR MINIMO\r\n\r\n\t\t\t\t\t\tEND--GRUPO ITEM\r\n\r\n\t\t\t\t\tEND--END USAGE\r\n\r\n\t\t\tSET @Cont14141 = @Cont14141 +1\r\n\t\t\tEND--END WHILE\r\nEND--END FINAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\tVinicius Palmagnani\r\n-- Create date: 30/05/2022\r\n-- Update Date: \r\n-- Description: Utiliza‡ao USO E CONSUMO obrigat¢rio preenchimento dos CSTs\r\n-- Documentos: NF de Entrada \r\n-- GLPI ID : 13504\r\n-- GLPI ID atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027)) --\u002718\u0027 = Nota Fiscal Entrada\r\n\r\nBEGIN\r\n\r\nDECLARE @Linhas13504 Numeric = (SELECT Count(*)FROM PCH1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Cont13504 Numeric = 0\r\n\r\nWHILE(@Cont13504 \u003c @Linhas13504)\r\n\tBEGIN\r\n\t\tIF EXISTS (SELECT T2.Usage,T0.CSTCode,T0.CSTfIPI,T0.CSTfPIS,CSTfCOFINS\r\n\t\t\t\t\tFROM PCH1 T0\r\n\t\t\t\t\tINNER JOIN OUSG T2 ON T2.ID = T0.Usage\r\n\t\t\t\t\tWHERE T0.Usage IN (27,26,29,51,31,32,33,23,62,24,25,50,28,18,41,19,20,21,63)\r\n\t\t\t\t\tAND (T0.CSTCode IS NULL OR T0.CSTfIPI IS NULL OR T0.CSTfPIS IS NULL OR CSTfCOFINS IS NULL)\r\n\t\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del AND T0.LineNum = @Cont13504)\r\n\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @Error =-13504\r\n\t\t\t\tSET @Error_Message = \u0027Favor revisar o preenchimento do CST\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\r\n\t\tSET @Cont13504 = @Cont13504 +1\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\tVinicius Palmagnani\r\n-- Create date: 18/05/2022\r\n-- Update Date: 01/06/2022\r\n-- Description: Grupo de itens MAQUINAS OPERACIONAIS ‚ obrigatorio preenchimento da utiliza‡ao \"OPE\" \r\n-- Documentos: NF de Entrada \r\n-- GLPI ID : 13410\r\n-- GLPI ID atualiza‡ao: 13518,13598\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027)) --\u002718\u0027 = Nota Fiscal Entrada\r\n\r\nBEGIN\r\n\r\n\tIF EXISTS (SELECT T0.DocEntry,T1.ItmsGrpCod,T0.OcrCode\r\n\t\t\t\tFROM PCH1 T0\r\n\t\t\t\tINNER JOIN OITM T1 ON T1.ItemCode = T0.ItemCode\r\n\t\t\t\tWHERE T1.ItmsGrpCod = 174\r\n\t\t\t\tAND T0.OcrCode IN (\u002701.0001\u0027, \u002701.0002\u0027,\u002701.0005\u0027)\r\n\t\t\t\tAND T0.Usage NOT IN (19,21,31,32)\r\n\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\t\tBEGIN\r\n\r\n\t\t\tSET @Error =-13410\r\n\t\t\tSET @Error_Message = \u0027Favor revisar o preenchimento do campo \"Utiliza‡ao\"\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\r\n\t\tEND\r\n\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Dalmir Pompeu Ponzo Junior\r\n-- Create date: 28/10/2021\r\n-- Update Date:\r\n-- Description: Travar altera‡oes e cancelamentos em Cota‡oes de Vendas para vendedores\r\n-- Documento: Cota‡ao de Vendas\r\n-- GLPI ID: 12179\r\n-- GLPI IG Atualiza‡ao: \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027U\u0027 , \u0027D\u0027 , \u0027C\u0027 , \u0027L\u0027))\r\nBEGIN\r\n\r\nDECLARE @UserSign12179C int = (SELECT UserSign2 FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Dep12179C int SET @Dep12179C = (SELECT Department FROM OUSR WHERE USERID = @UserSign12179C)\r\n\r\n\r\nIF(@Dep12179C = 1)\r\nBEGIN\r\n\r\n\r\nSET @error = -12179\r\nSET @error_message = \u0027Nao ‚ permitido alterar ou cancelar o documento. Favor entrar em contato com Administra‡ao de Vendas.\u0027\r\nSELECT @error, @error_message\r\nEND\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n*/\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Dalmir Pompeu Ponzo Junior\r\n-- Create date: 27/10/2021\r\n-- Update Date:\r\n-- Description: Travar altera‡oes e cancelamentos em Pedidos de Vendas para vendedores\r\n-- Documento: Pedido de Vendas\r\n-- GLPI ID: 12179\r\n-- GLPI ID Atualiza‡ao:16900\r\n-- UpdateAuthor: Leonardo do Prado Gomes\r\n-- Description: Acrescentado novo parametro para travar cancelamento do pedido de vendas.\r\n-- UpdateDate: 09/05/2024\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027U\u0027 , \u0027D\u0027 , \u0027C\u0027 , \u0027L\u0027))\r\nBEGIN\r\n\r\nDECLARE @UserSign12179V int = (SELECT UserSign2 FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Dep12179V int SET @Dep12179V = (SELECT Department FROM OUSR WHERE USERID = @UserSign12179V)\r\nDECLARE @UserAprov12179 INT;\r\nSET @UserAprov12179 = (SELECT T1.UserID\r\n\t\t\t\t\t\t\tFROM OWDD T0\r\n\t\t\t\t\t\t\tINNER JOIN WDD1 T1\r\n\t\t\t\t\t\t\t   ON T1.WddCode = T0.WddCode\r\n\t\t\t\t\t\t\tWHERE T1.UserID = 279\r\n\t\t\t\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\tGROUP BY T1.UserID)\r\n\r\nIF(@Dep12179V = 1 AND @UserAprov12179 \u003c\u003e 279)\r\nBEGIN\r\n\r\n\tSET @error = -12179\r\n\tSET @error_message = \u0027Nao ‚ permitido alterar ou cancelar o documento. Favor entrar em contato com Administra‡ao de Vendas.\u0027\r\n\tSELECT @error, @error_message\r\n\tEND\r\n\r\nEND\r\n\r\n-------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027C\u0027))\r\nBEGIN\r\n\r\nDECLARE @UserSign16900V int = (SELECT UserSign2 FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Dep16900V int SET @Dep16900V = (SELECT Department FROM OUSR WHERE USERID = @UserSign16900V)\r\nDECLARE @UserAprov16900 INT;\r\nSET @UserAprov16900 = (SELECT T1.UserID\r\n\t\t\t\t\t\t\tFROM OWDD T0\r\n\t\t\t\t\t\t\tINNER JOIN WDD1 T1\r\n\t\t\t\t\t\t\t   ON T1.WddCode = T0.WddCode\r\n\t\t\t\t\t\t\tWHERE T1.UserID = 279\r\n\t\t\t\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\r\n\r\nIF(@Dep16900V \u003c\u003e 2 AND @UserAprov16900 \u003c\u003e 279)\r\nBEGIN\r\n\r\n\r\nSET @error = -12179\r\nSET @error_message = \u0027Nao ‚ permitido alterar ou cancelar o documento. Favor entrar em contato com Administra‡ao de Vendas.\u0027\r\nSELECT @error, @error_message\r\n\r\nEND\r\n\r\nEND\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Vinicius Palmagnani Faria\r\n-- Create date: 12/08/2021\r\n-- Description:\tBloquear cadastro de placas com mais de sete caracteres\r\n-- Documento: Cadastro de ve¡culo (add-on Ruston - perif‚ricos)\r\n-- GLPI ID: 11712\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u0027RAL_VEICULO\u0027) and (@transaction_type in (\u0027A\u0027, \u0027U\u0027))\r\n\r\nBEGIN\r\n\r\nDECLARE @PLACA11712 NVARCHAR(10) = (SELECT U_PLACA FROM [@RAL_VEICULO] WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\nIF LEN(@PLACA11712) \u003e 7\r\n\r\nSET @Error =-11712\r\nSET @Error_Message = \u0027Quantidade incorreta de caracteres na placa do ve¡culo. Favor revisar o preenchimento do campo.\u0027\r\nSELECT @error, @error_message\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- SPS CONSULTORIA\r\n-- Author: Cristiana Maria\r\n-- Create date: 15/06/2021\r\n-- Description:\tNao permitir lancamento contabil negativo\r\n-- Documento: Lancamento cont bil manual\r\n-- GLPI ID: 11332\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = N\u002730\u0027) and (@transaction_type in (\u0027A\u0027, \u0027U\u0027))\r\nBegin \r\n\r\nif (select count (transid) from jdt1 where debit \u003c 0 and TransId =  @list_of_cols_val_tab_del) \u003e0\r\nbegin\r\n\tset @Error =-11332\r\n    set @Error_Message = \u0027Lan‡amento cont bil com valor negativo.\u0027\r\n\tSELECT @error, @error_message\r\nend\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\tFabricio Consiglio\t\r\n-- Create date: 18/02/2021\r\n-- Description:\tPreencher campo \"Observa‡ao do di rio\" em importa‡ao de CTE de Venda\r\n-- Documento: NF-Entrada\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF ((\t\r\n\t\t@object_type = N\u002718\u0027)\r\n\tAND @transaction_type IN (\u0027A\u0027))\r\n\r\nBEGIN\r\n\tEXEC [dbo].[SPS_SP_OBS] @object_type, @list_of_cols_val_tab_del\t\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 18/01/2021\r\n-- Description:\tNao permitir pedido de Vendas com parceiro Lead (ESBO€O)\r\n-- Documento: Pedido de Vendas\r\n-- GLPI ID:9768\r\n-- GLPI IG Atualiza‡ao:10260\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\r\nDECLARE @CardType9768E char = (SELECT T1.CardType FROM ODRF T0\r\nINNER JOIN OCRD T1 on T0.CardCode = T1.CardCode\r\nWHERE T0.ObjType = 17 AND T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@CardType9768E =\u0027L\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -9768\r\n\t\t\tSET @error_message = \u0027Nao ‚ permitido enviar Pedido com cliente Lead - esbo‡o\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Vinicius Palmagnani Faria\r\n-- Create date: 10/09/2020\r\n-- Description: Impossibilitar adi‡ao de documento sem regra de distribui‡ao\r\n-- Documentos: Lan‡amento de estoque\r\n-- GLPI ID: 9450\r\n-- GLPI ID Atualiza‡oes:\r\n------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002710000071\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002710000071\u0027 = Lan‡amento de estoque\r\n \r\nBEGIN\r\n DECLARE @DocEntryLE int = @list_of_cols_val_tab_del\r\n DECLARE @DocTypeLE char = (SELECT DataSource FROM OIQR WHERE DocEntry = @DocEntryLE)\r\n \r\n ----Regra de Distribui‡ao\r\n IF EXISTS (SELECT OL.OcrCode FROM OIQR O INNER JOIN IQR1 OL ON O.DocEntry = ol.DocEntry\r\n \tWHERE o.DocEntry = @DocEntryLE AND (OL.OcrCode IS NULL OR OL.OcrCode = \u0027\u0027))\r\n\r\n \tBEGIN\r\n\t\tSET @error = -9450\r\n\t\tSET @error_message = \u0027Lan‡amento de estoque - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t\tSELECT @error, @error_message\r\n    END\r\n \r\nEND;\r\n \r\n---------------------------------ESBO€O\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--N\u0027112\u0027 = ESBO€O\r\n \r\nBEGIN\r\n DECLARE @DocEntryESBLE int = @list_of_cols_val_tab_del\r\n DECLARE @DocTypeESBLE char = (SELECT DocType FROM ODRF WHERE objtype = 10000071 AND DocEntry = @DocEntryESBLE)\r\n \r\n IF EXISTS (SELECT OL.OcrCode FROM ODRF O INNER JOIN DRF1 OL ON O.DocEntry = ol.DocEntry\r\n WHERE o.objtype = 10000071 AND o.DocEntry = @DocEntryESBLE AND OL.OcrCode IS NULL)\r\n\r\n\t BEGIN\r\n\t   SET @error = -9450\r\n\t   SET @error_message = \u0027Esbo‡o - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t   SELECT @error, @error_message\r\n\t END\r\n\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------- \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Vinicius Palmagnani\r\n-- Create date: 04/12/2020\r\n-- Update Date: \r\n-- Description: Travar atualiza‡ao de PN para vendedores/representantes com parceiro Cliente \r\n-- Documento: Parceiro de Negocios\r\n-- GLPI ID: 10063\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*IF (@object_type = \u00272\u0027) and (@transaction_type in (\u0027U\u0027)) --\u00272\u0027 = Parceiro de Negocios\r\nBEGIN\r\n\r\nDECLARE @UserSign10063 int = (SELECT UserSign2 FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @Dep10063 int SET @Dep10063 = (SELECT Department FROM OUSR WHERE USERID = @UserSign10063)\r\nDECLARE @CardType10063 char = (SELECT CardType FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\n\r\nIF(@Dep10063 = 1)\t\r\n\tBEGIN\r\n\t\r\n\tIF(@CardType10063 \u003c\u003e \u0027L\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -10063\r\n\t\t\tSET @error_message = \u0027Nao ‚ permitido atualizar os cadastros do PN.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END */\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 10/11/20\r\n-- Update Date: \r\n-- Description: Nao permitir pedido de Vendas com parceiro Lead\r\n-- Documento: Pedido de Vendas\r\n-- GLPI ID:9768\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u00272\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @CardType9768P char = (SELECT T1.CardType FROM ORDR T0\r\nINNER JOIN OCRD T1 on T0.CardCode = T1.CardCode\r\nWHERE T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@CardType9768P =\u0027L\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -9768\r\n\t\t\tSET @error_message = \u0027Nao ‚ permitido enviar Pedido com cliente Lead.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 10/11/20\r\n-- Update Date: \r\n-- Description: Nao permitir cota‡ao de Vendas com parceiro Lead\r\n-- Documento: Cota‡ao de Vendas\r\n-- GLPI ID:9768\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027 ))--\u00272\u0027 = Cota‡ao de vendas\r\nBEGIN\r\n\r\nDECLARE @CardType9768C char = (SELECT T1.CardType FROM OQUT T0\r\nINNER JOIN OCRD T1 on T0.CardCode = T1.CardCode\r\nWHERE T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@CardType9768C =\u0027L\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -9768\r\n\t\t\tSET @error_message = \u0027Nao ‚ permitido enviar Cota‡ao com cliente Lead.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 10/11/20\r\n-- Update Date: \r\n-- Description: Travar cadastro de pn feito por vendedores sem Nome, telefone, email e cnpj \r\n-- Documento: Parceiro de Negocios\r\n-- GLPI ID:9768\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u00272\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00272\u0027 = Parceiro de NEgocios\r\nBEGIN\r\n\r\nDECLARE @UserSign9768 int = (SELECT UserSign FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\n\r\nDECLARE @Dep9768 int SET @Dep9768 = (SELECT Department FROM OUSR WHERE USERID = @UserSign9768)\r\n\r\nDECLARE @CardName9768 NVARCHAR(MAX) = (select CardName from OCRD where CardCode = @list_of_cols_val_tab_del)\r\n\r\nDECLARE @Telefone9768 NVARCHAR(MAX) = (select Phone1 from OCRD where CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @Email9768 NVARCHAR(MAX) = (select E_mail from OCRD where CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @CNPJ9768 NVARCHAR(MAX) = (SELECT DISTINCT  T1.TaxId0 FROM OCRD T0 \r\n\t\t\t\t\t\t\t\t\tINNER JOIN CRD7 T1 ON T0.CardCode = T1.CardCode AND T0.ShipToDef = T1.Address\r\n\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = \u0027C001965\u0027 AND T1.TaxId0 IS NOT NULL)\r\nDECLARE @UserPortal9768 INT\r\nSET @UserPortal9768 = (SELECT T1.Department\r\n\t\t\t\t\t\t\tFROM OUSR T1\r\n\t\t\t\t\t\t\tWHERE T1.USER_CODE IN(SELECT T0.U_AHS_SapUserCode\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tFROM OCRD T0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = @list_of_cols_val_tab_del))\r\n\r\nIF(@UserPortal9768 \u003c\u003e 17) ----EQUIPE DE COMPRAS(SUPRIMENTO)\r\nBEGIN\r\n\r\n\tIF(@Dep9768 = 1)\t\r\n\tBEGIN\r\n\t\r\n\t\tIF(@CardName9768 is null OR @CardName9768 =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -9768\r\n\t\t\t\tSET @error_message = \u0027Campo NOME ‚ obrigat¢rio. Verifique!.\u0027\t\t\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tIF(@Telefone9768 is null OR @Telefone9768 =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -9768\r\n\t\t\t\tSET @error_message = \u0027Campo TELEFONE ‚ obrigat¢rio. Verifique!.\u0027\t\t\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tIF(@Email9768 is null OR @Email9768 =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -9768\r\n\t\t\t\tSET @error_message = \u0027Campo E-MAIL ‚ obrigat¢rio. Verifique!.\u0027\t\t\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tIF(@CNPJ9768 is null OR @CNPJ9768 =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -9768\r\n\t\t\t\tSET @error_message = \u0027Campo CNPJ ‚ obrigat¢rio. Verifique!.\u0027\t\t\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\t\r\n\t\tEND\t\r\n\r\n\tEND\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 03/11/2020\r\n-- Update Date: \r\n-- Description: Campos Grupo UF Cliente e Grupo fornecedores sao obrigatorios\r\n-- Documento: Parceiro de Negocios\r\n-- GLPI ID:9709\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u00272\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00272\u0027 = Parceiro de NEgocios\r\nBEGIN\r\n\r\n\r\nDECLARE @CardType9709 char = (SELECT CardType FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @GruCli NVARCHAR(MAX) = (SELECT U_MW_GRUCLI FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @GruFor NVARCHAR(MAX) = (SELECT U_MW_GRUFOR FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @UserPortal9709 INT\r\nSET @UserPortal9709 = (SELECT T1.Department\r\n\t\t\t\t\t\t\tFROM OUSR T1\r\n\t\t\t\t\t\t\tWHERE T1.USER_CODE IN(SELECT T0.U_AHS_SapUserCode\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tFROM OCRD T0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = @list_of_cols_val_tab_del))\r\n\r\nIF(@UserPortal9709 \u003c\u003e 17) ----EQUIPE DE COMPRAS(SUPRIMENTO)\r\nBEGIN\r\n\tIF(@CardType9709 = \u0027C\u0027 AND (@GruCli is null OR @GruCli =\u0027\u0027 OR @GruCli = \u0027DEFINIR\u0027))\t\r\n\t\tBEGIN\r\n\t\t\tSET @error = -9709\r\n\t\t\tSET @error_message = \u0027O preenchimento do campo Grupo UF de Cliente ‚ Obrigat¢rio. Verifique!.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\n\tELSE IF(@CardType9709 = \u0027S\u0027 AND (@GruFor is null OR @GruFor =\u0027\u0027 OR @GruFor = \u0027DEFINIR\u0027))\t\r\n\t\tBEGIN\r\n\t\t\tSET @error = -9709\r\n\t\t\tSET @error_message = \u0027O preenchimento do campo Grupo Fornecedores ‚ Obrigat¢rio. Verifique!.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- Author:Henrique Truyts\r\n---- Create date: 21/10/2020\r\n---- Update Date: \r\n---- Description: Trava para evitar altera‡ao da OC em caso de divergencias de quantidade da oc com o pedido\r\n---- Documento: Ordem de Carga\r\n---- GLPI ID:9173\r\n---- GLPI IG Atualiza‡ao: 15004\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u0027BIM_ORDEMCARGA\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00272\u0027 = Ordem de Carga\r\n--BEGIN\t\r\n--\tIF EXISTS (\r\n--\t----COMPARA€AO ENTRE TOTAIS DA OC E TOTAIS DOS PEDIDOS DA OC\r\n--\t----SE O CAMPO DIFEREN€A FOR MAIOR QUE ZERO DEVE-SE REFAZER A OC\r\n--\tSELECT *FROM (\r\n--\t\tSELECT \r\n--\t\t\tT100.U_Codigo,SUM(T100.U_Quantidade_Pedido) \u0027Qtd OC\u0027,\r\n--\t\t\t(--totais do pedido\r\n--\t\t\tSELECT \r\n--\t\t\t\tSUM(T1.Quantity)\r\n--\t\t\tFROM ORDR T0\r\n--\t\t\tINNER JOIN RDR1 T1 on T0.DocEntry = T1.DocEntry\r\n--\t\t\tWHERE CANCELED = \u0027N\u0027 AND T1.U_OC_num = T100.DocEntry AND ItemCode = U_Codigo\r\n--\t\t\tGROUP BY T1.ItemCode\r\n--\t\t\t)\u0027Totais do Pedido\u0027,\r\n--\t\t\tSUM\r\n--\t\t\t\t(U_Quantidade_Pedido) -\r\n--\t\t\t\t(--totais do pedido\r\n--\t\t\t\tSELECT \r\n--\t\t\t\t\tSUM(T1.Quantity)\r\n--\t\t\t\tFROM ORDR T0\r\n--\t\t\t\tINNER JOIN RDR1 T1 on T0.DocEntry = T1.DocEntry\r\n--\t\t\t\tWHERE CANCELED = \u0027N\u0027 AND T1.U_OC_num = T100.DocEntry AND ItemCode = U_Codigo\r\n--\t\t\t\tGROUP BY T1.ItemCode\r\n--\t\t\t)\u0027Diferen‡a\u0027\r\n--\t\tFROM [@BIM_ORDEMCARGA_1]  T100\r\n--\t\tWHERE T100.DocEntry =  @list_of_cols_val_tab_del\r\n--\t\tGROUP BY T100.U_Codigo,T100.DocEntry\r\n--\t)A WHERE Diferen‡a \u003e 0\r\n\r\n--\t)\r\n--\tBEGIN\r\n--\t\tSET @error = -9173\r\n--\t\tSET @error_message =  \u0027Divergˆncia entre as quantidades da OC e do pedido, favor refazer a OC!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\t\r\n--END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n----END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 25/01/2018\r\n-- Update Date: 13/08/2020\r\n-- Update Date: 21/12/2023\r\n-- Description:\tPREENCHIMENTO DOS CAMPOS DE OC NA ENTREGA\r\n-- Description: 14/12/2023 - Atualizado para colocarmos informa‡ao de horario de recebimento do parceiro no pedido.\r\n-- Documentos: Entrega\r\n-- GLPI ID:4103\r\n---- GLPI ID Atualiza‡oes:9231\r\n---- GLPI ID Atualiza‡oes:16244\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002715\u0027 = ENTREGA\r\nBEGIN\r\nIF EXISTS((SELECT *FROM (\r\n\t\tSELECT \r\n\t\t\tT0.U_OC_NUM ,T0.DocEntry,T0.U_dtPreventregainicial,T0.U_dtPreventregafinal,T0.U_Status\r\n\t\tFROM\r\n\t\t\tDLN1 T0 \r\n\t\tWHERE \r\n\t\t\tT0.DocEntry = @list_of_cols_val_tab_del AND U_Status \u003c\u003e\u0027Liberada\u0027)A))\r\n\tBEGIN\r\n\t\t\tSET @error = -4103\r\n\t\t\tSET @error_message = \u0027OC nao est  liberada para a Entrega. Verifique.\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\t\r\n\tEND\r\n\tIF ((SELECT Count(*)FROM    (\r\n\t\tSELECT \r\n\t\t\tT0.U_OC_NUM ,T0.DocEntry,T0.U_dtPreventregainicial,T0.U_dtPreventregafinal,T0.U_Status\r\n\t\tFROM\r\n\t\t\tDLN1 T0 \r\n\t\tWHERE \r\n\t\t\tT0.DocEntry = @list_of_cols_val_tab_del\r\n\t\tGROUP BY \r\n\t\t\tT0.U_OC_NUM,T0.DocEntry,T0.U_dtPreventregainicial,T0.U_dtPreventregafinal,T0.U_Status) A) \u003c\u003e 1)\r\n\tBEGIN\r\n\t\t\tSET @error = -4103\r\n\t\t\tSET @error_message = \u0027Existe linhas da Entrega sem aloca‡ao de OC ou com OC distintas. Verifique!\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\t\r\n\tEND\r\n\tELSE IF((SELECT T0.U_OC_NUM FROM DLN1 T0 WHERE T0.DocEntry = @list_of_cols_val_tab_del GROUP BY T0.U_OC_NUM ) IS NOT NULL)\r\n\tBEGIN\r\n\t\t\tDECLARE @DocEntryOC NVARCHAR (254) = (SELECT T0.U_OC_NUM FROM DLN1 T0 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0)\r\n\r\n--ALTERA€AO REALIZADA AQUI\r\n--UPDATE ENTREGA\r\n\tUPDATE ODLN SET \r\n\t\tU_OC_NUM = (SELECT T0.U_OC_NUM FROM DLN1 T0 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0),\r\n\t\tU_dtPreventregainicial = (SELECT T0.U_dtPreventregainicial FROM DLN1 T0 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0),\r\n\t\tU_dtPreventregafinal = (SELECT T0.U_dtPreventregafinal FROM DLN1 T0 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0),\r\n\t\tU_Status = (SELECT T0.U_Status FROM DLN1 T0 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0),\r\n\t\tHeader = (\u0027Pedido: \u0027+ \r\n\t(SELECT Convert(NVarchar(MAX),BaseEntry) FROM DLN1 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0) +\r\n\t\t\t\u0027, Oc: \u0027 + (SELECT T0.U_OC_NUM FROM DLN1 T0 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0)+ char(13) + \r\n\t\t\t\u0027Pn: \u0027 + (SELECT CardCode FROM ODLN WHERE DocEntry = @list_of_cols_val_tab_del) + \u0027,\u0027 + (SELECT [dbo].[PNHorarioEntrega]((SELECT CardCode FROM ODLN WHERE DocEntry = @list_of_cols_val_tab_del))) + \u0027, Entr: \u0027 + (SELECT Convert(NVARCHAR(MAX),DocNum) FROM ODLN WHERE DocEntry = @list_of_cols_val_tab_del) +char(13) + \r\n\t\t(SELECT CASE WHEN ( U_LocalEntregaLabel IS NOT NULL AND U_LocalEntregaLabel\u003c\u003e\u0027\u0027) THEN (\r\n\t\tSELECT \u0027Local de Entrega:\u0027+ \r\n\t\tCASE WHEN U_tipoLogradouro IS NOT NULL THEN U_tipoLogradouro ELSE \u0027\u0027 END +\u0027 \u0027+ \r\n\t\tCASE WHEN U_Logradouro IS NOT NULL THEN U_Logradouro ELSE \u0027\u0027 END +\u0027,\u0027+ \r\n\t\tCASE WHEN U_Numero IS NOT NULL THEN U_Numero ELSE \u0027\u0027 END +\u0027 -\u0027+\r\n\t\tCASE WHEN U_Bairro IS NOT NULL THEN U_Bairro ELSE \u0027\u0027 END +\u0027 - \u0027+\r\n\t\tCASE WHEN U_Municipio IS NOT NULL THEN U_Municipio ELSE \u0027\u0027 END +\u0027/\u0027+\r\n\t\tCASE WHEN U_Estado IS NOT NULL THEN U_Estado ELSE \u0027\u0027 END+\u0027 - CEP \u0027+\r\n\t\tCASE WHEN U_Cep IS NOT NULL THEN  U_Cep ELSE \u0027\u0027 END\r\n\t\tFROM [@RAL_LOCALENTREGA1] t0\r\n\t\tINNER JOIN [@RAL_LOCALENTREGA] T1 On t0.DocEntry = T1.DocEntry\r\n\t\tWHERE U_IDEndereco = (\r\n\t\tSELECT U_LocalEntregaLabel FROM ORDR WHERE DocEntry = (SELECT BaseEntry FROM DLN1 WHERE DocEntry =@list_of_cols_val_tab_del and VisOrder = 0))\t\r\n\t\t AND T1.U_CardCode = (\r\n\t\tSELECT cardCode FROM ORDR WHERE DocEntry = (SELECT BaseEntry FROM DLN1 WHERE DocEntry =@list_of_cols_val_tab_del and VisOrder = 0))\r\n\t\tGROUP BY U_IDEndereco ,U_tipoLogradouro ,U_Logradouro,U_Numero,U_Bairro,U_Municipio,U_Estado,U_Cep\r\n\t\t) ELSE \u0027\u0027 END\t\t\r\n\t\t FROM ORDR WHERE DocEntry = (SELECT BaseEntry FROM DLN1 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0))+ char(13)+\r\n\t\t(SELECT CASE WHEN Header IS NOT NULL THEN Convert(NVARCHAR(MAX),Header) ELSE \u0027\u0027 END FROM ODLN WHERE DocEntry = @list_of_cols_val_tab_del))\t\t\r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del;\r\n\r\n\r\n\r\n\t\t\tUPDATE DLN12 SET Carrier = (SELECT U_Transportadora FROM [@BIM_ORDEMCARGA] WHERE DocEntry =  @DocEntryOC),\r\n\t\t\t\t\t\t QOP = (SELECT SUM(T0.QUANTITY) FROM DLN1 T0 WHERE T0.DocEntry = @list_of_cols_val_tab_del),\r\n\t\t\t\t\t\t PackDesc =  (SELECT dbo.DescricaoEmbalagensEntrega(@list_of_cols_val_tab_del)),\r\n\t\t\t\t\t\t Brand=\u0027Ruston\u0027,\r\n\t\t\t\t\t\t grsweight = (SELECT SUM (CAST(REPLACE(t1.U_MW_PESO_BRUTO,\u0027,\u0027,\u0027.\u0027) AS float) * T0.QUANTITY)\r\n\t\t\t\t\t\t FROM DLN1 T0  INNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode WHERE T0.[DocEntry] = @list_of_cols_val_tab_del),\r\n\t\t\t\t\t\t vehicle = (SELECT U_Placa FROM [@RAL_Veiculo] WHERE DocEntry = (SELECT U_Veiculo FROM [@BIM_ORDEMCARGA] WHERE DocEntry =  @DocEntryOC)),\r\n\t\t\t\t\t\t Incoterms = (SELECT U_Frete FROM [@BIM_ORDEMCARGA] WHERE DocEntry =  @DocEntryOC),\r\n\t\t\t\t\t\t VidState = (SELECT  U_Estado_Veiculo FROM [@RAL_Veiculo] WHERE DocEntry = (SELECT U_Veiculo FROM [@BIM_ORDEMCARGA] WHERE DocEntry =  @DocEntryOC))\r\n\t\t\t\t\t\t WHERE DocEntry = @list_of_cols_val_tab_del;\r\n\r\n\t\t\tUPDATE ODLN SET \r\n\t\t\t\t\t\t\tU_EmailEnvDanfe = (SELECT T2.E_Mail\r\n\t\t\t\t\t\t\t\t\t\t\t\tFROM ODLN T0\r\n\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN DLN12 T1 ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN OCRD T2 ON T2.CardCode = T1.Carrier\r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del)\r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del;\r\n\r\n\tEND\r\n\r\nEND;--END GERAL\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n-------------------------------------------------------------------------------------------------------------------------\r\n---- Author: SPS\r\n---- Create date: 02/07/2020\r\n---- Description: Barrar no coletor as ocorrˆncias de duplicidade\r\n---- Documentos:  Entrada de mercadorias\r\n---- GLPI ID: 8984\r\n---- GLPI ID Atualiza‡oes:\r\n-------------------------------------------------------------------------------------------------------------------------\r\n\r\nif(@object_type = \u0027R_IA\u0027 AND @transaction_type IN (\u0027A\u0027,\u0027U\u0027))\r\nbegin\r\n\r\ndeclare @count int= 0\r\ndeclare @tipoPallet int = 0\r\n\r\nselect @tipoPallet = U_TpPallet from [@RAL_IA]\r\nwhere code = @list_of_cols_val_tab_del\r\n\r\nif(@tipoPallet = 0)\r\nbegin\r\n\r\n\tselect @count = COUNT(DocEntry) \r\n\tFROM OIGN \r\n\tWHERE U_NumIA = @list_of_cols_val_tab_del\r\n\t\r\n\t-- DIEGO 27/07/2022\r\n\t--if(@count \u003e 1)\r\n\t--begin\r\n\t--\tset @error = -8984\r\n\t--\tset @error_message = \u0027Pallet j  possui uma entrada\u0027\r\n\t--end\r\n\r\nend\r\n\r\nend \r\n\r\n\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-------------------------------------------------------------------------------------------------------------------------\r\n---- Author: Douglas Dias - SPS\r\n---- Create date: 02/06/2020\r\n---- Description: Travar OP sem preenchimento Custo componente item real\r\n---- Documentos:  Ordem de Produ‡ao\r\n---- GLPI ID: 8700\r\n---- GLPI ID Atualiza‡oes:\r\n-------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027202\u0027) and (@transaction_type in (\u0027U\u0027))--\u0027202\u0027 = Ordem de Produ‡ao\r\nBEGIN\r\nDECLARE @OPStatusF NVarchar(1) SET @OPStatusF = (select Status From OWOR where DocEntry = @list_of_cols_val_tab_del)\r\n\r\nIF(@OPStatusF = \u0027L\u0027)\r\nBEGIN\r\n\tIF NOT EXISTS(SELECT * FROM OWOR WHERE DocEntry IN (select top 1 BaseEntry from IGE1 where BaseEntry = @list_of_cols_val_tab_del)) --VERIFICA SE A OP ESTA SENDO FECHADA SEM SAIDA DE INSUMO (QUE APLICA O CUSTO DO ITEM)\r\n\tBEGIN\r\n\t\tSET @error = -8700\r\n\t\tSET @error_message = \u0027 obrigat¢rio o lan‡amento da Sa¡da de Insumo para contabilizar o Custo componente item!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND\r\n\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 28/05/2020\r\n-- Update Date: 30/04/2022\r\n-- Description:\tTravar Local de Entrega duplicado por parceiro de negocios\r\n-- Documentos:  Local de Entrega\r\n-- GLPI ID: 8813\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027CadLocalEntrega\u0027) and (@transaction_type in (\u0027A\u0027))--\u0027CadLocalEntrega\u0027 = Local de Entrega\r\nBEGIN\r\nDECLARE @CodigoCliente NVARCHAR(10) = (select U_CardCode from [@RAL_LOCALENTREGA] WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Filial8813 numeric = (select U_BPLId from [@RAL_LOCALENTREGA] WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\t\tIF EXISTS(\r\n\t\t\tselect *from [@RAL_LOCALENTREGA] where U_BPLId = @Filial8813 AND U_CardCode = @CodigoCliente AND DocEntry \u003c\u003e@list_of_cols_val_tab_del\r\n\t\t\t)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -8813\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ possivel concluir! J  existe cadastro de local de entrega para esse parceiro!\u0027\r\n\t\t\t\tSELECT @error, @error_message\t\r\n\t\t\tEND\r\n\t\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 16/08/2019\r\n-- Update Date: 28/02/2020\r\n-- Description:\tPreencher informa‡oes de Classifica‡ao e lote na Linha da entrega - Informa‡oes vao para NF - WMS\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002715\u0027 =ENTREGA \r\n\r\nBEGIN\r\n\tDECLARE @ContadorEnt2 int = 0\t\r\n\tDECLARE @ClassificacaoEnt2 nvarchar (255)\r\n\tDECLARE @DocEntryEnt2 int = @list_of_cols_val_tab_del\r\n\tDECLARE @QtyLinesEnt2  int = (SELECT MAX(LineNum) FROM DLN1 WHERE DocEntry =  @DocEntryEnt2)\t\r\n\t\r\n\tWHILE(@ContadorEnt2 \u003c @QtyLinesEnt2+1)\r\n\r\n\t\tBEGIN\r\n\t\t\t--SET @ClassificacaoEnt2 = (SELECT [dbo].[Preench_LoteClassif_Entrega](@DocEntryEnt2,@ContadorEnt2))\r\n\r\n\t\t\tSET @ClassificacaoEnt2 = (SELECT [dbo].[Preench_LotepeloPick_Entrega](@DocEntryEnt2,@ContadorEnt2)) ---REMOVIDO 02/12/2025\r\n\r\n\t\t\tif(@ClassificacaoEnt2 is null OR @ClassificacaoEnt2 = \u0027\u0027)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\tSET @ClassificacaoEnt2 = (SELECT [dbo].[Preench_LoteClassif_Entrega](@DocEntryEnt2,@ContadorEnt2))\r\n\r\n\t\t\tEND\r\n\r\n\t\t\tif (@ClassificacaoEnt2 is not null AND @ClassificacaoEnt2 \u003c\u003e \u0027\u0027)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\r\n\t\t\t\t\tUPDATE DLN1\tSET U_SKILL_InfAdItem = @ClassificacaoEnt2 WHERE DocEntry = @DocEntryEnt2 AND LineNum =  @ContadorEnt2\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\t\t\r\n\t\t\tSET @ContadorEnt2 = @ContadorEnt2 + 1\r\n\t\tEND;\r\n\r\nEND;--END GERAL\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create Date: 21/01/2020\r\n-- Update Date: \r\n-- Description:\tBloquear campos Rendimento\r\n-- GLPI ID: 8272\r\n-- GLPI ID Atualiza‡oes:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027Rendimento\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))-- RENDIMENTOS\r\nBEGIN \r\n--Validar BBranco - \r\n\tIF EXISTS(select Code,U_BBranco From [@RA_RENDIMENTO] where U_BBranco \u003e 99.99 \r\n\tAND code = @list_of_cols_val_tab_del)\r\n\tBEGIN\r\n\t\tSET @error = -8272\r\n\t\tSET @error_message = \u0027BBranco nao pode ser maior que 99.99\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n-------------------------------------------------------------------------------------------------------------------------\r\n---- Author: Vinicius Palmagnani \r\n---- Create date: 14/01/2020\r\n---- Update date: 21/07/2020\r\n---- Description: Travar documento sem preenchimento N§ Requisi‡ao/N§ Chamado\r\n---- Documentos:  Sa¡da de Mercadorias\r\n---- GLPI ID: 8239\r\n---- GLPI ID Atualiza‡oes:9070\r\n-------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002760\u0027) and (@transaction_type in (\u0027A\u0027))--N\u002760\u0027 = OIGE\r\nBEGIN\r\n\tDECLARE @NumReq VARCHAR(MAX) = \u0027\u0027\r\n\tDECLARE @NumCha VARCHAR(MAX) = \u0027\u0027\r\n\tDECLARE @QtyLines8239  int = (SELECT MAX(LineNum) FROM IGE1 WHERE DocEntry = @list_of_cols_val_tab_del)\t\r\n\tDECLARE @Cont8239 int = 0\r\n\r\n\tIF EXISTS(SELECT * FROM \r\n\t\t\t  OIGE T0 INNER JOIN IGE1 T1 ON T1.DocEntry = T0.DocEntry\r\n\t\t\t  WHERE T0.DocEntry = @list_of_cols_val_tab_del AND T0.DataSource \u003c\u003e \u0027A\u0027 AND T0.RelatedTyp \u003c\u003e 59\r\n\t\t\t\t\tAND T1.WhsCode = \u002702.07\u0027 AND T1.BaseType \u003c\u003e 202)\r\n\t\tBEGIN\r\n\r\n\t\t\tWHILE (@Cont8239 \u003c= @QtyLines8239)\r\n\t\t\tBEGIN\r\n\r\n\t\t\tIF EXISTS (SELECT * FROM IGE1 \r\n\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont8239)\r\n\t\t\t\tBEGIN\r\n\r\n\t\t\t\t\tSET @NumReq = (SELECT U_NumRequisicao FROM IGE1 \r\n\t\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont8239)\r\n\r\n\t\t\t\t\tSET @NumCha = (SELECT U_NumChamado FROM IGE1 \r\n\t\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont8239)\r\n\r\n\t\t\t\t\t\tIF (@NumReq is null or @NumReq = \u0027\u0027)\r\n\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\tSET @error = -8239\r\n\t\t\t\t\t\t\tSET @error_message = \u0027O preenchimento do campo \"N§ Requisi‡ao\" ‚ obrigat¢rio\u0027\r\n\t\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\t\tEND\r\n\r\n\t\t\t\t\t\tIF (@NumCha is null or @NumCha = \u0027\u0027)\r\n\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\tSET @error = -8239\r\n\t\t\t\t\t\t\tSET @error_message = \u0027O preenchimento do campo \"N§ Chamado\" ‚ obrigat¢rio\u0027\r\n\t\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\t\tSET @Cont8239 = @Cont8239 +1\r\n\t\t\tEND\r\n\t\tEND\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n---- Author: Henrique Truyts \r\n---- Create date: 06/01/2020\r\n---- Update Date: \r\n---- Description: Atualizar o campo Comissao do assistente na Linha do Pedido \r\n----              Com base no cadastro de comissao do assistente\r\n---- Documentos:  Pedido de Venda\r\n---- GLPI ID: 7452\r\n---- GLPI ID Atualiza‡oes:\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\tDECLARE @ContAssist int = 0\t\r\n\tDECLARE @ComissaoAssistente float = 0\r\n\tDECLARE @DocEntryAssist int = @list_of_cols_val_tab_del\r\n\tDECLARE @CardCodeComAssist Nvarchar (20) = (SELECT CardCode FROM ORDR WHERE DocEntry = @DocEntryAssist)\r\n\tDECLARE @ComAssistPN float = 0\r\n\tDECLARE @QtyLinesAssist  int = (SELECT MAX(LineNum) FROM rdr1 WHERE DocEntry = @DocEntryAssist)\t\r\n\r\n\r\n\tSet @ComAssistPN = (SELECT Coalesce(U_ComissaoAssistente,0) FROM OCRD WHERE CardCode = @CardCodeComAssist)\r\n\t\t\r\n\tWHILE(@ContAssist \u003c @QtyLinesAssist+1)\r\n\t\tBEGIN\r\n\t\t\tIF(@ComAssistPN is not null AND @ComAssistPN \u003e0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @ComissaoAssistente = @ComAssistPN\r\n\t\t\t\tEND\r\n\t\t\tELSE \r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @ComissaoAssistente = (\r\n\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\tT0.U_Comissao\r\n\t\t\t\t\t\tFROM\t\r\n\t\t\t\t\t\t[@RAL_ComAssist1] T0\r\n\t\t\t\t\t\tINNER JOIN [@RAL_ComAssist] T1 ON T1.Code = T0.Code\r\n\t\t\t\t\t\tINNER JOIN OSLP T2 ON T2.SlpCode = T1.U_SlpCode\r\n\t\t\t\t\t\tINNER JOIN OCRD T5 ON T5.U_Assistente = T2.SlpName\r\n\t\t\t\t\t\tINNER JOIN ORDR T3 ON T3.CardCode = T5.CardCode  \r\n\t\t\t\t\t\tINNER JOIN RDR1 T4 ON T4.DocEntry = T3.DocEntry AND T0.U_ItemCode = T4.ItemCode\r\n\t\t\t\t\t\tWHERE T3.DocNum = @DocEntryAssist AND T4.LineNum = @ContAssist)\r\n\t\t\t\tEND\r\n\r\n\t\t\tif (@ComissaoAssistente \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE RDR1\tSET U_ComissaoAssistente = @ComissaoAssistente WHERE DocEntry = @DocEntryAssist AND LineNum =  @ContAssist\r\n\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\t\t\r\n\t\t\tSET @ContAssist = @ContAssist + 1\r\n\t\tEND;\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n------------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 04/04/2019\r\n-- Update date: 10/12/2019\r\n-- Update date: 05/10/2020\r\n-- Description:\tGravar o Pre‡o de Lista do PN ao adicionar o pedido\r\n-- GLPI ID:6659\r\n-- GLPI ID Atualiza‡oes:8127\r\n-- GLPI ID Atualiza‡oes: 9608 - Aplicar desconto no Pre‡o de Lista\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\t\r\nDECLARE @PrecoDeLista Numeric(10,2) = 0\r\nDECLARE @CodigoItem6659 NVARCHAR(10)\r\nDECLARE @TotalLinhas6659 Numeric = (SELECT Max(LineNum) FROM RDR1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Cont6659 Numeric = 0\r\nDECLARE @PrecoExistente Numeric = 0\r\nDECLARE @Desconto9608 NUMERIC = 0\r\n\r\nWHILE(@Cont6659 \u003c @TotalLinhas6659 + 1)\r\n\tBEGIN\r\n\t\tIF EXISTS( SELECT *FROM RDR1 WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont6659)\r\n\t\tBEGIN\r\n\t\t\tSELECT \r\n\t\t\t@CodigoItem6659 = T1.ItemCode,\r\n\t\t\t@PrecoDeLista  = T5.price,\r\n\t\t\t@PrecoExistente = (case when T1.U_PrecoDeLista is null then 0 else T1.U_PrecoDeLista end),\r\n\t\t\t@Desconto9608 = T1.DiscPrcnt\r\n\t\t\tFROM ORDR T0\r\n\t\t\tINNER JOIN RDR1 T1 ON T0.DocEntry = T1.DocEntry \r\n\t\t\tINNER JOIN OCRD T3 ON T0.CardCode = T3.CardCode\r\n\t\t\tINNER JOIN OPLN T4 ON T3.ListNum = T4.ListNum\r\n\t\t\tINNER JOIN ITM1 T5 ON T4.ListNum = T5.PriceList AND T1.ItemCode = T5.ItemCode\r\n\t\t\tWHERE  T0.DocEntry = @list_of_cols_val_tab_del AND T1.LineNum = @Cont6659\r\n\r\n\t\t\tIF ( (@CodigoItem6659  is not null AND @CodigoItem6659 \u003c\u003e \u0027\u0027)\r\n\t\t\t\t\t AND (@PrecoDeLista is not null AND @PrecoDeLista \u003e 0)\r\n\t\t\t\t\t\tAND (@PrecoExistente is null OR @PrecoExistente = 0))\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE RDR1\tSET U_PrecoDeLista = @PrecoDeLista - (@PrecoDeLista * @Desconto9608 / 100)\r\n\t\t\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del AND ItemCode = @CodigoItem6659 AND LineNum =  @Cont6659\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\r\n\t\tEND \r\n\t\tSET @Cont6659 = @Cont6659 + 1\r\n\tEND;\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 21/11/2017\r\n-- Update Date: 11/11/2019\r\n-- Description:\tTRAVA DE CAMPOS ATENDIMENTO\r\n-- GLPI ID: 3873,7718\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027DWU_atend\u0027) and (@transaction_type in (\u0027A\u0027))--N\u0027C1_atend\u0027 = ATENDIMENTO\r\nBEGIN\r\n--@VERDADEIRO \u003e 0 se for igual a 2 ou 7, e o usu rio de cria‡ao do Atendimento for do departamento \"Vendas\"\r\n\r\n\r\nDECLARE @TotalLinhasAtend INT = (SELECT COUNT(*)FROM [@DWU_ATEND_ITENS] WHERE DocEntry = @list_of_cols_val_tab_del) \r\nDECLARE @ContAtend int = 0\r\n\r\n\tIF EXISTS( SELECT  *FROM [@DWU_ATENDIMENTO] T0 \r\n\t\t\t\t\t\t\tINNER JOIN OUSR T1 ON T0.UserSign = T1.USERID\r\n\t\t\t\t\t\t\tWHERE T1.Department = 1 AND T0.U_CodTipoAtendimento IN (2,7) \r\n\t\t\t\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del )\r\n\tBEGIN\r\n\t\tWHILE(@ContAtend \u003c @TotalLinhasAtend )\r\n\t\tBEGIN\r\n\t\t\tIF EXISTS(SELECT U_Motivo FROM [@DWU_ATEND_ITENS] WHERE \r\n\t\t\t\tDocEntry = @list_of_cols_val_tab_del AND LineId =@ContAtend +1 AND (U_MOTIVO IS NULL OR U_MOTIVO =\u0027\u0027)  )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o campo MOTIVO na aba dos Itens !\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF U_MOTIVO\r\n\t\t\tIF EXISTS(SELECT U_Ref1 FROM [@DWU_ATEND_ITENS] WHERE \r\n\t\t\t\tDocEntry = @list_of_cols_val_tab_del AND LineId =@ContAtend +1 AND (U_Ref1 IS NULL OR U_Ref1 =\u0027\u0027) )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o campo LOTE na aba dos Itens !\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF U_Ref1\r\n\t\t\tIF EXISTS(SELECT U_Ref2 FROM [@DWU_ATEND_ITENS] WHERE \r\n\t\t\t\t\tDocEntry = @list_of_cols_val_tab_del AND LineId =@ContAtend +1 AND (U_Ref2 IS NULL OR U_Ref2 =\u0027\u0027) )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o campo DATA FABRICA€AO na aba dos Itens !\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF U_Ref2 \r\n\t\t\tIF EXISTS(SELECT U_Ref3 FROM [@DWU_ATEND_ITENS] WHERE \r\n\t\t\t\tDocEntry = @list_of_cols_val_tab_del AND LineId =@ContAtend +1 AND (U_Ref3 IS NULL OR U_Ref3 =\u0027\u0027) )\r\n\t\t\tBEGIN\r\n\t\t\t    SET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o campo DATA VALIDADE na aba dos Itens !\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF U_Ref3\r\n\t\t\tSET @ContAtend = @ContAtend +1\r\n\t\tEND --END WHILE\r\n\tEND--end if verdadeiro\r\n\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END - TRAVA DE CAMPOS ATENDIMENTO CRM- ID 3873\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n-------------------------------------------------------------------------------------------------------------------------\r\n---- Author: Henrique Truyts \r\n---- Create date: 11/10/2019\r\n---- Update Date: \r\n---- Description: Travar OP sem Classifica‡ao de OP\r\n---- Documentos:  Ordem de Produ‡ao\r\n---- GLPI ID: 7790\r\n---- GLPI ID Atualiza‡oes:\r\n-------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027202\u0027) and (@transaction_type in (\u0027U\u0027))--\u0027202\u0027 = Ordem de Produ‡ao\r\nBEGIN\r\nDECLARE @OPStatus NVarchar(1) SET @OPStatus = (select Status From OWOR where DocEntry = @list_of_cols_val_tab_del)\r\n\r\nIF(@OPStatus = \u0027L\u0027)\r\nBEGIN\r\n\tIF EXISTS(select Status From OWOR where DocEntry = @list_of_cols_val_tab_del and (U_ClassOP is null or U_ClassOP =\u0027\u0027))\r\n\tBEGIN\r\n\t\tSET @error = -7790\r\n\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Classifica‡ao de OP, verifique!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND\r\n\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n-------------------------------------------------------------------------------------------------------------------------\r\n---- Author:\t\tHenrique Truyts \r\n---- Create date: 29/01/2018\r\n---- Update Date: 27/09/2019\r\n---- Description: Travar Documentos sem RA preenchido \r\n---- Documentos:  Solicita‡ao de Compra,Oferta de Compra, Saida de mercadorias\r\n---- GLPI ID: 6345\r\n---- GLPI ID Atualiza‡oes: 9451\r\n---- Description: Retirar a trava de RA dos documentos sa¡da de mercadoria e entrada de mercadoria em 13/09/2020\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u00271470000113\u0027) and (@transaction_type in (\u0027A\u0027))--\u00271470000113\u0027 = Solicita‡ao de Compra\r\n--BEGIN\r\n--\tIF EXISTS(SELECT * FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del AND (U_RAL_CadastroRA IS NULL OR  U_RAL_CadastroRA = \u0027\u0027))\r\n--\tBEGIN\r\n--\t\tSET @error = -6345\r\n--\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Cadastro RA, verifique!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\n--END\r\n------------------------------OFERTA DE COMPRA\r\n--IF (@object_type = \u0027540000006\u0027) and (@transaction_type in (\u0027A\u0027))--\u0027540000006\u0027 = Oferta de Compra\r\n--BEGIN\r\n--\tIF EXISTS(SELECT * FROM PQT1 WHERE DocEntry =@list_of_cols_val_tab_del  AND (U_RAL_CadastroRA IS NULL OR  U_RAL_CadastroRA = \u0027\u0027))\r\n--\tBEGIN\r\n--\t\tSET @error = -6345\r\n--\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Cadastro RA, verifique!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\n--END\r\n--------------------------------SAIDA DE MERCADORIAS\r\n--IF (@object_type = \u002760\u0027) and (@transaction_type in (\u0027A\u0027))--\u002760\u0027 = Saida de mercadorias\r\n--BEGIN\r\n--\tIF EXISTS(SELECT * FROM IGE1 WHERE BaseType \u003c\u003e202 AND DocEntry =@list_of_cols_val_tab_del  AND (U_RAL_CadastroRA IS NULL OR  U_RAL_CadastroRA = \u0027\u0027))\r\n--\tBEGIN\r\n--\t\tSET @error = -6345\r\n--\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Cadastro RA, verifique!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 31/01/2017\r\n-- Update date: 23/09/2019\r\n-- Update date: 15/05/2024\r\n-- Description:\tTravar Solicita‡oes de compras com data necessaria inferior ao prazo de solicita‡ao\r\n-- Bruno pediu para adicionar a a‡ao ao atualizar em 23/09/2019\r\n-- DescriptionUpdate: acrescentado nova regra para que o colaborador william (compras) nao caia na regra e consiga atualizar o campo de status da solicitacao\r\n-- Documentos: Solicita‡ao de Compras\r\n-- GLPI ID : 4768\r\n-- GLPI Update ID : 16926\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u00271470000113\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00271470000113\u0027 = Solicita‡ao de Compras\r\nBEGIN\r\nDECLARE @TotLinhas4768 Numeric SET @TotLinhas4768 =  (SELECT Count(*) FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Cont4768 Numeric = 0\r\nDECLARE @ReqDate4768 DATETIME = null\r\nDECLARE @PrazoDias Numeric = 0\r\nDECLARE @DataAtual Datetime SET @DataAtual = (SELECT GETDATE())\r\nDECLARE @Urgente Char(1) SET @Urgente =(SELECT U_Ral_Urgente FROM OPRQ WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @User16926 Varchar(254)\r\n\r\nSET @User16926 = (SELECT T0.UserSign2\r\n\t\t\t\t FROM OPRQ T0\r\n\t\t\t\t WHERE T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF (@User16926 \u003c\u003e 230)\r\n\tBEGIN\r\n\r\n\t\tIF(@Urgente = \u0027N\u0027)\r\n\t\tBEGIN\r\n\t\tWHILE(@Cont4768 \u003c@TotLinhas4768)\r\n\t\tBEGIN\r\n\t\t\tSET @ReqDate4768 = (SELECT PQTReqDate FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont4768)\r\n\t\t\r\n\t\t\tSET @PrazoDias = ISNULL(( SELECT U_RAL_Prazo FROM [@RAL_PrazoSolCompras] WHERE  U_RAL_GrupoItensID = \r\n\t\t\t\t(SELECT ITMsGrpCod FROM OITM WHERE ItemCode = \r\n\t\t\t\t\t(SELECT ItemCode FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont4768))),0)\r\n\r\n\t\t\t\r\n\t\t\t\t\tIF(@PrazoDias \u003e 0 AND (@ReqDate4768 \u003c(@DataAtual + @PrazoDias)))\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @error = - 4768\r\n\t\t\t\t\t\tSET @error_message = \u0027O prazo m¡nimo para data necess ria ‚ \u0027+Convert(Nvarchar,((@DataAtual + @PrazoDias)+1),103)+\u0027. Verifique.\u0027\r\n\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\tEND\r\n\t\t\tSET @Cont4768 = @Cont4768  +1\r\n\t\tEND--END WHILE\r\n\t\tEND--END IF\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 19/01/2017\r\n-- Update date: 17/08/2019\r\n-- Description:\tAtualizar o campo Classifica‡ao na Linha da NF Com ORIGEM ENTREGA\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002713\u0027 = Nota Fiscal \r\n\r\n--BEGIN\r\n--\tDECLARE @ContadorEnt int = 0\t\r\n--\tDECLARE @ClassificacaoEnt nvarchar (255)\r\n--\tDECLARE @DocEntryEnt int = @list_of_cols_val_tab_del\r\n--\tDECLARE @QtyLinesEnt  int = (SELECT MAX(LineNum) FROM INV1 WHERE DocEntry = @DocEntryEnt)\t\r\n--\tDECLARE @BaseTypeENT int = (SELECT BaseType FROM INV1 WHERE DocEntry= @DocEntryEnt GROUP BY  BaseType)\r\n\r\n--IF(@BaseTypeENT = 15)\r\n--BEGIN\r\n--\tWHILE(@ContadorEnt \u003c @QtyLinesEnt+1)\r\n--\t\tBEGIN\r\n--\t\t\tSET @ClassificacaoEnt = (SELECT [dbo].RAL_CLASSIFICACAO_ENTREGA(@DocEntryEnt,@ContadorEnt))\r\n\r\n--\t\t\tif  EXISTS(select *from inv1 WHERE DocEntry = @DocEntryEnt AND LineNum =  @ContadorEnt and (U_SKILL_InfAdItem is null OR Convert(nvarchar(max),U_SKILL_InfAdItem)=\u0027 / LT:\u0027))\r\n--\t\t\tBEGIN\r\n--\t\t\t\tif (@ClassificacaoEnt is not null AND @ClassificacaoEnt \u003c\u003e \u0027\u0027)\r\n--\t\t\t\tBEGIN\r\n\t\t\t\t\r\n--\t\t\t\t\tUPDATE INV1\tSET U_SKILL_InfAdItem = @ClassificacaoEnt WHERE DocEntry = @DocEntryEnt AND LineNum =  @ContadorEnt\t\t\t\t\t\r\n\t\t\t\t\t\r\n--\t\t\t\tEND;\r\n--\t\t\tEND\r\n\r\n\t\t\r\n\t\t\r\n--\t\t\tSET @ContadorEnt = @ContadorEnt + 1\r\n--\t\tEND;\r\n--END--END IF\t\t\r\n--END;--END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 13/01/2017\r\n-- Update Date: 13/08/2018\r\n-- Description:\tAtualizar o campo Classifica‡ao na Linha da NF\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002713\u0027 = Nota Fiscal \r\n\r\n--BEGIN\r\n--\tDECLARE @Contador1 int = 0\t\r\n--\tDECLARE @Classificacao nvarchar (255)\r\n--\tDECLARE @DocEntry1 int = @list_of_cols_val_tab_del\r\n--\tDECLARE @QtyLinesS  int = (SELECT MAX(LineNum) FROM INV1 WHERE DocEntry = @DocEntry1)\t\r\n--\tDECLARE @BaseType int = (SELECT BaseType FROM INV1 WHERE DocEntry= @DocEntry1 GROUP BY  BaseType)\r\n\r\n--IF(@BaseType\u003c\u003e15)\r\n--BEGIN\r\n\r\n--\tWHILE(@Contador1 \u003c @QtyLinesS+1)\r\n--\t\tBEGIN\r\n--\t\t\tSET @Classificacao = \r\n--\t\t\t(\r\n--\t\t\tSELECT  \r\n--\tCOALESCE(\r\n--\t\t(SELECT \r\n\t\t\t\t\r\n--\t\t CONCAT (\u0027 \u0027,CL0.Name,\u0027-\u0027,CL2.U_MW_TIPO,\u0027-\u0027,CL2.U_MW_CLASSE,\u0027- LT:\u0027,CL1.U_MW_LOTE,\u0027- T:\u0027,CL2.U_MW_TIPO) as class\r\n\t\t\t\t\r\n--\t\t\tFROM\r\n--\t\t\t\tINV1 NFL\r\n--\t\t\t\tINNER JOIN IBT1 LL ON  NFL.DocEntry = LL.BaseEntry\r\n--\t\t\t\tAND NFL.LineNum  = LL.BaseLinNum       \r\n--\t\t\t\tAND NFL.ItemCode = LL.ItemCode\r\n--\t\t\t\tAND NFL.WhsCode  = LL.WhsCode\r\n--\t\t\t\tAND LL.BaseType  = NFL.ObjType\r\n--\t\t\t\tINNER JOIN OBTN L ON LL.BatchNum = L.DistNumber AND LL.ItemCode = L.ItemCode\r\n--\t\t\t\tINNER JOIN [@MW_CLASS] CL0 ON L.U_MW_CLASSIFICACAO = CL0.Name\r\n--\t\t\t\tINNER JOIN [@MW_CLAS1] CL1 ON CL0.Code = CL1.Code \r\n--\t\t\t\tINNER JOIN [@MW_CLAS2] CL2 ON CL1.Code = CL2.Code\r\n--\t\t\tWHERE CL1.U_MW_VALIDADE \u003e= GETDATE() AND NFL.DocEntry = @DocEntry1 and NFL.LineNum = @Contador1\r\n--\t\t FOR XML PATH(\u0027\u0027), TYPE).value(\u0027.[1]\u0027, \u0027VARCHAR(MAX)\u0027), \u0027\u0027) AS Classificacao\r\n--FROM (\r\n--SELECT \t\tnfl.ItemCode,\t\t\t\r\n--\t\t CONCAT (CL0.Name,\u0027-\u0027,CL2.U_MW_TIPO,\u0027-\u0027,CL2.U_MW_CLASSE,\u0027- LT:\u0027,CL1.U_MW_LOTE,\u0027- T:\u0027,CL2.U_MW_TIPO) as class\r\n\t\t\t\t\r\n--\t\t\tFROM\r\n--\t\t\t\tINV1 NFL\r\n--\t\t\t\tINNER JOIN IBT1 LL ON  NFL.DocEntry = LL.BaseEntry\r\n--\t\t\t\tAND NFL.LineNum  = LL.BaseLinNum       \r\n--\t\t\t\tAND NFL.ItemCode = LL.ItemCode\r\n--\t\t\t\tAND NFL.WhsCode  = LL.WhsCode\r\n--\t\t\t\tAND LL.BaseType  = NFL.ObjType\r\n--\t\t\t\tINNER JOIN OBTN L ON LL.BatchNum = L.DistNumber AND LL.ItemCode = L.ItemCode\r\n--\t\t\t\tINNER JOIN [@MW_CLASS] CL0 ON L.U_MW_CLASSIFICACAO = CL0.Name\r\n--\t\t\t\tINNER JOIN [@MW_CLAS1] CL1 ON CL0.Code = CL1.Code \r\n--\t\t\t\tINNER JOIN [@MW_CLAS2] CL2 ON CL1.Code = CL2.Code\r\n--\t\t\tWHERE CL1.U_MW_VALIDADE \u003e= GETDATE() AND NFL.DocEntry = @DocEntry1 and NFL.LineNum = @Contador1\r\n--)AS C\r\n--Group by ItemCode\r\n\r\n--\t\t\t)\r\n\r\n--\t\t\tif (@Classificacao is not null AND @Classificacao \u003c\u003e \u0027\u0027)\r\n--\t\t\t\tBEGIN\r\n\t\t\t\t\r\n--\t\t\t\t\tUPDATE INV1\tSET U_SKILL_InfAdItem = @Classificacao WHERE DocEntry = @DocEntry1 AND LineNum =  @Contador1\t\t\t\t\t\r\n\t\t\t\t\t\r\n--\t\t\t\tEND;\r\n\t\t\r\n--\t\t\tSET @Contador1 = @Contador1 + 1\r\n--\t\tEND;\r\n--END--end if\t\t\r\n--END;--END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 02/01/2017\r\n-- Update Date: 07/08/2019\r\n-- Description:\tAtualizar os campos Macro, Micro,Desconto financeiro,Detalhes de entrega e Cidade com Base no cadastro de PN\r\n-- Houve acrescimo do campo U_DescFinBP para ajustar o desconto financeiro no bankplus\r\n-- GLPI ID:\r\n-- GLPI ID Atualiza‡oes: 6708, 6468, 7373\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\tDECLARE @CardCodeFromOrder NVarchar (20)\r\n\tDECLARE @Macro NVARCHAR (255)\r\n\tDECLARE @Micro NVARCHAR (255)\r\n\tDECLARE @Cidade NVARCHAR (255)\r\n\tDECLARE @DescontoFinanceiro Decimal(10,2) SET @DescontoFinanceiro = 0\r\n\tDECLARE @R_EntregaAgendada CHAR (1) SET @R_EntregaAgendada = \u0027N\u0027\r\n\tDECLARE @R_Encarte  CHAR (1) SET @R_Encarte = \u0027N\u0027\r\n\tDECLARE @DetalhesEntrega NVARCHAR (MAX)\r\n\tDECLARE @Paletizada  CHAR (1) SET @Paletizada = \u0027N\u0027\r\n\tDECLARE @Batida  CHAR (1) SET @Batida = \u0027N\u0027\r\n\tDECLARE @U_RAL_Reentrega  CHAR (1) SET @U_RAL_Reentrega = \u0027N\u0027\r\n\tDECLARE @U_RAL_Retira  CHAR (1) SET @U_RAL_Retira = \u0027N\u0027\r\n\tDECLARE @CaracteristicasEntregaPN NVARCHAR(MAX)\r\n\r\n\tSET @CardCodeFromOrder  = (SELECT CardCode FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tSET @Macro = (SELECT U_MW_MACRO FROM OCRD WHERE CardCode = @CardCodeFromOrder)\r\n\tSET @Micro = (SELECT U_MW_MICRO FROM OCRD WHERE CardCode = @CardCodeFromOrder)\r\n\tSET @Cidade = (SELECT U_MW_CIDADE FROM OCRD WHERE CardCode = @CardCodeFromOrder)\r\n\tSET @DescontoFinanceiro = (SELECT U_MW_DESFIN FROM OCRD WHERE CardCode = @CardCodeFromOrder)\r\n\tSET @Paletizada = (SELECT QryGroup22 FROM OCRD WHERE CardCode = @CardCodeFromOrder)\r\n \tSET @Batida  = (SELECT QryGroup23 FROM OCRD WHERE CardCode = @CardCodeFromOrder)\r\n\r\n\tSET @R_Encarte = (SELECT U_R_Encarte FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tSET @R_EntregaAgendada = (SELECT U_R_EntregaAgendada FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tSET @U_RAL_Reentrega = (SELECT U_RAL_Reentrega FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\t\r\n\tSET @U_RAL_Retira = (SELECT U_RAL_Retira FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tSET @CaracteristicasEntregaPN = (select [dbo].[NomedasCaracteristicasPN](@CardCodeFromOrder) )\r\n\r\n\tIF(@R_EntregaAgendada = \u0027Y\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @DetalhesEntrega = \u0027AGENDADA \u0027\r\n\t\tEND\r\n\tIF(@R_Encarte = \u0027Y\u0027)\r\n\t\tBEGIN\t\t\r\n\t\t\tSET @DetalhesEntrega = concat(@DetalhesEntrega,\u0027ENCARTE \u0027)\r\n\t\tEND\r\n\tIF(@U_RAL_Reentrega = \u0027Y\u0027)\r\n\t\tBEGIN\t\t\r\n\t\t\tSET @DetalhesEntrega = concat(@DetalhesEntrega,\u0027REENTREGA \u0027)\r\n\t\tEND\r\n\tIF(@U_RAL_Retira = \u0027Y\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @DetalhesEntrega = concat(@DetalhesEntrega,\u0027RETIRA \u0027)\r\n\t\tEND\r\n\tIF(@Batida = \u0027Y\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @DetalhesEntrega = concat(@DetalhesEntrega,\u0027CARGA BATIDA \u0027)\r\n\t\tEND\r\n\tIF(@Paletizada = \u0027Y\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @DetalhesEntrega = concat(@DetalhesEntrega,\u0027CARGA PALETIZADA \u0027)\r\n\t\tEND\r\n\tIF(@CaracteristicasEntregaPN is NOT null AND @CaracteristicasEntregaPN \u003c\u003e \u0027\u0027)\r\n\tBEGIN\r\n\t\tSET @DetalhesEntrega = concat(@DetalhesEntrega,@CaracteristicasEntregaPN)\r\n\tEND\t\r\n\r\n\t\tBEGIN\t\t\t\r\n\t\t\tUPDATE ORDR \r\n\t\t\t\tSET  U_MW_MICRO = @Micro, U_MW_MACRO = @Macro, U_MW_CIDADE = @Cidade,\r\n\t\t\t\t U_DescFinBP  = @DescontoFinanceiro,U_MW_DESCONTO  = @DescontoFinanceiro, U_RA_DetalhesEntrega = @DetalhesEntrega  WHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\tEND \r\n\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 22/07/2019\r\n-- Update Date: \r\n-- Description: Bloquear Fun‡ao Copiar para Pedido a partir da cota‡ao\r\n-- Documento: Pedido de Vendas\r\n-- GLPI ID: 7321\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @UserSign27321 Nvarchar(10) = (SELECT  UserSign2 FROM ORDR where docentry = @list_of_cols_val_tab_del)\r\n\r\nDECLARE @Dep7321 int SET @Dep7321 = (SELECT Department FROM OUSR WHERE USERID = @UserSign27321)\r\n\r\nIF EXISTS (SELECT BaseEntry FROM RDR1 WHERE DocEntry = @list_of_cols_val_tab_del AND BaseEntry IS NOT NULL)\r\nBEGIN\r\n\tIF(@Dep7321 = 1)--Departamento de vendas\r\n\tBEGIN\r\n\t\tSET @error = -7321\r\n\t\tSET @error_message = \u0027A a‡ao \"Copiar para Pedido\" nao ‚ permitida!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\t\t\t\t\r\n\t\t\t\r\nEND--END IF EXISTS\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n------------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 27/06/2019\r\n-- Update date: 07/10/2020\r\n-- Description:\tGravar o Pre‡o de Lista do PN ao adicionar o pedido\r\n-- GLPI ID:7208\r\n-- GLPI ID Atualiza‡oes:9608 - Aplicar desconto no Pre‡o de Lista\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002714\u0027 = Dev NF de saida\r\n\r\nBEGIN\r\n\t\r\nDECLARE @PrecoDeListaDev Numeric(10,2) = 0\r\nDECLARE @CodigoItemDev NVARCHAR(10)\r\nDECLARE @TotalLinhasDev Numeric = (SELECT Count(LineNum) FROM RIN1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @ContDev Numeric = 0\r\nDECLARE @PrecoExistenteDev Numeric = 0\r\nDECLARE @DescontoDev NUMERIC = 0\r\n\r\nWHILE(@ContDev \u003c @TotalLinhasDev + 1)\r\n\tBEGIN\r\n\t\tIF EXISTS( SELECT *FROM RIN1 WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @ContDev)\r\n\t\tBEGIN\r\n\t\t\tSELECT \r\n\t\t\t@CodigoItemDev = T1.ItemCode,\r\n\t\t\t@PrecoDeListaDev  = T5.price, \r\n\t\t\t@PrecoExistenteDev = (case when T1.U_PrecoDeLista is null then 0 else T1.U_PrecoDeLista end),\r\n\t\t\t@DescontoDev = T1.DiscPrcnt\r\n\t\t\tFROM ORIN T0\r\n\t\t\tINNER JOIN RIN1 T1 ON T0.DocEntry = T1.DocEntry \r\n\t\t\tINNER JOIN OCRD T3 ON T0.CardCode = T3.CardCode\r\n\t\t\tINNER JOIN OPLN T4 ON T3.ListNum = T4.ListNum\r\n\t\t\tINNER JOIN ITM1 T5 ON T4.ListNum = T5.PriceList AND T1.ItemCode = T5.ItemCode\r\n\t\t\tWHERE  T0.DocEntry = @list_of_cols_val_tab_del AND T1.LineNum = @ContDev\r\n\r\n\t\t\tIF ( (@CodigoItemDev  is not null AND @CodigoItemDev \u003c\u003e \u0027\u0027)\r\n\t\t\t\t\t AND (@PrecoDeListaDev is not null AND @PrecoDeListaDev \u003e 0)\r\n\t\t\t\t\t\tAND (@PrecoExistenteDev is null OR @PrecoExistenteDev = 0))\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE RIN1\tSET U_PrecoDeLista = @PrecoDeListaDev - (@PrecoDeListaDev * @DescontoDev / 100)\r\n\t\t\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del AND ItemCode = @CodigoItemDev AND LineNum =  @ContDev\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\r\n\t\tEND \r\n\t\tSET @ContDev = @ContDev + 1\r\n\tEND;\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n-----------------------------------------------------------------------------------------------------------------------------\r\n------ Author: Henrique Truyts \r\n------ Create date: 17/06/2019\r\n------ Documentos:  Cota‡ao de vendas\r\n------ GLPI ID: 6734\r\n------ GLPI ID Atualiza‡oes: \r\n-- Description:\tBloquear cota‡ao de vendas sem  C¢digo de imposto\r\n---------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Cota‡ao\r\n\r\nBEGIN\t\t\r\n\t--C¢digo de imposto\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tOQUT O\r\n\t\t\t    INNER JOIN QUT1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @list_of_cols_val_tab_del AND OL.TaxCode IS NULL)\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Cota‡ao de Venda - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 17/06/2019\r\n-- Update Date: \r\n-- Description: Trava para evitar altera‡ao de DocEntry da OC\r\n-- Documento: Ordem de Carga\r\n-- GLPI ID:7147\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027BIM_ORDEMCARGA\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00272\u0027 = Ordem de Carga\r\nBEGIN\t\r\n\tIF EXISTS (\r\n\tSELECT DocNum FROM [@BIM_ORDEMCARGA]  WHERE DocEntry = @list_of_cols_val_tab_del AND DocNum\u003c\u003eDocEntry\r\n\t)\r\n\tBEGIN\r\n\t\tSET @error = -7147\r\n\t\tSET @error_message =  \u0027N£mero da Ordem de Carga nao pode ser modificado.Verifique!\u0027+ \u0027 - \u0027 +\r\n\t\tConvert(nvarchar,@list_of_cols_val_tab_del)\r\n\t\tSELECT @error, @error_message\r\n\tEND\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 11/06/2019\r\n-- Update Date: \r\n-- Description: Vendedor s¢ pode cadastrar clientes pelo APP caso o cliente seja Lead\r\n-- Documento: Parceiro de Negocios\r\n-- GLPI ID:6942\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u00272\u0027) and (@transaction_type in (\u0027A\u0027))--\u00272\u0027 = Parceiro de NEgocios\r\nBEGIN\r\n\r\nDECLARE @UserSign6942 int = (SELECT UserSign FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @CardTypeL char = (SELECT CardType FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @Series80 int = (SELECT Series FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @Dep6942 int SET @Dep6942 = (SELECT Department FROM OUSR WHERE USERID = @UserSign6942)\r\nDECLARE @UserPortal6942 INT\r\nSET @UserPortal6942 = (SELECT T1.Department\r\n\t\t\t\t\t\t\tFROM OUSR T1\r\n\t\t\t\t\t\t\tWHERE T1.USER_CODE IN(SELECT T0.U_AHS_SapUserCode\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tFROM OCRD T0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = @list_of_cols_val_tab_del))\r\n\r\nIF(@UserPortal6942 \u003c\u003e 17) ----EQUIPE DE COMPRAS(SUPRIMENTO)\r\nBEGIN\r\n\tIF(@Dep6942 = 1 AND ( @Series80 \u003c\u003e 80 OR @CardTypeL \u003c\u003e \u0027L\u0027))\t\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6942\r\n\t\t\tSET @error_message = \u0027S¢ ‚ permitido o cadastramento de cliente potencial. Verifique!.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 10/06/2019\r\n-- Update Date: \r\n-- Description:\tTrava para Clientes Bloqueados (caracteristica 24) Esbo‡o\r\n-- Documents: Pedido de Vendas e Cota‡ao de vendas\r\n-- GLPI ID: \r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas (DepCB = departamentos Clientes Bloqueados\r\nBEGIN\r\n\r\nDECLARE @DepCBEsb int SET @DepCBEsb = (SELECT u.Department From ODRF O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.ObjType = 17 AND O.DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @ObjTypeEsb int = 0\r\nSET @ObjTypeEsb = (SELECT Distinct ObjType FROM ODRF WHERE ObjType = 17 AND DocEntry = @list_of_cols_val_tab_del )\r\n\r\n IF(@DepCBEsb = 1 AND @ObjTypeEsb = 17)\t\r\n\tBEGIN\r\n\t\tIF  EXISTS (\r\n\t\tSELECT\r\n\t\tt0.QryGroup25,T0.CardCode\r\n\t\tFROM OCRD T0\r\n\t\tWHERE T0.QryGroup25 = \u0027N\u0027 AND T0.QryGroup24 = \u0027Y\u0027 \r\n\t\tAND T0.CardCode  = ( SELECT Distinct CardCode FROM ODRF WHERE ObjType = 17 AND DocEntry =  @list_of_cols_val_tab_del )\r\n\t\t\r\n\t\t) BEGIN\t\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Cliente Bloqueado, nao ‚ poss¡vel adicionar o Pedido. Entrar em contato com o setor de Cr‚dito e Cobran‡a ou Adm. de Vendas!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t  END;\r\n\t\r\n\tEND;\r\nEND;--END PRINCIPAL\r\n-------------------------COTA€AO DE VENDAS--------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002723\u0027 = Cota‡ao de Vendas (DepCB = departamentos Clientes Bloqueados\r\nBEGIN\r\n\r\nDECLARE @DepCBQEsb int SET @DepCBQEsb = (SELECT u.Department From ODRF O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.ObjType = 23 AND O.DocNum = @list_of_cols_val_tab_del)\r\nDECLARE @ObjTypeEsbQ int = 0\r\nSET @ObjTypeEsbQ = (SELECT Distinct ObjType FROM ODRF WHERE ObjType = 23 AND DocEntry = @list_of_cols_val_tab_del )\r\n\r\n IF(@DepCBQEsb = 1 AND @ObjTypeEsbQ = 23)\t\r\n\tBEGIN\r\n\t\tIF  EXISTS (\r\n\t\tSELECT\r\n\t\tt0.QryGroup25,T0.CardCode\r\n\t\tFROM OCRD T0\r\n\t\tWHERE T0.QryGroup25 = \u0027N\u0027 AND T0.QryGroup24 = \u0027Y\u0027 \r\n\t\tAND T0.CardCode  = ( SELECT Distinct CardCode FROM ODRF WHERE ObjType = 23 AND DocEntry =  @list_of_cols_val_tab_del )\r\n\t\t\r\n\t\t) BEGIN\t\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Cliente Bloqueado, nao ‚ poss¡vel adicionar a Cota‡ao. Entrar em contato com o setor de Cr‚dito e Cobran‡a ou Adm. de Vendas!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t  END;\r\n\t\r\n\tEND;\r\nEND;--END PRINCIPAL\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n------------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 04/04/2019\r\n-- Update date: 07/10/2020\r\n-- Description:\tGravar o Pre‡o de Lista do PN ao adicionar a cota‡ao\r\n-- GLPI ID: 6659\r\n-- GLPI ID Atualiza‡oes: 9608 - Aplicar desconto no Pre‡o de Lista\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002723\u0027 = Cota‡ao de Vendas\r\n\r\nBEGIN\r\n\t\r\nDECLARE @PrecoDeListaQ Numeric(10,2) = 0\r\nDECLARE @CodigoItem6659Q NVARCHAR(10)\r\nDECLARE @TotalLinhas6659Q Numeric = (SELECT Count(LineNum) FROM QUT1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Cont6659Q Numeric = 0\r\nDECLARE @PrecoExistenteQ Numeric = 0\r\nDECLARE @DescontoQ NUMERIC = 0\r\n\r\nWHILE(@Cont6659Q \u003c @TotalLinhas6659Q + 1)\r\n\tBEGIN\r\n\t\tIF EXISTS( SELECT *FROM QUT1 WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont6659Q)\r\n\t\tBEGIN\r\n\t\t\tSELECT \r\n\t\t\t@CodigoItem6659Q = T1.ItemCode,\r\n\t\t\t@PrecoDeListaQ  = T5.price, \r\n\t\t\t@PrecoExistenteQ = (case when T1.U_PrecoDeLista is null then 0 else T1.U_PrecoDeLista end),\r\n\t\t\t@DescontoQ = T1.DiscPrcnt\r\n\t\t\tFROM OQUT T0\r\n\t\t\tINNER JOIN QUT1 T1 ON T0.DocEntry = T1.DocEntry \r\n\t\t\tINNER JOIN OCRD T3 ON T0.CardCode = T3.CardCode\r\n\t\t\tINNER JOIN OPLN T4 ON T3.ListNum = T4.ListNum\r\n\t\t\tINNER JOIN ITM1 T5 ON T4.ListNum = T5.PriceList AND T1.ItemCode = T5.ItemCode\r\n\t\t\tWHERE  T0.DocEntry = @list_of_cols_val_tab_del AND T1.LineNum = @Cont6659Q\r\n\r\n\t\t\tIF ( (@CodigoItem6659Q  is not null AND @CodigoItem6659Q \u003c\u003e \u0027\u0027)\r\n\t\t\t\t\t AND (@PrecoDeListaQ is not null AND @PrecoDeListaQ \u003e 0)\r\n\t\t\t\t\t\tAND (@PrecoExistenteQ is null OR @PrecoExistenteQ = 0))\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE QUT1\tSET U_PrecoDeLista = @PrecoDeListaQ - (@PrecoDeListaQ * @DescontoQ / 100)\r\n\t\t\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del AND ItemCode = @CodigoItem6659Q AND LineNum =  @Cont6659Q\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\r\n\t\tEND \r\n\t\tSET @Cont6659Q = @Cont6659Q + 1\r\n\tEND;\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 03/07/2018\r\n-- Update Date: 07/05/2019\r\n-- Description: Bloquear atualiza‡ao e cancelamento Se todas as linhas do PV estiverem com vinculo em OC (campo N£mero OC preenchido)\r\n-- Documento: Pedido de Vendas\r\n-- GLPI ID:5046\r\n-- GLPI IG Atualiza‡ao:41118,6908\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027U\u0027,\u0027C\u0027,\u0027L\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\nDECLARE @TotaldeLinhasLog int = (SELECT COUNT(*)FROM (SELECT  LineNum from ADO1  WHERE ObjType = 17 AND DocEntry = @list_of_cols_val_tab_del GROUP BY LineNum)A )\r\nDECLARE @TotalLinhascomOC int = (SELECT COUNT(*) FROM RDR1 WHERE DocEntry=@list_of_cols_val_tab_del AND (U_OC_num IS NOT NULL AND U_OC_num \u003c\u003e \u0027\u0027))\r\n\r\nDECLARE @Status5046 Nvarchar (10) = ( SELECT DocStatus FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\nDECLARE @UserSign2 Nvarchar(10) = (SELECT  UserSign2 FROM ORDR where docentry = @list_of_cols_val_tab_del)\r\n\r\nDECLARE @Dep5046 int SET @Dep5046 = (SELECT Department FROM OUSR WHERE USERID = @UserSign2)\r\n\r\nIF( @Status5046 IN(\u0027O\u0027,\u0027C\u0027))\r\nBEGIN\r\n\tIF(@Dep5046 = 1 OR @Dep5046 = 2)\t\r\n\tBEGIN\r\n\t\tIF(@TotaldeLinhasLog = @TotalLinhascomOC)\t\t\t\r\n\t\tBEGIN\t\r\n\t\t\tSET @error = -5046\r\n\t\t\tSET @error_message = \u0027Nao ‚ poss¡vel modifica‡ao do PV pois o mesmo tem vinculo na OC do processo log¡stico.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\t\r\nEND\r\n\r\nEND \r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n-----------------------------------------------------------------------------------------------------------------------------\r\n------ Author: Henrique Truyts \r\n------ Create date: 25/02/2019\r\n------ Documentos:Saida de Mercadoria\r\n------ GLPI ID: 6313\r\n------ GLPI ID Atualiza‡oes: \r\n---------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002760\u0027) and (@transaction_type in (\u0027A\u0027))--\u002760\u0027 = Saida de Mercadoria (SM)\r\nBEGIN\r\n-------------------------------------------------------------------------------------------------------------------------\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a saida - Padrao /Especial / Desmontagem\r\n--Peso do Item do cabe‡alho da OP deve bater com a somatoria da quantidade base das linhas da op (IGNORAR EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @PesoItemOpSM Numeric(10,3) SET @PesoItemOpSM = (\r\n\t\t\t\t\t\tSELECT T1.SWeight1 FROM OWOR T0 \r\n\t\t\t\t\t\tINNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode\r\n\t\t\t\t\t\tWHERE T0.DocEntry = (\r\n\t\t\t\t\t\t\t\tSELECT DISTINCT BaseEntry FROM IGE1 WHERE DocEntry = @list_of_cols_val_tab_del\t)\t)\r\n\r\nDECLARE @QtdeBaseOpSM Numeric(10,3) SET @QtdeBaseOpSM = (\r\n\t\t\t\t\t\t\t\tSELECT SUM(T1.SWeight1*T0.BaseQty) FROM WOR1 T0 \r\n\t\t\t\t\t\t\t\tINNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode\r\n\t\t\t\t\t\t\t\tWHERE SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND T0.DocEntry =\t(\r\n\t\t\t\t\t\t\t\t\tSELECT DISTINCT BaseEntry FROM IGE1 WHERE DocEntry = @list_of_cols_val_tab_del\t)\t)\r\n\r\nDECLARE @TotalPesoMinimoSM Numeric(10,3) = @PesoItemOpSM - ((@PesoItemOpSM*1)/100)\r\n\r\nDECLARE @TotalPesoMaximoSM Numeric(10,3) = @PesoItemOpSM + ((@PesoItemOpSM*1)/100)\r\n\r\nIF(@QtdeBaseOpSM \u003e @TotalPesoMaximoSM OR @QtdeBaseOpSM \u003c @TotalPesoMinimoSM)\r\nBEGIN\r\n\tSET @error = -6313\t\r\n\tSET @error_message = \u0027Nao foi possivel salvar a OP, quantidade base menor/Maior em 1% em rela‡ao ao peso do produto principal na Ordem de Produ‡ao\u0027\r\n\tSELECT @error, @error_message\r\nEND\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a saida - Padrao /Especial \r\n--A somatoria das quantidades das linhas das saidas existentes nao pode superar a quantidade planejada das linhas da OP (IGNORAR EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @TypeOpSM Char (1)= (SELECT Type FROM OWOR WHERE DocEntry = \r\n\t\t\t\t\t\t\t(SELECT DISTINCT BaseEntry FROM IGE1 WHERE DocEntry = @list_of_cols_val_tab_del\t))\r\n\r\n\t\t\t\t\t\t\t\r\n--IF ( @TypeOpSM \u003c\u003e \u0027D\u0027)\r\n--\tBEGIN\r\n--\tIF EXISTS(\r\n--\t\tSELECT *FROM (\r\n--\t\tSELECT T0.ItemCode \u0027ItemCodeSaida\u0027,SUM(T0.Quantity)\u0027QtdSaida\u0027,T1.ItemCode \u0027ItemCodeLinhaOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n--\t\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n--\t\tFROM IGE1 T0\r\n--\t\tINNER JOIN WOR1 T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n--\t\tWHERE T1.DocEntry = (SELECT Distinct BaseEntry FROM IGE1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\n--\t\tAND SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND SUBSTRING( T1.ItemCode,1,2) \u003c\u003e \u0027EM\u0027\r\n--\t\tGROUP BY T0.ItemCode,T1.ItemCode,T1.PlannedQty\r\n--\t\t)A\r\n--\t\tWHERE QtdSaida \u003e QtdPlanejadaMaxima\r\n--\t\t)\r\n--\t\tBEGIN\r\n--\t\t\tSET @error = -6313\r\n--\t\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das sa¡das ‚ maior em 1% que a quantidade planejada indicada nas linhas da OP\u0027\r\n--\t\t\tSELECT @error, @error_message\r\n--\t\tEND\r\n--\tEND\r\n---------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a saida - Desmontagem\r\n--A somatoria das quantidades das linhas das saidas existentes nao pode superar a quantidade planejada do cabe‡alho da OP \r\n-------------------------------------------------------------------------------------------------------------------------\r\n\tIF ( @TypeOpSM = \u0027D\u0027)\r\n\tBEGIN\r\n\t\tIF EXISTS(\r\n\t\tSELECT *FROM (\r\n\t\tSELECT SUM(T0.Quantity) \u0027QtdEntrada\u0027,T1.ItemCode\u0027ItemCodeOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n\t\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n\t\tFROM IGE1 T0\r\n\t\tINNER JOIN OWOR T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n\t\t\tWHERE T1.DocEntry = (SELECT Distinct  BaseEntry FROM IGE1 WHERE DocEntry = @list_of_cols_val_tab_del) \r\n\t\tGROUP BY T1.ItemCode,T1.PlannedQty\t)\tA\r\n\t\tWHERE QtdEntrada \u003e QtdPlanejadaMaxima\r\n\t\t)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6313\r\n\t\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das sa¡das ‚ maior em 1% que a quantidade planejada na OP\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\n\tEND\r\n\r\nEND\r\n---------------------------------------------------------------------------------------------------------------------------\r\n----END\r\n---------------------------------------------------------------------------------------------------------------------------\r\n---------------------------------------------------------------------------------------------------------------------------\r\n------ Author: Henrique Truyts \r\n------ Create date: 25/02/2019\r\n------ Documentos:Entrada de Produto acabado\r\n------ GLPI ID: 6313\r\n------ GLPI ID Atualiza‡oes:\r\n---------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002759\u0027) and (@transaction_type in (\u0027A\u0027))--\u002759\u0027 = Entrada de Produto acabado (EPA)\r\nBEGIN\r\n-------------------------------------------------------------------------------------------------------------------------\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a entrada - Padrao /Especial / Desmontagem\r\n--Peso do Item do cabe‡alho da OP deve bater com a somatoria da quantidade base das linhas da op (IGNORAR EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @PesoItemOpEPA Numeric(10,3) SET @PesoItemOpEPA = (\r\n\t\t\t\t\t\tSELECT T1.SWeight1 FROM OWOR T0 \r\n\t\t\t\t\t\tINNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode\r\n\t\t\t\t\t\tWHERE T0.DocEntry = (\r\n\t\t\t\t\t\t\t\tSELECT DISTINCT BaseEntry FROM IGN1 WHERE DocEntry = @list_of_cols_val_tab_del\t)\t)\r\n\r\nDECLARE @QtdeBaseOpEpa Numeric(10,3) SET @QtdeBaseOpEpa = (\r\n\t\t\t\t\t\t\t\tSELECT SUM(T1.SWeight1*T0.BaseQty) FROM WOR1 T0 \r\n\t\t\t\t\t\t\t\tINNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode\r\n\t\t\t\t\t\t\t\tWHERE SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND T0.DocEntry =\t(\r\n\t\t\t\t\t\t\t\t\tSELECT DISTINCT BaseEntry FROM IGN1 WHERE DocEntry = @list_of_cols_val_tab_del\t)\t)\r\n\r\nDECLARE @TotalPesoMinimo Numeric(10,3) = @PesoItemOpEPA - ((@PesoItemOpEPA*1)/100)\r\n\r\nDECLARE @TotalPesoMaximo Numeric(10,3) = @PesoItemOpEPA + ((@PesoItemOpEPA*1)/100)\r\n\r\nIF(@QtdeBaseOpEpa \u003e @TotalPesoMaximo OR @QtdeBaseOpEpa \u003c @TotalPesoMinimo)\r\nBEGIN\r\n\tSET @error = -6313\t\r\n\tSET @error_message = \u0027Nao foi possivel salvar a OP, quantidade base menor/Maior em 1% em rela‡ao ao peso do produto principal na Ordem de Produ‡ao\u0027\r\n\tSELECT @error, @error_message\r\nEND\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a entrada - Padrao /Especial \r\n--A somatoria das quantidades das linhas das entradas existentes nao pode superar a quantidade planejada do cabe‡alho da OP\r\n-------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @TypeOpEPA Char (1)= (SELECT Type FROM OWOR WHERE DocEntry = \r\n\t\t\t\t\t\t\t(SELECT DISTINCT BaseEntry FROM IGN1 WHERE DocEntry = @list_of_cols_val_tab_del\t))\r\n\r\n\t\t\t\t\t\t\t\r\n--IF ( @TypeOpEPA \u003c\u003e \u0027D\u0027)\r\n--\tBEGIN\r\n--\t\tIF EXISTS(\r\n--\t\tSELECT *FROM (\r\n--\t\tSELECT SUM(T0.Quantity) \u0027QtdEntrada\u0027,T1.ItemCode\u0027ItemCodeOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n--\t\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n--\t\tFROM IGN1 T0\r\n--\t\tINNER JOIN OWOR T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n--\t\t\tWHERE T1.DocEntry = (SELECT Distinct BaseEntry FROM IGN1 WHERE DocEntry = @list_of_cols_val_tab_del) \r\n--\t\tGROUP BY T1.ItemCode,T1.PlannedQty\t)\tA\r\n--\t\tWHERE QtdEntrada \u003e QtdPlanejadaMaxima\r\n--\t\t)\r\n--\t\tBEGIN\r\n--\t\t\tSET @error = -6313\r\n--\t\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das entradas ‚ maior em 1% que a quantidade planejada na OP\u0027\r\n--\t\t\tSELECT @error, @error_message\r\n--\t\tEND\r\n\t\r\n--\tEND\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a entrada - Desmontagem\r\n--A somatoria das quantidades das linhas das entradas existentes nao pode superar a quantidade planejada das linhas da OP (IGNORAR EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\n\tIF ( @TypeOpEPA = \u0027D\u0027)\r\n\tBEGIN\r\n\tIF  EXISTS(\r\n\t\tSELECT *FROM (\r\n\t\tSELECT T0.ItemCode \u0027ItemCodeSaida\u0027,SUM(T0.Quantity)\u0027QtdSaida\u0027,T1.ItemCode \u0027ItemCodeLinhaOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n\t\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n\t\tFROM IGN1 T0\r\n\t\tINNER JOIN WOR1 T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n\t\tWHERE T1.DocEntry = (SELECT Distinct  BaseEntry FROM IGN1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\tAND SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND SUBSTRING( T1.ItemCode,1,2) \u003c\u003e \u0027EM\u0027\r\n\t\tGROUP BY T0.ItemCode,T1.ItemCode,T1.PlannedQty\r\n\t\t)A\r\n\t\tWHERE QtdSaida \u003e QtdPlanejadaMaxima\r\n\t\t)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6313\r\n\t\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das Entradas ‚ maior em 1% que a quantidade planejada indicada nas linhas da OP\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\n\t\r\n\r\n\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a entrada e se a op tiver itens negativos\r\n--A somatoria das quantidades das linhas das entradas existentes nao pode superar a quantidade planejada das linhas da OP (IGNORAR EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--IF EXISTS(\r\n--\tSELECT *FROM (\r\n--\t\tSELECT T0.ItemCode \u0027ItemCodeSaida\u0027,SUM(T0.Quantity)\u0027QtdSaida\u0027,T1.ItemCode \u0027ItemCodeLinhaOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n--\t\t(T1.PlannedQty - ((T1.PlannedQty*1)/100))*-1\u0027QtdPlanejadaMinima\u0027,(T1.PlannedQty + ((T1.PlannedQty*1)/100))*-1\u0027QtdPlanejadaMaxima\u0027\r\n--\t\tFROM IGN1 T0\r\n--\t\tINNER JOIN WOR1 T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n--\t\tWHERE T1.DocEntry = (SELECT Distinct  BaseEntry FROM IGN1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\n--\t\tAND SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND SUBSTRING( T1.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND\r\n--\t\tT1.PlannedQty \u003c 0\r\n--\t\tGROUP BY T0.ItemCode,T1.ItemCode,T1.PlannedQty\r\n--\t\t)A\r\n--\t\tWHERE QtdSaida \u003e QtdPlanejadaMaxima\r\n\r\n--\t)\r\n--\tBEGIN\r\n--\t\tSET @error = -6313\r\n--\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das Entradas ‚ maior em 1% que a quantidade planejada indicada nas linhas da OP\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\nEnd\r\n---------------------------------------------------------------------------------------------------------------------------\r\n----END\r\n---------------------------------------------------------------------------------------------------------------------------\r\n---------------------------------------------------------------------------------------------------------------------------\r\n------ Author: Henrique Truyts \r\n------ Create date: 25/02/2019\r\n------ Documentos:Ordem de Produ‡ao Padrao, Especial e Desmontagem\r\n------ GLPI ID: 6313\r\n------ GLPI ID Atualiza‡oes:\r\n---------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027202\u0027) and (@transaction_type in (\u0027U\u0027))--\u0027202\u0027 = Ordem de Produ‡ao\r\nBEGIN\r\n------------------------------------------------VARIAVEIS GERAIS---------------------------------------------------------\r\nDECLARE @StatusOP NVARCHAR SET @StatusOP = (\r\n\t\t\t\t\t\t\tSELECT Status FROM OWOR WHERE DocEntry = @list_of_cols_val_tab_del\t)\r\n\r\nDECLARE @TypeOP Char (1)= (\r\n\t\t\t\t\tSELECT Type FROM OWOR WHERE DocEntry = @list_of_cols_val_tab_del\t)\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--FECHAMENTO DA OP (ESPECIAL E PADRAO) - SAIDA\r\n--Verificar a somatoria das saidas (Linhas campo quantidade) que deve ser igual a quantidade planejada na linha da op (IGNORAR O EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\n\t--IF (@StatusOP = \u0027L\u0027 AND @TypeOP \u003c\u003e \u0027D\u0027)\r\n\t--BEGIN\r\n\t--\tIF NOT EXISTS(\r\n\t--\tSELECT *FROM (\r\n\t--\tSELECT T0.ItemCode \u0027ItemCodeSaida\u0027,SUM(T0.Quantity)\u0027QtdSaida\u0027,T1.ItemCode \u0027ItemCodeLinhaOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n\t--\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n\t--\tFROM IGE1 T0\r\n\t--\tINNER JOIN WOR1 T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n\t--\tWHERE T1.DocEntry = @list_of_cols_val_tab_del \r\n\t--\tAND SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND SUBSTRING( T1.ItemCode,1,2) \u003c\u003e \u0027EM\u0027\r\n\t--\tGROUP BY T0.ItemCode,T1.ItemCode,T1.PlannedQty\r\n\t--\t)A\r\n\t--\tWHERE QtdSaida \u003e= QtdPlanejadaMinima AND QtdSaida \u003c=QtdPlanejadaMaxima\r\n\t--\t)\r\n\t--\tBEGIN\r\n\t--\t\tSET @error = -6313\r\n\t--\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das sa¡das ‚ maior/menor em 1% que a quantidade planejada indicada nas linhas da OP\u0027\r\n\t--\t\tSELECT @error, @error_message\r\n\t--\tEND\r\n\t--END\r\n\t\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--FECHAMENTO DA OP  (ESPECIAL E PADRAO) - ENTRADA\r\n--Verificar a somatoria das entradas (Linhas campo quantidade) que deve ser igual a quantidade planejada no cabe‡alho da op\r\n-------------------------------------------------------------------------------------------------------------------------\r\n\t--IF (@StatusOP = \u0027L\u0027 AND @TypeOP \u003c\u003e \u0027D\u0027)\r\n\t--BEGIN\r\n\t--\tIF NOT EXISTS(\r\n\t--\tSELECT *FROM (\r\n\t--\tSELECT SUM(T0.Quantity) \u0027QtdEntrada\u0027,T1.ItemCode\u0027ItemCodeOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n\t--\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n\t--\tFROM IGN1 T0\r\n\t--\tINNER JOIN OWOR T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n\t--\tWHERE T1.DocEntry = @list_of_cols_val_tab_del\r\n\t--\tGROUP BY T1.ItemCode,T1.PlannedQty\t)\tA\r\n\t--\tWHERE QtdEntrada \u003e= QtdPlanejadaMinima AND QtdEntrada \u003c=QtdPlanejadaMaxima\r\n\t--\t)\r\n\t--\tBEGIN\r\n\t--\t\tSET @error = -6313\r\n\t--\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das entradas ‚ maior/menor em 1% que a quantidade planejada na OP\u0027\r\n\t--\t\tSELECT @error, @error_message\r\n\t--\tEND\r\n\t\r\n\t--END\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--FECHAMENTO DA OP (Desmontagem) - SAIDA\r\n--Verificar a somatoria das saidas(Linhas campo quantidade) que deve ser igual a quantidade planejada no cabe‡alho da op\r\n-------------------------------------------------------------------------------------------------------------------------\r\n\tIF (@StatusOP = \u0027L\u0027 AND @TypeOP = \u0027D\u0027)\r\n\tBEGIN\r\n\tIF NOT EXISTS(\r\n\t\tSELECT *FROM (\r\n\t\tSELECT SUM(T0.Quantity) \u0027QtdEntrada\u0027,T1.ItemCode\u0027ItemCodeOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n\t\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n\t\tFROM IGE1 T0\r\n\t\tINNER JOIN OWOR T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n\t\tWHERE T1.DocEntry = @list_of_cols_val_tab_del\r\n\t\tGROUP BY T1.ItemCode,T1.PlannedQty\t)\tA\r\n\t\tWHERE QtdEntrada \u003e= QtdPlanejadaMinima AND QtdEntrada \u003c=QtdPlanejadaMaxima\r\n\t\t)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6313\r\n\t\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das Saidas ‚ maior/menor em 1% que a quantidade planejada na OP\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--FECHAMENTO DA OP (Desmontagem) - Entrada\r\n--Verificar a somatoria das entradas (Linhas campo quantidade) que deve ser igual a quantidade planejada na linha da op (IGNORAR O EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--\tIF (@StatusOP = \u0027L\u0027 AND @TypeOP = \u0027D\u0027)\r\n--\tBEGIN\r\n--\tIF NOT EXISTS(\r\n--\t\tSELECT *FROM (\r\n--\t\tSELECT T0.ItemCode \u0027ItemCodeSaida\u0027,SUM(T0.Quantity)\u0027QtdSaida\u0027,T1.ItemCode \u0027ItemCodeLinhaOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n--\t\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n--\t\tFROM IGN1 T0\r\n--\t\tINNER JOIN WOR1 T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n--\t\tWHERE T1.DocEntry = @list_of_cols_val_tab_del \r\n--\t\tAND SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND SUBSTRING( T1.ItemCode,1,2) \u003c\u003e \u0027EM\u0027\r\n--\t\tGROUP BY T0.ItemCode,T1.ItemCode,T1.PlannedQty\r\n--\t\t)A\r\n--\t\tWHERE QtdSaida \u003e= QtdPlanejadaMinima AND QtdSaida \u003c= QtdPlanejadaMaxima\r\n--\t\t)\r\n--\t\tBEGIN\r\n--\t\t\tSET @error = -6313\r\n--\t\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das Entradas ‚ maior/menor em 1% que a quantidade planejada indicada nas linhas da OP\u0027\r\n--\t\t\tSELECT @error, @error_message\r\n--\t\tEND\r\n--\tEND\r\nEND\r\n---------------------------------------------------------------------------------------------------------------------------\r\n----END\r\n---------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 26/02/2017\r\n-- Update Date: 22/02/2019\r\n-- Description: Trava NF ENTRADA e Solicita‡ao de compra - Aquisi‡oes para Projeto Ativo Fixo\r\n-- Documentos: NF ENTRADA e Solicita‡ao de compra\r\n-- GLPI ID : 4572\r\n---- GLPI ID Atualiza‡oes:6527\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------NF ENTRADA--------------------------------------------------------------\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002718\u0027 = NF ENTRADA\r\nBEGIN\r\nDECLARE @Linhas4572E int = (SELECT MAX(LineNum)FROM PCH1  WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Cont4572E int = 0\r\nDECLARE @Deposito4572E Nvarchar (10)\r\nDECLARE @Util4572E int\r\nDECLARE @ProjetoE NVarchar (100) = null\r\nWHILE(@Cont4572E \u003c  @Linhas4572E + 1) -- percorrendo todas as linhas do Pedido\r\n  BEGIN\r\n  \r\n   SET @Deposito4572E = (SELECT WhsCode FROM PCH1 WHERE LineNum = @Cont4572E AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @Util4572E = (SELECT Usage FROM PCH1 WHERE LineNum = @Cont4572E AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @ProjetoE = (SELECT rtrim(ltrim(Project)) FROM PCH1 WHERE LineNum = @Cont4572E AND DocEntry = @list_of_cols_val_tab_del)-- pegando projeto de cada linha\r\n\r\n\t\t\r\n\t\tIF(@ProjetoE IS NOT NULL AND \t@ProjetoE\u003c\u003e\u0027\u0027)\r\n\t\tBEGIN\r\n\r\n\t\t\tIF( @Deposito4572E \u003c\u003e \u002702.98\u0027 AND @Deposito4572E \u003c\u003e \u002702.94\u0027  )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4572\r\n\t\t\t\tSET @error_message = \u0027Obrigatorio dep¢sito 02.98 ou 02.94!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t--32 = Compra de Ativo ST 31- Compra de Ativo 45 - Compra Servi‡o ISS\r\n\t\t\tELSE IF(@Util4572E \u003c\u003e 32 AND @Util4572E \u003c\u003e 31 AND @Util4572E \u003c\u003e 45)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4572\r\n\t\t\t\tSET @error_message = \u0027O campo utiliza‡ao nao pode ser diferente de compra de ativo, compra ativo st ou compra servi‡o iss quando dep¢sito for = 02.98!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t\r\n\t\tEND\r\n\t\t\r\n\tSet @Cont4572E =  @Cont4572E + 1\r\n  END--END while\r\nEND\r\n\r\n--------------------------SOLICITA€AO DE COMPRA--------------------------------------------------------------\r\nIF (@object_type = \u00271470000113\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00271470000113\u0027 = SOLICITA€AO DE COMPRA\r\nBEGIN\r\nDECLARE @Linhas4572S int = (SELECT MAX(LineNum)FROM PRQ1   WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Cont4572S int = 0\r\nDECLARE @Deposito4572S Nvarchar (10)\r\nDECLARE @Util4572S int\r\nDECLARE @ProjetoS NVarchar (100) = null\r\nWHILE(@Cont4572S \u003c  @Linhas4572S + 1) -- percorrendo todas as linhas do Pedido\r\n  BEGIN\r\n  \r\n   SET @Deposito4572S = (SELECT WhsCode FROM PRQ1 WHERE LineNum = @Cont4572S AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @Util4572S = (SELECT Usage FROM PRQ1 WHERE LineNum = @Cont4572S AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @ProjetoS = (SELECT (rtrim(ltrim(Project))) FROM PRQ1 WHERE LineNum = @Cont4572S AND DocEntry = @list_of_cols_val_tab_del)-- pegando projeto de cada linha\r\n\r\n\t\tIF(@ProjetoS IS NOT NULL AND \t@ProjetoS\u003c\u003e\u0027\u0027)\r\n\t\tBEGIN\r\n\r\n\t\t\tIF( @Deposito4572S \u003c\u003e \u002702.98\u0027 AND @Deposito4572S \u003c\u003e \u002702.94\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4572\r\n\t\t\t\tSET @error_message = \u0027Obrigatorio dep¢sito 02.98 ou 02.94!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t--32 = Compra de Ativo ST 31- Compra de Ativo 45 - Compra Servi‡o ISS\r\n\t\t\tELSE IF(@Util4572S \u003c\u003e 32 AND @Util4572S \u003c\u003e 31 AND @Util4572S \u003c\u003e 45)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4572\r\n\t\t\t\tSET @error_message = \u0027O campo utiliza‡ao nao pode ser diferente de compra de ativo, compra ativo st ou compra servi‡o iss quando dep¢sito for = 02.98!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t\r\n\t\tEND\r\n\t\t\r\n\tSet @Cont4572S =  @Cont4572S + 1\r\n  END--END while\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 18/02/2019\r\n-- Update Date:\r\n-- Description:\tTravar adicionar linhas com cidades duplicadas na macro regiao\r\n-- GLPI ID: 6500\r\n-- GLPI ID Atualiza‡oes:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027CadMacroRegiao\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--CadMacroRegiao\r\nBEGIN\r\n\r\nIF EXISTS(\r\nSELECT *FROM(\r\nSELECT A.U_Estado,COUNT(A.U_MUNICIPIO)\u0027cidades\u0027 FROM(\r\n SELECT T0.U_Estado, LineId,T0.U_Municipio FROM [@RAL_MACROREGIAO1] T0 \r\n INNER JOIN [@RAL_MACROREGIAO] T1 ON T1.DocEntry= T0.DocEntry \r\n WHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n ) A\r\n GROUP BY A.U_ESTADO,A.U_Municipio) B WHERE cidades \u003e 1 )\r\n BEGIN\r\n\tSET @error = -6500\r\n\tSET @error_message = \u0027Existe duplicidade de cidades, Verifique!\u0027\r\n\tSELECT @error, @error_message\r\n\r\n END\r\n END;\r\n --------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n-------------------------------------------------------------------------------------------------------------------------\r\n---- Author:\t\tHenrique Truyts \r\n---- Create date: 15/02/2019\r\n---- Description: Travar Documentos sem RA preenchido  - ESBO€O\r\n---- Documentos:  Solicita‡ao de Compra,Oferta de Compra, Saida de mercadorias\r\n---- GLPI ID: 6345\r\n---- GLPI ID Atualiza‡oes: 9451\r\n---- Description: Retirar a trava de RA dos documentos sa¡da de mercadoria e entrada de mercadoria em 13/09/2020\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027))--N\u0027112\u0027 = ESBO€O\r\n--BEGIN\r\n\r\n--\tIF EXISTS(SELECT * FROM DRF1 WHERE ObjType=\u00271470000113\u0027 \r\n--\t\tAND (U_RAL_CadastroRA IS NULL OR  U_RAL_CadastroRA = \u0027\u0027) AND DocEntry = @list_of_cols_val_tab_del  )\r\n--\tBEGIN\r\n--\t\tSET @error = -6345\r\n--\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Cadastro RA, verifique!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\n------------------------------OFERTA DE COMPRA\r\n--IF EXISTS(SELECT * FROM DRF1 WHERE ObjType=\u0027540000006\u0027 \r\n--\t\tAND (U_RAL_CadastroRA IS NULL OR  U_RAL_CadastroRA = \u0027\u0027) AND DocEntry = @list_of_cols_val_tab_del  )\r\n--\tBEGIN\r\n--\t\tSET @error = -6345\r\n--\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Cadastro RA, verifique!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\n--------------------------------SAIDA DE MERCADORIAS\r\n--IF EXISTS(SELECT * FROM DRF1 WHERE ObjType=\u002760\u0027 \r\n--\t\tAND (U_RAL_CadastroRA IS NULL OR  U_RAL_CadastroRA = \u0027\u0027) AND DocEntry = @list_of_cols_val_tab_del  )\r\n--\tBEGIN\r\n--\t\tSET @error = -6345\r\n--\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Cadastro RA, verifique!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Henrique Truyts\r\n-- Create date: 04/01/2018\r\n-- Update Date: 07/05/2018\r\n-- Description:\tBloquear OP caso o produto da lista nao exista no cadastro de base de produtos\r\n-- Documentos: Ordem de Produ‡ao\r\n-- GLPI ID: 4012\r\n-- GLPI ID Atualiza‡oes:5115\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u0027202\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u0027202\u0027 = Ordem de Produ‡ao - OWOR\r\n--BEGIN\r\n--\tDECLARE @ItemCode4012 NVARCHAR (20)  = (SELECT ItemCode FROM OWOR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n--\tDECLARE @TotalProdutos4012 INT = (SELECT Count(DISTINCT ItemCode) FROM WOR1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\n--\tDECLARE @ProdExistentesBase INT = (\r\n--\t--se o total de linhas desse select for menor que a conta de itens da wor1 tem q bloquear\r\n--\t\t\t SELECT COUNT(DISTINCT U_ItemCode) FROM [@RAL_BASEPRODUTOS1] WHERE Code \r\n--\t\t\t IN(SELECT Code FROM [@RAL_BASEPRODUTOS] WHERE  U_ItemCode =  @ItemCode4012 )\r\n--\t\t\t AND U_ItemCode IN(SELECT ItemCode FROM WOR1 WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\r\n--\t--OP ESPECIAL (TYPE =\u0027P\u0027 nao passa pela valida‡ao)\r\n--\tDECLARE @OPType CHAR (1) = (SELECT  Type FROM OWOR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n--\tIF(@OPType \u003c\u003e \u0027P\u0027)\r\n--\tBEGIN\r\n--\t\tIF(@ProdExistentesBase \u003c @TotalProdutos4012)\r\n--\t\tBEGIN\r\n--\t\t\tSET @error = -1\r\n--\t\t\tSET @error_message = \u0027Estrutura inv lida, verifique os componentes da OP!\u0027\r\n--\t\t\tSELECT @error, @error_message\r\n--\t\tEND\r\n--\tEND\r\n--END;--END GERAL\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 07/01/2019\r\n-- Update Date:\r\n-- Description:\tTravar Pedidos de Vendas com condi‡ao de pagamento diferente da condi‡ao do pn \r\n-- GLPI ID: 6271\r\n-- GLPI ID Atualiza‡oes:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @Dep6271 int SET @Dep6271 = (SELECT u.Department From ORDR O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\nDECLARE @CondPagtoPN Int = (SELECT GroupNum FROM OCRD WHERE CardCode = \r\n\t(SELECT O.CardCode FROM ORDR O WHERE O.DocNum = @list_of_cols_val_tab_del))\r\n\r\nDECLARE @CondPagtoPedido Int = (SELECT O.GroupNum FROM ORDR O WHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n IF(@Dep6271 = 1 AND @CondPagtoPN \u003c\u003e@CondPagtoPedido)\t\r\n\tBEGIN\r\n\t\tSET @error = -6271\r\n\t\tSET @error_message = \u0027Nao ‚ possivel atualizar o pedido, a condi‡ao de pagamento do pedido diverge da condi‡ao de pagamento cadastrada no parceiro!\u0027\r\n\t\tSELECT @error, @error_message\r\n\r\n\tEND;\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 16/11/2018\r\n-- Update date: 30/04/2022\r\n-- Description:\tTravar Pedido caso a data de entrega coincida com agendamento de Bloqueio\r\n-- Documentos:  Pedido de Vendas\r\n-- GLPI ID: 5915\r\n-- GLPI ID Atualiza‡oes:\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @DataEntregaAGBloq DATETIME SET @DataEntregaAGBloq = (SELECT DocDueDate FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\r\nDECLARE @CodigoPNAGBloq nvarchar(10) =(SELECT CardCode FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\r\nDECLARE @Filial5915 Numeric = (SELECT BPLId FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\nIF EXISTS(\r\nSELECT  U_RAL_CardCode,U_RAL_CardName,U_RAL_DataInicial,U_RAL_DataFinal\t\r\nFROM [@RAL_AGENDACLIENTES]\r\nWHERE U_BPLId = @Filial5915 AND U_RAL_StatusEntrega = \u0027Bloqueada\u0027  AND \r\n(@DataEntregaAGBloq between U_RAL_DataInicial AND U_RAL_DataFinal ) \r\nAND \r\n(@DataEntregaAGBloq between U_RAL_DataInicial AND U_RAL_DataFinal ) \r\nAND U_RAL_CardCode = @CodigoPNAGBloq\r\n)\r\nBEGIN\r\n\tSET @error = -1\r\n\tSET @error_message = \u0027Nao foi possivel salvar o pedido, existe um bloqueio para a data de entrega :\u0027+\r\n\treplace(convert(char(11),@DataEntregaAGBloq,113),\u0027 \u0027,\u0027-\u0027)\r\n\tSELECT @error, @error_message\r\nEND\r\nEND\r\n\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 16/11/2018\r\n-- Update date: 30/04/2022\r\n-- Description:\tTravar Pedido caso a data de entrega coincida com feriado e nao possua agendamento de autoriza‡ao\r\n-- Documentos:  Pedido de Vendas\r\n-- GLPI ID: 5915\r\n-- GLPI ID Atualiza‡oes:\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @Pais nvarchar(30)\r\nDECLARE @Estado nvarchar(30)\r\nDECLARE @Municipio nvarchar(30)\r\nDECLARE @Mes INT =  (SELECT DATEPART ( MONTH ,(SELECT DocDueDate FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)) )\r\nDECLARE @Dia INT = (SELECT DATEPART ( DAY ,(SELECT DocDueDate FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)) )\r\nDECLARE @DataEntrega DATETIME SET @DataEntrega = (SELECT DocDueDate FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\r\nDECLARE @CodigoPN nvarchar(10) =(SELECT CardCode FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\r\nDECLARE @Filial5915A Numeric = (SELECT BPLId FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n--primeiro tem que pegar os dados do local de entrega(Pais, estado, municipio)\r\nSELECT \r\n@Municipio = (CASE WHEN T8.U_Municipio IS NULL OR T8.U_Municipio = \u0027\u0027 THEN T3.Name ELSE T8.U_Municipio END) ,\r\n@Estado = (CASE WHEN T8.U_Estado IS NULL OR T8.U_Estado = \u0027\u0027 THEN T3.State ELSE T8.U_Estado END),\r\n@Pais=T3.Country\r\nFROM OCRD T0 \r\nINNER JOIN OCRG T1 ON T0.GroupCode = T1.GroupCode\r\nINNER JOIN CRD1 T2 ON T0.CardCode = T2.CardCode\r\nINNER JOIN OCNT T3 ON T2.County = T3.AbsId\r\nLEFT JOIN [@RAL_MACROREGIAO1] T4 ON T4.U_Municipio = T3.Name\r\nLEFT JOIN [@RAL_MACROREGIAO] T5 ON T5.DocEntry= T4.DocEntry \r\nLEFT JOIN ORDR T6 ON T6.CardCode = T0.CardCode \r\nLEFT JOIN [@RAL_LOCALENTREGA] T7 on T6.U_LocalEntregaId = T7.DocEntry  AND t7.U_BPLId = T6.BPLId\r\nLEFT JOIN [@RAL_LOCALENTREGA1] T8 on T8.DocEntry = T7.DocEntry \r\nWHERE T2.Address=\u0027FATURAMENTO\u0027 AND T0.CardCode = @CodigoPN\r\nAND T6.DocEntry = @list_of_cols_val_tab_del\r\n\r\n\r\n--Depois deve-se verificar com base nos dados do local de entrega, se existe algum feriado nacional, estadual ou municipal\r\nIF EXISTS(\r\n--Verificar apenas feriados nacionais\r\nSELECT T0.DocEntry,T1.U_RAL_Mes,T1.U_RAL_Dia,T1.U_RAL_Descricao,\u0027Nacional\u0027 as \u0027Tipo\u0027 FROM [@RAL_FERIADOS] T0 \r\nINNER JOIN [@RAL_FERIADOS1] T1 ON T0.DocEntry = T1.DocEntry \r\nWHERE T0.U_BPLId = @Filial5915A AND T0.U_RAL_Pais = @Pais AND T0.U_RAL_Estado IS NULL AND T0.U_RAL_Municipio IS NULL \r\nAND (T1.U_RAL_Dia \u003e= @Dia AND T1.U_RAL_Dia \u003c= @Dia )AND( T1.U_RAL_Mes\u003e= @Mes AND T1.U_RAL_Mes\u003c= @Mes) \r\nUNION\r\n--Verificar apenas feriados estaduais\r\nSELECT T0.DocEntry,T1.U_RAL_Mes,T1.U_RAL_Dia,T1.U_RAL_Descricao,\u0027Estadual\u0027 as \u0027Tipo\u0027 FROM [@RAL_FERIADOS] T0 \r\nINNER JOIN [@RAL_FERIADOS1] T1 ON T0.DocEntry = T1.DocEntry\r\nWHERE T0.U_BPLId = @Filial5915A AND T0.U_RAL_Pais = @Pais AND T0.U_RAL_Estado =@Estado  AND T0.U_RAL_Municipio IS NULL \r\nAND (T1.U_RAL_Dia \u003e= @Dia AND T1.U_RAL_Dia \u003c= @Dia )AND( T1.U_RAL_Mes\u003e=@Mes AND T1.U_RAL_Mes\u003c=@Mes) \r\nUNION \r\n--verificar apenas feriados municipais\r\nSELECT T0.DocEntry,T1.U_RAL_Mes,T1.U_RAL_Dia,T1.U_RAL_Descricao,\u0027Municipal\u0027 as \u0027Tipo\u0027 FROM [@RAL_FERIADOS] T0 \r\nINNER JOIN [@RAL_FERIADOS1] T1 ON T0.DocEntry = T1.DocEntry \r\nWHERE T0.U_BPLId = @Filial5915A AND T0.U_RAL_Pais = @Pais AND T0.U_RAL_Estado =@Estado AND T0.U_RAL_Municipio = @Municipio \r\nAND (T1.U_RAL_Dia \u003e= @Dia AND T1.U_RAL_Dia \u003c= @Dia )AND( T1.U_RAL_Mes\u003e=@Mes AND T1.U_RAL_Mes\u003c=@Mes)\r\n)\r\n--caso exista algum feriado, deve verificar se existe agendamento de autoriza‡ao\r\nBEGIN\r\n\t--se nao existe agendamento de autoriza‡ao , o sistema trava a entrada do pedido\r\n\tIF NOT EXISTS(\r\n\t\t\tSELECT  U_RAL_CardCode,U_RAL_CardName,U_RAL_DataInicial,U_RAL_DataFinal\t,U_RAL_StatusEntrega\r\n\t\t    FROM [@RAL_AGENDACLIENTES]\r\n\t\t    WHERE U_BPLId = @Filial5915A AND U_RAL_StatusEntrega = \u0027Autorizada\u0027 AND\r\n\t\t    (@DataEntrega between U_RAL_DataInicial AND U_RAL_DataFinal )\r\n\t\t    AND \r\n\t\t    (@DataEntrega between U_RAL_DataInicial AND U_RAL_DataFinal ) \r\n\t\t    AND U_RAL_CardCode = @CodigoPN\r\n\t)\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Nao foi possivel salvar o pedido, existe um feriado que coincide com a data de entrega :\u0027+\r\n\t\treplace(convert(char(11),@DataEntrega,113),\u0027 \u0027,\u0027-\u0027)\r\n\t\tSELECT @error, @error_message\r\n\t\t \r\n\tEND\r\n\t\r\nEND\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 16/11/2018\r\n-- Update date: 30/04/2022\r\n-- Description:\tTravar cota‡ao caso a data de entrega coincida com agendamento de Bloqueio\r\n-- Documentos:  Cota‡ao\r\n-- GLPI ID: 5915\r\n-- GLPI ID Atualiza‡oes:\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027))--\u002723\u0027 = Cota‡ao de Vendas\r\n--BEGIN\r\n\r\n--DECLARE @DataEntregaAGBloqCOT DATETIME SET @DataEntregaAGBloqCOT = (SELECT DocDueDate FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n--DECLARE @CodigoPNAGBloqCOT nvarchar(10) =(SELECT CardCode FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n--DECLARE @Filial5915COT Numeric = (SELECT BPLId FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n--IF EXISTS(\r\n--SELECT  U_RAL_CardCode,U_RAL_CardName,U_RAL_DataInicial,U_RAL_DataFinal\t\r\n--FROM [@RAL_AGENDACLIENTES]\r\n--WHERE U_BPLId = @Filial5915COT AND U_RAL_StatusEntrega = \u0027Bloqueada\u0027  AND \r\n--(@DataEntregaAGBloqCOT between U_RAL_DataInicial AND U_RAL_DataFinal ) \r\n--AND \r\n--(@DataEntregaAGBloqCOT between U_RAL_DataInicial AND U_RAL_DataFinal ) \r\n--AND U_RAL_CardCode = @CodigoPNAGBloqCOT\r\n--)\r\n--BEGIN\r\n--\tSET @error = -5915\r\n--\tSET @error_message = \u0027Nao foi possivel salvar o pedido, existe um bloqueio para a data de entrega :\u0027+\r\n--\treplace(convert(char(11),@DataEntregaAGBloqCOT,113),\u0027 \u0027,\u0027-\u0027)\r\n--\tSELECT @error, @error_message\r\n--END\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 16/11/2018\r\n-- Update date: 30/04/2022\r\n-- Description:\tTravar Cota‡ao caso a data de entrega coincida com feriado e nao possua agendamento de autoriza‡ao\r\n-- Documentos:  Cota‡ao de Vendas\r\n-- GLPI ID: 5915\r\n-- GLPI ID Atualiza‡oes: --comentei a trava em 11/10/2023 para evitar que bloqueie pedidos do edi\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027))--\u002723\u0027 = Cota‡ao de Vendas\r\n--BEGIN\r\n\r\n--DECLARE @PaisCOT nvarchar(30)\r\n--DECLARE @EstadoCOT nvarchar(30)\r\n--DECLARE @MunicipioCOT nvarchar(30)\r\n--DECLARE @MesCOT INT =  (SELECT DATEPART ( MONTH ,(SELECT DocDueDate FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del)) )\r\n--DECLARE @DiaCOT INT = (SELECT DATEPART ( DAY ,(SELECT DocDueDate FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del)) )\r\n--DECLARE @DataEntregaCOT DATETIME SET @DataEntregaCOT = (SELECT DocDueDate FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n--DECLARE @CodigoPNCOT nvarchar(10) =(SELECT CardCode FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n--DECLARE @Filial5915COTB Numeric = (SELECT BPLId FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n----primeiro tem que pegar os dados do local de entrega(Pais, estado, municipio)\r\n--SELECT \r\n--@MunicipioCOT = (CASE WHEN T8.U_Municipio IS NULL OR T8.U_Municipio = \u0027\u0027 THEN T3.Name ELSE T8.U_Municipio END) ,\r\n--@EstadoCOT = (CASE WHEN T8.U_Estado IS NULL OR T8.U_Estado = \u0027\u0027 THEN T3.State ELSE T8.U_Estado END),\r\n--@PaisCOT=T3.Country\r\n--FROM OCRD T0 \r\n--INNER JOIN OCRG T1 ON T0.GroupCode = T1.GroupCode\r\n--INNER JOIN CRD1 T2 ON T0.CardCode = T2.CardCode\r\n--INNER JOIN OCNT T3 ON T2.County = T3.AbsId\r\n--LEFT JOIN [@RAL_MACROREGIAO1] T4 ON T4.U_Municipio = T3.Name\r\n--LEFT JOIN [@RAL_MACROREGIAO] T5 ON T5.DocEntry= T4.DocEntry \r\n--LEFT JOIN OQUT T6 ON T6.CardCode = T0.CardCode \r\n--LEFT JOIN [@RAL_LOCALENTREGA] T7 on T6.U_LocalEntregaId = T7.DocEntry AND t7.U_BPLId = T6.BPLId\r\n--LEFT JOIN [@RAL_LOCALENTREGA1] T8 on T8.DocEntry = T7.DocEntry \r\n--WHERE T2.Address=\u0027FATURAMENTO\u0027 AND T0.CardCode = @CodigoPNCOT\r\n--AND T6.DocEntry = @list_of_cols_val_tab_del\r\n\r\n\r\n----Depois deve-se verificar com base nos dados do local de entrega, se existe algum feriado nacional, estadual ou municipal\r\n--IF EXISTS(\r\n----Verificar apenas feriados nacionais\r\n--SELECT T0.DocEntry,T1.U_RAL_Mes,T1.U_RAL_Dia,T1.U_RAL_Descricao,\u0027Nacional\u0027 as \u0027Tipo\u0027 FROM [@RAL_FERIADOS] T0 \r\n--INNER JOIN [@RAL_FERIADOS1] T1 ON T0.DocEntry = T1.DocEntry \r\n--WHERE T0.U_BPLId = @Filial5915COTB AND T0.U_RAL_Pais = @PaisCOT AND T0.U_RAL_Estado IS NULL AND T0.U_RAL_Municipio IS NULL \r\n--AND (T1.U_RAL_Dia \u003e= @DiaCOT AND T1.U_RAL_Dia \u003c= @DiaCOT )AND( T1.U_RAL_Mes\u003e= @MesCOT AND T1.U_RAL_Mes\u003c= @MesCOT) \r\n--UNION\r\n----Verificar apenas feriados estaduais\r\n--SELECT T0.DocEntry,T1.U_RAL_Mes,T1.U_RAL_Dia,T1.U_RAL_Descricao,\u0027Estadual\u0027 as \u0027Tipo\u0027 FROM [@RAL_FERIADOS] T0 \r\n--INNER JOIN [@RAL_FERIADOS1] T1 ON T0.DocEntry = T1.DocEntry\r\n--WHERE T0.U_BPLId = @Filial5915COTB AND T0.U_RAL_Pais = @PaisCOT AND T0.U_RAL_Estado =@EstadoCOT AND T0.U_RAL_Municipio IS NULL \r\n--AND (T1.U_RAL_Dia \u003e= @DiaCOT AND T1.U_RAL_Dia \u003c= @DiaCOT )AND( T1.U_RAL_Mes\u003e=@MesCOT AND T1.U_RAL_Mes\u003c=@MesCOT) \r\n--UNION \r\n----verificar apenas feriados municipais\r\n--SELECT T0.DocEntry,T1.U_RAL_Mes,T1.U_RAL_Dia,T1.U_RAL_Descricao,\u0027Municipal\u0027 as \u0027Tipo\u0027 FROM [@RAL_FERIADOS] T0 \r\n--INNER JOIN [@RAL_FERIADOS1] T1 ON T0.DocEntry = T1.DocEntry \r\n--WHERE T0.U_BPLId = @Filial5915COTB AND T0.U_RAL_Pais = @PaisCOT AND T0.U_RAL_Estado =@EstadoCOT AND T0.U_RAL_Municipio = @MunicipioCOT \r\n--AND (T1.U_RAL_Dia \u003e= @DiaCOT AND T1.U_RAL_Dia \u003c= @DiaCOT )AND( T1.U_RAL_Mes\u003e=@MesCOT AND T1.U_RAL_Mes\u003c=@MesCOT)\r\n--)\r\n----caso exista algum feriado, deve verificar se existe agendamento de autoriza‡ao\r\n--BEGIN\r\n--\t--se nao existe agendamento de autoriza‡ao , o sistema trava a entrada do pedido\r\n--\tIF NOT EXISTS(\r\n--\t\t\tSELECT  U_RAL_CardCode,U_RAL_CardName,U_RAL_DataInicial,U_RAL_DataFinal\t,U_RAL_StatusEntrega\r\n--\t\t    FROM [@RAL_AGENDACLIENTES]\r\n--\t\t    WHERE U_BPLId = @Filial5915COTB AND U_RAL_StatusEntrega = \u0027Autorizada\u0027 AND\r\n--\t\t    (@DataEntregaCOT between U_RAL_DataInicial AND U_RAL_DataFinal )\r\n--\t\t    AND \r\n--\t\t    (@DataEntregaCOT between U_RAL_DataInicial AND U_RAL_DataFinal ) \r\n--\t\t    AND U_RAL_CardCode = @CodigoPNCOT\r\n--\t)\r\n--\tBEGIN\r\n--\t\tSET @error = -5915\r\n--\t\tSET @error_message = \u0027Nao foi possivel salvar a cota‡ao, existe um feriado que coincide com a data de entrega :\u0027+\r\n--\t\treplace(convert(char(11),@DataEntregaCOT,113),\u0027 \u0027,\u0027-\u0027)\r\n--\t\tSELECT @error, @error_message\r\n\t\t \r\n--\tEND\r\n\t\r\n--END\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 08/11/2018\r\n-- Update Date: \r\n-- Description: Trava P/ Recebimento de mercadorias sem imposto\r\n-- Documento: Recebimento de Mercadorias\r\n-- GLPI ID:6038\r\n-- GLPI ID Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002720\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--Recebimento de mercadorias\r\nBEGIN \r\n\t\tIF EXISTS(SELECT *FROM  PDN1 WHERE (TaxCode IS NULL  OR TaxCode = \u0027\u0027)\r\n\t\t\t\tAND DocEntry = @list_of_cols_val_tab_del)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6038\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio o preenchimento do campo C¢digo de Imposto na linha do documento\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 06/11/2018\r\n-- Update Date: \r\n-- Description: Trava P/ Cancelamento de notas fiscais - Restrito ao Grupo Cont bil/Fiscal\r\n-- Documento: Entrega,Devolu‡ao,NF de Sa¡da e Dev. NF de Sa¡da\r\n-- Recebimento de Mercadorias,Devolu‡ao de Mercadorias,Nota Fiscal de Entrada,Dev. NF de Entrada,NF Recebimento Futuro\r\n-- GLPI ID:5953\r\n-- GLPI ID Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--Nota Fiscal de Sa¡da\r\nBEGIN \r\nDECLARE @Canceled5953NFS varchar (10) =(SELECT CANCELED FROM OINV WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953NFS int = (SELECT SeqCode FROM OINV WHERE DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953NFS int SET @Dep5953NFS = (SELECT u.Department From OINV O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953NFS \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953NFS = \u0027C\u0027 AND @TipoNF5953NFS = 27) --27 = Nfe\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--ENTREGA\r\nBEGIN \r\nDECLARE @Canceled5953ENT varchar (10) =(SELECT CANCELED FROM ODLN WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953ENT int = (SELECT SeqCode FROM ODLN WHERE  DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953ENT int SET @Dep5953ENT = (SELECT u.Department From ODLN O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953ENT \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953ENT = \u0027C\u0027 AND (@TipoNF5953ENT = 27 OR @TipoNF5953ENT = -2 )) --27 = Nfe -2 externo\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002716\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--DEVOLU€AO\r\nBEGIN \r\nDECLARE @Canceled5953DEV varchar (10) =(SELECT CANCELED FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953DEV int = (SELECT SeqCode FROM ORDN WHERE  DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953DEV int SET @Dep5953DEV = (SELECT u.Department From ORDN O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953DEV \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953DEV = \u0027C\u0027 AND (@TipoNF5953DEV = 29 OR @TipoNF5953DEV = -2 )) --29 = NFe_ENT -2 = externo\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--DEVOLU€AO NOTA FISCAL DE SAIDA\r\nBEGIN \r\nDECLARE @Canceled5953DEVNFS varchar (10) =(SELECT CANCELED FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953DEVNFS int = (SELECT SeqCode FROM ORIN WHERE  DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953DEVNFS int SET @Dep5953DEVNFS = (SELECT u.Department From ORIN O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953DEVNFS \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953DEVNFS = \u0027C\u0027 AND (@TipoNF5953DEVNFS = 29 OR @TipoNF5953DEVNFS = -2 )) --29 = NFe_ENT -2 = externo\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002720\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--Recebimento de mercadorias\r\nBEGIN \r\nDECLARE @Canceled5953RM varchar (10) =(SELECT CANCELED FROM OPDN WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953RM int = (SELECT SeqCode FROM OPDN WHERE DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953RM int SET @Dep5953RM = (SELECT u.Department From OPDN O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\nDECLARE @Modelo5953 int = (SELECT Model FROM OPDN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tIF(@Dep5953RM \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953RM = \u0027C\u0027 AND (@TipoNF5953RM = -2 OR @TipoNF5953RM = 29 OR @TipoNF5953RM = 28 ) \r\n\t\tAND (@Modelo5953 != NULL AND @Modelo5953 \u003e0)\t\t) --2=externo | --28=NFE_IMP | 29=NFE_Ent\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002721\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--Devolu‡ao de mercadorias\r\nBEGIN \r\nDECLARE @Canceled5953DM varchar (10) =(SELECT CANCELED FROM ORPD WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953DM int = (SELECT SeqCode FROM ORPD WHERE DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953DM int SET @Dep5953DM = (SELECT u.Department From ORPD O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953DM \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953DM = \u0027C\u0027 AND (@TipoNF5953DM = -2 OR @TipoNF5953DM = 27)) --2=externo | --27=Nfe\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--Nota Fiscal de Entrada | NF Receb Futuro\r\nBEGIN \r\nDECLARE @Canceled5953NFRF varchar (10) =(SELECT CANCELED FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953NFRF int = (SELECT SeqCode FROM OPCH WHERE DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953NFRF int SET @Dep5953NFRF = (SELECT u.Department From OPCH O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953NFRF \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953NFRF = \u0027C\u0027 AND (@TipoNF5953NFRF = -2 OR @TipoNF5953NFRF = 29 OR @TipoNF5953NFRF = 28))--2=externo | --28=NFE_IMP | 29=NFE_En\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002719\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--dev nota fiscal de entrada\r\nBEGIN \r\nDECLARE @Canceled5953DVNFE varchar (10) =(SELECT CANCELED FROM ORPC WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953DVNFE int = (SELECT SeqCode FROM ORPC WHERE DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953DVNFE int SET @Dep5953DVNFE = (SELECT u.Department From ORPC O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953DVNFE \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953DVNFE = \u0027C\u0027 AND (@TipoNF5953DVNFE = -2 OR @TipoNF5953DVNFE = 27 ))--2=externo | --27=Nfe\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 20/10/2017\r\n-- Update Date: 26/10/2017\r\n-- Description:\tTRAVA DE DEPOSITO PARA DEVOLU€AO DE NF DE SAIDA DE ACORDO COM O GRUPO DO PRODUTO E TIPO  DE NFE - ID 3812\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027))--\u002714\u0027 = DEVOLU€AO DE NF DE SAIDA \r\nBEGIN\r\nDECLARE @Linhas int set @Linhas = (SELECT MAX(LineNum)FROM RIN1  WHERE DOCENTRY = @list_of_cols_val_tab_del)\r\nDECLARE @Cont1 int = 0\r\nDECLARE @GrupoProduto Nvarchar(255)\r\nDECLARE @TipoNFe Nvarchar(255) SET @TipoNFe = (SELECT SeqCode FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del) \r\nDECLARE @Deposito Nvarchar(255)\r\nDECLARE @SimplesNacional Nvarchar (10) SET @SimplesNacional = (SELECT  U_RA_SimplesNacional FROM OCRD WHERE\r\n\t\t\t\t\t\t\t\t\tCardCode = (SELECT CardCode FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\r\nWHILE(@Cont1 \u003c  @Linhas+1) -- percorrendo todas as linhas da nf\r\n  BEGIN\r\n\r\n  SET @GrupoProduto = (SELECT ItmsGrpCod FROM OITM WHERE ItemCode = (\r\n\t\t\t\t\t\tSELECT ItemCode FROM RIN1  WHERE LineNum = @Cont1 AND DOCENTRY = @list_of_cols_val_tab_del)) -- pegando grupo de cada produto de cada linha\r\n\r\n  SET @Deposito = (SELECT WhsCode FROM RIN1 WHERE LineNum = @Cont1 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n\r\n\tIF(@GrupoProduto = 106 OR @GrupoProduto = 116 OR @GrupoProduto = 117 OR @GrupoProduto = 118 )--if principal\r\n\tBEGIN\r\n\t\tIF(@SimplesNacional = \u0027S\u0027)\r\n\t\tBEGIN\r\n\t\t\tIF(29 = @TipoNFe AND \u002702.04\u0027 != @Deposito)--NFe Ent = 29\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Devolu‡ao com NF de cliente o dep¢sito deve ser = 02.04 em caso de cliente SIMPLES NACIONAL verificar parceiro de neg¢cios!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tEND -- END IF SIMPLES NACIONAL\r\n\t\tELSE\r\n\t\tBEGIN\r\n\t\t\tIF(-2 = @TipoNFe AND \u002702.04\u0027 != @Deposito)-- Externo = -2\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Devolu‡ao com NF de cliente o dep¢sito deve ser = 02.04 em caso de cliente SIMPLES NACIONAL verificar parceiro de neg¢cios!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\tIF(29 = @TipoNFe AND (\u002702.03\u0027 != @Deposito AND \u002702.19\u0027!= @Deposito AND \u002702.35\u0027!= @Deposito))--NFe Ent = 29\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Retorno com NF pr¢pria o dep¢sito deve ser = 02.03, 02.19 ou 02.35!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tEND -- END ELSE IF SIMPLES NACIONAL\r\n\tEND-- end if principal\r\n\tSet @Cont1 = @Cont1 +1\r\n  END--END while\r\nEND; -- END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 25/04/2018\r\n-- Update Date: 30/04/2022\r\n-- Description:\tPreencher os campos de usu rio: Local de Entrega id, Line local id.\r\n-- Documentos:  Pedido de Venda\r\n-- GLPI ID: 4644\r\n-- GLPI ID Atualiza‡oes:5771\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Venda \r\nBEGIN\r\nDECLARE @LocalEntregaID  Numeric = 0\r\nDECLARE @LineLocalEntregaID NUmeric = 0\r\nDECLARE @U_RAL_LocalEntrega NVarchar (254)\r\nDECLARE @U_LocalEntrega Nvarchar (254)\r\nDECLARE @U_CardCode NVARCHAR (254)\r\nDECLARE @Filial4644 Numeric = (SELECT BPLId FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\tSET @U_RAL_LocalEntrega = (SELECT U_RAL_LocalEntrega FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tSET @U_CardCode = (SELECT CardCode FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@U_RAL_LocalEntrega IS NOT NULL AND @U_RAL_LocalEntrega \u003c\u003e \u0027\u0027)\r\n\tBEGIN\r\n\t\t\t--id local entrega \r\n\t\t\tSET @LocalEntregaID = (SELECT T1.DocEntry\r\n\t\t\tFROM [@RAL_LOCALENTREGA1] T0\r\n\t\t\tINNER JOIN  [@RAL_LOCALENTREGA] T1 ON T0.DocEntry = T1.DocEntry\r\n\t\t\tWHERE T1.U_BPLId = @Filial4644 AND T0.U_IDEndereco = @U_RAL_LocalEntrega AND  T1.U_CardCode = @U_CardCode)\r\n\t\t\t--id linha local entrega\r\n\t\t\tSET  @LineLocalEntregaID =(SELECT T0.LineId\tFROM [@RAL_LOCALENTREGA1] T0\r\n\t\t\tINNER JOIN  [@RAL_LOCALENTREGA] T1 ON T0.DocEntry = T1.DocEntry\r\n\t\t\tWHERE T1.U_BPLId = @Filial4644 AND T0.U_IDEndereco = @U_RAL_LocalEntrega AND  T1.U_CardCode = @U_CardCode )\r\n\r\n\t\t\t--Munic¡pio local entrega \r\n\t\t\tSET @U_LocalEntrega = (SELECT T0.U_Municipio\r\n\t\t\tFROM [@RAL_LOCALENTREGA1] T0\r\n\t\t\tINNER JOIN  [@RAL_LOCALENTREGA] T1 ON T0.DocEntry = T1.DocEntry\r\n\t\t\tWHERE T1.U_BPLId = @Filial4644 AND T0.U_IDEndereco = @U_RAL_LocalEntrega AND  T1.U_CardCode = @U_CardCode)\r\n\r\n\t\t\r\n\r\n\t\t\tUPDATE ORDR SET U_LineLocalId = Convert(nvarchar,@LineLocalEntregaID) , U_LocalEntregaId = Convert(NVarchar,@LocalEntregaID)\r\n\t\t\t,U_LocalEntregaLabel = @U_RAL_LocalEntrega, U_LocalEntrega = @U_LocalEntrega,U_RAL_LocalEntrega=@U_RAL_LocalEntrega,\r\n\t\t\tU_MacroRegiaoId = @U_LocalEntrega\r\n\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del;\r\n\t\t\t\t\r\n\tEND\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 25/04/2018\r\n-- Update Date: 30/04/2022\r\n-- Description:\tPreencher os campos de usu rio: Local de Entrega id, Line local id.\r\n-- Documentos:  Cota‡ao de Venda\r\n-- GLPI ID: 4644\r\n-- GLPI ID Atualiza‡oes:5771\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002723\u0027) and (@transaction_type in (N\u0027A\u0027,N\u0027U\u0027))--\u002723\u0027 = Cota‡ao de Venda\r\nBEGIN\r\nDECLARE @LocalEntregaIDQ  Numeric = 0\r\nDECLARE @LineLocalEntregaIDQ NUmeric = 0\r\nDECLARE @U_RAL_LocalEntregaQ NVarchar (254)\r\nDECLARE @U_LocalEntregaQ NVarchar (254)\r\nDECLARE @U_CardCodeQ NVARCHAR (254)\r\nDECLARE @Filial4644Q Numeric = (SELECT BPLId FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\tSET @U_RAL_LocalEntregaQ = (SELECT U_RAL_LocalEntrega FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tSET @U_CardCodeQ = (SELECT CardCode FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@U_RAL_LocalEntregaQ IS NOT NULL AND @U_RAL_LocalEntregaQ \u003c\u003e \u0027\u0027)\r\n\tBEGIN\r\n\t\t\t--id local entrega \r\n\t\t\tSET @LocalEntregaIDQ = (SELECT T1.DocEntry\r\n\t\t\tFROM [@RAL_LOCALENTREGA1] T0\r\n\t\t\tINNER JOIN  [@RAL_LOCALENTREGA] T1 ON T0.DocEntry = T1.DocEntry\r\n\t\t\tWHERE T1.U_BPLId = @Filial4644Q AND T0.U_IDEndereco = @U_RAL_LocalEntregaQ AND  T1.U_CardCode = @U_CardCodeQ)\r\n\t\t\t--id linha local entrega\r\n\t\t\tSET  @LineLocalEntregaIDQ =(SELECT T0.LineId\tFROM [@RAL_LOCALENTREGA1] T0\r\n\t\t\tINNER JOIN  [@RAL_LOCALENTREGA] T1 ON T0.DocEntry = T1.DocEntry\r\n\t\t\tWHERE T1.U_BPLId = @Filial4644Q AND T0.U_IDEndereco = @U_RAL_LocalEntregaQ AND  T1.U_CardCode = @U_CardCodeQ)\r\n\r\n\t\t\t--Munic¡pio local entrega \r\n\t\t\tSET @U_LocalEntregaQ = (SELECT T0.U_Municipio\r\n\t\t\tFROM [@RAL_LOCALENTREGA1] T0\r\n\t\t\tINNER JOIN  [@RAL_LOCALENTREGA] T1 ON T0.DocEntry = T1.DocEntry\r\n\t\t\tWHERE T1.U_BPLId = @Filial4644Q AND T0.U_IDEndereco = @U_RAL_LocalEntregaQ AND  T1.U_CardCode = @U_CardCodeQ)\r\n\r\n\t\t\t\r\n\t\t\tUPDATE OQUT SET U_LineLocalId = Convert(nvarchar,@LineLocalEntregaIDQ) , U_LocalEntregaId = Convert(NVarchar,@LocalEntregaIDQ)\r\n\t\t\t,U_LocalEntregaLabel = @U_RAL_LocalEntregaQ, U_LocalEntrega = @U_LocalEntregaQ,U_RAL_LocalEntrega=@U_RAL_LocalEntregaQ,\r\n\t\t\tU_MacroRegiaoId = @U_LocalEntregaQ\r\n\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del;\r\n\t\t\t\t\r\n\tEND\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 04/09/2018\r\n-- Update Date: \r\n-- Description: Validar o Munic¡pio na Linha como obrigat¢rio.\r\n-- Documento: Picking \r\n-- GLPI ID:5724\r\n-- GLPI ID Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u0027CadLocalEntrega\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))-- Local de Entrega\r\nBEGIN \r\n\tDECLARE @Municipio5724 nvarchar (255) \r\n\tDECLARE @Cont5724 INT = 1\r\n\tDECLARE @Linhas5724 INT = (SELECT Max(LineId) FROM  [@RAL_LOCALENTREGA1] WHERE  DocEntry = @list_of_cols_val_tab_del )\r\n\t\r\n\tWHILE(@Cont5724 \u003c=@Linhas5724)\r\n\t\tBEGIN\r\n\t\t\tSET @Municipio5724 = (SELECT U_Municipio FROM  [@RAL_LOCALENTREGA1] \r\n\t\t\t\t\t\tWHERE LineId = @Cont5724 AND DocEntry = @list_of_cols_val_tab_del)--@list_of_cols_val_tab_del)\r\n\t\t\tIF(@Municipio5724 IS NULL OR @Municipio5724 = \u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5724\r\n\t\t\t\tSET @error_message = \u0027 obrigatorio o preenchimento do campo munic¡pio!.\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\r\n\t\t\tSET @Cont5724 = @Cont5724 + 1\r\n\t\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 21/12/2017\r\n-- Update Date: 15/08/2018\r\n-- Description:\tBloqueio de NF em Duplicidade\r\n-- Documentos: NF de entrada,DEVOLU€AO NOTA FISCAL DE SAIDA\r\n-- GLPI ID:4194\r\n-- GLPI ID Atualiza‡ao:5505,5633\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027))--\u002718\u0027 = NF DE ENTRADA\r\nBEGIN\r\n\t--Se Nø NF for Externo\r\n\tIF((SELECT SeqCode FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del) = -2)\r\n\tBEGIN\t\t\r\n\t\tIF EXISTS(SELECT * FROM [dbo].[RAL_Opch] WHERE CardCode = (SELECT CardCode FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\t  AND Serial  = (SELECT Serial FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del) \r\n\t\t  AND DoCentry \u003c\u003e @list_of_cols_val_tab_del AND Canceled=\u0027N\u0027 \r\n\t\t  AND Model =  (SELECT model FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\t  AND SeriesStr =   (SELECT [dbo].[SeriesStrOPCH]( @list_of_cols_val_tab_del)) )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -4194\r\n\t\t\tSET @error_message = \u0027NF ENTRADA - Nao foi poss¡vel concluir. N£mero de NF j  existente para esse parceiro.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\n\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- DEVOLU€AO NOTA FISCAL DE SAIDA \r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027))--\u002714\u0027 = DEVOLU€AO NOTA FISCAL DE SAIDA\r\nBEGIN\r\n\t--Se Nø NF for Externo\r\n\tIF((SELECT SeqCode FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del) = -2)\r\n\tBEGIN\t\t\r\n\t\tIF EXISTS(SELECT * FROM [dbo].[RAL_Orin] WHERE CardCode = (SELECT CardCode FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\t  AND Serial  = (SELECT Serial FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del) \r\n\t\t  AND DoCentry \u003c\u003e @list_of_cols_val_tab_del AND Canceled=\u0027N\u0027 \r\n\t\t  AND Model =  (SELECT model FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\t  AND SeriesStr =  (SELECT [dbo].[SeriesStrORIN]( @list_of_cols_val_tab_del)))\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5505\r\n\t\t\tSET @error_message = \u0027DEV NF SAIDA - Nao foi poss¡vel concluir. N£mero de NF j  existente para esse parceiro.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\n\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- AuthorUpdate:leonardo do Prado Gomes\r\n-- Create date: 20/06/2018\r\n-- Update Date: 26/04/2024\r\n-- Description:  Adi‡ao e altera‡ao de registro de Lista de Picking\r\n-- DescriptionUpdate: Melhoria na Contagem de OC, aplicado CASE para tratar valor Nulo.\r\n-- Documento: Picking \r\n-- GLPI ID:5261\r\n-- GLPI ID Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027156\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u0027156\u0027 = Picking\r\nBEGIN\r\nDECLARE @OCNum Nvarchar (10) = 0\r\n\r\nDECLARE @U_Veiculo_Placa  Nvarchar (10)\r\nDECLARE @U_Transportadora  Nvarchar (max)\r\nDECLARE @U_Valor_Frete  Numeric\r\nDECLARE @U_Tipo_Veiculo_Nome  Nvarchar (max)\r\nDECLARE @U_Itinerario_Nome  Nvarchar (max)\r\nDECLARE @U_Peso_Estimado numeric\r\nDECLARE @U_Peso_Pedidos numeric\r\nDECLARE @U_Quantidade_Entrega numeric\r\nDECLARE @U_Valor_Seguro numeric(10,3)\r\nDECLARE @U_Valor_Total_Frete numeric (10,3)\r\nDECLARE @U_TotalTaxaEntrega numeric (10,3)\r\n\r\n\tIF((SELECT COUNT(U_OC_num) FROM (\r\n\t\t\t\tSELECT CASE \r\n\t\t\t\t\t\t\tWHEN T1.U_OC_num IS NULL THEN 1  -----MELHORIA APLICADA NESTE BLOCO\r\n\t\t\t\t\t\t\tELSE T1.U_OC_num \r\n\t\t\t\t\t  END AS \u0027U_OC_num\u0027\r\n\t\t\t\tFROM PKL1 T0\r\n\t\t\t\tINNER JOIN RDR1 T1 ON T0.OrderEntry = T1.DocEntry AND T0.OrderLine = T1.LineNum\r\n\t\t\t\tWHERE AbsEntry = @list_of_cols_val_tab_del\t\t\t\r\n\t\t\t\tGroup by T1.U_OC_num)A) = 1 ) --Se s¢ houver 1 oc entra no if\r\n\tBEGIN\r\n\tSET @OCNum = (SELECT T1.U_OC_num FROM PKL1 T0\r\n\t\t\t\tINNER JOIN RDR1 T1 ON T0.OrderEntry = T1.DocEntry AND T0.OrderLine = T1.LineNum\r\n\t\t\t\tWHERE AbsEntry = @list_of_cols_val_tab_del\t\r\n\t\t\t\tGroup by T1.U_OC_num) \r\n\r\n\r\n\t\tSET @U_Veiculo_Placa = (SELECT U_Veiculo_Placa FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Transportadora = (SELECT U_Transportadora FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Valor_Frete = (SELECT U_Valor_Frete FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Tipo_Veiculo_Nome = (SELECT U_Tipo_Veiculo_Nome FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Itinerario_Nome = (SELECT U_Itinerario_Nome FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Peso_Estimado = (SELECT U_Peso_Estimado FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Peso_Pedidos = (SELECT U_Peso_Estimado - U_Peso_Estimado_Pallets FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Quantidade_Entrega = (SELECT U_Quantidade_Entrega FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Valor_Seguro = (SELECT U_Valor_Seguro FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_TotalTaxaEntrega = (SELECT  U_Valor_Taxa_entrega FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Valor_Total_Frete = (SELECT U_Valor_Total_Frete FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\r\n\t\tUpdate OPKL SET U_PlacaVeiculo = @U_Veiculo_Placa,U_Transportadora = @U_Transportadora,\r\n\t\tU_ValorFrete =  @U_Valor_Frete,U_TipoVeiculo = @U_Tipo_Veiculo_Nome,U_Itinerario = @U_Itinerario_Nome,\r\n\t\tU_PesoSuportado = @U_Peso_Estimado, U_PesoPedidos = @U_Peso_Pedidos,U_Entrega = @U_Quantidade_Entrega,\r\n\t\tU_TaxaEntrega = @U_Valor_Seguro, U_TotalTaxaEntrega= @U_TotalTaxaEntrega, U_ValorTotalFrete = @U_Valor_Total_Frete \r\n\t\tWHERE AbsEntry = @list_of_cols_val_tab_del;\t\t\r\n\r\n\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 20/06/2018\r\n-- Update Date: \r\n-- Description: Atualizar dados da OC ao cancelar o Picking\r\n-- Documento: Picking\r\n-- GLPI ID:5261 item 2\r\n-- GLPI ID Atualiza‡oes:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027156\u0027) and (@transaction_type in (\u0027U\u0027))--\u0027156\u0027 = Picking\r\nBEGIN\r\nDECLARE @PKCancelado char(1) = (SELECT U_RAL_Cancelado FROM OPKL WHERE AbsEntry = @list_of_cols_val_tab_del )\r\n\r\n\tIF(@PKCancelado = \u0027Y\u0027)\r\n\tBEGIN\r\n\t\tIF((SELECT U_Num_picking FROM [@BIM_ORDEMCARGA]  \r\n\t\tWHERE DocEntry IN(\r\n\t\t\tSELECT\tdistinct T1.U_OC_num FROM PKL1 T0 \r\n\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\r\n\t\t\tINNER JOIN [@BIM_ORDEMCARGA] T2 ON T2.DocEntry = T1.U_OC_num\r\n\t\t\tWHERE T0.AbsEntry = @list_of_cols_val_tab_del AND  T2.U_piking_checkbox = \u0027Y\u0027)) = @list_of_cols_val_tab_del )\r\n\r\n\r\n\t\tBEGIN\r\n\t\tUPDATE [@BIM_ORDEMCARGA] SET U_Num_picking = null, U_RAL_NumPick = (SELECT dbo.PickingsdaOCCancelamento(@list_of_cols_val_tab_del))\r\n\t\tWHERE DocEntry IN(\r\n\t\t\tSELECT\tdistinct T1.U_OC_num FROM PKL1 T0 \r\n\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\r\n\t\t\tINNER JOIN [@BIM_ORDEMCARGA] T2 ON T2.DocEntry = T1.U_OC_num\r\n\t\t\tWHERE T0.AbsEntry = @list_of_cols_val_tab_del AND  T2.U_piking_checkbox = \u0027Y\u0027);\r\n\t\tEND\r\n\tELSE \r\n\t\tBEGIN\r\n\t\t\tUPDATE [@BIM_ORDEMCARGA] SET U_RAL_NumPick = (SELECT dbo.PickingsdaOCCancelamento(@list_of_cols_val_tab_del))\r\n\t\tWHERE DocEntry IN(\r\n\t\t\tSELECT\tdistinct T1.U_OC_num FROM PKL1 T0 \r\n\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\r\n\t\t\tINNER JOIN [@BIM_ORDEMCARGA] T2 ON T2.DocEntry = T1.U_OC_num\r\n\t\t\tWHERE T0.AbsEntry = @list_of_cols_val_tab_del AND  T2.U_piking_checkbox = \u0027Y\u0027);\r\n\t\tEND\r\n\tEND--END IF\r\nEND--END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 24/01/2018\r\n-- Update Date: 20/06/2018\r\n-- Description: Valida‡ao de Picking\r\n-- Documento: Picking \r\n-- GLPI ID:4243\r\n-- GLPI IG Atualiza‡ao:5261\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027156\u0027) and (@transaction_type in (\u0027A\u0027))--\u0027156\u0027 = Picking\r\nBEGIN\r\n\tIF EXISTS(SELECT * FROM [@BIM_ORDEMCARGA] WHERE U_piking_checkbox=\u0027N\u0027 AND DocEntry in (\r\n\t\t\tSELECT\tT1.U_OC_num FROM PKL1 T0 \r\n\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\r\n\t\t\tINNER JOIN [@BIM_ORDEMCARGA] T2 ON T2.DocEntry = T1.U_OC_num\r\n\t\t\tWHERE T0.AbsEntry =  @list_of_cols_val_tab_del ))  \r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Existe OC sem libera‡ao para Picking. Verifique.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\tELSE \r\n\tBEGIN\r\n\t\tUPDATE [@BIM_ORDEMCARGA] SET U_Num_picking = @list_of_cols_val_tab_del, U_RAL_NumPick = (SELECT dbo.PickingsdaOC(@list_of_cols_val_tab_del)) WHERE DocEntry IN(\r\n\t\t\tSELECT\tdistinct T1.U_OC_num FROM PKL1 T0 \r\n\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\r\n\t\t\tINNER JOIN [@BIM_ORDEMCARGA] T2 ON T2.DocEntry = T1.U_OC_num\r\n\t\t\tWHERE T0.AbsEntry = @list_of_cols_val_tab_del AND  T2.U_piking_checkbox = \u0027Y\u0027);\r\n\r\n\t\t\t\tUPDATE OPKL SET Remarks = \u0027OC \u0027+(\tSELECT STUFF((SELECT Distinct\t\u0027,\u0027 + CONVERT(nvarchar,T1.U_OC_num) FROM PKL1 T0 \r\n\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\r\n\t\t\tINNER JOIN [@BIM_ORDEMCARGA] T2 ON T2.DocEntry = T1.U_OC_num\r\n\t\t\tWHERE T0.AbsEntry = @list_of_cols_val_tab_del AND  T2.U_piking_checkbox = \u0027Y\u0027\r\n\t\tFOR XML PATH(\u0027\u0027)), 1, 1, \u0027\u0027) ) WHERE AbsEntry = @list_of_cols_val_tab_del;\r\n\r\n\tEND \r\nEND\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 26/10/2017\r\n-- Update Date: 10/05/2018\r\n-- Description: TRAVA DE MODELO E CHAVE DE ACESSO NF ENTRADA, DEVOLU€AO E DEV DE NF DE SAIDA - Chamado 3811\r\n-- GLPI ID:3811\r\n-- GLPI ID Atualiza‡ao:5041\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @Model int\r\nDECLARE @ChaveAcesso NVARCHAR(100)\r\nDECLARE @SqCode int = 0\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002713\u0027 = NOTA FISCAL DE ENTRADA\r\nBEGIN\r\n\tSET @SqCode = (SELECT SeqCode FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\tIF(@SqCode = -2)\r\n\tBEGIN\r\n\t\t--VALIDA€AO MODELO DA NF\r\n\t\tSET @Model = (SELECT Model FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\t\tIF(@Model = 0)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -3811\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o modelo da NF!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND--END IF\r\n\t\tELSE IF (@Model = 39 OR @Model = 44 OR @Model = 45)--NFE e Modelo CTe\r\n\t\tBEGIN\r\n\t\t\t--VALIDA€AO CHAVE DE ACESSO\r\n\t\t\tSET @ChaveAcesso = (SELECT U_chaveacesso FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\tIF (@ChaveAcesso IS NULL OR len(@ChaveAcesso)\u003c\u003e44 )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -3811\r\n\t\t\t\tSET @error_message = \u0027Chave de Acesso incorreta!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t--VALIDA€AO DA SERIE\r\n\t\t\tIF((SELECT SeriesStr FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del) IS  NULL OR \r\n\t\t\t   (SELECT SeriesStr FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del) =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tIF((SELECT convert(Numeric,substring(@ChaveAcesso,23,3))) \u003c\u003e0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -5041\r\n\t\t\t\t\tSET @error_message = \u0027Necess rio o preenchimento do campo Serie da NF!\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND\r\n\t\t\tELSE IF( (SELECT convert(Numeric,substring(@ChaveAcesso,23,3))) \u003c\u003e\r\n\t\t\t\t\t (SELECT SeriesStr FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5041\r\n\t\t\t\tSET @error_message = \u0027Serie difere da Chave de Acesso!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t----VALIDA€AO DO NUMERO DA NF\r\n\t\t\tIF((SELECT convert(Numeric,substring(@ChaveAcesso,26,9))) \u003c\u003e\r\n\t\t\t(SELECT Serial FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5041\r\n\t\t\t\tSET @error_message = \u0027N£mero da NF difere da Chave de Acesso!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND \r\n\t\tEND--END ELSE\r\n\tEND -- IF SEQ CODE\r\nEND;-- END GERAL\r\n----DEVOLU€AO DE NOTA FISCAL DE SAIDA----------------------------------------------------------------\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = DEVOLU€AO DE NOTA FISCAL DE SAIDA\r\nBEGIN\r\n\tSET @SqCode = (SELECT SeqCode FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\tIF(-2 = @SqCode)\r\n\tBEGIN\r\n\t\t--VALIDA€AO MODELO DA NF\r\n\t\tSET @Model = (SELECT Model FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\t\tIF(@Model = 0)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -3811\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o modelo da NF!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND--END IF\r\n\t\tELSE IF (@Model = 39 OR @Model = 44 OR @Model = 45)--NFE e Modelo CTe\r\n\t\tBEGIN\r\n\t\t\t--VALIDA€AO CHAVE DE ACESSO\r\n\t\t\tSET @ChaveAcesso = (SELECT U_chaveacesso FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\tIF (@ChaveAcesso IS NULL OR len(@ChaveAcesso)\u003c\u003e44 )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -3811\r\n\t\t\t\tSET @error_message = \u0027Chave de Acesso incorreta!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t--VALIDA€AO DA SERIE\r\n\t\t\tIF((SELECT SeriesStr FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del) IS  NULL OR \r\n\t\t\t   (SELECT SeriesStr FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del) =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tIF((SELECT convert(Numeric,substring(@ChaveAcesso,23,3))) \u003c\u003e0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -5041\r\n\t\t\t\t\tSET @error_message = \u0027Necess rio o preenchimento do campo Serie da NF!\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND\r\n\t\t\tELSE IF( (SELECT convert(Numeric,substring(@ChaveAcesso,23,3))) \u003c\u003e\r\n\t\t\t\t\t (SELECT SeriesStr FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5041\r\n\t\t\t\tSET @error_message = \u0027Serie difere da Chave de Acesso!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t--VALIDA€AO DO NUMERO DA NF\r\n\t\t\tIF((SELECT convert(Numeric,substring(@ChaveAcesso,26,9))) \u003c\u003e\r\n\t\t\t(SELECT Serial FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5041\r\n\t\t\t\tSET @error_message = \u0027N£mero da NF difere da Chave de Acesso!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND \r\n\t\tEND--END ELSE\r\n\tEND -- IF SEQ CODE\r\nEND;-- END GERAL\r\n----DEVOLU€AO----------------------------------------------------------------------------------------\r\nIF (@object_type = \u002716\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = DEVOLU€AO\r\nBEGIN\r\n\tSET @SqCode = (SELECT SeqCode FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\tIF(-2 = @SqCode)\r\n\tBEGIN\r\n\t\t--VALIDA€AO MODELO DA NF\r\n\t\tSET @Model = (SELECT Model FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\t\tIF(@Model = 0)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -3811\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o modelo da NF!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND--END IF\r\n\t\tELSE IF (@Model = 39 OR @Model = 44 OR @Model = 45)--NFE e Modelo CTe\r\n\t\tBEGIN\r\n\t\t\t--VALIDA€AO CHAVE DE ACESSO\r\n\t\t\tSET @ChaveAcesso = (SELECT U_chaveacesso FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\tIF (@ChaveAcesso IS NULL OR len(@ChaveAcesso)\u003c\u003e44 )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -3811\r\n\t\t\t\tSET @error_message = \u0027Chave de Acesso incorreta!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\r\n\t\t\t--VALIDA€AO DA SERIE\r\n\t\t\tIF((SELECT SeriesStr FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del) IS  NULL OR \r\n\t\t\t   (SELECT SeriesStr FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del) =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tIF((SELECT convert(Numeric,substring(@ChaveAcesso,23,3))) \u003c\u003e0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -5041\r\n\t\t\t\t\tSET @error_message = \u0027Necess rio o preenchimento do campo Serie da NF!\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND\r\n\t\t\tELSE IF( (SELECT convert(Numeric,substring(@ChaveAcesso,23,3))) \u003c\u003e\r\n\t\t\t\t\t (SELECT SeriesStr FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5041\r\n\t\t\t\tSET @error_message = \u0027Serie difere da Chave de Acesso!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t--VALIDA€AO DO NUMERO DA NF\r\n\t\t\t\tIF((SELECT convert(Numeric,substring(@ChaveAcesso,26,9))) \u003c\u003e\r\n\t\t\t(SELECT Serial FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5041\r\n\t\t\t\tSET @error_message = \u0027N£mero da NF difere da Chave de Acesso!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND \r\n\t\tEND--END ELSE\r\n\tEND -- IF SEQ CODE\r\nEND;-- END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 01/02/2018\r\n-- Update Date: 08/05/2018 \r\n-- Description: Valida‡ao de Gera‡ao Picking\r\n-- Documento: Picking\r\n-- GLPI ID:4430\r\n-- GLPI ID Atualiza‡oes:5128\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027156\u0027) and (@transaction_type in (\u0027A\u0027))--\u0027156\u0027 = Picking\r\nBEGIN\r\n\tDECLARE @LinhasPicking Numeric = ( SELECT count(*) From pkl1 WHERE AbsEntry =  @list_of_cols_val_tab_del)\r\n\tDECLARE @Cont4430 numeric = 0 \r\n\tDECLARE @QuantidadeOC Numeric = 0 \r\n\tDECLARE @RelQtty4430 Numeric = 0\r\n\r\n\tWHILE(@Cont4430 \u003c @LinhasPicking)\r\n\tBEGIN\r\n\t\tSET @QuantidadeOC = (\r\n\t\t\t\t\tSELECT  CASE WHEN T1.U_Qtde_OC IS NULL THEN 0 ELSE  T1.U_Qtde_OC END\r\n\t\t\t\t\tFROM PKL1 T0 \r\n\t\t\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\t\r\n\t\t\t\t\tAND (T1.U_Qtde_OC = T0.RelQtty OR T1.U_Qtde_OC= T0.PickQtty)\t-- adicionei essa linha dia 20/03\r\n\t\t\t\t\tINNER JOIN OPKL T2 ON T2.ABSENTRY =T0.AbsEntry\r\n\t\t\t\t\tWHERE T0.AbsEntry =  @list_of_cols_val_tab_del AND T0.PickEntry = @Cont4430 \r\n\t\t\t\t\tAND T2.Status \u003c\u003e \u0027C\u0027\t) \r\n\t\tSET @RelQtty4430 = (\r\n\t\tSELECT  T0.RelQtty\r\n\t\t\t\t\tFROM PKL1 T0 \r\n\t\t\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\t\r\n\t\t\t\t\tAND (T1.U_Qtde_OC = T0.RelQtty OR T1.U_Qtde_OC= T0.PickQtty)\t-- adicionei essa linha dia 20/03\r\n\t\t\t\t\tINNER JOIN OPKL T2 ON T2.ABSENTRY =T0.AbsEntry\r\n\t\t\t\t\tWHERE T0.AbsEntry =  @list_of_cols_val_tab_del AND T0.PickEntry = @Cont4430 \r\n\t\t\t\t\tAND T2.Status \u003c\u003e \u0027C\u0027\t) \r\n\r\n\t\tIF(@QuantidadeOC \u003e 0)\r\n\t\t\tBEGIN\r\n\t\t\t\tIF(\t@RelQtty4430 \u003c\u003e @QuantidadeOC ) \r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -4430\r\n\t\t\t\t\tSET @error_message = \u0027 - A libera‡ao (\u0027+convert(nvarchar,@RelQtty4430  )+\u0027) nao pode ser diferente da quantidade da OC (\u0027+\r\n\t\t\t\t\tconvert(nvarchar,@QuantidadeOC  )+\u0027). Verifique\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\t\r\n\t\t\t\tEND\r\n\t\t\tEND\r\n\r\n\tSET @Cont4430 = @Cont4430 +1\r\n\tEND\r\nEND\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 25/04/2018\r\n-- Update date: 30/04/2022\r\n-- Description:\tTravar Pedido caso o PN tenha Local de Entrega Obrigatorio\r\n-- Documentos:  Pedido de Venda\r\n-- GLPI ID: 4644 Item D\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002717\u0027) and (@transaction_type in (N\u0027A\u0027,N\u0027U\u0027))--\u002717\u0027 = Pedido de Venda \r\nBEGIN\r\nDECLARE @ObrigatorioPV  Char(1)\r\nDECLARE @Filial4644D Numeric = (SELECT BPLId FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\tSET @ObrigatorioPV = (SELECT U_ObrigatorioPV FROM  [@RAL_LOCALENTREGA] WHERE U_BPLId = @Filial4644D AND U_CardCode = \r\n\t\t\t\t\t\t\t(SELECT CardCode FROM ORDR WHERE DocEntry =  @list_of_cols_val_tab_del))\r\n\r\n\tIF(@ObrigatorioPV IS NOT NULL AND @ObrigatorioPV = \u0027Y\u0027)\r\n\tBEGIN\r\n\t\tIF EXISTS(\r\n\t\t\tSELECT U_RAL_LocalEntrega, U_LocalEntregaId,U_LineLocalId FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del AND\r\n\t\t\t( (U_RAL_LocalEntrega is NULL OR  U_RAL_LocalEntrega =\u0027\u0027) AND (U_LocalEntregaId IS NULL OR U_LocalEntregaId =\u0027\u0027)) )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4644\r\n\t\t\t\tSET @error_message = \u0027 obrigat¢rio definir o Local de Entrega para este PN. Verifique.\u0027\r\n\t\t\t\tSELECT @error, @error_message\t\r\n\t\t\tEND\r\n\tEND\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 25/04/2018\r\n-- Update date: 30/04/2022\r\n-- Description:\tTravar Cota‡ao caso o PN tenha Local de Entrega Obrigatorio\r\n-- Documentos:  Cota‡ao de Vendas\r\n-- GLPI ID: 4644 Item D\r\n-- GLPI ID Atualiza‡oes:\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002723\u0027) and (@transaction_type in (N\u0027A\u0027,N\u0027U\u0027))--\u002723\u0027 = Cota‡ao de Vendas\r\nBEGIN\r\n\r\nDECLARE @ObrigatorioPVQ  Char(1)\r\nDECLARE @Filial4644QD Numeric = (SELECT BPLId FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\tSET @ObrigatorioPVQ = (SELECT U_ObrigatorioPV FROM  [@RAL_LOCALENTREGA] WHERE U_BPLId = @Filial4644QD AND U_CardCode = \r\n\t\t\t\t\t\t\t(SELECT CardCode FROM OQUT WHERE DocEntry =  @list_of_cols_val_tab_del))\r\n\r\n\tIF(@ObrigatorioPVQ IS NOT NULL AND @ObrigatorioPVQ = \u0027Y\u0027)\r\n\tBEGIN\r\n\t\tIF EXISTS(\r\n\t\t\tSELECT U_RAL_LocalEntrega, U_LocalEntregaId,U_LineLocalId FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del AND\r\n\t\t\t( (U_RAL_LocalEntrega is NULL OR  U_RAL_LocalEntrega =\u0027\u0027) AND (U_LocalEntregaId IS NULL OR U_LocalEntregaId =\u0027\u0027)) )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4644\r\n\t\t\t\tSET @error_message = \u0027 obrigat¢rio definir o Local de Entrega para este PN. Verifique.\u0027\r\n\t\t\t\tSELECT @error, @error_message\t\r\n\t\t\tEND\r\n\tEND\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 12/03/2017\r\n-- Update Date: 29/08/2023\r\n-- Description: Trava solicita‡ao de compras,Pedido de Compra e NF de Entrada \r\n-- Documentos: solicita‡ao de compras e NF de Entrada \r\n-- GLPI ID : 4596\r\n-- GLPI ID Atualiza‡oes:15772\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u00271470000113\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00271470000113\u0027 = Solicita‡ao de Compra\r\nBEGIN\r\nDECLARE @Linhas4596S Numeric = (SELECT Count(*)FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del) \r\nDECLARE @Cont4596S Numeric = 0\r\nDECLARE @BlpID4596S Numeric = (SELECT BPLId FROM OPRQ WHERE DocEntry = @list_of_cols_val_tab_del) \r\n\r\n--verificar se a filial for jacarei, a trava s¢ ir  atuar na filial jacarei\r\nIF(@BlpID4596S = 2)\r\nBEGIN\r\n\tWHILE(@Cont4596S \u003c @Linhas4596S)\r\n\tBEGIN\r\n\t\tIF EXISTS (SELECT T0.ItemCode,T0.Project ,T1.ItmsGrpCod\r\n\t\t\t\tFROM PRQ1 T0\r\n\t\t\t\tINNER JOIN OITM T1 ON T1.ItemCode = T0.ItemCode\r\n\t\t\t\tWHERE T0.ItemCode LIKE \u0027CG%\u0027 AND (T0.Project IS Null OR T0.Project =\u0027\u0027 )AND\r\n\t\t\t\tT1.ItmsGrpCod IN(164,125,141,127,129,126,128,157,135,136,131,137,133,159,138,\r\n\t\t\t\t130,146,147,174,123,156) AND T0.DocEntry = @list_of_cols_val_tab_del AND T0.LineNum = @Cont4596S)\r\n\t\tBEGIN\r\n\t\r\n\t\t--Se o centro de custo come‡ar com 01 o dep¢sito tem que ser 02.97 \r\n\t\tIF EXISTS (SELECT DocEntry , OcrCode,WhsCode FROM PRQ1 \r\n\t\tWHERE OcrCode LIKE\u002701.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del   AND WhsCode \u003c\u003e \u002702.97\u0027 AND LineNum = @Cont4596S)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.97!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--Se o centro de custo come‡ar com 02 o dep¢sito tem que ser 02.99 \r\n\t\tIF EXISTS (SELECT  DocEntry , OcrCode,WhsCode FROM PRQ1 \r\n\t\tWHERE OcrCode LIKE\u002702.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del   AND WhsCode \u003c\u003e \u002702.99\u0027 AND LineNum = @Cont4596S)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.99!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--Se o centro de custo come‡ar com 03 o dep¢sito tem que ser 02.95 \r\n\t\tIF EXISTS (SELECT DocEntry , OcrCode,WhsCode FROM PRQ1\r\n\t\tWHERE OcrCode LIKE\u002703.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del  AND WhsCode \u003c\u003e \u002702.95\u0027 AND LineNum = @Cont4596S)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.95!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--Se o centro de custo come‡ar com 04 o dep¢sito tem que ser 02.96 \r\n\t\tIF EXISTS (SELECT DocEntry , OcrCode,WhsCode FROM PRQ1 \r\n\t\tWHERE OcrCode LIKE\u002704.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del  AND WhsCode \u003c\u003e \u002702.96\u0027 AND LineNum = @Cont4596S)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.96!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tEND--END IF EXISTS\r\n\t\tSET @Cont4596S = @Cont4596S +1\r\n\tEND --END WHILE\r\n\r\nEND--END IF\r\nEND --END GERAL \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-----------------------------------------------------Nota Fiscal Entrada--------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002718\u0027 = Nota Fiscal Entrada\r\nBEGIN\r\nDECLARE @Linhas4596E Numeric = (SELECT Count(*)FROM PCH1 WHERE DocEntry = @list_of_cols_val_tab_del) \r\nDECLARE @Cont4596E Numeric = 0\r\nDECLARE @BlpID4596E Numeric = (SELECT BPLId FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del) \r\n\r\n--verificar se a filial for jacarei, a trava s¢ ir  atuar na filial jacarei\r\nIF(@BlpID4596E = 2)\r\nBEGIN\r\nWHILE(@Cont4596E \u003c @Linhas4596E)\r\n\tBEGIN\r\n\t\tIF EXISTS (\r\n\t\t\tSELECT T0.ItemCode,T0.Project ,T1.ItmsGrpCod\r\n\t\t\tFROM PCH1 T0\r\n\t\t\tINNER JOIN OITM T1 ON T1.ItemCode = T0.ItemCode\r\n\t\t\tWHERE T0.ItemCode LIKE \u0027CG%\u0027 AND (T0.Project IS Null OR T0.Project =\u0027\u0027 ) AND\r\n\t\t\tT1.ItmsGrpCod IN(164,125,141,127,129,126,128,157,135,136,131,137,133,159,138,\r\n\t\t\t130,146,147,174,123,156) AND T0.DocEntry =  @list_of_cols_val_tab_del AND T0.LineNum = @Cont4596E)\r\n\t\tBEGIN\r\n\t\r\n\t\t--Se o centro de custo come‡ar com 01 o dep¢sito tem que ser 02.97 \r\n\t\tIF EXISTS (SELECT DocEntry , OcrCode,WhsCode FROM PCH1 \r\n\t\tWHERE OcrCode LIKE\u002701.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del  AND WhsCode \u003c\u003e \u002702.97\u0027 AND LineNum = @Cont4596E)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.97!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--Se o centro de custo come‡ar com 02 o dep¢sito tem que ser 02.99 \r\n\t\tIF EXISTS (SELECT  DocEntry , OcrCode,WhsCode FROM PCH1\r\n\t\tWHERE OcrCode LIKE\u002702.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del  AND WhsCode \u003c\u003e \u002702.99\u0027 AND LineNum = @Cont4596E)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.99!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--Se o centro de custo come‡ar com 03 o dep¢sito tem que ser 02.95 \r\n\t\tIF EXISTS (SELECT DocEntry , OcrCode,WhsCode FROM PCH1 \r\n\t\tWHERE OcrCode LIKE\u002703.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del  AND WhsCode \u003c\u003e \u002702.95\u0027 AND LineNum = @Cont4596E)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.95!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--Se o centro de custo come‡ar com 04 o dep¢sito tem que ser 02.96 \r\n\t\tIF EXISTS (SELECT DocEntry , OcrCode,WhsCode FROM PCH1\r\n\t\tWHERE OcrCode LIKE\u002704.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del  AND WhsCode \u003c\u003e \u002702.96\u0027 AND LineNum = @Cont4596E)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.96!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\t\tEND--END IF EXISTS\r\n\t\tSET @Cont4596E = @Cont4596E +1\r\n\tEND --END WHILE\r\nEND--END IF\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 07/03/2018\r\n-- Update date: 19/03/2018\r\n-- Description:\tApagar quantidade OC pedido de venda quando adicionar nota fiscal de sa¡da (vinculada ao pedido).\r\n-- Documentos: Nota fiscal\r\n-- GLPI ID: 4661\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002713\u0027) and (@transaction_type in (N\u0027A\u0027,N\u0027U\u0027))--\u002713\u0027 = Nota Fiscal \r\nBEGIN\r\n\r\nDECLARE @LinhasNF Numeric = 0\r\nDECLARE @BaseLineNF Numeric = 0\r\nDECLARE @Cont4661 Numeric = 0\r\nDECLARE @CANCEL4661 CHAR(1) SET @CANCEL4661 = (SELECT CANCELED FROM OINV WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @NumeroPedido Numeric =0 \r\nDECLARE @U_Qtde_OC Numeric = 0\r\nDECLARE @U_OC_num  Numeric = 0\r\nDECLARE @U_dtPrevEntregaInicial Datetime \r\nDECLARE @U_dtPrevEntregaFinal Datetime\r\nDECLARE @U_STATUS NVARCHAR (255)\r\n\r\nSET @LinhasNF =  (SELECT MAX(LineNum)FROM INV1  WHERE DocEntry = 26153 )\r\n\tWHILE(@Cont4661 \u003c  @LinhasNF+1) -- percorrendo todas as linhas 26018\r\n\tBEGIN\t\r\n\t\t\r\n\t\t\tIF((SELECT U_qtde_OC FROM INV1 WHERE DocEntry =@list_of_cols_val_tab_del  AND LineNum = @Cont4661) IS NOT NUll AND \r\n\t\t\t\t(SELECT U_qtde_OC FROM INV1 WHERE DocEntry =@list_of_cols_val_tab_del  AND LineNum = @Cont4661) \u003e 0)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\tSET @NumeroPedido = (SELECT dbo.DocEntryPedido(@list_of_cols_val_tab_del, @Cont4661) )\r\n\r\n\t\t\t\tIF((SELECT baseType FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont4661 ) = 15)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @BaseLineNF = (SELECT BaseLine FROM DLN1 WHERE DocEntry = (\r\n\t\t\t\t\tSELECT BaseRef FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\t\tAND LineNum = (SELECT BaseLine FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661))\r\n\t\t\t\tEND\r\n\t\t\t\tELSE IF((SELECT baseType FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661 ) = 17)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @BaseLineNF = (SELECT BaseLine FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\tEND\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tIF(@CANCEL4661 = \u0027Y\u0027)\r\n\t\t\t\tBEGIN \t\t\r\n\t\t\t\t\r\n\t\t\t\t\tSET @U_Qtde_OC = (SELECT U_qtde_OC FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\t\tSET @U_OC_num  = (SELECT U_OC_num FROM INV1 WHERE DocEntry  = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\t\tSET @U_dtPrevEntregaInicial =  (SELECT U_dtPrevEntregaInicial FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\t\tSET @U_dtPrevEntregaFinal = (SELECT U_dtPrevEntregaFinal FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\t\tSET @U_STATUS = (SELECT U_Status FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\t\tUPDATE  RDR1 SET U_Qtde_OC = @U_Qtde_OC, U_OC_num = @U_OC_num , \r\n\t\t\t\t\t\tU_dtPrevEntregaInicial = @U_dtPrevEntregaInicial, U_dtPrevEntregaFinal = @U_dtPrevEntregaFinal,\r\n\t\t\t\t\t\tU_Status = @U_STATUS\r\n\t\t\t\t\t\tWHERE DocEntry = @NumeroPedido AND LineNum = @BaseLineNF\r\n\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\tBEGIN\t\r\n\t\t\t\t\tUPDATE  RDR1 SET U_Qtde_OC = null, U_OC_num = null , \r\n\t\t\t\t\tU_dtPrevEntregaInicial = null, U_dtPrevEntregaFinal = null , U_Status= null\r\n\t\t\t\t\tWHERE DocEntry = @NumeroPedido AND LineNum = @BaseLineNF\r\n\t\t\t\tEND \r\n\t\t\tEND\r\n\t\t\t\r\n\t\tSET @Cont4661 = @Cont4661 +1\r\n\tEND\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 26/02/2017\r\n-- Update Date: \r\n-- Description: Travar entrega com pedidos diferentes nas linhas\r\n-- Documentos: ENTREGA\r\n-- GLPI ID : 4738\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027A\u0027))--\u002715\u0027 = entrega\r\nBEGIN\r\n\tIF((SELECT  Count(distinct BaseEntry) FROM DLN1 WHERE DocEntry =  @list_of_cols_val_tab_del) \u003e1)\r\n\tBEGIN\r\n\t\tSET @error = -4738\r\n\t\tSET @error_message = \u0027Nao ‚ poss¡vel adicionar o documento pois uma ou mais linhas estao relacionadas a Pedidos de Venda diferentes.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 12/03/2017\r\n-- Update Date: \r\n-- Description: Limpar dados OC ao adicionar pedido\r\n-- Documentos: Pedido de Vendas\r\n-- GLPI ID : 4732\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\t\r\n\tIF Exists (\r\n\t\tSELECT U_OC_num,U_dtPrevEntregaInicial,U_dtPrevEntregaFinal,U_Status,U_Qtde_OC\r\n\t\tFROM RDR1 T1\r\n\t\tWHERE (U_OC_num IS NOT NULL OR U_dtPrevEntregaInicial IS NOT NULL OR\r\n\t\tU_dtPrevEntregaFinal IS NOT NULL OR U_Status IS NOT NULL OR U_Qtde_OC IS NOT NULL)\r\n\t\tAND DocEntry = @list_of_cols_val_tab_del)\r\n\tBEGIN\r\n\t\tUPDATE RDR1 SET U_OC_num = NULL, U_dtPrevEntregaInicial =NULL,U_dtPrevEntregaFinal = NULL,U_Status = NULL,U_Qtde_OC = NULL\r\n\t\tWHERE DocEntry = @list_of_cols_val_tab_del;\r\n\tEND\r\n\r\n\t--IF Exists(SELECT header, U_RAL_LocalEntrega FROM ORDR \r\n\t--\tWHERE DocEntry = @list_of_cols_val_tab_del AND (header IS NOT NULL OR U_RAL_LocalEntrega IS NOT NULL ))\r\n\t--BEGIN\r\n\t--\tUPDATE ORDR Set --header = null, \r\n\t--\tU_RAL_LocalEntrega = null WHERE  DocEntry = @list_of_cols_val_tab_del;\r\n\t--END\r\n\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 17/11/2017\r\n-- Update Date: 16/02/2018\r\n-- Description: ESBO€O - TRAVA DE MODELO E CHAVE DE ACESSO NF ENTRADA, DEVOLU€AO E DEV DE NF DE SAIDA - Chamado 3811 \r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027))--N\u0027112\u0027 = ESBO€O\r\nBEGIN\r\nDECLARE @EModel int\r\nDECLARE @EChaveAcesso NVARCHAR(100)\r\nDECLARE @ESqCode int = 0\r\nDECLARE @ESObjType int = 0\r\nSET @ESObjType = (SELECT ObjType FROM ODRF WHERE DocEntry = @list_of_cols_val_tab_del )\r\n------DEVOLU€AO DE NOTA FISCAL DE SAIDA----------------------------------------------------------------\r\n\tIF(@ESObjType = 14)\r\n\tBEGIN\r\n\tSET @ESqCode = (SELECT SeqCode FROM ODRF WHERE ObjType = 14 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\r\n\t\tIF(-2 = @ESqCode)\r\n\t\tBEGIN\r\n\t\t\tSET @EModel = (SELECT Model FROM ODRF WHERE ObjType = 14 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\tIF(@EModel = 0)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o modelo da NF!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF\r\n\t\t\tELSE IF (@EModel = 39 OR @EModel = 44)--NFE e Modelo CTe\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @EChaveAcesso = (SELECT U_chaveacesso FROM ODRF WHERE ObjType = 14 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\t\tIF (@EChaveAcesso IS NULL OR len(@EChaveAcesso)\u003c\u003e44 )\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027Chave de Acesso incorreta!\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND--END ELSE\r\n\t\t\tEND\r\n\t\tEND\r\n\tEND\t\r\n\t\r\n\r\n------DEVOLU€AO----------------------------------------------------------------------------------------\r\n\tIF(@ESObjType = 16)--\u002716\u0027 = DEVOLU€AO\r\n\tBEGIN\r\n\tSET @ESqCode = (SELECT SeqCode FROM ODRF WHERE ObjType = 16 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\tIF(-2 = @ESqCode)\r\n\t\tBEGIN\r\n\t\t\tSET @EModel = (SELECT Model FROM ODRF WHERE ObjType = 16 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\tIF(@EModel = 0)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o modelo da NF!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF\r\n\t\t\tELSE IF (@EModel = 39 OR @EModel = 44)--NFE e Modelo CTe\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @EChaveAcesso = (SELECT U_chaveacesso FROM ODRF WHERE ObjType = 16 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\t\tIF (@EChaveAcesso IS NULL OR len(@EChaveAcesso)\u003c\u003e44 )\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027Chave de Acesso incorreta!\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND--END ELSE\r\n\t\tEND -- IF SEQ CODE\r\n\tEND\r\n-----NF ENTRADA ---------------------------------------------------------------------------------------------------------------\r\n\tIF(@ESObjType = 18)--\u002718\u0027 = NF ENTRADA\r\n\tBEGIN\r\n\tSET @ESqCode = (SELECT SeqCode FROM ODRF WHERE ObjType = 18 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\tIF(-2 = @ESqCode)\r\n\t\tBEGIN\r\n\t\tSET @EModel = (SELECT Model FROM ODRF WHERE ObjType = 18 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\tIF(@EModel = 0)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o modelo da NF!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF\r\n\t\t\tELSE IF (@EModel = 39 OR @EModel = 44 OR @EModel = 45)--NFE e Modelo CTe\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @EChaveAcesso = (SELECT U_chaveacesso FROM ODRF WHERE ObjType = 18 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\t\tIF (@EChaveAcesso IS NULL OR len(@EChaveAcesso)\u003c\u003e44 )\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027Chave de Acesso incorreta!\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND--END ELSE\r\n\tEND\r\nEND;\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 05/02/2018\r\n-- Update Date: 26/07/2023\r\n-- Description: Nao permitir utiliza‡oes diferentes na mesma entrega\r\n-- Documentos: Entrega\r\n-- GLPI ID:4454\r\n-- GLPI ID atualiza‡ao:15618 - por conta da venda de macarrao, que possui cfop diferente, precisamos\r\n-- ajustar a trava para passar a preencher os cfops concatenados de ambas opera‡oes\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027A\u0027))--\u002715\u0027 = ENTREGA\r\nBEGIN\r\n\t\tIF((SELECT COUNT(*)FROM(SELECT DocEntry FROM DLN1 WHERE DocEntry = @list_of_cols_val_tab_del GROUP BY Usage,DocEntry)A) \u003e 1)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -4454\r\n\t\t\tSET @error_message = \u0027Nao ‚ permitido utiliza‡oes diferentes na mesma entrega.Verifique.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tELSE\r\n\t\tBEGIN\r\n\t\t\t --UPDATE ODLN SET U_MW_CFOP = (SELECT Descrip FROM OCFP WHERE Code =\r\n\t\t\t\t--(SELECT CFOPCode FROM DLN1 WHERE DocEntry = @list_of_cols_val_tab_del GROUP BY CFOPCode) ) \r\n\t\t\t\t--WHERE DocEntry = @list_of_cols_val_tab_del\r\n\r\n\t\tUPDATE ODLN SET U_MW_CFOP = ( \r\n             SELECT STUFF((SELECT \u0027,\u0027 + CONVERT(nvarchar(max),Descrip) \r\n\t\t\t FROM OCFP WHERE Code in(SELECT CFOPCode FROM DLN1 \r\n\t\t\t\t\t\t\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del GROUP BY CFOPCode)\r\n\t\t\t\tFOR XML PATH(\u0027\u0027)), 1, 1, \u0027\u0027)\r\n\t\t\t\t ) \r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 22/01/2018\r\n-- Update Date: 30-04-2022\r\n-- Description: Valida‡ao de Peso Maximo\r\n-- Documento: Pedido de Vendas\r\n-- GLPI ID:4102\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = PEDIDO DE VENDA\r\nBEGIN\r\n\tDECLARE @TotalLinhas4102 NUMERIC = (SELECT COUNT(*) FROM RDR1 WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\tDECLARE @Contador4102 NUMERIC = 0\r\n\tDECLARE @Peso4102 NUMERIC  = 0\t\r\n\tDECLARE @NumeroFilial Numeric = (SELECT BPLId FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\tDECLARE @PesoMaximo NUMERIC = (SELECT MAX(U_Capacidade_Max) FROM [@BIM_TPO_VEICULO] WHERE U_BPLId = @NumeroFilial  AND U_Prioridade =1)\r\n\r\n\tWHILE(@Contador4102 \u003c @TotalLinhas4102)\r\n\t\tBEGIN\r\n\t\tSET @Peso4102 = (SELECT Weight1 FROM RDR1 WHERE VisOrder = @Contador4102 AND  DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\t\tIF((SELECT dbo.PesoLinhaPedido(@Peso4102,@NumeroFilial)) = 1)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4102\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ poss¡vel adicionar ou atualizar. O peso de uma ou mais linhas ultrapassa a capacidade m xima de cargas da log¡stica, que ‚ de \u0027\r\n\t\t\t\t+CONVERT(NVARCHAR, (SELECT dbo.PesoMaximo(@PesoMaximo,@NumeroFilial)))+  \u0027KG . Crie mais linhas no PV para redistribuir as quantidades!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tSET @Contador4102 = @Contador4102 +1\r\n\t\tEND\r\nEND;--END GERAL\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 04/01/2018\r\n-- Update Date: \r\n-- Description:\tTrava de Dep¢sito por utiliza‡ao\r\n-- Documentos: Devolu‡ao de Mercadorias, ENTREGA\r\n-- GLPI ID:4222\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @Usage4222 NUMERIC \r\nDECLARE @Linhas4222 NUMERIC =0\r\nDECLARE @Cont4222 NUMERIC = 0\r\nDECLARE @Deposito4222 Nvarchar(255)\r\nIF (@object_type = \u002721\u0027) and (@transaction_type in (\u0027A\u0027))--\u002721\u0027 = Dev de mercadoria\r\nBEGIN\r\n\tSET @Linhas4222 =  (SELECT MAX(LineNum)FROM RPD1 WHERE DocEntry =  @list_of_cols_val_tab_del )\r\n\tWHILE(@Cont4222 \u003c  @Linhas4222+1) -- percorrendo todas as linhas\r\n\tBEGIN\r\n\t\tSET @Usage4222 = ( SELECT Usage FROM RPD1 WHERE LineNum = @Cont4222 AND DocEntry = @list_of_cols_val_tab_del)\r\n\t\tSET @Deposito4222 = (SELECT WhsCode FROM RPD1 WHERE LineNum = @Cont4222 AND DocEntry = @list_of_cols_val_tab_del)\r\n\t\t--7 = REM INDUST ENCOME | 15 = REM CONSERTO | 39 = OUTRAS ENTRADAS\r\n\t\tIF((@Usage4222 = 7 OR @Usage4222 = 15 OR @Usage4222 = 39 ) AND @Deposito4222 \u003c\u003e \u002702.99\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.99 para as utiliza‡oes REM INDUST ENCOME,REM CONSERTO e OUTRAS ENTRADAS!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tSET @Cont4222 = @Cont4222 +1\r\n\tEND\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n---ALTERADO NA DATA DE 22/12/2025 ACRESCENTADO NULLIF PARA TRATAR CAMPOS VAZIOS E NAO NULOS\r\nIF (@object_type = \u002715\u0027) AND (@transaction_type IN (\u0027A\u0027,\u0027U\u0027))--\u002715\u0027 = entrega\r\nBEGIN\r\nSET @Cont4222 = 0\r\nSET @Linhas4222  = (SELECT MAX(LineNum)FROM DLN1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @U_SKILL_cEnq NUMERIC = 0\r\nSET @Deposito4222 = null\r\n\r\n\t\tWHILE(@Cont4222 \u003c  @Linhas4222+1) -- percorrendo todas as linhas\r\n\t\tBEGIN\r\n\t\t\tSET @Usage4222 = ( SELECT Usage FROM DLN1 WHERE LineNum = @Cont4222 AND DocEntry = @list_of_cols_val_tab_del)\r\n\t\t\tSET @Deposito4222 = (SELECT WhsCode FROM DLN1 WHERE LineNum = @Cont4222 AND DocEntry = @list_of_cols_val_tab_del)\r\n\t\t\tSET @U_SKILL_cEnq = (SELECT NULLIF(U_SKILL_cEnq,0) FROM DLN1 WHERE LineNum = @Cont4222 AND DocEntry = @list_of_cols_val_tab_del)\r\n\t\t\t----16 = REM ARMAZANAGEM\r\n\t\t\tIF(@Usage4222 = 16)\r\n\t\t\tBEGIN\r\n\t\t\t\tIF(\u002702.99\u0027 \u003c\u003e @Deposito4222 )\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.99 para a utiliza‡ao REM ARMAZENAGEM e C¢d de Enquadramento de IPI - 103\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\t\tIF(@U_SKILL_cEnq IS NULL OR @U_SKILL_cEnq \u003c\u003e 103)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.99 para a utiliza‡ao REM ARMAZENAGEM e C¢d de Enquadramento de IPI - 103\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND\r\n\t\t----11 = REM Vazilh Saca\r\n\t\tIF(@Usage4222 = 11  AND @Deposito4222 \u003c\u003e \u002702.99\u0027 )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.99 para a utiliza‡ao REM VASILH SACARIA!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tSET @Cont4222 = @Cont4222 + 1\r\n\t\tEND\t \r\nEND\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 14/12/2017\r\n-- Update Date: \r\n-- Description: TRAVA DE DEPOSITO NF TRANSBORDO\r\n-- Documents: RECEBIMENTOS DE MERCADORIAS\r\n--GLPI ID:4168\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002720\u0027) and (@transaction_type in (\u0027A\u0027))--\u002720\u0027 = recebimento de mercadorias\r\nBEGIN\r\nDECLARE @Linhas4168 int set @Linhas4168 = (SELECT MAX(LineNum)FROM INV1  WHERE DOCENTRY = @list_of_cols_val_tab_del)\r\nDECLARE @Cont4168 int = 0\r\nDECLARE @Deposito4168 Nvarchar(255)\r\nDECLARE @Util4168 Nvarchar (255)\r\n\r\nWHILE(@Cont4168 \u003c  @Linhas4168+1) -- percorrendo todas as linhas da nf\r\n  BEGIN\r\n  \r\n   SET @Deposito4168 = (SELECT WhsCode FROM PDN1 WHERE LineNum = @Cont4168 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @Util4168 = (SELECT Usage FROM PDN1 WHERE LineNum = @Cont4168 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n\r\n\t\t--USAGE = NF transbordo\r\n\t\tIF( \u002702.99\u0027 != @Deposito4168 AND @Util4168 = 49)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027NF de Transbordo - utilizar dep¢sito 02.99\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--USAGE NF FILHA\r\n\t\tIF( \u002702.02\u0027 != @Deposito4168 AND @Util4168 = 40)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027NF Filha - utilizar dep¢sito 02.02\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\tSet @Cont4168=  @Cont4168 + 1\r\n  END--END while\r\nEND; -- END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Henrique Truyts\r\n-- Create date: 14/12/2017\r\n-- Update Date: \r\n-- Description:\tPreencher os campos Data Entrada/Sa¡da e Hora Entrada e Sa¡da NF-e\r\n-- Documentos: ENTREGA; DEVOLU€AO; NF DE SAIDA; DEVOLU€AO DE NF DE SAIDA; \r\n-- RECEBIMENTO DE MERCADORIAS; DEVOLU€AO DE MERCADORIAS; NF DE ENTRADA; DEVOLU€AO DE NF DE ENTRADA; NF RECEBIMENTO FUTURO; \r\n-- GLPI ID: 3528\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @SeqCode3825 int = 0\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002715\u0027 = ENTREGA - ODLN\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM ODLN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE ODLN SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002716\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002716\u0027 =  DEVOLU€AO - ORDN\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE ORDN SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002713\u0027 =  NF DE SAIDA - OINV\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM OINV WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE OINV SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002714\u0027 =  DEVOLU€AO DE NF DE SAIDA - ORIN\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE ORIN SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002720\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002720\u0027 = RECEBIMENTO DE MERCADORIAS - OPDN\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM OPDN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE OPDN SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002721\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002721\u0027 =  DEVOLU€AO DE MERCADORIAS - ORPD\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM ORPD WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE ORPD SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002718\u0027 =  NF DE ENTRADA E  NF RECEBIMENTO FUTURO - OPCH\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE OPCH SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002719\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002719\u0027 =  DEVOLU€AO DE NF DE ENTRADA - ORPC\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM ORPC WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE ORPC SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 04/07/2017\r\n-- Update Date: 11/12/2017\r\n-- Description:\tTrava para Clientes Bloqueados (caracteristica 24)\r\n-- Documents: Pedido de Vendas e Cota‡ao de vendas\r\n-- GLPI ID: 4129 (OBS esse nao ‚ o chamado que deu origem … essa valida‡ao)\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas (DepCB = departamentos Clientes Bloqueados\r\nBEGIN\r\n\r\nDECLARE @DepCB int SET @DepCB = (SELECT u.Department From ORDR O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n IF(@DepCB = 1)\t\r\n\tBEGIN\r\n\t\tIF  EXISTS (\r\n\t\tSELECT\r\n\t\tt0.QryGroup25,T0.CardCode\r\n\t\tFROM OCRD T0\r\n\t\tWHERE T0.QryGroup25 = \u0027N\u0027 AND T0.QryGroup24 = \u0027Y\u0027 \r\n\t\tAND T0.CardCode  = ( SELECT CardCode FROM ORDR WHERE DocNum =  @list_of_cols_val_tab_del )\r\n\t\t\r\n\t\t) BEGIN\t\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ poss¡vel adicionar o Pedido. Entrar em contato com o setor de Cr‚dito e Cobran‡a ou Adm. de Vendas!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t  END;\r\n\t\r\n\tEND;\r\nEND;--END PRINCIPAL\r\n-------------------------COTA€AO DE VENDAS--------------------------------------------------------------------------------------\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002723\u0027 = Cota‡ao de Vendas (DepCB = departamentos Clientes Bloqueados\r\nBEGIN\r\n\r\nDECLARE @DepCBQ int SET @DepCBQ = (SELECT u.Department From OQUT O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n IF(@DepCBQ = 1)\t\r\n\tBEGIN\r\n\t\tIF  EXISTS (\r\n\t\tSELECT\r\n\t\tt0.QryGroup25,T0.CardCode\r\n\t\tFROM OCRD T0\r\n\t\tWHERE T0.QryGroup25 = \u0027N\u0027 AND T0.QryGroup24 = \u0027Y\u0027 \r\n\t\tAND T0.CardCode  = ( SELECT CardCode FROM OQUT WHERE DocEntry =  @list_of_cols_val_tab_del )\r\n\t\t\r\n\t\t) BEGIN\t\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ poss¡vel adicionar a Cota‡ao. Entrar em contato com o setor de Cr‚dito e Cobran‡a ou Adm. de Vendas!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t  END;\r\n\t\r\n\tEND;\r\nEND;--END PRINCIPAL\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 17/11/2017\r\n-- Update Date: \r\n-- Description:\tPreencher o campo Grupo de Itens na linha da solicita‡ao, para que apare‡a o grupo de itens no relatorio\r\n-- de solicita‡ao de compras - chamado ID 3991\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u00271470000113\u0027) and (@transaction_type in (\u0027A\u0027))--\u00271470000113\u0027 = Solicita‡ao de Compra\r\nBEGIN\r\nDECLARE @QtdLinhasSol INT SET @QtdLinhasSol = (SELECT Count(*) FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del )\r\nDECLARE @ContadorSol INT = 0\r\nDECLARE @GrupoItens INT = 0\r\n\r\n\tWHILE(@ContadorSol \u003c @QtdLinhasSol)\r\n\tBEGIN\r\n\t\tSET @GrupoItens = (SELECT U_RAL_GrupoItens FROM OITM WHERE ItemCode = \r\n\t\t\t\t\t\t\t(SELECT ItemCode FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del AND VisOrder = @ContadorSol))\r\n\t\tIF(@GrupoItens is not null OR @GrupoItens \u003e 0)\r\n\t\tBEGIN\r\n\t\t\tUPDATE PRQ1 SET U_RAL_GrupoItens = @GrupoItens WHERE DocEntry = @list_of_cols_val_tab_del AND VisOrder = @ContadorSol\r\n\t\tEND--END IF\r\n\tSET @ContadorSol = @ContadorSol + 1\r\n\tEND--END WHILE\r\nEND;--END GERAL\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 20/11/2017\r\n-- Update Date: \r\n-- Description:\tTRAVA DE CODIGO DE IMPOSTO E CFOP - ESBO€O ADIANTAMENTOS - ID 3805\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--N\u0027112\u0027 = ESBO€O\r\nBEGIN\r\nDECLARE @ESAdObjType int = 0\r\nSET @ESAdObjType = (SELECT ObjType FROM ODRF WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n--ADIANTAMENTO FORNECEDOR\r\n\tIF (@ESAdObjType = 204)--\u0027204\u0027 = ADIANTAMENTO DE FORNECEDOR\r\n\tBEGIN\r\n\r\n\t\tIF NOT EXISTS( SELECT   T1.TaxCode FROM DRF1 T1\tWHERE (T1.TaxCode IS NOT NULL AND T1.TaxCode\u003c\u003e\u0027\u0027 ) AND T1.DocEntry = @list_of_cols_val_tab_del )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio colocar o C¢digo de Imposto!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\r\n\t\tIF NOT EXISTS( SELECT  T1.CFOPCode FROM DRF1 T1 WHERE  ( T1.CFOPCode IS NOT NULL AND  T1.CFOPCode \u003c\u003e \u0027\u0027) AND T1.DocEntry = @list_of_cols_val_tab_del )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio colocar o CFOP!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND;\r\n\r\n--ADIANTAMENTO CLIENTE\r\n\tIF (@ESAdObjType =  \u0027203\u0027) --\u0027203\u0027 = ADIANTAMENTO DE CLIENTE\r\n\tBEGIN\r\n\r\n\t\tIF NOT EXISTS( SELECT   T1.TaxCode FROM DRF1 T1\tWHERE (T1.TaxCode IS NOT NULL AND T1.TaxCode\u003c\u003e\u0027\u0027 ) AND T1.DocEntry = @list_of_cols_val_tab_del )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio colocar o C¢digo de Imposto!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF NOT EXISTS( SELECT  T1.CFOPCode FROM DRF1 T1 WHERE ( T1.CFOPCode IS NOT NULL AND  T1.CFOPCode \u003c\u003e \u0027\u0027) AND T1.DocEntry =  @list_of_cols_val_tab_del )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio colocar o CFOP!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND;\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 24/10/2017\r\n-- Update Date: 09/11/2017\r\n-- Description:\tTRAVA DE DOCUMENTO REFERENCIADO - ID 3649\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @Usage int \r\nDECLARE @RefDocEntr int \r\nDECLARE @SeqCodes int\r\n\r\n--TRANSBORDO - RECEBIMENTO DE MERCADORIA\r\nIF (@object_type = \u002720\u0027) and (@transaction_type in (\u0027A\u0027))--\u002720\u0027 = RECEBIMENTO DE MERCADORIA\r\nBEGIN\r\nSET @Usage = (SELECT Distinct USAGE FROM PDN1 WHERE USAGE = 49 AND DocEntry = @list_of_cols_val_tab_del )\r\nSET @RefDocEntr =\r\n\t(SELECT\tCOUNT(T2.RefDocEntr) FROM  OPDN T0 \r\n\t\tINNER JOIN PDN1 T1 ON T1.DocEntry = T0.DocEntry\r\n\t\tINNER JOIN PDN21 T2 ON T2.DocEntry = T0.DocEntry\r\n\t\tWHERE T1.Usage = 49 AND T0.DocEntry = @list_of_cols_val_tab_del)\r\n-- usage Transbordo\r\nIF (49 = @Usage)\r\nBEGIN\r\n\tIF(@RefDocEntr \u003c 1)\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Obrigat¢rio colocar a referˆncia do pedido de compras!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND\r\nEND;\r\n--FRETE DE COMPRAS - NF ENTRADA\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027))--\u002718\u0027 = Nota Fiscal de Entrada\r\nBEGIN\r\nDECLARE @CG02043 Bit SET @CG02043 = (SELECT DISTINCT  CASE WHEN itemCode = \u0027CG02043\u0027 THEN 1 ElSE 0 END FROM PCH1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nSET @RefDocEntr = (\r\n\tSELECT\tCOUNT(T2.RefDocEntr) FROM  OPCH T0 \r\n\t\tINNER JOIN PCH1 T1 ON T1.DocEntry = T0.DocEntry\r\n\t\tINNER JOIN PCH21 T2 ON T2.DocEntry = T0.DocEntry\r\n\t\tWHERE T1.itemCode = \u0027CG02043\u0027 AND T0.DocEntry = @list_of_cols_val_tab_del\r\n)\r\n\r\nIF (1 = @CG02043)\r\nBEGIN\r\n\tIF(@RefDocEntr \u003c 1)\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Obrigat¢rio colocar a referˆncia da NF de origem!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND\r\nEND;\r\n\r\n--NOTAS COMPLEMENTARES - NF DE ENTRADA\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027))--\u002718\u0027 = Nota Fiscal de Entrada\r\nBEGIN\r\nSET @Usage = (SELECT Distinct USAGE FROM PCH1 WHERE USAGE = 51 AND DocEntry =  @list_of_cols_val_tab_del)\r\n\r\nSET @RefDocEntr = (\r\nSELECT\tCOUNT(DISTINCT T2.RefDocEntr) FROM  OPCH T0 \r\n\t\tINNER JOIN PCH1 T1 ON T1.DocEntry = T0.DocEntry\r\n\t\tINNER JOIN PCH21 T2 ON T2.DocEntry = T0.DocEntry\r\n\t\tWHERE T1.usage = 51 AND T0.DocEntry = @list_of_cols_val_tab_del\r\n)\r\n--usage compra complementar\r\n\tIF (51 = @Usage)\r\n\tBEGIN\r\n\t\tIF(@RefDocEntr \u003c 2)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio colocar a referˆncia do Pedido e NF de origem!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\t\r\n\tEND\r\nEND;\r\n\r\n--Devolu‡ao de Nota Fiscal de Entrada\r\nIF (@object_type = \u002719\u0027) and (@transaction_type in (\u0027A\u0027))--\u002719\u0027 = Devolu‡ao de Nota Fiscal de Entrada\r\nBEGIN\r\n\tSET @Usage = (\tSELECT CASE WHEN\t(SELECT Distinct USAGE FROM RPC1 WHERE USAGE = 22 AND DocEntry =   @list_of_cols_val_tab_del ) is  null then \r\n\t\t\t\t\t0 else (SELECT Distinct USAGE FROM RPC1 WHERE USAGE = 22 AND  DocEntry =   @list_of_cols_val_tab_del) end  )\r\n\tSET @SeqCodes = (SELECT DISTINCT SeqCode FROM ORPC WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\r\n\t\r\n\tSET @RefDocEntr = (\r\n\t\tSELECT\tCOUNT(DISTINCT T2.RefDocEntr) FROM  ORPC T0 \r\n\t\t\tINNER JOIN RPC1 T1 ON T1.DocEntry = T0.DocEntry\r\n\t\t\tINNER JOIN RPC21 T2 ON T2.DocEntry = T0.DocEntry\r\n\t\t\tWHERE  T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n-- usage BAIXA ESTOQUE nao deve passar pela valida‡ao\r\n\tIF(@Usage \u003c\u003e 22 )\r\n\tBEGIN\r\n\t\tIF(@SeqCodes = 27 )\r\n\t\tBEGIN\r\n\t\t\tIF(@RefDocEntr \u003c 2)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio colocar a referˆncia do Pedido e NF de origem!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\t\t\r\n\t\tEND\r\n\tEND\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 25/10/2017\r\n-- Update Date: \r\n-- Description: TRAVA DE DEPOSITO PARA UTILIZA€AO DOA€AO NF DE SAIDA\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027))--\u002713\u0027 = Nota Fiscal de sa¡da\r\nBEGIN\r\nDECLARE @LLinhas int set @LLinhas = (SELECT MAX(LineNum)FROM INV1  WHERE DOCENTRY = @list_of_cols_val_tab_del)\r\nDECLARE @CCont1 int = 0\r\nDECLARE @DDeposito Nvarchar(255)\r\nDECLARE @UUtil Nvarchar (255)\r\n\r\nWHILE(@CCont1 \u003c  @LLinhas+1) -- percorrendo todas as linhas da nf\r\n  BEGIN\r\n  \r\n   SET @DDeposito = (SELECT WhsCode FROM INV1 WHERE LineNum = @CCont1 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @UUtil = (SELECT Usage FROM INV1 WHERE LineNum = @CCont1 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n\r\n\r\n\t\tIF( \u002702.19\u0027 != @DDeposito AND @UUtil = 52)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Para utiliza‡ao DOA€AO/SAC o dep¢sito deve ser 02.19\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\tSet @CCont1=  @CCont1 + 1\r\n  END--END while\r\nEND; -- END GERAL\r\n----PEDIDO DE VENDA\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Nota Fiscal de sa¡da\r\nBEGIN\r\nset @LLinhas = (SELECT MAX(LineNum)FROM rdr1  WHERE DOCENTRY = @list_of_cols_val_tab_del)\r\nSet @CCont1 = 0\r\n\r\nWHILE(@CCont1 \u003c  @LLinhas+1) -- percorrendo todas as linhas da nf\r\n  BEGIN\r\n  \r\n   SET @DDeposito = (SELECT WhsCode FROM rdr1 WHERE LineNum = @CCont1 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @UUtil = (SELECT Usage FROM rdr1 WHERE LineNum = @CCont1 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n\r\n\r\n\t\tIF( \u002702.19\u0027 != @DDeposito AND @UUtil = 52)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo dep¢sito nas linhas de cada item deve ser = 02.19!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\tSet @CCont1=  @CCont1 + 1\r\n  END--END while\r\nEND; -- END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 24/10/2017\r\n-- Update Date: \r\n-- Description:\tTRAVA DE CODIGO DE IMPOSTO E CFOP - ADIANTAMENTOS - ID 3805\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--ADIANTAMENTO FORNECEDOR\r\nIF (@object_type = \u0027204\u0027) and (@transaction_type in (\u0027A\u0027))--\u0027204\u0027 = ADIANTAMENTO DE FORNECEDOR\r\nBEGIN\r\n\r\n\tIF NOT EXISTS( SELECT   T1.TaxCode FROM DPO1 T1\tWHERE (T1.TaxCode IS NOT NULL AND T1.TaxCode\u003c\u003e\u0027\u0027 ) AND T1.DocEntry = @list_of_cols_val_tab_del )\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Obrigat¢rio colocar o C¢digo de Imposto!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\r\n\tIF NOT EXISTS( SELECT  T1.CFOPCode FROM DPO1 T1 WHERE  ( T1.CFOPCode IS NOT NULL AND  T1.CFOPCode \u003c\u003e \u0027\u0027) AND T1.DocEntry = @list_of_cols_val_tab_del )\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Obrigat¢rio colocar o CFOP!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND;\r\n\r\n--ADIANTAMENTO CLIENTE\r\nIF (@object_type = \u0027203\u0027) and (@transaction_type in (\u0027A\u0027))--\u0027203\u0027 = ADIANTAMENTO DE CLIENTE\r\nBEGIN\r\n\r\n\tIF NOT EXISTS( SELECT   T1.TaxCode FROM DPI1 T1\tWHERE (T1.TaxCode IS NOT NULL AND T1.TaxCode\u003c\u003e\u0027\u0027 ) AND T1.DocEntry = @list_of_cols_val_tab_del )\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Obrigat¢rio colocar o C¢digo de Imposto!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\r\n\tIF NOT EXISTS( SELECT   T1.CFOPCode FROM DPI1 T1 WHERE ( T1.CFOPCode IS NOT NULL AND  T1.CFOPCode \u003c\u003e \u0027\u0027) AND T1.DocEntry =  @list_of_cols_val_tab_del )\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Obrigat¢rio colocar o CFOP!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 21/09/2017\r\n-- Update Date: \r\n-- Description:\tatualizar Observa‡oes adicionais da nf com o valor do funrural\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027))--\u002718\u0027 = Nota Fiscal de Entrada\r\nBEGIN\r\n\r\nDECLARE @ContHeader int set @ContHeader = (\r\nSELECT count(*) FROM OPCH WHERE Header LIKE \u0027%FUNRURAL%\u0027 AND DocEntry = @list_of_cols_val_tab_del\r\n)\r\n\r\nDECLARE @Funrural nvarchar (200)  set @Funrural = \r\n\t\t\t\t\t\t\t\t\t(SELECT LTRIM(RTRIM(WTName)) FROM PCH5 T0\r\n\t\t\t\t\t\t\t\t\tINNER JOIN OPCH T1 ON T0.AbsEntry = T1.DocEntry\r\n\t\t\t\t\t\t\t\t\tINNER JOIN OWHT T2 ON T2.WTCode = T0.WTCode\r\n\t\t\t\t\t\t\t\t\tWHERE T0.WTCode = 16 AND T1.DocEntry = @list_of_cols_val_tab_del  )\r\n\tIF(@Funrural = \u0027FUNRURAL\u0027)\r\n\tBEGIN\r\n\t\t\tIF (@ContHeader \u003c 1)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027INFORMAR VALOR DO FUNRURAL NOS DADOS ADCIONAIS!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\r\n\tEND\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 15/09/2017\r\n-- Update Date: \r\n-- Description:\tTravar NFS sem data e hora de entrada/saida\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @SeqCode int = 0\r\nDECLARE @DtSaida datetime= NULL\r\nDECLARE @HrSaida smallint = NULL\r\n\r\nIF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027))--\u002713\u0027 = Nota Fiscal de sa¡da\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM OINV WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM OINV WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM OINV WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027A\u0027))--\u002715\u0027 = entrega\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM ODLN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM ODLN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM ODLN WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002716\u0027) and (@transaction_type in (\u0027A\u0027))--\u002716\u0027 = Devolu‡ao\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM ORDN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM ORDN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM ORDN WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027))--\u002714\u0027 = DEV Nota Fiscal de Sa¡da\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM ORIN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM ORIN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM ORIN WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002720\u0027) and (@transaction_type in (\u0027A\u0027))--\u002720\u0027 = Recebimento de Mercadoria\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM OPDN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM OPDN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM OPDN WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002721\u0027) and (@transaction_type in (\u0027A\u0027))--\u002721\u0027 = Dev de mercadoria\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM ORPD WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM ORPD WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM ORPD WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027))--\u002718\u0027 = Nota Fiscal de Entrada/NF Recebimento futuro\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM OPCH WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM OPCH WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM OPCH WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002719\u0027) and (@transaction_type in (\u0027A\u0027))--\u002719\u0027 = Dev Nota Fiscal de entrada\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM ORPC WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM ORPC WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM ORPC WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 31/01/2017\r\n-- Update Date: 30/08/2017\r\n-- Description:\tTravar Pedidos de Vendas com ITENS EM ABERTO (APENAS ATUALIZAR) \r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @DepUPV int SET @DepUPV = (SELECT u.Department From ORDR O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n IF(@DepUPV = 1)\t\r\n\tBEGIN\r\n\t\tIF  EXISTS (\r\n\t\t\tSELECT \r\n\t\t\t\t* \r\n\t\t\tFROM \r\n\t\t\t\tOJDT T0  \r\n\t\t\tINNER JOIN JDT1 T1 ON T0.[TransId] = T1.[TransId] \r\n\t\t\tINNER JOIN OACT T2 ON T1.[Account] = T2.[AcctCode] \r\n\t\t\tINNER JOIN OCRD T3 ON T3.CardCode = t1.ShortName\r\n\t\t\t\r\n\t\t\tWHERE \r\n\t\t\t\tT2.[LocManTran] = \u0027Y\u0027 AND \r\n\t\t\t\tT1.[BalDueDeb] \u003c\u003e 0   AND  T3.QryGroup25 = \u0027N\u0027 AND\r\n\t\t\t\tT1.[DueDate] \u003c  CONVERT(DATETIME, FLOOR(CONVERT(FLOAT(24), GETDATE())))  AND \r\n\t\t\t\tT1.[ShortName] = ( SELECT CardCode FROM ORDR WHERE DocNum =  @list_of_cols_val_tab_del )\r\n\t\t\t\t\r\n\t\t\r\n\t\t) BEGIN\t\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ possivel adicionar esse pedido, cliente possui t¡tulos vencidos!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t  END;\r\n\t\r\n\r\n\tEND;\t\t\r\n\t\t\r\n\r\nEND;\r\n\r\n------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 31/01/2017\r\n-- Update Date: 30/08/2017\r\n-- Description:\tTravar Pedidos de Vendas com ITENS EM ABERTO  (APENAS ADICIONAR)\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @DepCR int SET @DepCR = (SELECT u.Department From ORDR O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n IF(@DepCR = 1)\t\r\n\tBEGIN\r\n\t\tIF  EXISTS (\r\n\t\t\tSELECT \r\n\t\t\t\t* \r\n\t\t\tFROM \r\n\t\t\t\tOJDT T0  \r\n\t\t\tINNER JOIN JDT1 T1 ON T0.[TransId] = T1.[TransId] \r\n\t\t\tINNER JOIN OACT T2 ON T1.[Account] = T2.[AcctCode] \r\n\t\t\tINNER JOIN OCRD T3 ON T3.CardCode = t1.ShortName\r\n\t\t\tWHERE \r\n\t\t\t\tT2.[LocManTran] = \u0027Y\u0027 AND \r\n\t\t\t\tT1.[BalDueDeb] \u003c\u003e 0   AND   T3.QryGroup25 = \u0027N\u0027 AND\r\n\t\t\t\tT1.[DueDate] \u003c  CONVERT(DATETIME, FLOOR(CONVERT(FLOAT(24), GETDATE())))  AND \r\n\t\t\t\tT1.[ShortName] = ( SELECT CardCode FROM ORDR WHERE DocNum =  @list_of_cols_val_tab_del )\r\n\t\t\t\r\n\t\t) BEGIN\t\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ possivel adicionar esse pedido, cliente possui t¡tulos vencidos!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t  END;\r\n\r\n\t\r\n\tEND;\t\t\r\n\t\t\r\n\r\nEND;\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 23/08/2017\r\n-- Update Date: \r\n-- Description:\tBloquear ESBO€O de Pedidos com deposito bloqueado\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--N\u0027112\u0027 = ESBO€O\r\n\r\nBEGIN\r\n\tIF EXISTS(\r\n\t\tSELECT \r\n\t\t\tA.DocNum \u0027Nø do Esbo‡o\u0027,\r\n\t\t\tA.CardCode +\u0027-\u0027+ A.CardName \u0027Parceiro\u0027,\r\n\t\t\tI.ItemCode +\u0027-\u0027+ I.ItemName \u0027Produto\u0027,\r\n\t\t\tA.DocDueDate \u0027Data de Entrega\u0027\t,IW.Locked\r\n\t\tFROM \r\n\t\t\tODRF A \r\n\t\tINNER JOIN DRF1 AL ON AL.DocEntry = A.DocEntry\r\n\t\tINNER JOIN OITM I ON AL.ItemCode = I.ItemCode\r\n\t\tINNER JOIN OITW IW ON IW.ItemCode = I.ItemCode AND IW.WhsCode = Al.WhsCode\r\n\t\tWHERE \r\n\t\t\tA.ObjType = 17 AND A.DocEntry = @list_of_cols_val_tab_del AND IW.Locked = \u0027Y\u0027 )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Dep¢sito selecionado est  bloqueado para o Item\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 13/01/2017\r\n-- UPdate Date: 06/07/2017\r\n-- Description:\tTravar Pedidos de Vendas com Data de Validade Menor que a data atual + 2 DDL (APENAS AO ADICIONAR)\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\n\tDECLARE @DocDueDate DATETIME SET @DocDueDate = (SELECT DocDueDate FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DocDate DATETIME SET @DocDate = (SELECT DocDate FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DDL INT  SET @DDL =2\r\n\tDECLARE @HoraAtual INT =  (SELECT DATEPART ( Hour , GETDATE() )  )\r\n\tDECLARE @MinutoAtual INT = (SELECT DATEPART ( MINUTE , GETDATE() )  )\r\n\tDECLARE @Desconto Float SET @Desconto =  (SELECT DiscPrcnt FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n\tDECLARE @diasemana INT = Convert(int,(select DatePart(WEEKDAY,GETDATE())))\r\n\t\r\n\t\r\nIF (@diasemana = 1) --DOMINGO\r\n\tBEGIN\r\n\t\tSET @DDL =3\r\n\tEND\r\nELSE IF(@diasemana between 2 AND 3) -- SEGUNDA E TER€A\r\n\tBEGIN\r\n\t\tIF (@HoraAtual between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtual = 11) AND (@MinutoAtual \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDL =3 \r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDL =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtual between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDL =3\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemana = 4) -- QUARTA-FEIRA\r\n\tBEGIN\r\n\t\tIF (@HoraAtual between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtual = 11) AND (@MinutoAtual \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDL =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDL =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtual between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDL =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemana between 5 AND 6) -- QUINTA E SEXTA\r\n\tBEGIN\r\n\t\tIF (@HoraAtual between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtual = 11) AND (@MinutoAtual \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDL =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDL =4\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtual between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDL =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemana = 7) --SABADO\r\n\tBEGIN\r\n\t\tSET @DDL =4\r\n\tEND\r\n\r\n\tDECLARE @dateDiff INT SET @dateDiff = (SELECT DATEDIFF(DAY,@DocDate+@DDL,@DocDueDate))\r\n\t\r\n\tDECLARE @Dep int SET @Dep = (SELECT u.Department From ORDR O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\t\t\t\t\t\t\t\t \r\n\tDECLARE @GroupNumBP INT SET @GroupNumBP = (SELECT GroupNum FROM OCRD WHERE CardCode = (SELECT CardCode FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del ))\r\n\tDECLARE @GroupNumPV INT SET @GroupNumPV = (SELECT GroupNum FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\r\n\r\nIF ((@dateDiff \u003c 0) AND @Dep NOT IN (2, 18, 12, 20))\r\nBEGIN\r\n    SET @error = -1\r\n    SET @error_message = \u0027A validade deve ter no m¡nimo \u0027 + CONVERT(VARCHAR, @DDL) + \u0027 dias\u0027\r\n    SELECT @error, @error_message\r\nEND\r\n\r\nIF ((@GroupNumBP \u003c\u003e @GroupNumPV) AND @Dep NOT IN (2, 18, 20))\r\nBEGIN\r\n    SET @error = -1\r\n    SET @error_message = \u0027Nao ‚ permitido modificar a Condi‡ao de Pagamento do PN\u0027\r\n    SELECT @error, @error_message\r\nEND\r\n\r\nIF ((@Desconto \u003e 0) AND @Dep NOT IN (2, 18, 20))\r\nBEGIN\r\n    SET @error = -1\r\n    SET @error_message = \u0027Nao ‚ permitido definir esse tipo de desconto no Pedido\u0027\r\n    SELECT @error, @error_message\r\nEND\r\n\r\nEND;\r\n\r\n\r\n\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n-----------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 31/01/2017\r\n-- Update date: 06/07/2017\r\n-- Description:\tTravar Pedidos de Vendas com Data de Validade Menor que a data atual + 2 DDL(APENAS AO ATUALIZAR)\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\n\tDECLARE @DocDueDateU DATETIME SET @DocDueDateU = (SELECT DocDueDate FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DocDateU DATETIME SET @DocDateU = (SELECT DocDate FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DDLU INT  SET @DDLU =2\r\n\tDECLARE @HoraAtualU INT =  (SELECT DATEPART ( Hour , GETDATE() )  )\r\n\tDECLARE @MinutoAtualU INT = (SELECT DATEPART ( MINUTE , GETDATE() )  )\r\n\tDECLARE @DescontoU Float SET @DescontoU =  (SELECT DiscPrcnt FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n\tDECLARE @diasemanaU INT = Convert(int,(select DatePart(WEEKDAY,GETDATE())))\r\n\r\n\tIF (@diasemanaU = 1) --DOMINGO\r\n\tBEGIN\r\n\t\tSET @DDLU =3\r\n\tEND\r\nELSE IF(@diasemanaU between 2 AND 3) -- SEGUNDA E TER€A\r\n\tBEGIN\r\n\t\tIF (@HoraAtualU between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualU = 11) AND (@MinutoAtualU \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLU =3 \r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLU =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualU between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLU =3\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaU = 4) -- QUARTA-FEIRA\r\n\tBEGIN\r\n\t\tIF (@HoraAtualU between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualU = 11) AND (@MinutoAtualU \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLU =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLU =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualU between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLU =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaU between 5 AND 6) -- QUINTA E SEXTA\r\n\tBEGIN\r\n\t\tIF (@HoraAtualU between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualU = 11) AND (@MinutoAtualU \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLU =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLU =4\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualU between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLU =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaU = 7) --SABADO\r\n\tBEGIN\r\n\t\tSET @DDLU =4\r\n\tEND\r\n\tDECLARE @dateDiffU INT SET @dateDiffU = (SELECT DATEDIFF(DAY,@DocDateU+@DDLU,@DocDueDateU))\r\n\t\r\n\tDECLARE @DepU int SET @DepU = (SELECT u.Department From ORDR O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\t\t\t\t\t\t\t\t \r\n\tDECLARE @GroupNumBPU INT SET @GroupNumBPU = (SELECT GroupNum FROM OCRD WHERE CardCode = (SELECT CardCode FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del ))\r\n\tDECLARE @GroupNumPVU INT SET @GroupNumPVU = (SELECT GroupNum FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\t\r\n\tIF ((@dateDiffU \u003c 0) AND @DepU NOT IN (1, 2, 18, 12, 20))\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027A validade deve ter no m¡nimo \u0027 + convert(Varchar,@DDLU) + \u0027 dias\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF ((@GroupNumBPU \u003c\u003e @GroupNumPVU) AND @DepU NOT IN (1, 2, 18, 20))\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ permitido modificar a Condi‡ao de Pagamento do PN\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF ((@DescontoU \u003e 0) AND @DepU NOT IN (1, 2, 18, 20))\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ permitido definir esse tipo de desconto no Pedido\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\nEND;\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 01/02/2017\r\n-- Update date: 06/07/2017\r\n-- Description:\tTravar Cota‡ao de Vendas com Data de Validade Menor que a data atual + 2 DDL (APENAS AO ADICIONAR)\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027))--\u002723\u0027 = cota‡ao de Vendas\r\nBEGIN\r\n\r\n\tDECLARE @DocDueDateADDQ DATETIME SET @DocDueDateADDQ = (SELECT DocDueDate FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DocDateADDQ DATETIME SET @DocDateADDQ = (SELECT DocDate FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DDLADDQ INT  SET @DDLADDQ =2\r\n\tDECLARE @HoraAtualADDQ INT =  (SELECT DATEPART ( Hour , GETDATE() )  )\r\n\tDECLARE @MinutoAtualADDQ INT = (SELECT DATEPART ( MINUTE , GETDATE() )  )\r\n\tDECLARE @DescontoADDQ Float SET @DescontoADDQ =  (SELECT DiscPrcnt FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n\tDECLARE @diasemanaADDQ INT = Convert(int,(select DatePart(WEEKDAY,GETDATE())))\r\n\r\n\t\r\nIF (@diasemanaADDQ = 1) --DOMINGO\r\n\tBEGIN\r\n\t\tSET @DDLADDQ =3\r\n\tEND\r\nELSE IF(@diasemanaADDQ between 2 AND 3) -- SEGUNDA E TER€A\r\n\tBEGIN\r\n\t\tIF (@HoraAtualADDQ between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualADDQ = 11) AND (@MinutoAtualADDQ \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLADDQ =3 \r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLADDQ =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualADDQ between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLADDQ =3\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaADDQ = 4) -- QUARTA-FEIRA\r\n\tBEGIN\r\n\t\tIF (@HoraAtualADDQ between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualADDQ = 11) AND (@MinutoAtualADDQ \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLADDQ =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLADDQ =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualADDQ between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLADDQ =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaADDQ between 5 AND 6) -- QUINTA E SEXTA\r\n\tBEGIN\r\n\t\tIF (@HoraAtualADDQ between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualADDQ = 11) AND (@MinutoAtualADDQ \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLADDQ =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLADDQ =4\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualADDQ between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLADDQ =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaADDQ = 7) --SABADO\r\n\tBEGIN\r\n\t\tSET @DDLADDQ =4\r\n\tEND\r\n\r\n\tDECLARE @dateDiffADDQ INT SET @dateDiffADDQ = (SELECT DATEDIFF(DAY,@DocDateADDQ+@DDLADDQ,@DocDueDateADDQ))\r\n\t\r\n\tDECLARE @DepADDQ int SET @DepADDQ = (SELECT u.Department From OQUT O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\t\t\t\t\t\t\t\t \r\n\tDECLARE @GroupNumBPADDQ INT SET @GroupNumBPADDQ = (SELECT GroupNum FROM OCRD WHERE CardCode = (SELECT CardCode FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del ))\r\n\tDECLARE @GroupNumPVADDQ INT SET @GroupNumPVADDQ = (SELECT GroupNum FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\t\r\n\tIF ((@dateDiffADDQ \u003c 0) AND @DepADDQ = 1)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027A validade deve ter no m¡nimo \u0027+convert(Varchar,@DDLADDQ)+\u0027 dias\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF ((@GroupNumBPADDQ \u003c\u003e @GroupNumPVADDQ) AND @DepADDQ = 1)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ permitido modificar a Condi‡ao de Pagamento do PN\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF ((@DescontoADDQ \u003e 0) AND @DepADDQ = 1)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ permitido definir esse tipo de desconto no Pedido\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\nEND;\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n*/\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 01/02/2017\r\n-- Update date: 06/07/2017\r\n-- Description:\tTravar Cota‡ao de Vendas com Data de Validade Menor que a data atual + 2 DDL(APENAS AO ATUALIZAR)\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027U\u0027))--\u002723\u0027 = Cota‡ao de Vendas\r\nBEGIN\r\n\r\n\tDECLARE @DocDueDateUQ DATETIME SET @DocDueDateUQ = (SELECT DocDueDate FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DocDateUQ DATETIME SET @DocDateUQ = (SELECT DocDate FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DDLUQ INT  SET @DDLUQ =2\r\n\tDECLARE @HoraAtualUQ INT =  (SELECT DATEPART ( Hour , GETDATE() )  )\r\n\tDECLARE @MinutoAtualUQ INT = (SELECT DATEPART ( MINUTE , GETDATE() )  )\r\n\tDECLARE @DescontoUQ Float SET @DescontoUQ =  (SELECT DiscPrcnt FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n\tDECLARE @diasemanaUQ INT = Convert(int,(select DatePart(WEEKDAY,GETDATE())))\r\n\r\nIF (@diasemanaUQ = 1) --DOMINGO\r\n\tBEGIN\r\n\t\tSET @DDLUQ =3\r\n\tEND\r\nELSE IF(@diasemanaUQ between 2 AND 3) -- SEGUNDA E TER€A\r\n\tBEGIN\r\n\t\tIF (@HoraAtualUQ between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualUQ = 11) AND (@MinutoAtualUQ \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLUQ =3 \r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLUQ =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualUQ between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLUQ =3\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaUQ = 4) -- QUARTA-FEIRA\r\n\tBEGIN\r\n\t\tIF (@HoraAtualUQ between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualUQ = 11) AND (@MinutoAtualUQ \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLUQ =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLUQ =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualUQ between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLUQ =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaUQ between 5 AND 6) -- QUINTA E SEXTA\r\n\tBEGIN\r\n\t\tIF (@HoraAtualUQ between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualUQ = 11) AND (@MinutoAtualUQ \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLUQ =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLUQ =4\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualUQ between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLUQ =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaUQ = 7) --SABADO\r\n\tBEGIN\r\n\t\tSET @DDLUQ =4\r\n\tEND\r\n\t\r\n\t\r\n\tDECLARE @dateDiffUQ INT SET @dateDiffUQ = (SELECT DATEDIFF(DAY,@DocDateUQ+@DDLUQ,@DocDueDateUQ))\r\n\t\r\n\tDECLARE @DepUQ int SET @DepUQ = (SELECT u.Department From OQUT O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\t\t\t\t\t\t\t\t \r\n\tDECLARE @GroupNumBPUQ INT SET @GroupNumBPUQ = (SELECT GroupNum FROM OCRD WHERE CardCode = (SELECT CardCode FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del ))\r\n\tDECLARE @GroupNumPVUQ INT SET @GroupNumPVUQ = (SELECT GroupNum FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\t\r\n\tIF ((@dateDiffUQ \u003c 0) AND @DepUQ = 1)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027A validade deve ter no m¡nimo \u0027+convert(nvarchar,@DDLUQ)+\u0027 dias\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF ((@GroupNumBPUQ \u003c\u003e @GroupNumPVUQ) AND @DepUQ = 1)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ permitido modificar a Condi‡ao de Pagamento do PN\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF ((@DescontoUQ \u003e 0) AND @DepUQ = 1)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ permitido definir esse tipo de desconto no Pedido\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\nEND;\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n*/\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create Date: 23/05/2017\r\n-- Update Date: \r\n-- Description:\tValida‡oes de atualiza‡oes campos Rendimento\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027Rendimento\u0027) and (@transaction_type in (\u0027U\u0027))-- RENDIMENTOS\r\nBEGIN \r\n\t--VALIDAR NUMERO RECEBIMENTO\r\n\tDECLARE @NRecebU NVARCHAR (15) SET @NRecebU =(SELECT U_DocNum\tFROM [@RA_RENDIMENTO] \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE Code  = @list_of_cols_val_tab_del)\r\n\tIF NOT Exists(\r\n\tSELECT *FROM OPDN \r\n\tWHERE DocNum = @NRecebU AND DocStatus IN (\u0027O\u0027,\u0027C\u0027))\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Recebimento nao encontrado ou cancelado. Nao ‚ poss¡vel adicionar.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\r\n\t--VALIDAR NUMERO DO ITEM\r\n\tDECLARE @NProdU NVARCHAR (15) SET @NProdU =(SELECT U_ItemCode\tFROM [@RA_RENDIMENTO] \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE Code  = @list_of_cols_val_tab_del)\r\n\tIF NOT Exists(\r\n\tSELECT *FROM OITM WHERE validFor = \u0027Y\u0027 AND ItemCode = @NProdU )\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Item nao encontrado ou inativo. Nao ‚ poss¡vel adicionar.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\r\n\tDECLARE @RendNomeU NVARCHAR (30)\r\n\t\r\n\t--PREENCHIMENTO AUTOMATICO DO NOME\r\n\tSET @RendNomeU =(SELECT CONCAT(U_DocNum,\u0027 - \u0027,U_ItemCode) \r\n\t\t\t\t\t\t\tFROM [@RA_RENDIMENTO] WHERE Code  = @list_of_cols_val_tab_del )\r\n\tIF(@RendNomeU is not Null)\r\n\t\tBEGIN\r\n\t\t\tUPDATE [@RA_RENDIMENTO] SET NAME = @RendNomeU WHERE Code = @list_of_cols_val_tab_del\r\n\t\tEND\r\n\r\n\t--VALIDAR NOME\r\n\tSET @RendNomeU = (SELECT Name FROM [@RA_RENDIMENTO] \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE Code  = @list_of_cols_val_tab_del)\r\n\tIF Exists(\r\n\tSELECT Name FROM [@RA_RENDIMENTO]\tWHERE Name = @RendNomeU AND Code \u003c\u003e@list_of_cols_val_tab_del)\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Rendimento j  cadastrado. Nao ‚ poss¡vel adicionar\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 09/05/2017\r\n-- Description:\tAtualizar Quantidade Real\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002720\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002720\u0027 = Recebimento de Mercadoria\r\n\r\nBEGIN\r\nDECLARE @QRealCab int = (SELECT U_MW_QuantReal FROM OPDN WHERE DocNum =  @list_of_cols_val_tab_del )\r\nDECLARE @StatusImp Varchar (20) = (SELECT U_MW_STATUSIMP FROM OPDN WHERE DocNum =  @list_of_cols_val_tab_del )\r\n\r\n\tIF(@StatusImp = \u0027RECEBIDO\u0027 AND (@QRealCab IS NULL OR @QRealCab = 0))\r\n\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Informar Quantidade Real\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\tEND \r\n\r\n\tIF(@QRealCab IS NOT NULL AND @QRealCab \u003e 0)\r\n\tBEGIN\r\n\t\tIF(@StatusImp = \u0027RECEBIDO\u0027)\r\n\t\tBEGIN\r\n\t\t\tUPDATE  PDN1 SET U_MW_QUANTIREAL = @QRealCab WHERE DocEntry = @list_of_cols_val_tab_del;\r\n\t\tEND \r\n\t\tELSE\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Verificar Status Importa‡ao\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\tEND \r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create Date: 18/04/2017\r\n-- Update Date: \r\n-- Description:\tBloquear campos Rendimento\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027Rendimento\u0027) and (@transaction_type in (\u0027A\u0027))-- RENDIMENTOS\r\nBEGIN \r\n\t--VALIDAR NUMERO RECEBIMENTO\r\n\tDECLARE @NReceb NVARCHAR (15) SET @NReceb =(SELECT U_DocNum\tFROM [@RA_RENDIMENTO] \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE Code  = @list_of_cols_val_tab_del)\r\n\tIF NOT Exists(\r\n\tSELECT *FROM OPDN \r\n\tWHERE DocNum = @NReceb AND DocStatus IN (\u0027O\u0027,\u0027C\u0027))\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Recebimento nao encontrado ou cancelado. Nao ‚ poss¡vel adicionar.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\r\n\t--VALIDAR NUMERO DO ITEM\r\n\tDECLARE @NProd NVARCHAR (15) SET @NProd =(SELECT U_ItemCode\tFROM [@RA_RENDIMENTO] \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE Code  = @list_of_cols_val_tab_del)\r\n\tIF NOT Exists(\r\n\tSELECT *FROM OITM WHERE validFor = \u0027Y\u0027 AND ItemCode = @NProd )\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Item nao encontrado ou inativo. Nao ‚ poss¡vel adicionar.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\r\n\tDECLARE @RendNome NVARCHAR (30)\r\n\t\r\n\t--PREENCHIMENTO AUTOMATICO DO NOME\r\n\tSET @RendNome =(SELECT CONCAT(U_DocNum,\u0027 - \u0027,U_ItemCode) \r\n\t\t\t\t\t\t\tFROM [@RA_RENDIMENTO] WHERE Code  = @list_of_cols_val_tab_del )\r\n\tIF(@RendNome is not Null)\r\n\t\tBEGIN\r\n\t\t\tUPDATE [@RA_RENDIMENTO] SET NAME = @RendNome WHERE Code = @list_of_cols_val_tab_del\r\n\t\tEND\r\n\r\n\t--VALIDAR NOME\r\n\tSET @RendNome = (SELECT Name FROM [@RA_RENDIMENTO] \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE Code  = @list_of_cols_val_tab_del)\r\n\tIF Exists(\r\n\tSELECT Name FROM [@RA_RENDIMENTO]\tWHERE Name = @RendNome AND Code \u003c\u003e@list_of_cols_val_tab_del)\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Rendimento j  cadastrado. Nao ‚ poss¡vel adicionar\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 12/04/2017\r\n-- Update Date: \r\n-- Description:\tBloquear Dev NF de Sa¡da sem Regra de Distribui‡ao,Utiliza‡ao e C¢digo de imposto\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002714\u0027 = DEV NF DE SAIDA\r\n\r\nBEGIN\r\n\tDECLARE @DocEntryDNFS int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeDNFS char = (SELECT DocType FROM ORIN  WHERE DocEntry = @DocEntryDNFS)\r\n\r\n\t--Utiliza‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tORIN O\r\n\t\t\t    INNER JOIN RIN1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryDNFS AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\tIF( @DocTypeDNFS = \u0027I\u0027)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027Dev NF de Sa¡da - Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\tEND\r\n\r\n\t\t--C¢digo de imposto\r\n\t\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tORIN O\r\n\t\t\t    INNER JOIN RIN1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryDNFS AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Dev NF de Sa¡da - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\t\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 12/04/2017\r\n-- Update Date: \r\n-- Description:\tBloquear DEV NF ENTRADA sem Regra de Distribui‡ao,Utiliza‡ao e C¢digo de imposto\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002719\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002719\u0027 = DEV NF DE ENTRADA\r\n\r\nBEGIN\r\n\tDECLARE @DocEntryDNFE int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeDNFE char = (SELECT DocType FROM ORPC WHERE DocEntry = @DocEntryDNFE)\r\n\t--Utiliza‡ao\r\n\tIF EXISTS (\r\n\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tORPC O\r\n\t\t\t    INNER JOIN RPC1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryDNFE AND OL.OcrCode IS NULL)\t\t\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tif (@DocTypeDNFE = \u0027I\u0027)\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\t\tSET @error_message = \u0027DEV NF ENTRADA - Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\r\n\t\t--C¢digo de imposto\r\n\t\tIF EXISTS (\r\n\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tORPC O\r\n\t\t\t    INNER JOIN RPC1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryDNFE AND OL.OcrCode IS NULL)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027DEV NF ENTRADA - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 12/04/2017\r\n-- Update Date: \r\n-- Description:\tBloquear NF ENTRADA sem Regra de Distribui‡ao,Utiliza‡ao e C¢digo de imposto\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002718\u0027 = NF DE ENTRADA\r\n\r\nBEGIN\r\n\tDECLARE @DocEntryNFE int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeNFE char = (SELECT DocType FROM OPCH WHERE DocEntry = @DocEntryNFE)\r\n\t--C¢digo de imposto\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tOPCH O\r\n\t\t\t    INNER JOIN PCH1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryNFE AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027NF ENTRADA - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 12/04/2017\r\n-- Update Date: \r\n-- Description:\tBloquear NF de Sa¡da sem Regra de Distribui‡ao,Utiliza‡ao e C¢digo de imposto\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002713\u0027 = NF DE SAIDA\r\n\r\nBEGIN\r\n\t\r\n\tDECLARE @DocEntryNFS int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeNFS char = (SELECT DocType FROM OINV WHERE DocEntry = @DocEntryNFS)\r\n\r\n\t--Utiliza‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tOINV O\r\n\t\t\t    INNER JOIN INV1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryNFS AND OL.OcrCode IS NULL)\r\n\t\t\t\tBEGIN\r\n\t\t\t\tif (@DocTypeNFS = \u0027I\u0027)\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\t\tSET @error_message = \u0027Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\r\n\t--C¢digo de imposto\r\n\t--IF EXISTS(\r\n\t--\t\tSELECT \r\n\t--\t\t\tOL.TaxCode\r\n\t--\t\tFROM \r\n\t--\t\t\tOINV O\r\n\t--\t\t    INNER JOIN INV1 OL ON O.DocEntry = ol.DocEntry\r\n\t--\t\tWHERE o.DocEntry = @DocEntryNFS AND OL.OcrCode IS NULL AND )\r\n\t--\t\t\tBEGIN\r\n\t--\t\t\t\tSET @error = -1\r\n\t--\t\t\t\tSET @error_message = \u0027Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t--\t\t\t\tSELECT @error, @error_message\r\n\t--\t\t\tEND\r\n\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 03/01/2017\r\n-- Description:\tAtualizar o campo Regra de Distribui‡ao nas Linhas do Pedido (ESBO€O)\r\n-- OBS:UPDATE IRREGULAR AUTORIZADO PELO ROBSON VIA CHAMADO 2271\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\tDECLARE @ContEsb int = 0\t\r\n\tDECLARE @CentroCustosEsb NVarchar (255)\r\n\t--DECLARE @IDPedido int = @list_of_cols_val_tab_del\r\n\tDECLARE @TotalLinhasEsb  int = (SELECT MAX(LineNum) FROM DRF1 WHERE ObjType = 17 AND DocEntry = @list_of_cols_val_tab_del)\t\r\n\r\n\tWHILE(@ContEsb \u003c @TotalLinhasEsb+1)\r\n\t\tBEGIN\r\n\t\t\tSET @CentroCustosEsb= (\r\n\t\t\t\r\n\t\t\tSELECT  \r\n\t\t\t\tI.[U_MW_CENTRO]\r\n\t\tFROM\r\n\t\tDRF1 T1\t\t\r\n\t\tINNER JOIN OITM I ON T1.ItemCode = I.ItemCode\r\n\t\tWHERE  T1.ObjType = 17 AND T1.DocEntry = @list_of_cols_val_tab_del AND T1.LineNum = @ContEsb)\r\n\t\t\r\n\r\n\t\t\tif ( @CentroCustosEsb  is not null AND @CentroCustosEsb \u003c\u003e \u0027\u0027)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE DRF1\tSET OcrCode = @CentroCustosEsb, CogsOcrCod = @CentroCustosEsb \r\n\t\t\t\t\tWHERE ObjType = 17 AND DocEntry = @list_of_cols_val_tab_del AND LineNum =  @ContEsb\r\n\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\t\t\r\n\t\t\tSET @ContEsb = @ContEsb + 1\r\n\t\tEND;\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 16/03/2017\r\n-- update date: \r\n-- Description:\tAtualizar o campo Regra de Distribui‡ao nas Linhas do Pedido de Compra \r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002722\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002722\u0027 = Pedido de compra frete\r\n\r\nBEGIN\r\n\tDECLARE @ContOPOR int = 0\t\r\n\tDECLARE @CentroCustosOPOR NVarchar (255)\r\n\t--DECLARE @IDPedido int = @list_of_cols_val_tab_del\r\n\tDECLARE @TotalLinhasOPOR  int = (SELECT MAX(LineNum) FROM POR1 WHERE DocEntry = @list_of_cols_val_tab_del)\t\r\n\r\n\tWHILE(@ContOPOR \u003c @TotalLinhasOPOR+1)\r\n\t\tBEGIN\r\n\t\t\tSET @CentroCustosOPOR = (\r\n\t\t\t\r\n\t\t\tSELECT  \r\n\t\t\t\tI.[U_MW_CENTRO]  \r\n\t\t\tFROM \r\n\t\t\t\tOITM I\r\n\t\t\t\tINNER JOIN POR1 T1 ON I.ItemCode = T1.ItemCode\r\n\t\t\tWHERE T1.DocEntry = @list_of_cols_val_tab_del AND T1.LineNum = @ContOPOR)\r\n\t\t\r\n\r\n\t\t\tif ( @CentroCustosOPOR  is not null AND @CentroCustosOPOR \u003c\u003e \u0027\u0027)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE POR1\tSET OcrCode = @CentroCustosOPOR, CogsOcrCod = @CentroCustosOPOR WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum =  @ContOPOR\r\n\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\t\t\r\n\t\t\tSET @ContOPOR = @ContOPOR+ 1\r\n\t\tEND;\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 03/01/2017\r\n-- update date: 15/03/2017\r\n-- Description:\tAtualizar o campo Regra de Distribui‡ao nas Linhas do Pedido\r\n-- OBS:UPDATE IRREGULAR AUTORIZADO PELO ROBSON VIA CHAMADO 2271\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\tDECLARE @Cont int = 0\t\r\n\tDECLARE @CentroCustos NVarchar (255)\r\n\t--DECLARE @IDPedido int = @list_of_cols_val_tab_del\r\n\tDECLARE @TotalLinhas  int = (SELECT MAX(LineNum) FROM rdr1 WHERE DocEntry = @list_of_cols_val_tab_del)\t\r\n\r\n\tWHILE(@Cont \u003c @TotalLinhas+1)\r\n\t\tBEGIN\r\n\t\t\tSET @CentroCustos = (\r\n\t\t\t\r\n\t\t\tSELECT  \r\n\t\t\t\tI.[U_MW_CENTRO]\r\n\t\t\tFROM \r\n\t\t\t\tOITM I\r\n\t\t\t\tINNER JOIN RDR1 T1 ON I.ItemCode = T1.ItemCode\r\n\t\t\tWHERE T1.DocEntry = @list_of_cols_val_tab_del AND T1.LineNum = @Cont)\r\n\t\t\r\n\r\n\t\t\tif ( @CentroCustos  is not null AND @CentroCustos \u003c\u003e \u0027\u0027)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE RDR1\tSET OcrCode = @CentroCustos, CogsOcrCod = @CentroCustos WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum =  @Cont\r\n\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\t\t\r\n\t\t\tSET @Cont = @Cont + 1\r\n\t\tEND;\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n-----------------------------------------------------------------------------------------------------------------------------\r\n------ Author: Henrique Truyts \r\n------ Create date: 02/04/2019\r\n------ Update date: 14/08/2019\r\n------ Documentos:  Pedido de Venda, Solicita‡ao de Compra,Pedido de Compra, Oferta de Compra E Esbo‡os\r\n------ GLPI ID: 6734\r\n------ GLPI ID Atualiza‡oes: 8927 - Sa¡da de mercadorias sendo adicionadas sem regra de distribui‡ao\r\n------ GLPI ID Atualiza‡oes: 13866 - Almoxarifado pode adicionar solicita‡ao de compra sem o preenchimento dos campos\r\n-- Description:\tBloquear Documentos sem Regra de Distribui‡ao,Utiliza‡ao e C¢digo de imposto\r\n\r\n---------------------------------------------------------------------------------------------------------------------------\r\n\r\n------------------------------------------------ Pedido de Venda------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\t\r\n\tDECLARE @DocEntryPV int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypePV char = (SELECT DocType FROM ORDR WHERE DocEntry = @DocEntryPV)\r\n\r\n\t--Regra de Distribui‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.OcrCode \r\n\t\t\tFROM \r\n\t\t\t\tORDR O\r\n\t\t\t    INNER JOIN RDR1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryPV AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6734\r\n\t\t\tSET @error_message = \u0027Pedidos de Venda - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\t--Utiliza‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tORDR O\r\n\t\t\t    INNER JOIN RDR1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryPV AND OL.OcrCode IS NULL)\r\n\tBEGIN\r\n\t\tIF ( @DocTypePV = \u0027I\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6734\r\n\t\t\tSET @error_message = \u0027Pedidos de Venda - Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\n\r\n\t--C¢digo de imposto\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tORDR O\r\n\t\t\t    INNER JOIN RDR1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryPV AND OL.OcrCode IS NULL)\r\n\tBEGIN\r\n\t\tSET @error = -6734\r\n\t\tSET @error_message = \u0027Pedidos de Venda - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\t\t\r\nEND;\r\n------------------------------------------------ Solicita‡ao de Compra ------------------------------------------------\r\nIF (@object_type = \u00271470000113\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Solicita‡ao de Compra\r\n\r\nDECLARE @UserSign6734SC int = (SELECT UserSign2 FROM OPRQ WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Dep6734SC int SET @Dep6734SC = (SELECT Department FROM OUSR WHERE USERID = @UserSign6734SC)\r\n\r\nIF(@Dep6734SC NOT IN (22))\r\nBEGIN\r\n\r\nBEGIN \r\n IF (SELECT \r\n\t\tCOUNT(*) \r\n\t FROM\r\n\t\tPRQ1 SC\r\n\t\tWHERE \r\n\t\t(SC.DocEntry = @list_of_cols_val_tab_del) AND (SC.OcrCode = \u0027\u0027 OR SC.OcrCode IS NULL)) \u003e 0\r\n BEGIN\r\n  SET @error = -6734\r\n  SET @error_message = \u0027Solicita‡ao de Compra - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n  SELECT @error, @error_message\r\n   \r\n END;\r\n --Utiliza‡ao obrigatoria\r\n IF (SELECT \r\n\t\tCOUNT(*)\r\n\t FROM\r\n\t\tPRQ1 SC\r\n\tWHERE \r\n\t\t(SC.DocEntry = @list_of_cols_val_tab_del) AND (SC.usage = \u0027\u0027 OR SC.usage IS NULL)) \u003e 0\r\n BEGIN \r\n  SET @error = -6734\r\n  SET @error_message = \u0027Solicita‡ao de Compra - Nao foi poss¡vel concluir.  necess rio definir a Utiliza‡ao.\u0027\r\n  SELECT @error, @error_message\r\n\r\n END;\r\nEND;\r\nEND\r\n\r\n------------------------------------------------ Pedido de Compra ------------------------------------------------\r\nIF (@object_type = \u002722\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002722\u0027 = Pedido de Compras\r\n\r\nBEGIN\r\n\r\n\tDECLARE @DocEntryPC int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypePC char = (SELECT DocType FROM OPOR WHERE DocEntry = @DocEntryPC)\r\n\r\n\t--Regra de Distribui‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.OcrCode \r\n\t\t\tFROM \r\n\t\t\t\tOPOR O\r\n\t\t\t    INNER JOIN POR1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryPC AND OL.OcrCode IS NULL)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -6734\r\n\t\t\t\t\tSET @error_message = \u0027Pedidos de Compra - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\r\n\t--Utiliza‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tOPOR O\r\n\t\t\t    INNER JOIN POR1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryPC AND OL.OcrCode IS NULL)\r\n\t\t\tBEGIN\r\n\t\t\t\tif (@DocTypePC = \u0027I\u0027)\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @error = -6734\r\n\t\t\t\t\t\tSET @error_message = \u0027Pedidos de Compra - Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\tEND\r\n\t\t\tEND\r\n\r\n\t\t--C¢digo de imposto\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tOPOR O\r\n\t\t\t    INNER JOIN POR1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryPC AND OL.OcrCode IS NULL)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -6734\r\n\t\t\t\t\tSET @error_message = \u0027Pedidos de Compra - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\r\n\t\t\r\nEND;\r\n------------------------------------------------ Oferta de Compra 540000006\r\nIF (@object_type = \u0027540000006\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u0027 540000006\u0027 = Oferta de Compras\r\n\r\nBEGIN\r\n\r\n\tDECLARE @DocEntryOFC int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeOFC char = (SELECT DocType FROM OPQT WHERE DocEntry = @DocEntryOFC)\r\n\r\n\t--Regra de Distribui‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.OcrCode \r\n\t\t\tFROM \r\n\t\t\t\tOPQT O\r\n\t\t\t    INNER JOIN PQT1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryOFC AND OL.OcrCode IS NULL)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -6734\r\n\t\t\t\t\tSET @error_message = \u0027Oferta de Compra - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\r\n\t--Utiliza‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tOPQT O\r\n\t\t\t    INNER JOIN PQT1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryOFC AND OL.OcrCode IS NULL)\r\n\t\t\tBEGIN\r\n\t\t\t\tif (@DocTypeOFC = \u0027I\u0027)\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @error = -6734\r\n\t\t\t\t\t\tSET @error_message = \u0027Oferta de Compra - Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\tEND\r\n\t\t\tEND\r\n\r\n\t\t--C¢digo de imposto\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tOPQT O\r\n\t\t\t    INNER JOIN PQT1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryOFC AND OL.OcrCode IS NULL)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -6734\r\n\t\t\t\t\tSET @error_message = \u0027OFerta de Compra - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\t\t\r\nEND;\r\n\r\n------------------------------------------------ Sa¡da de mercadorias ------------------------------------------------\r\nIF (@object_type = \u002760\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002760\u0027 = Sa¡da de mercadorias\r\n\r\nBEGIN\r\n\t\r\n\tDECLARE @DocEntrySM int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeSM char = (SELECT DocType FROM OIGE WHERE DocEntry = @DocEntrySM)\r\n\r\n\t--Regra de Distribui‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.OcrCode \r\n\t\t\tFROM \r\n\t\t\t\tOIGE O\r\n\t\t\t    INNER JOIN IGE1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntrySM AND (OL.OcrCode IS NULL OR OL.OcrCode = \u0027\u0027) AND (OL.AcctCode LIKE \u00274%\u0027 OR OL.AcctCode LIKE \u00275%\u0027))\r\n\t\tBEGIN\r\n\t\t\tSET @error = 6734\r\n\t\t\tSET @error_message = \u0027Sa¡da de mercadorias - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\nEND;\r\n\r\n------------------------------------------------ Esbo‡os Todos os Documentos acima\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--N\u0027112\u0027 = ESBO€O\r\n\r\nBEGIN\r\n\tDECLARE @DocEntryESB int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeESB char = (SELECT DocType FROM ODRF \r\n\t\t\t\t\t\t\tWHERE objtype in (17,1470000113,22,540000006,60) AND DocEntry = @DocEntryESB)\r\n\r\n\t--Regra de Distribui‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.OcrCode \r\n\t\t\tFROM \r\n\t\t\t\tODRF O\r\n\t\t\t    INNER JOIN DRF1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.objtype in (17,1470000113,22,540000006,60) AND o.DocEntry = @DocEntryESB AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6734\r\n\t\t\tSET @error_message = \u0027Esbo‡o - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\t--Utiliza‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tODRF O\r\n\t\t\t    INNER JOIN DRF1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.objtype in (17,1470000113,22,540000006) AND o.DocEntry = @DocEntryESB AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\tIF(@DocTypeESB = \u0027I\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -6734\r\n\t\t\t\tSET @error_message = \u0027Esbo‡o - Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tEND\r\n\r\n\t--C¢digo de imposto\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tODRF O\r\n\t\t\t    INNER JOIN DRF1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.objtype in (17,1470000113,22,540000006) AND o.DocEntry = @DocEntryESB AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6734\r\n\t\t\tSET @error_message = \u0027Esbo‡o - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\t\r\nEND;\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 03/01/2017\r\n-- Update Date: 16/02/2017\r\n-- Description:\tAtualizar o campo Comissao na Linha do Pedido Com base no cadastro de comissao do vendedor\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\tDECLARE @Contador int = 0\t\r\n\tDECLARE @Comissao float = 0\r\n\tDECLARE @DocEntry int = @list_of_cols_val_tab_del\r\n\tDECLARE @CardCodeComission Nvarchar (20) = (SELECT CardCode FROM ORDR WHERE DocEntry = @DocEntry)\r\n\tDECLARE @ComissaoEspecial float = 0\r\n\tDECLARE @QtyLines  int = (SELECT MAX(LineNum) FROM rdr1 WHERE DocEntry = @DocEntry)\t\r\n\r\n\r\n\tSet @ComissaoEspecial = (SELECT U_RA_Comissao_Especial FROM OCRD WHERE CardCode = @CardCodeComission)\r\n\t\t\r\n\tWHILE(@Contador \u003c @QtyLines+1)\r\n\t\tBEGIN\r\n\t\t\tIF(@ComissaoEspecial is not null AND @ComissaoEspecial \u003e0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @Comissao = @ComissaoEspecial\r\n\t\t\t\tEND\r\n\t\t\tELSE \r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @Comissao = (\r\n\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\tc.U_MW_PRCT\r\n\t\t\t\t\t\tFROM\t\r\n\t\t\t\t\t\t\t[@MW_CDV1] C\r\n\t\t\t\t\t\tINNER JOIN [@MW_CDV0] C0 ON C0.Code = C.Code\r\n\t\t\t\t\t\tINNER JOIN OSLP V ON V.SlpName = C0.U_MW_SlpCode\r\n\t\t\t\t\t\tINNER JOIN ORDR O ON O.SlpCode = v.SlpCode\r\n\t\t\t\t\t\tINNER JOIN RDR1 OL ON OL.DocEntry = o.DocEntry AND c.U_MW_ItemCode = ol.ItemCode\r\n\t\t\t\t\t\tWHERE o.DocNum = @DocEntry AND ol.LineNum = @Contador)\r\n\t\t\t\tEND\r\n\r\n\t\t\tif (@Comissao \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE RDR1\tSET U_MW_PCOM = @Comissao WHERE DocEntry = @DocEntry AND LineNum =  @Contador\r\n\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\t\t\r\n\t\t\tSET @Contador = @Contador + 1\r\n\t\tEND;\r\n\t\t\r\nEND;\r\n\r\n\r\n\r\n\r\n-----------------------------------------------------------------------------------------------------------\r\n---- SPS CONSULTORIA\r\n---- BLOQUEIA ADICIONAR PEDIDO DE VENDA QUANDO O PN POSSUI BOLETOS EM ABERTO - BANKPLUS\r\n---- Description Update: Acrescentado mais um documento na trava, e atualizado AND com as datas.\r\n---- Criado: GISLAINE FERNANDES\r\n---- Atualizado: LEONARDO DO PRADO GOMES\r\n---- Data Cria‡ao:16/11/2023\r\n---- Data Update: 08/01/2024\r\n-----------------------------------------------------------------------------------------------------------\r\n/*\r\nIF  @object_type in (\u002717\u0027, \u002723\u0027) AND @Transaction_type in (\u0027A\u0027)\r\nBEGIN \r\n\tDECLARE @CardCode NVARCHAR (20)\r\n\tSET @CardCode = (select CardCode From ORDR where DocEntry = @list_of_cols_val_tab_del)\r\n\tDECLARE @BolAti INT \r\n\r\n\tIF @object_type = 17 \r\n\t\tBEGIN \r\n\t\t\tset @BolAti = (  \r\n\t\t\t\t\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t\t\t\tCOUNT (*)\r\n\t\t\t\t\t\t\t\t\t\t\t\tFROM OINV T0\r\n\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [IV_IB_BillOfExchange] T1 ON T0.Serial = T1.Document\r\n\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN INV6 T2 ON T0.DocEntry = T2.DocEntry\r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = @CardCode\r\n\t\t\t\t\t\t\t\t\t\t\t\t  AND T1.DocType = 13 \r\n\t\t\t\t\t\t\t\t\t\t\t\t  AND T2.InstlmntID = T1.InstallmentID\r\n\t\t\t\t\t\t\t\t\t\t\t\t  AND T1.Status in (1,3) AND T0.CANCELED = \u0027N\u0027  \r\n\t\t\t\t\t\t\t\t\t\t\t\t  --AND t1.DueDate \u003c GETDATE()\r\n\t\t\t\t\t\t\t\t\t\t\t\t  AND CONVERT(DATE, T1.DueDate) \u003c CONVERT(DATE, GETDATE())\r\n\t\t\t\t\t\t\t\t\t\t\t  )\r\n\t\t\t\t\t  IF @BolAti \u003e 0\r\n\r\n\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\tSET @error = 1\r\n\t\t\t\t\t\t\tSET @error_message = N\u0027SPS PEDIDO DE VENDAS - EXISTEM BOLETOS EM ABERTO PARA ESTE CLIENTE, GENTILEZA PROCURAR CRDITO E COBRAN€A!\u0027\r\n\t\t\t\t\t\tEND;  \r\n\t\t\tEND;\r\n\tELSE \r\n\t   BEGIN\r\n\r\n\t\t   set @BolAti = (  \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tCOUNT (*)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tFROM OINV T0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [IV_IB_BillOfExchange] T1 ON T0.Serial = T1.Document\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN INV6 T2 ON T0.DocEntry = T2.DocEntry\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = @CardCode\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t  AND T1.DocType = 13 \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t  AND T2.InstlmntID = T1.InstallmentID\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t  AND T1.Status in (1,3) AND T0.CANCELED = \u0027N\u0027  \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t  --AND t1.DueDate \u003c GETDATE()\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t  AND CONVERT(DATE, T1.DueDate) \u003c CONVERT(DATE, GETDATE())\r\n\t\t\t\t\t\t\t\t\t\t\t\t  )\r\n\t\t\t\t\t\t  IF @BolAti \u003e 0\r\n\r\n\t\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\t\tSET @error = 1\r\n\t\t\t\t\t\t\t\tSET @error_message = N\u0027SPS COTA€AO DE VENDAS - EXISTEM BOLETOS EM ABERTO PARA ESTE CLIENTE, GENTILEZA PROCURAR CRDITO E COBRAN€A!\u0027\r\n\t\t\t\t\t\t\tEND;  \r\n\t   END \r\n    \r\nEND;    \r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n*/\r\n\r\n\r\n\r\n\r\n\r--Start IntegrationBank\nDECLARE @companyDbIntBank nvarchar(128)\r\nSET @companyDbIntBank =  (SELECT DB_NAME())\r\nEXEC [IV_IB_TransNotificationValidateIntBank] @companyDbIntBank, @companyDbIntBank, \u0027IV_IB_Setting\u0027, \u0027IV_IB_BillOfExchange\u0027, \u0027IV_IB_BillOfExchangeInstallment\u0027, \u0027IV_IB_CompanyLocal\u0027, @object_type, @transaction_type, @list_of_cols_val_tab_del, @error OUTPUT, @error_message OUTPUT\r\n--End IntegrationBank--Start BankPlus\nDECLARE @BancoDeDados nvarchar(128)\r\nSET @BancoDeDados =  (SELECT DB_NAME())\r\nEXEC [IV_IB_TransacaoValidacaoPagamentoBankPlus] @BancoDeDados, @object_type, @transaction_type, @list_of_cols_val_tab_del, @error OUTPUT, @error_message OUTPUT\r\n--End BankPlus\n-- Select the return values\r\n\r\n\r\nselect @error, @error_message\r\n\r\nend\r\n"],"HasErrors":false,"Column1":"\r\n\r\n\r\n\r\n\r\nCREATE PROC [dbo].[SBO_SP_TransactionNotification] \r\n\r\n@object_type nvarchar(20), \t\t\t\t-- SBO Object Type\r\n@transaction_type nchar(1),\t\t\t-- [A]dd, [U]pdate, [D]elete, [C]ancel, C[L]ose\r\n@num_of_cols_in_key int,\r\n@list_of_key_cols_tab_del nvarchar(255),\r\n@list_of_cols_val_tab_del nvarchar(255)\r\n\r\nAS\r\n\r\nbegin\r\n\r\n-- Return values\r\ndeclare @error  int\t\t\t\t-- Result (0 for no error)\r\ndeclare @error_message nvarchar (200) \t\t-- Error string to be displayed\r\nselect @error = 0\r\nselect @error_message = N\u0027Ok\u0027\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--\tADD\tYOUR\tCODE\tHERE\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 12/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto na DEV. NOTA FISCAL DE ENTRADA\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF(@object_type = \u002719\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\r\n\t\r\n\tDECLARE @ControllerInt121220253 INT;\r\n\tSET @ControllerInt121220253 = 0;\r\n\r\n\tDECLARE @QtyLines121220253 INT\r\n\tSET @QtyLines121220253 = (SELECT COUNT(T0.DocEntry) FROM RPC1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto121220253 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn121220253 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt121220253 \u003c @QtyLines121220253)\r\n\tBEGIN\r\n\t\t\r\n\t\tSET @CodImposto121220253 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\t\tFROM RPC1 T0 \r\n\t\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt121220253);\r\n\r\n\t\t\tSET @CstCodeIn121220253 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\t\tSET @CstCodeIn121220253 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto121220253\r\n\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\r\n\t\t\tIF(@CstCodeIn121220253 IS NOT NULL AND @CstCodeIn121220253 \u003c\u003e \u0027\u0027)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\tUPDATE RPC1\r\n\t\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn121220253\r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND LineNum = @ControllerInt121220253;\r\n\r\n\t\t\tEND\r\n\r\n\t\t\tSET @ControllerInt121220253 = @ControllerInt121220253 + 1\r\n\r\n\r\n\tEND\r\n\r\n\r\n\r\n\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 12/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto na NOTA FISCAL DE ENTRADA E NOTA FISCAL DE RECEBIMENTO FUTURO\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF(@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\t\r\n\tDECLARE @ControllerInt121220252 INT;\r\n\tSET @ControllerInt121220252 = 0;\r\n\r\n\tDECLARE @QtyLines121220252 INT\r\n\tSET @QtyLines121220252 = (SELECT COUNT(T0.DocEntry) FROM PCH1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto121220252 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn121220252 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt121220252 \u003c @QtyLines121220252)\r\n\tBEGIN\r\n\r\n\t\t\t\r\n\t\t\tSET @CodImposto121220252 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\t\tFROM PCH1 T0 \r\n\t\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt121220252);\r\n\r\n\t\t\tSET @CstCodeIn121220252 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\t\tSET @CstCodeIn121220252 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto121220252\r\n\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\r\n\t\t\tIF(@CstCodeIn121220252 IS NOT NULL AND @CstCodeIn121220252 \u003c\u003e \u0027\u0027)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\tUPDATE PCH1\r\n\t\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn121220252\r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND LineNum = @ControllerInt121220252;\r\n\r\n\t\t\tEND\r\n\r\n\t\t\tSET @ControllerInt121220252 = @ControllerInt121220252 + 1\r\n\r\n\tEND\r\n\r\n\r\nEND\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 12/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto no DEVOLU€AO DE MERCADORIA\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF(@object_type = \u002721\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\r\n\r\n\tDECLARE @ControllerInt121220251 INT;\r\n\tSET @ControllerInt121220251 = 0;\r\n\r\n\tDECLARE @QtyLines121220251 INT\r\n\tSET @QtyLines121220251 = (SELECT COUNT(T0.DocEntry) FROM RPD1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto121220251 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn121220251 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt121220251 \u003c @QtyLines121220251)\r\n\tBEGIN\r\n\r\n\r\n\t\tSET @CodImposto121220251 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\t\tFROM RPD1 T0 \r\n\t\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt121220251);\r\n\r\n\t\t\tSET @CstCodeIn121220251 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\t\tSET @CstCodeIn121220251 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto121220251\r\n\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\r\n\t\t\tIF(@CstCodeIn121220251 IS NOT NULL AND @CstCodeIn121220251 \u003c\u003e \u0027\u0027)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\tUPDATE RPD1\r\n\t\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn121220251\r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND LineNum = @ControllerInt121220251;\r\n\r\n\t\t\tEND\r\n\r\n\t\t\tSET @ControllerInt121220251 = @ControllerInt121220251 + 1\r\n\r\n\tEND\r\n\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 12/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto no RECEBIMENTO DE MERCADORIA\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF(@object_type = \u002720\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\r\n\tDECLARE @ControllerInt12122025 INT;\r\n\tSET @ControllerInt12122025 = 0;\r\n\r\n\tDECLARE @QtyLines12122025 INT\r\n\tSET @QtyLines12122025 = (SELECT COUNT(T0.DocEntry) FROM PDN1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto12122025 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn12122025 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt12122025 \u003c @QtyLines12122025)\r\n\tBEGIN\r\n\r\n\t\t\tSET @CodImposto12122025 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\t\tFROM PDN1 T0 \r\n\t\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt12122025);\r\n\r\n\t\t\tSET @CstCodeIn12122025 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\t\tSET @CstCodeIn12122025 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto12122025\r\n\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\r\n\t\t\tIF(@CstCodeIn12122025 IS NOT NULL AND @CstCodeIn12122025 \u003c\u003e \u0027\u0027)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\tUPDATE PDN1\r\n\t\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn12122025\r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND LineNum = @ControllerInt12122025;\r\n\r\n\t\t\tEND\r\n\r\n\t\t\tSET @ControllerInt12122025 = @ControllerInt12122025 + 1\r\n\r\n\tEND\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 20/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto na DEV. nota fiscal de saida\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF(@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\r\nDECLARE @ControllerInt201220251 INT;\r\n\tSET @ControllerInt201220251 = 0;\r\n\r\n\tDECLARE @QtyLines201220251 INT\r\n\tSET @QtyLines201220251 = (SELECT COUNT(T0.DocEntry) FROM RIN1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto201220251 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn201220251 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt201220251 \u003c @QtyLines201220251)\r\n\tBEGIN\r\n\r\n\t\tSET @CodImposto201220251 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\tFROM RIN1 T0 \r\n\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt201220251);\r\n\r\n\r\n\t    SET @CstCodeIn201220251 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\tSET @CstCodeIn201220251 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto201220251\r\n\t\t\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\t\t\r\n\r\n\t\tIF(@CstCodeIn201220251 IS NOT NULL AND @CstCodeIn201220251 \u003c\u003e \u0027\u0027)\r\n\t\tBEGIN\r\n\r\n\t\t\tUPDATE RIN1\r\n\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn201220251\r\n\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\tAND LineNum = @ControllerInt201220251;\r\n\r\n\t\tEND\r\n\r\n\r\n\t\tSET @ControllerInt201220251 = @ControllerInt201220251 + 1\r\n\r\n\tEND\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 20/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto na nota fiscal de saida\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF(@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\r\n\tDECLARE @ControllerInt20122025 INT;\r\n\tSET @ControllerInt20122025 = 0;\r\n\r\n\tDECLARE @QtyLines20122025 INT\r\n\tSET @QtyLines20122025 = (SELECT COUNT(T0.DocEntry) FROM INV1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto20122025 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn20122025 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt20122025 \u003c @QtyLines20122025)\r\n\tBEGIN\r\n\r\n\t\tSET @CodImposto20122025 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\tFROM INV1 T0 \r\n\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt20122025);\r\n\r\n\r\n\t    SET @CstCodeIn20122025 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\tSET @CstCodeIn20122025 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto20122025\r\n\t\t\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\t\t\r\n\r\n\t\tIF(@CstCodeIn20122025 IS NOT NULL AND @CstCodeIn20122025 \u003c\u003e \u0027\u0027)\r\n\t\tBEGIN\r\n\r\n\t\t\tUPDATE INV1\r\n\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn20122025\r\n\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\tAND LineNum = @ControllerInt20122025;\r\n\r\n\t\tEND\r\n\r\n\r\n\t\tSET @ControllerInt20122025 = @ControllerInt20122025 + 1\r\n\r\n\tEND\r\n\r\n\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 09/12/2025\r\n-- Description: Bloco criado para PREENCHER o campo do CclassTrib direto no pedido\r\n-- GLPI IDs: -\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF(@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))\r\nBEGIN\r\n\t\r\n\tDECLARE @ControllerInt09122025 INT;\r\n\tSET @ControllerInt09122025 = 0;\r\n\r\n\tDECLARE @QtyLines09122025 INT\r\n\tSET @QtyLines09122025 = (SELECT COUNT(T0.DocEntry) FROM RDR1 T0 WHERE T0.DocEntry =  @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @CodImposto09122025 NVARCHAR(80);\r\n\tDECLARE @CstCodeIn09122025 NVARCHAR(80);\r\n\r\n\tWHILE (@ControllerInt09122025 \u003c @QtyLines09122025)\r\n\tBEGIN\r\n\r\n\t\tSET @CodImposto09122025 = (SELECT RTRIM(LTRIM(T0.TaxCode))\r\n\t\t\t\t\t\t\t\t\tFROM RDR1 T0 \r\n\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\t\tAND T0.LineNum = @ControllerInt09122025);\r\n\r\n\r\n\t    SET @CstCodeIn09122025 = NULL;  --limpando  antes de atribuir valor\r\n\r\n\t\tSET @CstCodeIn09122025 = (SELECT \"CstCodeIn\"\r\n\t\t\t\t\t\t\t\t\tFROM STC1\r\n\t\t\t\t\t\t\t\t\tWHERE \"STCCode\" = @CodImposto09122025\r\n\t\t\t\t\t\t\t\t\tAND \"STAType\" = 32\r\n\t\t\t\t\t\t\t\t\tAND \"STCCode\" LIKE \u0027%R\u0027) ---PEGANDO SOMENTE CODIGOS DA REFORMA.\r\n\t\t\r\n\r\n\t\tIF(@CstCodeIn09122025 IS NOT NULL AND @CstCodeIn09122025 \u003c\u003e \u0027\u0027)\r\n\t\tBEGIN\r\n\r\n\t\t\tUPDATE RDR1\r\n\t\t\tSET U_SKILL_CTIBSCBS = @CstCodeIn09122025\r\n\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\t\tAND LineNum = @ControllerInt09122025;\r\n\r\n\t\tEND\r\n\r\n\r\n\t\tSET @ControllerInt09122025 = @ControllerInt09122025 + 1\r\n\r\n\tEND\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 11/11/2025\r\n-- Description: Bloco criado para travar qualquer fatura de adiantamento que nao venha de um pedido de compras\r\n-- GLPI IDs: 19287\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF(@object_type = \u0027204\u0027) and (@transaction_type in (\u0027A\u0027))\r\nBEGIN\r\n\t\r\n\r\n\tIF NOT EXISTS(\r\n\tSELECT \r\n\t\tT0.DocEntry,\r\n\t\tT0.UserSign,\r\n\t\tT1.Department\r\n\tFROM ODPO T0\r\n\tINNER JOIN OUSR T1\r\n\t   ON T1.USERID = T0.UserSign\r\n\tWHERE T1.Department IN(9,13)\r\n\tAND T0.DocEntry = @list_of_cols_val_tab_del\r\n\t)\r\n\tBEGIN\r\n\t\t\r\n\t\tIF NOT EXISTS(\r\n\t\tSELECT T1.BaseEntry,\r\n\t\tT1.BaseType\r\n\t\tFROM ODPO T0\r\n\t\tINNER JOIN DPO1 T1\r\n\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\tAND T1.BaseType = 22)\r\n\t\tBEGIN\t\r\n\r\n\t\t\tSET @error = -11112025\r\n\t\t\tSET @error_message = \u0027Nao ‚ possivel lan‡ar este adiantamento, contate o administrador!\u0027;\r\n\t\t\tSELECT @error, @error_message;\r\n\r\n\r\n\t\tEND\r\n\r\n\r\n\tEND\r\n\r\n\r\n\t\r\n\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 06/07/2025\r\n-- Description: Bloco criado para criar travas somente em campos especificos de documentos.\r\n-- GLPI IDs: 18689, 18570\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--// - INICIO - CONTROLE DE CAMPOS PARA A DEVOLU€AO DE NOTA FISCAL DE SAIDA//--\r\n---TABELA DE CONTROLE\r\n\r\n\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027))\r\nBEGIN\r\n\t\r\n\tIF EXISTS(SELECT \r\n\t\t\t\t\t T0.DocDueDate,\r\n\t\t\t\t\t GETDATE() AS \u0027Hoje\u0027,\r\n\t\t\t\t\t T0.U_CorrecaoContabil\r\n\t\t\t\tFROM ORIN T0 \r\n\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND CAST(T0.DocDueDate AS DATE) \u003c CAST(GETDATE() AS DATE)\r\n\t\t\t\tAND (T0.U_CorrecaoContabil \u003c\u003e \u0027Y\u0027 OR T0.U_CorrecaoContabil IS NULL)\r\n\t\t\t\t)\r\n\tBEGIN\r\n\t\t\r\n\t\tSET @error = -01082025\r\n\t\tSET @error_message = \u0027Aten‡ao data de Vencimento divergente da data de Hoje, Contate o administrador!\u0027;\r\n\t\tSELECT @error, @error_message;\r\n\r\n\tEND\r\n\tELSE\r\n\tBEGIN\r\n\r\n\t\t/*INSERE O REGISTRO ATUAL*/\r\n\t\tINSERT INTO FAL_ORIN_CONTROLLER(\r\n\t\tDocEntry,\r\n\t\tCardCode,\r\n\t\tCardName,\r\n\t\tCreateDate,\r\n\t\tDocDate,\r\n\t\tDocDueDate,\r\n\t\tTaxDate,\r\n\t\tDocStatus,\r\n\t\tUserSign\r\n\t\t)\r\n\t\tSELECT \r\n\t\tDocEntry,\r\n\t\tCardCode,\r\n\t\tCardName,\r\n\t\tCreateDate,\r\n\t\tDocDate,\r\n\t\tDocDueDate,\r\n\t\tTaxDate,\r\n\t\tDocStatus,\r\n\t\tUserSign\r\n\t\tFROM ORIN T0\r\n\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del;\r\n\r\n\tEND\r\n\t\r\n\t\r\n\t \r\nEND\r\n\r\n\r\n--TRANSACTION DE VERIFICA€AO DE ALTERA€AO DO CAMPO\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027U\u0027))\r\nBEGIN\r\n\t\t\r\n\t\t\r\n\t\tIF NOT EXISTS(SELECT T0.DocDueDate,\r\n\t\t\t\t\t\t\t   T1.DocDueDate\r\n\t\t\t\t\t\tFROM ORIN T0\r\n\t\t\t\t\t\tINNER JOIN FAL_ORIN_CONTROLLER T1 \r\n\t\t\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\t\t\t   AND T1.DocDueDate = T0.DocDueDate\r\n\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t)\r\n\t\tBEGIN\r\n\t\t\t\r\n\t\t\tIF NOT EXISTS(\r\n\t\t\tSELECT T0.DocDueDate\r\n\t\t\tFROM ORIN T0\r\n\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\tAND (T0.DocDueDate \u003e= GETDATE() OR T0.U_CorrecaoContabil = \u0027Y\u0027))\r\n\t\t\tBEGIN\r\n\t\t\t\t\r\n\t\t\t\t\tSET @error = -01082025\r\n\t\t\t\t\tSET @error_message = \u0027Aten‡ao data de Vencimento divergente da data de Hoje ou retroativa, Contate o administrador!\u0027;\r\n\t\t\t\t\tSELECT @error, @error_message;\r\n\r\n\t\t\tEND\r\n\r\n\r\n\t\tEND\r\n\r\n\r\n\r\n\t\tIF EXISTS(SELECT * \r\n\t\tFROM FAL_ORIN_CONTROLLER T1\r\n\t\tWHERE T1.DocEntry IN (SELECT T0.DocEntry\r\n\t\t\t\t\t\t\t\tFROM ORIN T0\r\n\t\t\t\t\t\t\t\tWHERE T0.DocStatus = \u0027C\u0027))\r\n\t\tBEGIN\r\n\t\t\t\r\n\t\t\tDELETE \r\n\t\t\tFROM FAL_ORIN_CONTROLLER \r\n\t\t\tWHERE DocEntry IN (SELECT T0.DocEntry\r\n\t\t\t\t\t\t\t\tFROM ORIN T0\r\n\t\t\t\t\t\t\t\tWHERE T0.DocStatus = \u0027C\u0027)\r\n\r\n\r\n\t\tEND\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n\r\n--// - FIM - CONTROLE DE CAMPOS PARA A DEVOLU€AO DE NOTA FISCAL DE SAIDA//--\r\n\r\n--// - INICIO - CONTROLE DE CAMPOS PARA A NOTA FISCAL DE ENTRADA\r\n\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027))\r\nBEGIN\r\n\r\n\t\r\n\tIF EXISTS(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\t T0.DocDueDate,\r\n\t\t\t\t\t T1.DueDate,\r\n\t\t\t\t\t GETDATE() AS \u0027Hoje\u0027,\r\n\t\t\t\t\t T0.U_CorrecaoContabil\r\n\t\t\t\tFROM OPCH T0 \r\n\t\t\t\tINNER JOIN PCH6 T1\r\n\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\tWHERE (CAST(T0.DocDueDate AS DATE) \u003c CAST(GETDATE() AS DATE) OR (T1.DueDate \u003c CAST(GETDATE() AS DATE) AND T1.Status = \u0027O\u0027))\r\n\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND (T0.U_CorrecaoContabil \u003c\u003e \u0027Y\u0027 OR T0.U_CorrecaoContabil IS NULL)\r\n\r\n\t\t\t\t)\r\n\tBEGIN\r\n\r\n\r\n\t\tSET @error = -01082025\r\n\t\tSET @error_message = \u0027Aten‡ao data de Vencimento divergente da data de Hoje, Contate o administrador!\u0027;\r\n\t\tSELECT @error, @error_message;\r\n\r\n\tEND\r\n\tELSE\r\n\tBEGIN\r\n\t\t\r\n\t\t/*INSERE O REGISTRO ATUAL*/\r\n\t\tINSERT INTO FAL_OPCH_CONTROLLER(\r\n\t\tDocEntry,\r\n\t\tCardCode,\r\n\t\tCardName,\r\n\t\tCreateDate,\r\n\t\tDocDate,\r\n\t\tDocDueDate,\r\n\t\tTaxDate,\r\n\t\tDocStatus,\r\n\t\tUserSign,\r\n\t\tDataParcela\r\n\t\t)\r\n\t\tSELECT \r\n\t\tT0.DocEntry,\r\n\t\tT0.CardCode,\r\n\t\tT0.CardName,\r\n\t\tT0.CreateDate,\r\n\t\tT0.DocDate,\r\n\t\tT0.DocDueDate,\r\n\t\tT0.TaxDate,\r\n\t\tT0.DocStatus,\r\n\t\tT0.UserSign,\r\n\t\tT1.DueDate AS \u0027DataParcela\u0027\r\n\t\tFROM OPCH T0\r\n\t\tINNER JOIN PCH6 T1\r\n\t    ON T1.DocEntry = T0.DocEntry\r\n\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del;\r\n\r\n\tEND\r\n\r\n\r\nEND\r\n\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027U\u0027))\r\nBEGIN\t\r\n\r\n\r\n\t\t/*VERIFICA SE HOUVE ALTERA€AO NOS CAMPOS DE DATA DE VENCIMENTO/PARCELA */\r\n\t\tIF NOT EXISTS(SELECT T0.DocDueDate,\r\n\t\t\t\t\t\t\t   T1.DocDueDate,\r\n\t\t\t\t\t\t\t    T2.DueDate\r\n\t\t\t\t\t\tFROM OPCH T0\r\n\t\t\t\t\t\tINNER JOIN PCH6 T2\r\n\t\t\t\t\t\t   ON T2.DocEntry = T0.DocEntry\r\n\t\t\t\t\t\tINNER JOIN FAL_OPCH_CONTROLLER T1 \r\n\t\t\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\t\t\t   AND T1.DocDueDate = T0.DocDueDate\r\n\t\t\t\t\t\t   AND T1.DataParcela = T2.DueDate\r\n\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t)\r\n\r\n\r\n\r\n\t\tBEGIN\r\n\r\n\t\t\tIF NOT EXISTS(\r\n\r\n\t\t\tSELECT *\r\n\t\t\tFROM OPCH T0\r\n\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\tAND T0.DocStatus = \u0027C\u0027\r\n\t\t\tAND T0.U_CorrecaoContabil = \u0027Y\u0027\r\n\r\n\t\t\t\r\n\t\t\t)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\t/*SE AS DATAS (PARCELA/VENCIMENTO) FOREM MAIOR QUE A DATA DE HOJE, DEIXA PASSAR */\r\n\t\t\t\tIF NOT EXISTS(\r\n\t\t\t\tSELECT T0.DocDueDate\r\n\t\t\t\tFROM OPCH T0\r\n\t\t\t\tINNER JOIN PCH6 T1\r\n\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\r\n\t\t\t\tAND ((T0.DocDueDate \u003e= GETDATE() \r\n\t\t\t\tAND T1.DueDate \u003e= GETDATE()) OR  T0.U_CorrecaoContabil = \u0027Y\u0027)\r\n\r\n\t\t\t\t)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\r\n\t\t\t\t\t\tSET @error = -01082025\r\n\t\t\t\t\t\tSET @error_message = \u0027Aten‡ao data de Vencimento divergente da data de Hoje ou retroativa, Contate o administrador!\u0027;\r\n\t\t\t\t\t\tSELECT @error, @error_message;\r\n\r\n\t\t\t\tEND\r\n\r\n\r\n\r\n\t\t\tEND\r\n\r\n\r\n\r\n\t\t\t\r\n\r\n\r\n\t\tEND\r\n\r\n\t\t\r\n\t\tIF EXISTS(SELECT * \r\n\t\tFROM FAL_OPCH_CONTROLLER T1\r\n\t\tWHERE T1.DocEntry IN (SELECT T0.DocEntry\r\n\t\t\t\t\t\t\t\tFROM OPCH T0\r\n\t\t\t\t\t\t\t\tWHERE T0.DocStatus = \u0027C\u0027))\r\n\t\tBEGIN\r\n\t\t\t\r\n\t\t\tDELETE \r\n\t\t\tFROM FAL_OPCH_CONTROLLER \r\n\t\t\tWHERE DocEntry IN (SELECT T0.DocEntry\r\n\t\t\t\t\t\t\t\tFROM OPCH T0\r\n\t\t\t\t\t\t\t\tWHERE T0.DocStatus = \u0027C\u0027)\r\n\r\n\r\n\t\tEND\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n--// - FIM - CONTROLE DE CAMPOS PARA A DEVOLU€AO DE NOTA FISCAL DE SAIDA//--\r\n\r\n\r\n--// - INICIO - CONTROLE DE CAMPOS PARA FATURA DE ADIANTAMENTO\r\n\r\nIF (@object_type = \u0027204\u0027) and (@transaction_type in (\u0027A\u0027))\r\nBEGIN\t\r\n\r\n\t\r\n\tIF EXISTS(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\t T0.DocDueDate,\r\n\t\t\t\t\t T1.DueDate,\r\n\t\t\t\t\t GETDATE() AS \u0027Hoje\u0027,\r\n\t\t\t\t\t T0.U_CorrecaoContabil\r\n\t\t\t\tFROM ODPO T0 \r\n\t\t\t\tINNER JOIN DPO6 T1\r\n\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\tWHERE (CAST(T0.DocDueDate AS DATE) \u003c CAST(GETDATE() AS DATE) OR (T1.DueDate \u003c CAST(GETDATE() AS DATE) AND T1.Status = \u0027O\u0027))\r\n\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND (T0.U_CorrecaoContabil \u003c\u003e \u0027Y\u0027 OR T0.U_CorrecaoContabil IS NULL)\r\n\r\n\t\t\t\t)\r\n\tBEGIN\r\n\r\n\r\n\t\tSET @error = -30092025\r\n\t\tSET @error_message = \u0027Aten‡ao data de Vencimento divergente da data de Hoje, Contate o administrador!\u0027;\r\n\t\tSELECT @error, @error_message;\r\n\r\n\tEND\r\n\tELSE\t\r\n\tBEGIN\r\n\r\n\r\n\t\t/*INSERE O REGISTRO ATUAL*/\r\n\t\tINSERT INTO FAL_ODPO_CONTROLLER(\r\n\t\tDocEntry,\r\n\t\tCardCode,\r\n\t\tCardName,\r\n\t\tCreateDate,\r\n\t\tDocDate,\r\n\t\tDocDueDate,\r\n\t\tTaxDate,\r\n\t\tDocStatus,\r\n\t\tUserSign,\r\n\t\tDataParcela\r\n\t\t)\r\n\t\tSELECT \r\n\t\tT0.DocEntry,\r\n\t\tT0.CardCode,\r\n\t\tT0.CardName,\r\n\t\tT0.CreateDate,\r\n\t\tT0.DocDate,\r\n\t\tT0.DocDueDate,\r\n\t\tT0.TaxDate,\r\n\t\tT0.DocStatus,\r\n\t\tT0.UserSign,\r\n\t\tT1.DueDate AS \u0027DataParcela\u0027\r\n\t\tFROM ODPO T0\r\n\t\tINNER JOIN DPO6 T1\r\n\t    ON T1.DocEntry = T0.DocEntry\r\n\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del;\r\n\r\n\r\n\r\n\tEND\r\n\r\nEND\r\n\r\nIF (@object_type = \u0027204\u0027) and (@transaction_type in (\u0027U\u0027))\r\nBEGIN\t\r\n\r\n/*VERIFICA SE HOUVE ALTERA€AO NOS CAMPOS DE DATA DE VENCIMENTO/PARCELA */\r\n\t\tIF NOT EXISTS(SELECT T0.DocDueDate,\r\n\t\t\t\t\t\t\t   T1.DocDueDate,\r\n\t\t\t\t\t\t\t    T2.DueDate\r\n\t\t\t\t\t\tFROM ODPO T0\r\n\t\t\t\t\t\tINNER JOIN DPO6 T2\r\n\t\t\t\t\t\t   ON T2.DocEntry = T0.DocEntry\r\n\t\t\t\t\t\tINNER JOIN FAL_ODPO_CONTROLLER T1 \r\n\t\t\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\t\t\t   AND T1.DocDueDate = T0.DocDueDate\r\n\t\t\t\t\t\t   AND T1.DataParcela = T2.DueDate\r\n\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t)\r\n\r\n\r\n\r\n\t\tBEGIN\r\n\r\n\t\t\tIF NOT EXISTS(\r\n\r\n\t\t\tSELECT *\r\n\t\t\tFROM ODPO T0\r\n\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\tAND T0.DocStatus = \u0027C\u0027\r\n\t\t\tAND T0.U_CorrecaoContabil = \u0027Y\u0027\r\n\r\n\t\t\t\r\n\t\t\t)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\t/*SE AS DATAS (PARCELA/VENCIMENTO) FOREM MAIOR QUE A DATA DE HOJE, DEIXA PASSAR */\r\n\t\t\t\tIF NOT EXISTS(\r\n\t\t\t\tSELECT T0.DocDueDate\r\n\t\t\t\tFROM ODPO T0\r\n\t\t\t\tINNER JOIN DPO6 T1\r\n\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\r\n\t\t\t\tAND ((T0.DocDueDate \u003e= GETDATE() \r\n\t\t\t\tAND T1.DueDate \u003e= GETDATE()) OR  T0.U_CorrecaoContabil = \u0027Y\u0027)\r\n\r\n\t\t\t\t)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\r\n\t\t\t\t\t\tSET @error = -01082025\r\n\t\t\t\t\t\tSET @error_message = \u0027Aten‡ao data de Vencimento divergente da data de Hoje ou retroativa, Contate o administrador!\u0027;\r\n\t\t\t\t\t\tSELECT @error, @error_message;\r\n\r\n\t\t\t\tEND\r\n\r\n\r\n\r\n\t\t\tEND\r\n\r\n\r\n\r\n\t\t\t\r\n\r\n\r\n\t\tEND\r\n\r\n\t\t\r\n\t\tIF EXISTS(SELECT * \r\n\t\tFROM FAL_ODPO_CONTROLLER T1\r\n\t\tWHERE T1.DocEntry IN (SELECT T0.DocEntry\r\n\t\t\t\t\t\t\t\tFROM ODPO T0\r\n\t\t\t\t\t\t\t\tWHERE T0.DocStatus = \u0027C\u0027))\r\n\t\tBEGIN\r\n\t\t\t\r\n\t\t\tDELETE \r\n\t\t\tFROM FAL_ODPO_CONTROLLER \r\n\t\t\tWHERE DocEntry IN (SELECT T0.DocEntry\r\n\t\t\t\t\t\t\t\tFROM ODPO T0\r\n\t\t\t\t\t\t\t\tWHERE T0.DocStatus = \u0027C\u0027)\r\n\r\n\r\n\t\tEND\r\n\r\n\r\nEND\r\n\r\n\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Bruno Cassiano \r\n-- Create date: 10/06/2025\r\n-- Update \t\t27/06/2025\r\n-- Description: Trava UNIFICADA para impedir a inser‡ao ou atualiza‡ao de documentos fiscais com data de vencimento retroativa,\r\n--              incluindo valida‡ao de presta‡oes individuais e exce‡ao para usu rio espec¡fico (279).\r\n-- GLPI IDs: 18689, 18570\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n/*\r\nIF @object_type IN (N\u002718\u0027, N\u002719\u0027, N\u002714\u0027) AND @transaction_type IN (N\u0027A\u0027, N\u0027U\u0027)\r\nBEGIN\r\n    DECLARE @DocDueDateA DATE;\r\n    DECLARE @DocTypeName NVARCHAR(100);\r\n    DECLARE @CurrentUserID_A INT;\r\n\r\n    \r\n    IF @object_type = N\u002718\u0027\r\n    BEGIN\r\n        SELECT @DocDueDateA = T0.DocDueDate, @CurrentUserID_A = IIF(@transaction_type = \u0027A\u0027, T0.UserSign, T0.UserSign2) FROM OPCH T0 WHERE T0.DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocTypeName = N\u0027Fatura de Fornecedor\u0027;\r\n    END\r\n    ELSE IF @object_type = N\u002719\u0027\r\n    BEGIN\r\n        SELECT @DocDueDateA = T0.DocDueDate, @CurrentUserID_A = IIF(@transaction_type = \u0027A\u0027, T0.UserSign, T0.UserSign2) FROM ORPC T0 WHERE T0.DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocTypeName = N\u0027Nota de Cr‚dito de Compra\u0027;\r\n    END\r\n    ELSE IF @object_type = N\u002714\u0027\r\n    BEGIN\r\n        SELECT @DocDueDateA = T0.DocDueDate, @CurrentUserID_A = IIF(@transaction_type = \u0027A\u0027, T0.UserSign, T0.UserSign2) FROM ORIN T0 WHERE T0.DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocTypeName = N\u0027Nota de Cr‚dito de Venda\u0027;\r\n    END;\r\n\r\n    \r\n    IF (@DocDueDateA \u003c CAST(GETDATE() AS DATE) AND (@CurrentUserID_A \u003c\u003e 276 OR @CurrentUserID_A \u003c\u003e 283))\r\n    BEGIN\r\n        SET @error = -110;\r\n        SET @error_message = N\u0027Nao ‚ permitido inserir/atualizar um(a) \u0027 + @DocTypeName + N\u0027 com data de vencimento inferior … data atual.\u0027;\r\n        SELECT @error, @error_message;\r\n    END;\r\nEND;\r\n\r\n\r\n\r\n\r\n\r\n\r\nIF @object_type IN (N\u002713\u0027, N\u002718\u0027, N\u002719\u0027, N\u002714\u0027) AND @transaction_type IN (N\u0027A\u0027, N\u0027U\u0027)\r\nBEGIN\r\n    DECLARE @Vencidas INT = 0;\r\n    DECLARE @DocInstallmentTypeName NVARCHAR(100);\r\n    DECLARE @CurrentUserID_B INT;\r\n\r\n    \r\n    IF @object_type = N\u002713\u0027 \r\n    BEGIN\r\n        SELECT @Vencidas = COUNT(*) FROM INV6 WHERE DocEntry = @list_of_cols_val_tab_del AND DueDate \u003c CAST(GETDATE() AS DATE);\r\n        SELECT @CurrentUserID_B = IIF(@transaction_type = \u0027A\u0027, UserSign, UserSign2) FROM OINV WHERE DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocInstallmentTypeName = N\u0027Fatura de Cliente\u0027;\r\n    END\r\n    ELSE IF @object_type = N\u002718\u0027 \r\n    BEGIN\r\n        SELECT @Vencidas = COUNT(*) FROM PCH6 WHERE DocEntry = @list_of_cols_val_tab_del AND DueDate \u003c CAST(GETDATE() AS DATE);\r\n        SELECT @CurrentUserID_B = IIF(@transaction_type = \u0027A\u0027, UserSign, UserSign2) FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocInstallmentTypeName = N\u0027Fatura de Fornecedor\u0027;\r\n    END\r\n    ELSE IF @object_type = N\u002719\u0027 \r\n    BEGIN\r\n        SELECT @Vencidas = COUNT(*) FROM RPC6 WHERE DocEntry = @list_of_cols_val_tab_del AND DueDate \u003c CAST(GETDATE() AS DATE);\r\n        SELECT @CurrentUserID_B = IIF(@transaction_type = \u0027A\u0027, UserSign, UserSign2) FROM ORPC WHERE DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocInstallmentTypeName = N\u0027Nota de Cr‚dito de Compra\u0027;\r\n    END\r\n    ELSE IF @object_type = N\u002714\u0027 \r\n    BEGIN\r\n        SELECT @Vencidas = COUNT(*) FROM RIN6 WHERE DocEntry = @list_of_cols_val_tab_del AND DueDate \u003c CAST(GETDATE() AS DATE);\r\n        SELECT @CurrentUserID_B = IIF(@transaction_type = \u0027A\u0027, UserSign, UserSign2) FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del;\r\n        SET @DocInstallmentTypeName = N\u0027Nota de Cr‚dito de Venda\u0027;\r\n    END;\r\n\r\n    \r\n    IF (@Vencidas \u003e 0 AND (@CurrentUserID_B \u003c\u003e 276 OR @CurrentUserID_B \u003c\u003e 283))\r\n    BEGIN\r\n        SET @error = -111;\r\n        SET @error_message = N\u0027Nao ‚ permitido criar/atualizar \u0027 + @DocInstallmentTypeName + N\u0027 com presta‡oes com data de vencimento inferior … data atual.\u0027;\r\n        SELECT @error, @error_message;\r\n    END;\r\nEND;\r\n\r\n\r\n\r\n*/\r\n/*\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo Gomes\r\n-- Create date: 20/05/2025\r\n-- Description:\ttrava criada para quando o SAC Lan‡ar o pedido nao deixar lan‡ar no deposito 02.03\r\n-- GLPI ID:  18530\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\n\r\n\tIF EXISTS(\r\n\r\n\tSELECT T3.WhsCode\r\n\tFROM ORDR T0\r\n\tINNER JOIN OUSR T1\r\n\t   ON T1.USERID = T0.UserSign\r\n\tINNER JOIN OUSR T2\r\n\t   ON T2.USERID = T0.UserSign\r\n\tINNER JOIN RDR1 T3\r\n\t   ON T3.DocEntry = T0.DocEntry\r\n\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\tAND ((T1.Department = 12 OR T2.Department = 12) AND T3.WhsCode = \u002702.03\u0027)\r\n\t\r\n\t)\r\n\r\n\tBEGIN\r\n\r\n\t\r\n\t\tSET @error = -18530;\r\n\t\tSET @error_message = \u0027Aten‡ao! Dep¢sito nao ‚ permitido para o usu rio de lan‡amento!\u0027;\r\n\t\tSELECT @error, @error_message;\r\n\r\n\r\n\tEND\r\n\t\r\n\r\nEND \r\n\r\n*/\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo Gomes\r\n-- Create date: 17/04/2025\r\n-- Description:\ttrava criada para quando o SAC Lan‡ar o pedido, informe o canal de atendimento na ABA SAC\r\n-- GLPI ID:  ---\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\n\r\n\tDECLARE @UserSingSAC170425 INT;\r\n\tSET @UserSingSAC170425 = (SELECT T0.UserSign\r\n\t\t\t\t\t\tFROM ORDR T0\r\n\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @DepartmentSAC170425 INT;\r\n\tSET @DepartmentSAC170425 = (SELECT T0.Department\r\n\t\t\t\t\t\t\tFROM OUSR T0\r\n\t\t\t\t\t\t\tWHERE T0.USERID = @UserSingSAC170425)\t\r\n\r\n\tIF(@DepartmentSAC170425 = 12)\r\n\tBEGIN\r\n\t\r\n\t\t\t\t\tIF NOT EXISTS(SELECT T0.U_CanalAtendimento\r\n\t\t\t\t\tFROM ORDR T0\r\n\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\t\tAND T0.U_CanalAtendimento IS NOT NULL)\r\n\t\t\t\t\tBEGIN \r\n\t\t\t\t\t\r\n\t\t\t\t\t\tSET @error = -18108;\r\n\t\t\t\t\t\tSET @error_message = \u0027Aten‡ao! informe o Canal de Atendimento na aba SAC para prosseguir com o pedido.\u0027;\r\n\t\t\t\t\t\tSELECT @error, @error_message;\r\n\r\n\t\t\t\t\tEND\r\n\r\n\r\n\r\n\tEND\r\n\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END \r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo\r\n-- Create date: 17/02/2025\r\n-- Description:\ttrava criada para quando o cliente flegar SN URGENTE ser obrigat¢rio o preenchimento do campo grau de urgencia na solicita‡ao DE compra\r\n-- GLPI ID:  18108\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF @transaction_type IN (\u0027A\u0027, \u0027U\u0027) AND  @object_type = \u00271470000113\u0027 \r\nBEGIN\r\n\r\n\t\t\t\tIF EXISTS(\r\n\r\n\t\t\t\tSELECT T0.U_RAL_Urgente,\r\n\t\t\t\t\t   T0.U_RAL_GRAU_URGENCIA\r\n\t\t\t\tFROM OPRQ T0 \r\n\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\tAND T0.U_RAL_Urgente = \u0027Y\u0027\r\n\t\t\t\tAND T0.U_RAL_GRAU_URGENCIA NOT IN(0,3)\r\n\t\t\t\t\r\n\t\t\t\t)\r\n\r\n\t\t\t\tBEGIN \r\n\r\n\t\t\t\t\r\n\t\t\t\t\tSET @error = -18108;\r\n\t\t\t\t\tSET @error_message = \u0027Aten‡ao! Documento Definido com Urgencia, Necessario Definir um Grau para prosseguir.\u0027;\r\n\t\t\t\t\tSELECT @error, @error_message;\r\n\r\n\r\n\t\t\t\tEND \r\n\t\t\t\t\r\n\t\t\t\t\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END \r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo/Henrique\r\n-- Create date: 01/10/2024\r\n-- Description:\ttrava criada para impedir a inser‡ao de documentos com valores divergentes em KG, se baseando na nota fiscal de saida, se nao houver documento referenciado, considera o pre‡o de lista\r\n-- GLPI ID:  17552\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--IF @transaction_type IN (\u0027A\u0027, \u0027U\u0027) AND @object_type = \u002714\u0027 \r\n--BEGIN\r\n\r\n\t\r\n--\tIF EXISTS (\r\n--\t\t\t\t\tSELECT *\r\n--FROM (\r\n--\t\t\t\t\t--traz somente Devolu‡oes que nao tem nf de venda referenciada\r\n--\t\t\t\t\tSELECT\r\n--\t\t\t\t\tT0.ItemCode, \r\n--\t\t\t\t\tT1.ItmsGrpCod,\r\n--\t\t\t\t\tT0.Quantity,\r\n--\t\t\t\t\tT0.Price,\r\n--\t\t\t\t\tT0.Weight1 \u0027Peso Linha\u0027, \r\n--\t\t\t\t\tt2.Weight1 \u0027Peso UDM\u0027,\r\n--\t\t\t\t\tT0.Price/ NULLIF(T2.Weight1,0) \u0027Pre‡o KG NF\u0027, \r\n--\t\t\t\t\tT6.Price \u0027Pre‡o de Lista\u0027,\r\n--\t\t\t\t\tT1.SWeight1,\r\n--\t\t\t\t\tt6.Price / NULLIF(t1.SWeight1,0) \u0027Pre‡o por kg Lista\u0027,\r\n--\t\t\t\t\t(((T0.Price/ NULLIF(T2.Weight1,0)) / NULLIF((t6.Price / NULLIF(t1.SWeight1,0)),0)  ) * 100) - 100 AS \u0027Porcentagem\u0027,\r\n--\t\t\t\t\tnull \u0027RefDoc\u0027,null \u0027Pre‡o por kg venda\u0027 \t\r\n--\t\t\t\t\tFROM RIN1 T0\r\n--\t\t\t\t\tINNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode\r\n--\t\t\t\t\tINNER JOIN OUOM T2 ON T0.UomCode = T2.UomCode\r\n--\t\t\t\t\tINNER JOIN ORIN T3 on T0.DocEntry = T3.DocEntry\r\n--\t\t\t\t\tINNER JOIN OCRD T4 ON T3.CardCode = T4.CardCode\r\n--\t\t\t\t\tINNER JOIN OPLN T5 ON T4.ListNum = T5.ListNum\r\n--\t\t\t\t\tINNER JOIN ITM1 T6 on T5.ListNum = T6.PriceList AND T0.ItemCode = T6.ItemCode\r\n--\t\t\t\t\tLEFT JOIN RIN21 T7 on T0.DocEntry = T7.DocEntry\r\n--\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del  AND T7.RefDocEntr is null\r\n \r\n--\t\t\t\t\tUNION ALL\r\n--\t\t\t\t\t---TRAZ SOMENTE AS DEVOLU€oES COM NF REFERENCIADA\r\n--\t\t\t\t\tSELECT\r\n--\t\t\t\t\tT0.ItemCode, \r\n--\t\t\t\t\tT1.ItmsGrpCod,\r\n--\t\t\t\t\tT0.Quantity,\r\n--\t\t\t\t\tT0.Price,\r\n--\t\t\t\t\tT0.Weight1 \u0027Peso Linha\u0027, \r\n--\t\t\t\t\tt2.Weight1 \u0027Peso UDM\u0027,\r\n--\t\t\t\t\tT0.Price/ NULLIF(T2.Weight1,0) \u0027Pre‡o KG NF\u0027, \r\n--\t\t\t\t\tT6.Price \u0027Pre‡o de Lista\u0027,\r\n--\t\t\t\t\tT1.SWeight1,\r\n--\t\t\t\t\tt6.Price / NULLIF(t1.SWeight1,0) \u0027Pre‡o po25r kg Lista\u0027,\r\n--\t\t\t\t\t(((T0.Price/ NULLIF(T2.Weight1,0)) / COALESCE(T9.price /NULLIF(T10.weight1,0),NULLIF((t6.Price / NULLIF(t1.SWeight1,0)),0))   ) * 100) - 100 AS \u0027Porcentagem\u0027,\r\n--\t\t\t\t\tT7.RefDocNum,T9.price /NULLIF(T10.weight1,0) \u0027Pre‡o por kg venda\u0027\r\n--\t\t\t\t\tFROM RIN1 T0\r\n--\t\t\t\t\tINNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode\r\n--\t\t\t\t\tINNER JOIN OUOM T2 ON T0.UomCode = T2.UomCode\r\n--\t\t\t\t\tINNER JOIN ORIN T3 on T0.DocEntry = T3.DocEntry\r\n--\t\t\t\t\tINNER JOIN OCRD T4 ON T3.CardCode = T4.CardCode\r\n--\t\t\t\t\tINNER JOIN OPLN T5 ON T4.ListNum = T5.ListNum\r\n--\t\t\t\t\tINNER JOIN ITM1 T6 on T5.ListNum = T6.PriceList AND T0.ItemCode = T6.ItemCode\r\n--\t\t\t\t\tINNER JOIN RIN21 T7 ON T0.DocEntry = T7.DocEntry\r\n--\t\t\t\t\tINNER JOIN OINV T8 ON T7.RefDocNum = T8.DocEntry\r\n--\t\t\t\t\tINNER JOIN INV1 T9 ON T8.DocEntry = T9.DocEntry AND T0.ItemCode = T9.ItemCode\r\n--\t\t\t\t\tINNER JOIN OUOM T10 ON T9.UomCode = T10.UomCode\r\n--\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n--\t\t\t\t\t) A\r\n--\t\t\t\t\tWHERE (A.ItmsGrpCod = 117 AND (A.Porcentagem \u003e= 40 OR A.Porcentagem \u003c= -40)) \r\n--\t\t\t\t\tOR (A.ItmsGrpCod \u003c\u003e 117 AND (A.Porcentagem \u003e= 10 OR A.Porcentagem \u003c= -10))\r\n \r\n\r\n--\t\t)\r\n--\t\tBEGIN \r\n\r\n\t\t\r\n--\t\t\tSET @error = -17552;\r\n--\t\t\tSET @error_message = \u0027Documento com Divergencia em 10% ou 40% Referente ao Pre‡o de Liste ou Nota Referenciada em KG\u0027;\r\n--\t\t\tSELECT @error, @error_message;\r\n\r\n--\t\tEND \r\n\r\n\t\r\n--END\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END \r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo Prado\r\n-- Create date: 19/09/2024\r\n-- Description:\tTrava criada para impedir que o documento seja atualizado se houver vinculo com remessa no bankplus\r\n-- GLPI ID:  17516\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*\r\nIF ((@object_type = \u002714\u0027) AND (@transaction_type IN (\u0027U\u0027,\u0027D\u0027,\u0027C\u0027))) -- DEVOLU€AO DE NOTA FISCAL DE SAIDA\r\nBEGIN\r\n\r\n\tDECLARE @val_NR_Transf VARCHAR(254);\r\n\tDECLARE @val_Arc_Vinc VARCHAR(254);\r\n\t\r\n\tIF EXISTS (\r\n\r\n\t\tSELECT * \r\n\t\tFROM (\r\n\t\tSELECT \r\n\t\t\t   T1.NumeroInterno,\r\n\t\t\t   T2.NrTransferencia,\r\n\t\t\t   (SELECT T0.NomeDoArquivo\r\n\t\t\t\t\tFROM [dbo].[IV_IB_OrdemDePagamento] T0\r\n\t\t\t\t\tWHERE T0.Codigo = T2.CodigoDaOrdemDePagamento) AS \u0027ArquivoVinculado\u0027,\r\n\t\t\t\t(SELECT T0.Status\r\n\t\t\t\t\tFROM [dbo].[IV_IB_OrdemDePagamento] T0\r\n\t\t\t\t\tWHERE T0.Codigo = T2.CodigoDaOrdemDePagamento) AS \u0027Status\u0027\r\n\t\tFROM [dbo].[IV_IB_TransferenciaParaCliente] T0\r\n\t\tINNER JOIN [dbo].[IV_IB_TransferenciaParaClienteParcela] T1\r\n\t\t   ON T1.TransferenciaId = T0.Id\r\n\t\tINNER JOIN [dbo].[IV_IB_PagamentosDaOrdemDePagamento] T2\r\n\t\t   ON T2.TecId = T1.TransferenciaId)T100\r\n\t\tWHERE T100.NumeroInterno = @list_of_cols_val_tab_del\r\n\t\tAND T100.Status = 2\r\n\t)\r\n\r\n\tBEGIN\r\n\r\n\t\tSET @val_NR_Transf = (SELECT T100.NrTransferencia\r\n\t\t\t\t\t\t\t\tFROM (\r\n\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t   T1.NumeroInterno,\r\n\t\t\t\t\t\t\t\t\t   T2.NrTransferencia,\r\n\t\t\t\t\t\t\t\t\t   (SELECT T0.NomeDoArquivo\r\n\t\t\t\t\t\t\t\t\t\t\tFROM [dbo].[IV_IB_OrdemDePagamento] T0\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE T0.Codigo = T2.CodigoDaOrdemDePagamento) AS \u0027ArquivoVinculado\u0027,\r\n\t\t\t\t\t\t\t\t\t\t(SELECT T0.Status\r\n\t\t\t\t\t\t\t\t\t\t\tFROM [dbo].[IV_IB_OrdemDePagamento] T0\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE T0.Codigo = T2.CodigoDaOrdemDePagamento) AS \u0027Status\u0027\r\n\t\t\t\t\t\t\t\tFROM [dbo].[IV_IB_TransferenciaParaCliente] T0\r\n\t\t\t\t\t\t\t\tINNER JOIN [dbo].[IV_IB_TransferenciaParaClienteParcela] T1\r\n\t\t\t\t\t\t\t\t   ON T1.TransferenciaId = T0.Id\r\n\t\t\t\t\t\t\t\tINNER JOIN [dbo].[IV_IB_PagamentosDaOrdemDePagamento] T2\r\n\t\t\t\t\t\t\t\t   ON T2.TecId = T1.TransferenciaId)T100\r\n\t\t\t\t\t\t\t\tWHERE T100.NumeroInterno = @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\tAND T100.Status = 2)\r\n\r\n\t\tSET @val_Arc_Vinc = (SELECT T100.ArquivoVinculado\r\n\t\t\t\t\t\t\t\tFROM (\r\n\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t   T1.NumeroInterno,\r\n\t\t\t\t\t\t\t\t\t   T2.NrTransferencia,\r\n\t\t\t\t\t\t\t\t\t   (SELECT T0.NomeDoArquivo\r\n\t\t\t\t\t\t\t\t\t\t\tFROM [dbo].[IV_IB_OrdemDePagamento] T0\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE T0.Codigo = T2.CodigoDaOrdemDePagamento) AS \u0027ArquivoVinculado\u0027,\r\n\t\t\t\t\t\t\t\t\t\t(SELECT T0.Status\r\n\t\t\t\t\t\t\t\t\t\t\tFROM [dbo].[IV_IB_OrdemDePagamento] T0\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE T0.Codigo = T2.CodigoDaOrdemDePagamento) AS \u0027Status\u0027\r\n\t\t\t\t\t\t\t\tFROM [dbo].[IV_IB_TransferenciaParaCliente] T0\r\n\t\t\t\t\t\t\t\tINNER JOIN [dbo].[IV_IB_TransferenciaParaClienteParcela] T1\r\n\t\t\t\t\t\t\t\t   ON T1.TransferenciaId = T0.Id\r\n\t\t\t\t\t\t\t\tINNER JOIN [dbo].[IV_IB_PagamentosDaOrdemDePagamento] T2\r\n\t\t\t\t\t\t\t\t   ON T2.TecId = T1.TransferenciaId)T100\r\n\t\t\t\t\t\t\t\tWHERE T100.NumeroInterno = @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\t\tAND T100.Status = 2)\r\n\r\n\r\n\t\tSET @error = -17516;\r\n\t\tSET @error_message = CONCAT(\u0027Aten‡ao! Este Documento possui vinculo com Remessa no BankPlus, Transferencia: \u0027, @val_NR_Transf, \u0027, Arquivo: \u0027, @val_Arc_Vinc, \u0027, Contate o Financeiro.\u0027);\r\n\t\tSELECT @error, @error_message;\r\n\r\n\tEND\t\r\n\r\n\r\nEND\r\n*/\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo Prado\r\n-- Create date: 12/09/2024\r\n-- Description:\tTrava criada para impedir que seja cadastrado ou alterado os itinerarios por outros usuarios se nao os permitidos.\r\n-- GLPI ID: 17490\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--IF ((@object_type = \u0027BIM_ITINERARIO\u0027) AND (@transaction_type IN (\u0027A\u0027,\u0027U\u0027,\u0027D\u0027,\u0027C\u0027,\u0027L\u0027))) -- ORDEM DE CARGA - ITINERARIO\r\n--BEGIN\r\n\r\n--\tDECLARE @UserCad INT;\r\n\r\n--\t-- Busca o UserSign do documento\r\n--\tSET @UserCad = (SELECT T1.UserSign\r\n--\t\t\t\t\t\tFROM [@BIM_ITINERARIO] T0\r\n--\t\t\t\t\t\tINNER JOIN [@ABIM_ITINERARIO] T1\r\n--\t\t\t\t\t\t   ON T1.DocEntry = T0.DocEntry\r\n--\t\t\t\t\t\tWHERE T0.DocEntry =  @list_of_cols_val_tab_del\r\n--\t\t\t\t\t\tAND T1.LogInst IN(SELECT MAX(T1x.LogInst)\r\n--\t\t\t\t\t\t\t\t\t\t\tFROM [@BIM_ITINERARIO] T0x\r\n--\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [@ABIM_ITINERARIO] T1x\r\n--\t\t\t\t\t\t\t\t\t\t\t   ON T1x.DocEntry = T0x.DocEntry\r\n--\t\t\t\t\t\t\t\t\t\t\tWHERE T0x.DocEntry = T0.DocEntry));\r\n\r\n--\t-- Verifica se @UserCad nao ‚ NULL e nao est  na lista de usu rios permitidos\r\n--\tIF (@UserCad IS NULL OR @UserCad NOT IN\r\n--\t\t(SELECT T0.USERID\r\n--\t\t\tFROM OUSR T0\r\n--\t\t\tWHERE T0.USER_CODE LIKE \u0027%kely.carneiro%\u0027 \r\n--\t\t\t\tOR T0.USER_CODE LIKE \u0027%ronaldo.azevedo%\u0027))\r\n--\tBEGIN \r\n--\t\tSET @error = -17490;\r\n--\t\tSET @error_message = \u0027Aten‡ao! Este Documento so pode ser Criado/Atualizado/Deletado/Cancelado por usu rios com permissao! Contate o administrador.\u0027;\r\n--\t\tSELECT @error, @error_message;\r\n--\tEND;\r\n\r\n--END;\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo Prado\r\n-- Create date: 01/08/2024\r\n-- Description:\tTrava criada para impedir que documentos com a mesma Nf sejam Lan‡ados na Fatura de adiantamento de contas a pagar\r\n-- GLPI ID: 17252\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF ((@object_type = \u0027204\u0027) AND (@transaction_type IN (\u0027A\u0027,\u0027U\u0027))) -- CONTROLE DE DEVOLU€OES ARM\r\nBEGIN\r\n\r\n\tDECLARE @NF_Compra INT;\r\n\tDECLARE @Quantidade INT;\r\n\tDECLARE @Doc_Vinculado INT;\r\n\r\n\tSET @NF_Compra = (SELECT T0.U_NF_Compra\r\n\t\t\t\t\t  FROM ODPO T0\r\n\t\t\t\t\t  WHERE T0.DocEntry = @list_of_cols_val_tab_del);\r\n\r\n\tSET @Quantidade = (SELECT COUNT(*) AS Quantidade\r\n\t\t\t\t\t   FROM ODPO T1\r\n\t\t\t\t\t   WHERE T1.U_NF_Compra = @NF_Compra\r\n\t\t\t\t\t   AND T1.DocEntry \u003c\u003e @list_of_cols_val_tab_del);\r\n\r\n\t\r\n\tIF (@Quantidade \u003e= 1)\r\n\r\n\tBEGIN\r\n\r\n\t\tSET @Doc_Vinculado = (SELECT MAX(T1.DocEntry)\r\n\t\tFROM ODPO T1\r\n\t\tWHERE T1.U_NF_Compra = @NF_Compra)\r\n\r\n\r\n\t\tSET @Error = -17252;\r\n\t\tSET @Error_Message = CONCAT(\u0027Aten‡ao! Existe Documento vinculado a esta Nota Fiscal Informada, Verifique o valor do campo \"Nota Fiscal de Compra\" ou o Documento: \u0027, @Doc_Vinculado);\r\n\t\tSELECT @Error, @Error_Message;\r\n\t\r\n\r\n\tEND \r\n\r\n\r\nEND\r\n\r\n-------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo Prado\r\n-- Create date: 18/07/2024\r\n-- Description:\tTrava criada para impedir que haja divergencia do lan‡amento do controle x Dev Nfe\r\n-- GLPI ID:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF ((@object_type = \u0027CTRLARM\u0027) AND (@transaction_type IN (\u0027A\u0027,\u0027U\u0027))) -- CONTROLE DE DEVOLU€OES ARM\r\nBEGIN\r\n\r\n\tIF EXISTS (SELECT * \r\n\t\t\t\tFROM (\r\n\t\t\t\tSELECT T0.ItemCode AS \u0027ItemCodeNf\u0027,\r\n\t\t\t\t\t   T2.U_ItemCode AS \u0027ItemCodeControl\u0027\r\n\t\t\t\tFROM RIN1 T0\r\n\t\t\t\tINNER JOIN [@RAL_CONTROLE_DEVOL] T1\r\n\t\t\t\t   ON T1.U_Nf_Devolucao = T0.DocEntry\r\n\t\t\t\tLEFT JOIN [@RAL_CONTROLE_DEVOL1] T2\r\n\t\t\t\t   ON T2.DocEntry = T1.DocEntry AND T2.U_ItemCode = T0.ItemCode\r\n\t\t\t\tWHERE T1.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\t)T100\r\n\t\t\t\tWHERE T100.ItemCodeControl IS NULL) \r\n\tBEGIN\r\n\r\n        SET @Error = -1\r\n        SET @Error_Message = \u0027Aten‡ao! Divergencia de Lan‡amento, Verifique a quantidades de Item na Nota X Controle de Devolu‡ao ou Referencie o item e Preencha o campo Observa‡oes\u0027 \r\n        SELECT @Error, @Error_Message\r\n\r\n\tEND \r\n\r\nEND\r\n\r\n\r\n\r\n-- Author: Bruno Cassiano\r\n-- Create date: 24/05/2024\r\n-- Description:\tTrava criada para impedir produtos com valor acima de 30% ao pre‡o de lista\r\n-- GLPI ID:16972\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*\r\nIF ((@object_type = \u002717\u0027) AND (@transaction_type IN (\u0027A\u0027,\u0027U\u0027))) -- PEDIDO DE VENDA\r\nBEGIN\r\n    IF EXISTS (\r\n        SELECT *\r\n        FROM (\r\n            SELECT \r\n                T1.ItemCode,\r\n                T1.Price AS \u0027PrecoVenda\u0027,\r\n                T3.PriceList,\r\n                T3.Price AS \u0027PrecoLista\u0027,\r\n                T1.Price - T3.Price AS \u0027ConvertPrice\u0027,\r\n                CAST(CASE WHEN T3.Price \u003c\u003e 0 THEN (T1.Price / T3.Price) * 100 ELSE NULL END AS NUMERIC(10,2)) AS \u0027Porcent\u0027\r\n             \r\n            FROM ORDR T0\r\n            INNER JOIN RDR1 T1 ON T1.DocEntry = T0.DocEntry\r\n            INNER JOIN OCRD T2 ON T2.CardCode = T0.CardCode\r\n            INNER JOIN ITM1 T3 ON T3.PriceList = T2.ListNum AND T3.ItemCode = T1.ItemCode\r\n            WHERE \r\n                T0.DocEntry = @list_of_cols_val_tab_del \r\n               \r\n        ) T100\r\n        WHERE \r\n            (T100.Porcent \u003e 130)  -- Verifica se o pre‡o de venda ‚ mais de 30% acima do pre‡o de lista\r\n           \r\n    )\r\n    BEGIN\r\n        -- SETANDO A MENSAGEM DE ERRO NA TELA\r\n        SET @Error = -16972\r\n        SET @Error_Message = \u0027Pre‡o de venda maior que 30% acima do pre‡o de lista. Verifique!\u0027 \r\n        SELECT @Error, @Error_Message\r\n    END\r\nEND\r\n*/\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Create date: 15/05/2024\r\n-- Description:\tTrava criada para impedir a inser‡ao de notas fiscais de entrada com valor 0\r\n-- GLPI ID:16506\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002718\u0027 = Nota Fiscal Entrada\r\nBEGIN\r\n\r\n\tDECLARE @Utilizacao16506 INT\r\n\r\n\tSET @Utilizacao16506 = (SELECT DISTINCT T0.Usage ----DISTINCT USADO SOMENTE POR CONTA DE TRANSFERENCIAS! DOCUMENTOS DE TRASFERENCIAS OU SAO 60 PARA TODAS AS LINHAS OU 61\r\n\t\t\t\t\t\t    FROM PCH1 T0\r\n\t\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\tAND T0.Usage IN(60,61))\r\n\t\r\n\tIF @Utilizacao16506 IN (60, 61)\r\n\tBEGIN \r\n\r\n\t\tIF EXISTS(SELECT T1.LineTotal\r\n\t\t\t\t  FROM (SELECT T0.LineTotal\r\n\t\t\t\t\t\tFROM PCH1 T0\r\n\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del)T1\r\n\t\t\t\t  WHERE T1.LineTotal \u003c= 0)\r\n\r\n\t\tBEGIN\r\n\t\t\tSET @Error =-16506\r\n\t\t\tSET @Error_Message = \u0027Aten‡ao, Linha com valor 0 ou Nulo. insira um valor valido para prosseguir!\u0027 \r\n\t\t\tSELECT @error, @error_message\t\r\n\r\n\t\tEND\r\n\tEND\r\n\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Leonardo do Prado Gomes\r\n-- Author Update: Bruno Cassiano\r\n-- Create date: 15/05/2024\r\n-- Update Date: 23/09/2024\r\n-- Description: Trava criada para barrar pre‡os com mais de 5% de \r\n---desconto baseado no pre‡o de lista do PN(apenas cadastros manuais, edi esta fora da regra)\r\n-- Acrescentado regra para desconsiderar a kelly.\r\n-- Retirado usu rio de Larissa\r\n-- Documentos: Cota‡ao\r\n-- GLPI ID : 16908\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF ((@object_type = \u002723\u0027) AND (@transaction_type IN (\u0027A\u0027,\u0027U\u0027))) ----COTACAO DE VENDA\r\nBEGIN \r\n\r\n  IF EXISTS(SELECT * \r\n          \tFROM (\r\n          \tSELECT T1.ItemCode,\r\n              \t\t  T1.Price AS \u0027PrecoVenda\u0027,\r\n              \t\t  T3.PriceList,\r\n              \t\t  T3.Price AS \u0027PrecoLista\u0027,\r\n              \t\t  T3.Price - T1.Price AS \u0027ConvertPrice\u0027,\r\n              \t\t  CAST(CASE WHEN T3.Price \u003c\u003e 0 THEN (T1.Price / T3.Price) * 100 ELSE NULL END AS NUMERIC(10,2)) AS \u0027Porcent\u0027,\r\n              \t\t T0.Comments,\r\n              \t\t  T0.U_SPS_ID_NEOGRID \r\n          \t  FROM OQUT T0\r\n          \t  INNER JOIN QUT1 T1 ON T1.DocEntry = T0.DocEntry \r\n          \t  INNER JOIN OCRD T2 ON T2.CardCode = T0.CardCode\r\n          \t  INNER JOIN ITM1 T3 ON T3.PriceList = T2.ListNum AND T3.ItemCode = T1.ItemCode\r\n          \t  WHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n          \t  AND T0.U_AHS_SapUserCode = \u0027None\u0027\r\n\t\t\t  AND T0.UserSign \u003c\u003e 14\r\n\t\t\t  AND T0.UserSign2 \u003c\u003e 14\r\n\t\t\t  AND T0.UserSign \u003c\u003e 260\r\n\t\t\t  AND T0.UserSign2 \u003c\u003e 260\r\n\t\t\t  )T100\r\n          \t  WHERE (T100.Porcent \u003c 95 OR T100.Porcent IS NULL)\r\n          \t  AND (T100.Comments NOT LIKE \u0027%Gerado via integra‡ao EDI%\u0027 OR T100.Comments IS NULL OR T100.U_SPS_ID_NEOGRID IS NULL)\r\n\r\n  ) ---FIM DO IF EXISTIS\r\n\r\n  BEGIN\r\n\r\n    ----------SETANDO A MENSAGEM DE ERRO NA TELA\r\n    SET @Error =-16908\r\n    SET @Error_Message = \u0027Linha com desconto maior que 5% Verifique!\u0027 \r\n    SELECT @error, @error_message\r\n\r\n  END\r\n\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 05/10/2023\r\n-- Update date: 13/11/2023\r\n-- Description:\tAtualizar o campo U_DescFinBP para ajustar o desconto financeiro no bankplus\r\n-- Comentado por conta da nova versao do add-on em produ‡ao. (WMS)\r\n-- GLPI ID:\r\n-- GLPI ID Atualiza‡oes:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*\r\nIF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002713\u0027 = Nota Fiscal Saida\r\nBEGIN\r\n\tDECLARE @CardCodeNF NVarchar (20)\r\n\t\r\n\tDECLARE @DescontoFinanceiroNF Decimal(10,2) SET @DescontoFinanceiroNF = 0\r\n\t\r\n\r\n\tSET @CardCodeNF  = (SELECT CardCode FROM OINV WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\r\n\tSET @DescontoFinanceiroNF = (SELECT U_MW_DESFIN FROM OCRD WHERE CardCode = @CardCodeNF)\r\n\t\r\n\t\tBEGIN\t\t\t\r\n\t\t\tUPDATE OINV \r\n\t\t\t\tSET   U_DescFinBP  = @DescontoFinanceiroNF,U_MW_DESCONTO  = @DescontoFinanceiroNF  WHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\tEND \r\n\t\t\r\nEND;\r\n*/\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\tBruno Cassiano\r\n-- Create date: 14/10/2022\r\n-- Update Date: \r\n-- Description: Trava de data de 5 dias de vencimento para ap¢lice de seguro da transportadora.\r\n-- Documentos: Ordem de Carga\r\n-- GLPI ID : 14240\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027BIM_ORDEMCARGA\u0027) and (@transaction_type in (\u0027U\u0027)) --\u0027BIM_ORDEMCARGA\u0027 = ORDEM DE CARGA\r\nBEGIN\r\n\r\nDECLARE @CodTransportadora Varchar(10) = (SELECT U_Transportadora FROM [@BIM_ORDEMCARGA] WHERE Docentry = @list_of_cols_val_tab_del)\r\nDECLARE @DiasRestantesApolice Numeric = 0\r\n\r\n\tIF (@CodTransportadora IS NOT NULL AND @CodTransportadora \u003c\u003e\u0027\u0027) \r\n\tBEGIN\r\n\t\r\n\tSET @DiasRestantesApolice = (SELECT DATEDIFF(DAY, GETDATE(), U_DataApoliceFinal) FROM OCRD WHERE CardCode = @CodTransportadora)\r\n\t\r\n\t\tIF(@DiasRestantesApolice IS NOT NULL AND @DiasRestantesApolice \u003c= 5)\r\n\t\tBEGIN\r\n\t\r\n\t\t\tSET @Error =-14240\r\n\t\t\tSET @Error_Message = \u0027A transportadora selecionada, est  com data da ap¢lice vencida ou a vencer!\u0027 \r\n\t\t\tSELECT @error, @error_message\t\r\n\r\n\t\tEND\r\n\r\n\tEND\t\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\tHenrique Santos\t\r\n-- Create date: 19/09/2022 \r\n-- Description: Trava de pedido com valor minimo por regiao\r\n-- Documentos: Pedido de Venda \r\n-- GLPI ID : 14141\r\n\r\n-- Author:\tVinicius Palmagnani Faria\r\n-- Update date: 18/10/2022\r\n-- Description: Bloquear apenas o departamento de vendas, nos itens PA e utiliza‡ao VENDA-REVENDA \r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027)) --\u002717\u0027 = Pedido de venda\r\n\r\nBEGIN\r\n\r\n\tDECLARE @Linhas14141 Numeric = (SELECT Count(*)FROM RDR1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @Cont14141 Numeric = 0\r\n\r\n\tDECLARE @UserSign14141 int = (SELECT UserSign FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @Dep14141 int = (SELECT Department FROM OUSR WHERE USERID = @UserSign14141)\r\n\r\n\tDECLARE @Usage14141 Nvarchar (255)\r\n\r\n\tDECLARE @GrupoItem14141 Nvarchar (255)\r\n\r\n\tDECLARE @ValorPedido14141 Numeric(10,2) = (SELECT DocTotal FROM ORDR WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tDECLARE @ValorMinReg14141 Numeric(10,2) set @ValorMinReg14141 = 0\r\n\r\n\tDECLARE @RegiaoPedMin14141 Varchar (max) = (SELECT T1.Name FROM OCRD T0 INNER JOIN [@MW_MICRO] T1 ON T1.Code = T0.U_MW_MICRO \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = (SELECT CardCode FROM ORDR WHERE DocNum = @list_of_cols_val_tab_del))\r\n\r\n\t\tWHILE(@Cont14141 \u003c @Linhas14141)\r\n\t\t\tBEGIN\r\n\t\t\t\tIF (@Dep14141 = 1)\r\n\r\n\t\t\t\t\tSET @Usage14141 = (SELECT Usage FROM RDR1 WHERE LineNum = @Cont14141 AND DocEntry = @list_of_cols_val_tab_del)\r\n\t\t\t\t\tIF (@Usage14141 = 17)\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tSET @GrupoItem14141 = (SELECT T1.ItmsGrpCod FROM RDR1 T0 INNER JOIN OITM T1 ON T1.ItemCode = T0.ItemCode\r\n\t\t\t\t\t\t\t\t\t\t\t   WHERE T0.LineNum = @Cont14141 AND T0.DocEntry = @list_of_cols_val_tab_del)\r\n\t\t\t\t\t\tIF @GrupoItem14141 IN (116,117,118) \r\n\t\t\t\t\t\tBEGIN\r\n\r\n\t\t\t\t\t\t\tSET @ValorMinReg14141 = (SELECT U_ValorMinimo FROM [@RAL_PEDMINIMOREG] WHERE U_Regiao = @RegiaoPedMin14141)\r\n\t\t\t\t\t\t\tIF(@ValorPedido14141 \u003c @ValorMinReg14141)\r\n\t\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\t\t\tSET @Error =-14141\r\n\t\t\t\t\t\t\t\t\tSET @Error_Message = \u0027Valor m¡nimo para o pedido ‚ \u0027 + cast(@ValorMinReg14141 as varchar)\r\n\t\t\t\t\t\t\t\t\tSELECT @error, @error_message\r\n\r\n\t\t\t\t\t\t\tEND--VALOR MINIMO\r\n\r\n\t\t\t\t\t\tEND--GRUPO ITEM\r\n\r\n\t\t\t\t\tEND--END USAGE\r\n\r\n\t\t\tSET @Cont14141 = @Cont14141 +1\r\n\t\t\tEND--END WHILE\r\nEND--END FINAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\tVinicius Palmagnani\r\n-- Create date: 30/05/2022\r\n-- Update Date: \r\n-- Description: Utiliza‡ao USO E CONSUMO obrigat¢rio preenchimento dos CSTs\r\n-- Documentos: NF de Entrada \r\n-- GLPI ID : 13504\r\n-- GLPI ID atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027)) --\u002718\u0027 = Nota Fiscal Entrada\r\n\r\nBEGIN\r\n\r\nDECLARE @Linhas13504 Numeric = (SELECT Count(*)FROM PCH1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Cont13504 Numeric = 0\r\n\r\nWHILE(@Cont13504 \u003c @Linhas13504)\r\n\tBEGIN\r\n\t\tIF EXISTS (SELECT T2.Usage,T0.CSTCode,T0.CSTfIPI,T0.CSTfPIS,CSTfCOFINS\r\n\t\t\t\t\tFROM PCH1 T0\r\n\t\t\t\t\tINNER JOIN OUSG T2 ON T2.ID = T0.Usage\r\n\t\t\t\t\tWHERE T0.Usage IN (27,26,29,51,31,32,33,23,62,24,25,50,28,18,41,19,20,21,63)\r\n\t\t\t\t\tAND (T0.CSTCode IS NULL OR T0.CSTfIPI IS NULL OR T0.CSTfPIS IS NULL OR CSTfCOFINS IS NULL)\r\n\t\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del AND T0.LineNum = @Cont13504)\r\n\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @Error =-13504\r\n\t\t\t\tSET @Error_Message = \u0027Favor revisar o preenchimento do CST\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\r\n\t\tSET @Cont13504 = @Cont13504 +1\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\tVinicius Palmagnani\r\n-- Create date: 18/05/2022\r\n-- Update Date: 01/06/2022\r\n-- Description: Grupo de itens MAQUINAS OPERACIONAIS ‚ obrigatorio preenchimento da utiliza‡ao \"OPE\" \r\n-- Documentos: NF de Entrada \r\n-- GLPI ID : 13410\r\n-- GLPI ID atualiza‡ao: 13518,13598\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027)) --\u002718\u0027 = Nota Fiscal Entrada\r\n\r\nBEGIN\r\n\r\n\tIF EXISTS (SELECT T0.DocEntry,T1.ItmsGrpCod,T0.OcrCode\r\n\t\t\t\tFROM PCH1 T0\r\n\t\t\t\tINNER JOIN OITM T1 ON T1.ItemCode = T0.ItemCode\r\n\t\t\t\tWHERE T1.ItmsGrpCod = 174\r\n\t\t\t\tAND T0.OcrCode IN (\u002701.0001\u0027, \u002701.0002\u0027,\u002701.0005\u0027)\r\n\t\t\t\tAND T0.Usage NOT IN (19,21,31,32)\r\n\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\t\tBEGIN\r\n\r\n\t\t\tSET @Error =-13410\r\n\t\t\tSET @Error_Message = \u0027Favor revisar o preenchimento do campo \"Utiliza‡ao\"\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\r\n\t\tEND\r\n\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Dalmir Pompeu Ponzo Junior\r\n-- Create date: 28/10/2021\r\n-- Update Date:\r\n-- Description: Travar altera‡oes e cancelamentos em Cota‡oes de Vendas para vendedores\r\n-- Documento: Cota‡ao de Vendas\r\n-- GLPI ID: 12179\r\n-- GLPI IG Atualiza‡ao: \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027U\u0027 , \u0027D\u0027 , \u0027C\u0027 , \u0027L\u0027))\r\nBEGIN\r\n\r\nDECLARE @UserSign12179C int = (SELECT UserSign2 FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Dep12179C int SET @Dep12179C = (SELECT Department FROM OUSR WHERE USERID = @UserSign12179C)\r\n\r\n\r\nIF(@Dep12179C = 1)\r\nBEGIN\r\n\r\n\r\nSET @error = -12179\r\nSET @error_message = \u0027Nao ‚ permitido alterar ou cancelar o documento. Favor entrar em contato com Administra‡ao de Vendas.\u0027\r\nSELECT @error, @error_message\r\nEND\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n*/\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Dalmir Pompeu Ponzo Junior\r\n-- Create date: 27/10/2021\r\n-- Update Date:\r\n-- Description: Travar altera‡oes e cancelamentos em Pedidos de Vendas para vendedores\r\n-- Documento: Pedido de Vendas\r\n-- GLPI ID: 12179\r\n-- GLPI ID Atualiza‡ao:16900\r\n-- UpdateAuthor: Leonardo do Prado Gomes\r\n-- Description: Acrescentado novo parametro para travar cancelamento do pedido de vendas.\r\n-- UpdateDate: 09/05/2024\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027U\u0027 , \u0027D\u0027 , \u0027C\u0027 , \u0027L\u0027))\r\nBEGIN\r\n\r\nDECLARE @UserSign12179V int = (SELECT UserSign2 FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Dep12179V int SET @Dep12179V = (SELECT Department FROM OUSR WHERE USERID = @UserSign12179V)\r\nDECLARE @UserAprov12179 INT;\r\nSET @UserAprov12179 = (SELECT T1.UserID\r\n\t\t\t\t\t\t\tFROM OWDD T0\r\n\t\t\t\t\t\t\tINNER JOIN WDD1 T1\r\n\t\t\t\t\t\t\t   ON T1.WddCode = T0.WddCode\r\n\t\t\t\t\t\t\tWHERE T1.UserID = 279\r\n\t\t\t\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del\r\n\t\t\t\t\t\t\tGROUP BY T1.UserID)\r\n\r\nIF(@Dep12179V = 1 AND @UserAprov12179 \u003c\u003e 279)\r\nBEGIN\r\n\r\n\tSET @error = -12179\r\n\tSET @error_message = \u0027Nao ‚ permitido alterar ou cancelar o documento. Favor entrar em contato com Administra‡ao de Vendas.\u0027\r\n\tSELECT @error, @error_message\r\n\tEND\r\n\r\nEND\r\n\r\n-------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027C\u0027))\r\nBEGIN\r\n\r\nDECLARE @UserSign16900V int = (SELECT UserSign2 FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Dep16900V int SET @Dep16900V = (SELECT Department FROM OUSR WHERE USERID = @UserSign16900V)\r\nDECLARE @UserAprov16900 INT;\r\nSET @UserAprov16900 = (SELECT T1.UserID\r\n\t\t\t\t\t\t\tFROM OWDD T0\r\n\t\t\t\t\t\t\tINNER JOIN WDD1 T1\r\n\t\t\t\t\t\t\t   ON T1.WddCode = T0.WddCode\r\n\t\t\t\t\t\t\tWHERE T1.UserID = 279\r\n\t\t\t\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\r\n\r\nIF(@Dep16900V \u003c\u003e 2 AND @UserAprov16900 \u003c\u003e 279)\r\nBEGIN\r\n\r\n\r\nSET @error = -12179\r\nSET @error_message = \u0027Nao ‚ permitido alterar ou cancelar o documento. Favor entrar em contato com Administra‡ao de Vendas.\u0027\r\nSELECT @error, @error_message\r\n\r\nEND\r\n\r\nEND\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Vinicius Palmagnani Faria\r\n-- Create date: 12/08/2021\r\n-- Description:\tBloquear cadastro de placas com mais de sete caracteres\r\n-- Documento: Cadastro de ve¡culo (add-on Ruston - perif‚ricos)\r\n-- GLPI ID: 11712\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u0027RAL_VEICULO\u0027) and (@transaction_type in (\u0027A\u0027, \u0027U\u0027))\r\n\r\nBEGIN\r\n\r\nDECLARE @PLACA11712 NVARCHAR(10) = (SELECT U_PLACA FROM [@RAL_VEICULO] WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\nIF LEN(@PLACA11712) \u003e 7\r\n\r\nSET @Error =-11712\r\nSET @Error_Message = \u0027Quantidade incorreta de caracteres na placa do ve¡culo. Favor revisar o preenchimento do campo.\u0027\r\nSELECT @error, @error_message\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- SPS CONSULTORIA\r\n-- Author: Cristiana Maria\r\n-- Create date: 15/06/2021\r\n-- Description:\tNao permitir lancamento contabil negativo\r\n-- Documento: Lancamento cont bil manual\r\n-- GLPI ID: 11332\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = N\u002730\u0027) and (@transaction_type in (\u0027A\u0027, \u0027U\u0027))\r\nBegin \r\n\r\nif (select count (transid) from jdt1 where debit \u003c 0 and TransId =  @list_of_cols_val_tab_del) \u003e0\r\nbegin\r\n\tset @Error =-11332\r\n    set @Error_Message = \u0027Lan‡amento cont bil com valor negativo.\u0027\r\n\tSELECT @error, @error_message\r\nend\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\tFabricio Consiglio\t\r\n-- Create date: 18/02/2021\r\n-- Description:\tPreencher campo \"Observa‡ao do di rio\" em importa‡ao de CTE de Venda\r\n-- Documento: NF-Entrada\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF ((\t\r\n\t\t@object_type = N\u002718\u0027)\r\n\tAND @transaction_type IN (\u0027A\u0027))\r\n\r\nBEGIN\r\n\tEXEC [dbo].[SPS_SP_OBS] @object_type, @list_of_cols_val_tab_del\t\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 18/01/2021\r\n-- Description:\tNao permitir pedido de Vendas com parceiro Lead (ESBO€O)\r\n-- Documento: Pedido de Vendas\r\n-- GLPI ID:9768\r\n-- GLPI IG Atualiza‡ao:10260\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\r\nDECLARE @CardType9768E char = (SELECT T1.CardType FROM ODRF T0\r\nINNER JOIN OCRD T1 on T0.CardCode = T1.CardCode\r\nWHERE T0.ObjType = 17 AND T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@CardType9768E =\u0027L\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -9768\r\n\t\t\tSET @error_message = \u0027Nao ‚ permitido enviar Pedido com cliente Lead - esbo‡o\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Vinicius Palmagnani Faria\r\n-- Create date: 10/09/2020\r\n-- Description: Impossibilitar adi‡ao de documento sem regra de distribui‡ao\r\n-- Documentos: Lan‡amento de estoque\r\n-- GLPI ID: 9450\r\n-- GLPI ID Atualiza‡oes:\r\n------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002710000071\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002710000071\u0027 = Lan‡amento de estoque\r\n \r\nBEGIN\r\n DECLARE @DocEntryLE int = @list_of_cols_val_tab_del\r\n DECLARE @DocTypeLE char = (SELECT DataSource FROM OIQR WHERE DocEntry = @DocEntryLE)\r\n \r\n ----Regra de Distribui‡ao\r\n IF EXISTS (SELECT OL.OcrCode FROM OIQR O INNER JOIN IQR1 OL ON O.DocEntry = ol.DocEntry\r\n \tWHERE o.DocEntry = @DocEntryLE AND (OL.OcrCode IS NULL OR OL.OcrCode = \u0027\u0027))\r\n\r\n \tBEGIN\r\n\t\tSET @error = -9450\r\n\t\tSET @error_message = \u0027Lan‡amento de estoque - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t\tSELECT @error, @error_message\r\n    END\r\n \r\nEND;\r\n \r\n---------------------------------ESBO€O\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--N\u0027112\u0027 = ESBO€O\r\n \r\nBEGIN\r\n DECLARE @DocEntryESBLE int = @list_of_cols_val_tab_del\r\n DECLARE @DocTypeESBLE char = (SELECT DocType FROM ODRF WHERE objtype = 10000071 AND DocEntry = @DocEntryESBLE)\r\n \r\n IF EXISTS (SELECT OL.OcrCode FROM ODRF O INNER JOIN DRF1 OL ON O.DocEntry = ol.DocEntry\r\n WHERE o.objtype = 10000071 AND o.DocEntry = @DocEntryESBLE AND OL.OcrCode IS NULL)\r\n\r\n\t BEGIN\r\n\t   SET @error = -9450\r\n\t   SET @error_message = \u0027Esbo‡o - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t   SELECT @error, @error_message\r\n\t END\r\n\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------- \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Vinicius Palmagnani\r\n-- Create date: 04/12/2020\r\n-- Update Date: \r\n-- Description: Travar atualiza‡ao de PN para vendedores/representantes com parceiro Cliente \r\n-- Documento: Parceiro de Negocios\r\n-- GLPI ID: 10063\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*IF (@object_type = \u00272\u0027) and (@transaction_type in (\u0027U\u0027)) --\u00272\u0027 = Parceiro de Negocios\r\nBEGIN\r\n\r\nDECLARE @UserSign10063 int = (SELECT UserSign2 FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @Dep10063 int SET @Dep10063 = (SELECT Department FROM OUSR WHERE USERID = @UserSign10063)\r\nDECLARE @CardType10063 char = (SELECT CardType FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\n\r\nIF(@Dep10063 = 1)\t\r\n\tBEGIN\r\n\t\r\n\tIF(@CardType10063 \u003c\u003e \u0027L\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -10063\r\n\t\t\tSET @error_message = \u0027Nao ‚ permitido atualizar os cadastros do PN.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END */\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 10/11/20\r\n-- Update Date: \r\n-- Description: Nao permitir pedido de Vendas com parceiro Lead\r\n-- Documento: Pedido de Vendas\r\n-- GLPI ID:9768\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u00272\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @CardType9768P char = (SELECT T1.CardType FROM ORDR T0\r\nINNER JOIN OCRD T1 on T0.CardCode = T1.CardCode\r\nWHERE T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@CardType9768P =\u0027L\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -9768\r\n\t\t\tSET @error_message = \u0027Nao ‚ permitido enviar Pedido com cliente Lead.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 10/11/20\r\n-- Update Date: \r\n-- Description: Nao permitir cota‡ao de Vendas com parceiro Lead\r\n-- Documento: Cota‡ao de Vendas\r\n-- GLPI ID:9768\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027 ))--\u00272\u0027 = Cota‡ao de vendas\r\nBEGIN\r\n\r\nDECLARE @CardType9768C char = (SELECT T1.CardType FROM OQUT T0\r\nINNER JOIN OCRD T1 on T0.CardCode = T1.CardCode\r\nWHERE T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@CardType9768C =\u0027L\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -9768\r\n\t\t\tSET @error_message = \u0027Nao ‚ permitido enviar Cota‡ao com cliente Lead.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 10/11/20\r\n-- Update Date: \r\n-- Description: Travar cadastro de pn feito por vendedores sem Nome, telefone, email e cnpj \r\n-- Documento: Parceiro de Negocios\r\n-- GLPI ID:9768\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u00272\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00272\u0027 = Parceiro de NEgocios\r\nBEGIN\r\n\r\nDECLARE @UserSign9768 int = (SELECT UserSign FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\n\r\nDECLARE @Dep9768 int SET @Dep9768 = (SELECT Department FROM OUSR WHERE USERID = @UserSign9768)\r\n\r\nDECLARE @CardName9768 NVARCHAR(MAX) = (select CardName from OCRD where CardCode = @list_of_cols_val_tab_del)\r\n\r\nDECLARE @Telefone9768 NVARCHAR(MAX) = (select Phone1 from OCRD where CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @Email9768 NVARCHAR(MAX) = (select E_mail from OCRD where CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @CNPJ9768 NVARCHAR(MAX) = (SELECT DISTINCT  T1.TaxId0 FROM OCRD T0 \r\n\t\t\t\t\t\t\t\t\tINNER JOIN CRD7 T1 ON T0.CardCode = T1.CardCode AND T0.ShipToDef = T1.Address\r\n\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = \u0027C001965\u0027 AND T1.TaxId0 IS NOT NULL)\r\nDECLARE @UserPortal9768 INT\r\nSET @UserPortal9768 = (SELECT T1.Department\r\n\t\t\t\t\t\t\tFROM OUSR T1\r\n\t\t\t\t\t\t\tWHERE T1.USER_CODE IN(SELECT T0.U_AHS_SapUserCode\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tFROM OCRD T0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = @list_of_cols_val_tab_del))\r\n\r\nIF(@UserPortal9768 \u003c\u003e 17) ----EQUIPE DE COMPRAS(SUPRIMENTO)\r\nBEGIN\r\n\r\n\tIF(@Dep9768 = 1)\t\r\n\tBEGIN\r\n\t\r\n\t\tIF(@CardName9768 is null OR @CardName9768 =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -9768\r\n\t\t\t\tSET @error_message = \u0027Campo NOME ‚ obrigat¢rio. Verifique!.\u0027\t\t\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tIF(@Telefone9768 is null OR @Telefone9768 =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -9768\r\n\t\t\t\tSET @error_message = \u0027Campo TELEFONE ‚ obrigat¢rio. Verifique!.\u0027\t\t\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tIF(@Email9768 is null OR @Email9768 =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -9768\r\n\t\t\t\tSET @error_message = \u0027Campo E-MAIL ‚ obrigat¢rio. Verifique!.\u0027\t\t\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tIF(@CNPJ9768 is null OR @CNPJ9768 =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -9768\r\n\t\t\t\tSET @error_message = \u0027Campo CNPJ ‚ obrigat¢rio. Verifique!.\u0027\t\t\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\t\r\n\t\tEND\t\r\n\r\n\tEND\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 03/11/2020\r\n-- Update Date: \r\n-- Description: Campos Grupo UF Cliente e Grupo fornecedores sao obrigatorios\r\n-- Documento: Parceiro de Negocios\r\n-- GLPI ID:9709\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u00272\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00272\u0027 = Parceiro de NEgocios\r\nBEGIN\r\n\r\n\r\nDECLARE @CardType9709 char = (SELECT CardType FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @GruCli NVARCHAR(MAX) = (SELECT U_MW_GRUCLI FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @GruFor NVARCHAR(MAX) = (SELECT U_MW_GRUFOR FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @UserPortal9709 INT\r\nSET @UserPortal9709 = (SELECT T1.Department\r\n\t\t\t\t\t\t\tFROM OUSR T1\r\n\t\t\t\t\t\t\tWHERE T1.USER_CODE IN(SELECT T0.U_AHS_SapUserCode\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tFROM OCRD T0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = @list_of_cols_val_tab_del))\r\n\r\nIF(@UserPortal9709 \u003c\u003e 17) ----EQUIPE DE COMPRAS(SUPRIMENTO)\r\nBEGIN\r\n\tIF(@CardType9709 = \u0027C\u0027 AND (@GruCli is null OR @GruCli =\u0027\u0027 OR @GruCli = \u0027DEFINIR\u0027))\t\r\n\t\tBEGIN\r\n\t\t\tSET @error = -9709\r\n\t\t\tSET @error_message = \u0027O preenchimento do campo Grupo UF de Cliente ‚ Obrigat¢rio. Verifique!.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\n\tELSE IF(@CardType9709 = \u0027S\u0027 AND (@GruFor is null OR @GruFor =\u0027\u0027 OR @GruFor = \u0027DEFINIR\u0027))\t\r\n\t\tBEGIN\r\n\t\t\tSET @error = -9709\r\n\t\t\tSET @error_message = \u0027O preenchimento do campo Grupo Fornecedores ‚ Obrigat¢rio. Verifique!.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- Author:Henrique Truyts\r\n---- Create date: 21/10/2020\r\n---- Update Date: \r\n---- Description: Trava para evitar altera‡ao da OC em caso de divergencias de quantidade da oc com o pedido\r\n---- Documento: Ordem de Carga\r\n---- GLPI ID:9173\r\n---- GLPI IG Atualiza‡ao: 15004\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u0027BIM_ORDEMCARGA\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00272\u0027 = Ordem de Carga\r\n--BEGIN\t\r\n--\tIF EXISTS (\r\n--\t----COMPARA€AO ENTRE TOTAIS DA OC E TOTAIS DOS PEDIDOS DA OC\r\n--\t----SE O CAMPO DIFEREN€A FOR MAIOR QUE ZERO DEVE-SE REFAZER A OC\r\n--\tSELECT *FROM (\r\n--\t\tSELECT \r\n--\t\t\tT100.U_Codigo,SUM(T100.U_Quantidade_Pedido) \u0027Qtd OC\u0027,\r\n--\t\t\t(--totais do pedido\r\n--\t\t\tSELECT \r\n--\t\t\t\tSUM(T1.Quantity)\r\n--\t\t\tFROM ORDR T0\r\n--\t\t\tINNER JOIN RDR1 T1 on T0.DocEntry = T1.DocEntry\r\n--\t\t\tWHERE CANCELED = \u0027N\u0027 AND T1.U_OC_num = T100.DocEntry AND ItemCode = U_Codigo\r\n--\t\t\tGROUP BY T1.ItemCode\r\n--\t\t\t)\u0027Totais do Pedido\u0027,\r\n--\t\t\tSUM\r\n--\t\t\t\t(U_Quantidade_Pedido) -\r\n--\t\t\t\t(--totais do pedido\r\n--\t\t\t\tSELECT \r\n--\t\t\t\t\tSUM(T1.Quantity)\r\n--\t\t\t\tFROM ORDR T0\r\n--\t\t\t\tINNER JOIN RDR1 T1 on T0.DocEntry = T1.DocEntry\r\n--\t\t\t\tWHERE CANCELED = \u0027N\u0027 AND T1.U_OC_num = T100.DocEntry AND ItemCode = U_Codigo\r\n--\t\t\t\tGROUP BY T1.ItemCode\r\n--\t\t\t)\u0027Diferen‡a\u0027\r\n--\t\tFROM [@BIM_ORDEMCARGA_1]  T100\r\n--\t\tWHERE T100.DocEntry =  @list_of_cols_val_tab_del\r\n--\t\tGROUP BY T100.U_Codigo,T100.DocEntry\r\n--\t)A WHERE Diferen‡a \u003e 0\r\n\r\n--\t)\r\n--\tBEGIN\r\n--\t\tSET @error = -9173\r\n--\t\tSET @error_message =  \u0027Divergˆncia entre as quantidades da OC e do pedido, favor refazer a OC!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\t\r\n--END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n----END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 25/01/2018\r\n-- Update Date: 13/08/2020\r\n-- Update Date: 21/12/2023\r\n-- Description:\tPREENCHIMENTO DOS CAMPOS DE OC NA ENTREGA\r\n-- Description: 14/12/2023 - Atualizado para colocarmos informa‡ao de horario de recebimento do parceiro no pedido.\r\n-- Documentos: Entrega\r\n-- GLPI ID:4103\r\n---- GLPI ID Atualiza‡oes:9231\r\n---- GLPI ID Atualiza‡oes:16244\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002715\u0027 = ENTREGA\r\nBEGIN\r\nIF EXISTS((SELECT *FROM (\r\n\t\tSELECT \r\n\t\t\tT0.U_OC_NUM ,T0.DocEntry,T0.U_dtPreventregainicial,T0.U_dtPreventregafinal,T0.U_Status\r\n\t\tFROM\r\n\t\t\tDLN1 T0 \r\n\t\tWHERE \r\n\t\t\tT0.DocEntry = @list_of_cols_val_tab_del AND U_Status \u003c\u003e\u0027Liberada\u0027)A))\r\n\tBEGIN\r\n\t\t\tSET @error = -4103\r\n\t\t\tSET @error_message = \u0027OC nao est  liberada para a Entrega. Verifique.\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\t\r\n\tEND\r\n\tIF ((SELECT Count(*)FROM    (\r\n\t\tSELECT \r\n\t\t\tT0.U_OC_NUM ,T0.DocEntry,T0.U_dtPreventregainicial,T0.U_dtPreventregafinal,T0.U_Status\r\n\t\tFROM\r\n\t\t\tDLN1 T0 \r\n\t\tWHERE \r\n\t\t\tT0.DocEntry = @list_of_cols_val_tab_del\r\n\t\tGROUP BY \r\n\t\t\tT0.U_OC_NUM,T0.DocEntry,T0.U_dtPreventregainicial,T0.U_dtPreventregafinal,T0.U_Status) A) \u003c\u003e 1)\r\n\tBEGIN\r\n\t\t\tSET @error = -4103\r\n\t\t\tSET @error_message = \u0027Existe linhas da Entrega sem aloca‡ao de OC ou com OC distintas. Verifique!\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\t\r\n\tEND\r\n\tELSE IF((SELECT T0.U_OC_NUM FROM DLN1 T0 WHERE T0.DocEntry = @list_of_cols_val_tab_del GROUP BY T0.U_OC_NUM ) IS NOT NULL)\r\n\tBEGIN\r\n\t\t\tDECLARE @DocEntryOC NVARCHAR (254) = (SELECT T0.U_OC_NUM FROM DLN1 T0 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0)\r\n\r\n--ALTERA€AO REALIZADA AQUI\r\n--UPDATE ENTREGA\r\n\tUPDATE ODLN SET \r\n\t\tU_OC_NUM = (SELECT T0.U_OC_NUM FROM DLN1 T0 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0),\r\n\t\tU_dtPreventregainicial = (SELECT T0.U_dtPreventregainicial FROM DLN1 T0 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0),\r\n\t\tU_dtPreventregafinal = (SELECT T0.U_dtPreventregafinal FROM DLN1 T0 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0),\r\n\t\tU_Status = (SELECT T0.U_Status FROM DLN1 T0 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0),\r\n\t\tHeader = (\u0027Pedido: \u0027+ \r\n\t(SELECT Convert(NVarchar(MAX),BaseEntry) FROM DLN1 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0) +\r\n\t\t\t\u0027, Oc: \u0027 + (SELECT T0.U_OC_NUM FROM DLN1 T0 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0)+ char(13) + \r\n\t\t\t\u0027Pn: \u0027 + (SELECT CardCode FROM ODLN WHERE DocEntry = @list_of_cols_val_tab_del) + \u0027,\u0027 + (SELECT [dbo].[PNHorarioEntrega]((SELECT CardCode FROM ODLN WHERE DocEntry = @list_of_cols_val_tab_del))) + \u0027, Entr: \u0027 + (SELECT Convert(NVARCHAR(MAX),DocNum) FROM ODLN WHERE DocEntry = @list_of_cols_val_tab_del) +char(13) + \r\n\t\t(SELECT CASE WHEN ( U_LocalEntregaLabel IS NOT NULL AND U_LocalEntregaLabel\u003c\u003e\u0027\u0027) THEN (\r\n\t\tSELECT \u0027Local de Entrega:\u0027+ \r\n\t\tCASE WHEN U_tipoLogradouro IS NOT NULL THEN U_tipoLogradouro ELSE \u0027\u0027 END +\u0027 \u0027+ \r\n\t\tCASE WHEN U_Logradouro IS NOT NULL THEN U_Logradouro ELSE \u0027\u0027 END +\u0027,\u0027+ \r\n\t\tCASE WHEN U_Numero IS NOT NULL THEN U_Numero ELSE \u0027\u0027 END +\u0027 -\u0027+\r\n\t\tCASE WHEN U_Bairro IS NOT NULL THEN U_Bairro ELSE \u0027\u0027 END +\u0027 - \u0027+\r\n\t\tCASE WHEN U_Municipio IS NOT NULL THEN U_Municipio ELSE \u0027\u0027 END +\u0027/\u0027+\r\n\t\tCASE WHEN U_Estado IS NOT NULL THEN U_Estado ELSE \u0027\u0027 END+\u0027 - CEP \u0027+\r\n\t\tCASE WHEN U_Cep IS NOT NULL THEN  U_Cep ELSE \u0027\u0027 END\r\n\t\tFROM [@RAL_LOCALENTREGA1] t0\r\n\t\tINNER JOIN [@RAL_LOCALENTREGA] T1 On t0.DocEntry = T1.DocEntry\r\n\t\tWHERE U_IDEndereco = (\r\n\t\tSELECT U_LocalEntregaLabel FROM ORDR WHERE DocEntry = (SELECT BaseEntry FROM DLN1 WHERE DocEntry =@list_of_cols_val_tab_del and VisOrder = 0))\t\r\n\t\t AND T1.U_CardCode = (\r\n\t\tSELECT cardCode FROM ORDR WHERE DocEntry = (SELECT BaseEntry FROM DLN1 WHERE DocEntry =@list_of_cols_val_tab_del and VisOrder = 0))\r\n\t\tGROUP BY U_IDEndereco ,U_tipoLogradouro ,U_Logradouro,U_Numero,U_Bairro,U_Municipio,U_Estado,U_Cep\r\n\t\t) ELSE \u0027\u0027 END\t\t\r\n\t\t FROM ORDR WHERE DocEntry = (SELECT BaseEntry FROM DLN1 WHERE DocEntry = @list_of_cols_val_tab_del and VisOrder = 0))+ char(13)+\r\n\t\t(SELECT CASE WHEN Header IS NOT NULL THEN Convert(NVARCHAR(MAX),Header) ELSE \u0027\u0027 END FROM ODLN WHERE DocEntry = @list_of_cols_val_tab_del))\t\t\r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del;\r\n\r\n\r\n\r\n\t\t\tUPDATE DLN12 SET Carrier = (SELECT U_Transportadora FROM [@BIM_ORDEMCARGA] WHERE DocEntry =  @DocEntryOC),\r\n\t\t\t\t\t\t QOP = (SELECT SUM(T0.QUANTITY) FROM DLN1 T0 WHERE T0.DocEntry = @list_of_cols_val_tab_del),\r\n\t\t\t\t\t\t PackDesc =  (SELECT dbo.DescricaoEmbalagensEntrega(@list_of_cols_val_tab_del)),\r\n\t\t\t\t\t\t Brand=\u0027Ruston\u0027,\r\n\t\t\t\t\t\t grsweight = (SELECT SUM (CAST(REPLACE(t1.U_MW_PESO_BRUTO,\u0027,\u0027,\u0027.\u0027) AS float) * T0.QUANTITY)\r\n\t\t\t\t\t\t FROM DLN1 T0  INNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode WHERE T0.[DocEntry] = @list_of_cols_val_tab_del),\r\n\t\t\t\t\t\t vehicle = (SELECT U_Placa FROM [@RAL_Veiculo] WHERE DocEntry = (SELECT U_Veiculo FROM [@BIM_ORDEMCARGA] WHERE DocEntry =  @DocEntryOC)),\r\n\t\t\t\t\t\t Incoterms = (SELECT U_Frete FROM [@BIM_ORDEMCARGA] WHERE DocEntry =  @DocEntryOC),\r\n\t\t\t\t\t\t VidState = (SELECT  U_Estado_Veiculo FROM [@RAL_Veiculo] WHERE DocEntry = (SELECT U_Veiculo FROM [@BIM_ORDEMCARGA] WHERE DocEntry =  @DocEntryOC))\r\n\t\t\t\t\t\t WHERE DocEntry = @list_of_cols_val_tab_del;\r\n\r\n\t\t\tUPDATE ODLN SET \r\n\t\t\t\t\t\t\tU_EmailEnvDanfe = (SELECT T2.E_Mail\r\n\t\t\t\t\t\t\t\t\t\t\t\tFROM ODLN T0\r\n\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN DLN12 T1 ON T1.DocEntry = T0.DocEntry\r\n\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN OCRD T2 ON T2.CardCode = T1.Carrier\r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.DocEntry = @list_of_cols_val_tab_del)\r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del;\r\n\r\n\tEND\r\n\r\nEND;--END GERAL\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n-------------------------------------------------------------------------------------------------------------------------\r\n---- Author: SPS\r\n---- Create date: 02/07/2020\r\n---- Description: Barrar no coletor as ocorrˆncias de duplicidade\r\n---- Documentos:  Entrada de mercadorias\r\n---- GLPI ID: 8984\r\n---- GLPI ID Atualiza‡oes:\r\n-------------------------------------------------------------------------------------------------------------------------\r\n\r\nif(@object_type = \u0027R_IA\u0027 AND @transaction_type IN (\u0027A\u0027,\u0027U\u0027))\r\nbegin\r\n\r\ndeclare @count int= 0\r\ndeclare @tipoPallet int = 0\r\n\r\nselect @tipoPallet = U_TpPallet from [@RAL_IA]\r\nwhere code = @list_of_cols_val_tab_del\r\n\r\nif(@tipoPallet = 0)\r\nbegin\r\n\r\n\tselect @count = COUNT(DocEntry) \r\n\tFROM OIGN \r\n\tWHERE U_NumIA = @list_of_cols_val_tab_del\r\n\t\r\n\t-- DIEGO 27/07/2022\r\n\t--if(@count \u003e 1)\r\n\t--begin\r\n\t--\tset @error = -8984\r\n\t--\tset @error_message = \u0027Pallet j  possui uma entrada\u0027\r\n\t--end\r\n\r\nend\r\n\r\nend \r\n\r\n\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-------------------------------------------------------------------------------------------------------------------------\r\n---- Author: Douglas Dias - SPS\r\n---- Create date: 02/06/2020\r\n---- Description: Travar OP sem preenchimento Custo componente item real\r\n---- Documentos:  Ordem de Produ‡ao\r\n---- GLPI ID: 8700\r\n---- GLPI ID Atualiza‡oes:\r\n-------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027202\u0027) and (@transaction_type in (\u0027U\u0027))--\u0027202\u0027 = Ordem de Produ‡ao\r\nBEGIN\r\nDECLARE @OPStatusF NVarchar(1) SET @OPStatusF = (select Status From OWOR where DocEntry = @list_of_cols_val_tab_del)\r\n\r\nIF(@OPStatusF = \u0027L\u0027)\r\nBEGIN\r\n\tIF NOT EXISTS(SELECT * FROM OWOR WHERE DocEntry IN (select top 1 BaseEntry from IGE1 where BaseEntry = @list_of_cols_val_tab_del)) --VERIFICA SE A OP ESTA SENDO FECHADA SEM SAIDA DE INSUMO (QUE APLICA O CUSTO DO ITEM)\r\n\tBEGIN\r\n\t\tSET @error = -8700\r\n\t\tSET @error_message = \u0027 obrigat¢rio o lan‡amento da Sa¡da de Insumo para contabilizar o Custo componente item!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND\r\n\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 28/05/2020\r\n-- Update Date: 30/04/2022\r\n-- Description:\tTravar Local de Entrega duplicado por parceiro de negocios\r\n-- Documentos:  Local de Entrega\r\n-- GLPI ID: 8813\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027CadLocalEntrega\u0027) and (@transaction_type in (\u0027A\u0027))--\u0027CadLocalEntrega\u0027 = Local de Entrega\r\nBEGIN\r\nDECLARE @CodigoCliente NVARCHAR(10) = (select U_CardCode from [@RAL_LOCALENTREGA] WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Filial8813 numeric = (select U_BPLId from [@RAL_LOCALENTREGA] WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\t\tIF EXISTS(\r\n\t\t\tselect *from [@RAL_LOCALENTREGA] where U_BPLId = @Filial8813 AND U_CardCode = @CodigoCliente AND DocEntry \u003c\u003e@list_of_cols_val_tab_del\r\n\t\t\t)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -8813\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ possivel concluir! J  existe cadastro de local de entrega para esse parceiro!\u0027\r\n\t\t\t\tSELECT @error, @error_message\t\r\n\t\t\tEND\r\n\t\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 16/08/2019\r\n-- Update Date: 28/02/2020\r\n-- Description:\tPreencher informa‡oes de Classifica‡ao e lote na Linha da entrega - Informa‡oes vao para NF - WMS\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002715\u0027 =ENTREGA \r\n\r\nBEGIN\r\n\tDECLARE @ContadorEnt2 int = 0\t\r\n\tDECLARE @ClassificacaoEnt2 nvarchar (255)\r\n\tDECLARE @DocEntryEnt2 int = @list_of_cols_val_tab_del\r\n\tDECLARE @QtyLinesEnt2  int = (SELECT MAX(LineNum) FROM DLN1 WHERE DocEntry =  @DocEntryEnt2)\t\r\n\t\r\n\tWHILE(@ContadorEnt2 \u003c @QtyLinesEnt2+1)\r\n\r\n\t\tBEGIN\r\n\t\t\t--SET @ClassificacaoEnt2 = (SELECT [dbo].[Preench_LoteClassif_Entrega](@DocEntryEnt2,@ContadorEnt2))\r\n\r\n\t\t\tSET @ClassificacaoEnt2 = (SELECT [dbo].[Preench_LotepeloPick_Entrega](@DocEntryEnt2,@ContadorEnt2)) ---REMOVIDO 02/12/2025\r\n\r\n\t\t\tif(@ClassificacaoEnt2 is null OR @ClassificacaoEnt2 = \u0027\u0027)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\tSET @ClassificacaoEnt2 = (SELECT [dbo].[Preench_LoteClassif_Entrega](@DocEntryEnt2,@ContadorEnt2))\r\n\r\n\t\t\tEND\r\n\r\n\t\t\tif (@ClassificacaoEnt2 is not null AND @ClassificacaoEnt2 \u003c\u003e \u0027\u0027)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\r\n\t\t\t\t\tUPDATE DLN1\tSET U_SKILL_InfAdItem = @ClassificacaoEnt2 WHERE DocEntry = @DocEntryEnt2 AND LineNum =  @ContadorEnt2\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\t\t\r\n\t\t\tSET @ContadorEnt2 = @ContadorEnt2 + 1\r\n\t\tEND;\r\n\r\nEND;--END GERAL\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create Date: 21/01/2020\r\n-- Update Date: \r\n-- Description:\tBloquear campos Rendimento\r\n-- GLPI ID: 8272\r\n-- GLPI ID Atualiza‡oes:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027Rendimento\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))-- RENDIMENTOS\r\nBEGIN \r\n--Validar BBranco - \r\n\tIF EXISTS(select Code,U_BBranco From [@RA_RENDIMENTO] where U_BBranco \u003e 99.99 \r\n\tAND code = @list_of_cols_val_tab_del)\r\n\tBEGIN\r\n\t\tSET @error = -8272\r\n\t\tSET @error_message = \u0027BBranco nao pode ser maior que 99.99\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n-------------------------------------------------------------------------------------------------------------------------\r\n---- Author: Vinicius Palmagnani \r\n---- Create date: 14/01/2020\r\n---- Update date: 21/07/2020\r\n---- Description: Travar documento sem preenchimento N§ Requisi‡ao/N§ Chamado\r\n---- Documentos:  Sa¡da de Mercadorias\r\n---- GLPI ID: 8239\r\n---- GLPI ID Atualiza‡oes:9070\r\n-------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002760\u0027) and (@transaction_type in (\u0027A\u0027))--N\u002760\u0027 = OIGE\r\nBEGIN\r\n\tDECLARE @NumReq VARCHAR(MAX) = \u0027\u0027\r\n\tDECLARE @NumCha VARCHAR(MAX) = \u0027\u0027\r\n\tDECLARE @QtyLines8239  int = (SELECT MAX(LineNum) FROM IGE1 WHERE DocEntry = @list_of_cols_val_tab_del)\t\r\n\tDECLARE @Cont8239 int = 0\r\n\r\n\tIF EXISTS(SELECT * FROM \r\n\t\t\t  OIGE T0 INNER JOIN IGE1 T1 ON T1.DocEntry = T0.DocEntry\r\n\t\t\t  WHERE T0.DocEntry = @list_of_cols_val_tab_del AND T0.DataSource \u003c\u003e \u0027A\u0027 AND T0.RelatedTyp \u003c\u003e 59\r\n\t\t\t\t\tAND T1.WhsCode = \u002702.07\u0027 AND T1.BaseType \u003c\u003e 202)\r\n\t\tBEGIN\r\n\r\n\t\t\tWHILE (@Cont8239 \u003c= @QtyLines8239)\r\n\t\t\tBEGIN\r\n\r\n\t\t\tIF EXISTS (SELECT * FROM IGE1 \r\n\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont8239)\r\n\t\t\t\tBEGIN\r\n\r\n\t\t\t\t\tSET @NumReq = (SELECT U_NumRequisicao FROM IGE1 \r\n\t\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont8239)\r\n\r\n\t\t\t\t\tSET @NumCha = (SELECT U_NumChamado FROM IGE1 \r\n\t\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont8239)\r\n\r\n\t\t\t\t\t\tIF (@NumReq is null or @NumReq = \u0027\u0027)\r\n\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\tSET @error = -8239\r\n\t\t\t\t\t\t\tSET @error_message = \u0027O preenchimento do campo \"N§ Requisi‡ao\" ‚ obrigat¢rio\u0027\r\n\t\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\t\tEND\r\n\r\n\t\t\t\t\t\tIF (@NumCha is null or @NumCha = \u0027\u0027)\r\n\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\tSET @error = -8239\r\n\t\t\t\t\t\t\tSET @error_message = \u0027O preenchimento do campo \"N§ Chamado\" ‚ obrigat¢rio\u0027\r\n\t\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\t\tSET @Cont8239 = @Cont8239 +1\r\n\t\t\tEND\r\n\t\tEND\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n---- Author: Henrique Truyts \r\n---- Create date: 06/01/2020\r\n---- Update Date: \r\n---- Description: Atualizar o campo Comissao do assistente na Linha do Pedido \r\n----              Com base no cadastro de comissao do assistente\r\n---- Documentos:  Pedido de Venda\r\n---- GLPI ID: 7452\r\n---- GLPI ID Atualiza‡oes:\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\tDECLARE @ContAssist int = 0\t\r\n\tDECLARE @ComissaoAssistente float = 0\r\n\tDECLARE @DocEntryAssist int = @list_of_cols_val_tab_del\r\n\tDECLARE @CardCodeComAssist Nvarchar (20) = (SELECT CardCode FROM ORDR WHERE DocEntry = @DocEntryAssist)\r\n\tDECLARE @ComAssistPN float = 0\r\n\tDECLARE @QtyLinesAssist  int = (SELECT MAX(LineNum) FROM rdr1 WHERE DocEntry = @DocEntryAssist)\t\r\n\r\n\r\n\tSet @ComAssistPN = (SELECT Coalesce(U_ComissaoAssistente,0) FROM OCRD WHERE CardCode = @CardCodeComAssist)\r\n\t\t\r\n\tWHILE(@ContAssist \u003c @QtyLinesAssist+1)\r\n\t\tBEGIN\r\n\t\t\tIF(@ComAssistPN is not null AND @ComAssistPN \u003e0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @ComissaoAssistente = @ComAssistPN\r\n\t\t\t\tEND\r\n\t\t\tELSE \r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @ComissaoAssistente = (\r\n\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\tT0.U_Comissao\r\n\t\t\t\t\t\tFROM\t\r\n\t\t\t\t\t\t[@RAL_ComAssist1] T0\r\n\t\t\t\t\t\tINNER JOIN [@RAL_ComAssist] T1 ON T1.Code = T0.Code\r\n\t\t\t\t\t\tINNER JOIN OSLP T2 ON T2.SlpCode = T1.U_SlpCode\r\n\t\t\t\t\t\tINNER JOIN OCRD T5 ON T5.U_Assistente = T2.SlpName\r\n\t\t\t\t\t\tINNER JOIN ORDR T3 ON T3.CardCode = T5.CardCode  \r\n\t\t\t\t\t\tINNER JOIN RDR1 T4 ON T4.DocEntry = T3.DocEntry AND T0.U_ItemCode = T4.ItemCode\r\n\t\t\t\t\t\tWHERE T3.DocNum = @DocEntryAssist AND T4.LineNum = @ContAssist)\r\n\t\t\t\tEND\r\n\r\n\t\t\tif (@ComissaoAssistente \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE RDR1\tSET U_ComissaoAssistente = @ComissaoAssistente WHERE DocEntry = @DocEntryAssist AND LineNum =  @ContAssist\r\n\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\t\t\r\n\t\t\tSET @ContAssist = @ContAssist + 1\r\n\t\tEND;\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n------------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 04/04/2019\r\n-- Update date: 10/12/2019\r\n-- Update date: 05/10/2020\r\n-- Description:\tGravar o Pre‡o de Lista do PN ao adicionar o pedido\r\n-- GLPI ID:6659\r\n-- GLPI ID Atualiza‡oes:8127\r\n-- GLPI ID Atualiza‡oes: 9608 - Aplicar desconto no Pre‡o de Lista\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\t\r\nDECLARE @PrecoDeLista Numeric(10,2) = 0\r\nDECLARE @CodigoItem6659 NVARCHAR(10)\r\nDECLARE @TotalLinhas6659 Numeric = (SELECT Max(LineNum) FROM RDR1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Cont6659 Numeric = 0\r\nDECLARE @PrecoExistente Numeric = 0\r\nDECLARE @Desconto9608 NUMERIC = 0\r\n\r\nWHILE(@Cont6659 \u003c @TotalLinhas6659 + 1)\r\n\tBEGIN\r\n\t\tIF EXISTS( SELECT *FROM RDR1 WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont6659)\r\n\t\tBEGIN\r\n\t\t\tSELECT \r\n\t\t\t@CodigoItem6659 = T1.ItemCode,\r\n\t\t\t@PrecoDeLista  = T5.price,\r\n\t\t\t@PrecoExistente = (case when T1.U_PrecoDeLista is null then 0 else T1.U_PrecoDeLista end),\r\n\t\t\t@Desconto9608 = T1.DiscPrcnt\r\n\t\t\tFROM ORDR T0\r\n\t\t\tINNER JOIN RDR1 T1 ON T0.DocEntry = T1.DocEntry \r\n\t\t\tINNER JOIN OCRD T3 ON T0.CardCode = T3.CardCode\r\n\t\t\tINNER JOIN OPLN T4 ON T3.ListNum = T4.ListNum\r\n\t\t\tINNER JOIN ITM1 T5 ON T4.ListNum = T5.PriceList AND T1.ItemCode = T5.ItemCode\r\n\t\t\tWHERE  T0.DocEntry = @list_of_cols_val_tab_del AND T1.LineNum = @Cont6659\r\n\r\n\t\t\tIF ( (@CodigoItem6659  is not null AND @CodigoItem6659 \u003c\u003e \u0027\u0027)\r\n\t\t\t\t\t AND (@PrecoDeLista is not null AND @PrecoDeLista \u003e 0)\r\n\t\t\t\t\t\tAND (@PrecoExistente is null OR @PrecoExistente = 0))\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE RDR1\tSET U_PrecoDeLista = @PrecoDeLista - (@PrecoDeLista * @Desconto9608 / 100)\r\n\t\t\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del AND ItemCode = @CodigoItem6659 AND LineNum =  @Cont6659\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\r\n\t\tEND \r\n\t\tSET @Cont6659 = @Cont6659 + 1\r\n\tEND;\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 21/11/2017\r\n-- Update Date: 11/11/2019\r\n-- Description:\tTRAVA DE CAMPOS ATENDIMENTO\r\n-- GLPI ID: 3873,7718\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027DWU_atend\u0027) and (@transaction_type in (\u0027A\u0027))--N\u0027C1_atend\u0027 = ATENDIMENTO\r\nBEGIN\r\n--@VERDADEIRO \u003e 0 se for igual a 2 ou 7, e o usu rio de cria‡ao do Atendimento for do departamento \"Vendas\"\r\n\r\n\r\nDECLARE @TotalLinhasAtend INT = (SELECT COUNT(*)FROM [@DWU_ATEND_ITENS] WHERE DocEntry = @list_of_cols_val_tab_del) \r\nDECLARE @ContAtend int = 0\r\n\r\n\tIF EXISTS( SELECT  *FROM [@DWU_ATENDIMENTO] T0 \r\n\t\t\t\t\t\t\tINNER JOIN OUSR T1 ON T0.UserSign = T1.USERID\r\n\t\t\t\t\t\t\tWHERE T1.Department = 1 AND T0.U_CodTipoAtendimento IN (2,7) \r\n\t\t\t\t\t\t\tAND T0.DocEntry = @list_of_cols_val_tab_del )\r\n\tBEGIN\r\n\t\tWHILE(@ContAtend \u003c @TotalLinhasAtend )\r\n\t\tBEGIN\r\n\t\t\tIF EXISTS(SELECT U_Motivo FROM [@DWU_ATEND_ITENS] WHERE \r\n\t\t\t\tDocEntry = @list_of_cols_val_tab_del AND LineId =@ContAtend +1 AND (U_MOTIVO IS NULL OR U_MOTIVO =\u0027\u0027)  )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o campo MOTIVO na aba dos Itens !\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF U_MOTIVO\r\n\t\t\tIF EXISTS(SELECT U_Ref1 FROM [@DWU_ATEND_ITENS] WHERE \r\n\t\t\t\tDocEntry = @list_of_cols_val_tab_del AND LineId =@ContAtend +1 AND (U_Ref1 IS NULL OR U_Ref1 =\u0027\u0027) )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o campo LOTE na aba dos Itens !\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF U_Ref1\r\n\t\t\tIF EXISTS(SELECT U_Ref2 FROM [@DWU_ATEND_ITENS] WHERE \r\n\t\t\t\t\tDocEntry = @list_of_cols_val_tab_del AND LineId =@ContAtend +1 AND (U_Ref2 IS NULL OR U_Ref2 =\u0027\u0027) )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o campo DATA FABRICA€AO na aba dos Itens !\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF U_Ref2 \r\n\t\t\tIF EXISTS(SELECT U_Ref3 FROM [@DWU_ATEND_ITENS] WHERE \r\n\t\t\t\tDocEntry = @list_of_cols_val_tab_del AND LineId =@ContAtend +1 AND (U_Ref3 IS NULL OR U_Ref3 =\u0027\u0027) )\r\n\t\t\tBEGIN\r\n\t\t\t    SET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o campo DATA VALIDADE na aba dos Itens !\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF U_Ref3\r\n\t\t\tSET @ContAtend = @ContAtend +1\r\n\t\tEND --END WHILE\r\n\tEND--end if verdadeiro\r\n\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END - TRAVA DE CAMPOS ATENDIMENTO CRM- ID 3873\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n-------------------------------------------------------------------------------------------------------------------------\r\n---- Author: Henrique Truyts \r\n---- Create date: 11/10/2019\r\n---- Update Date: \r\n---- Description: Travar OP sem Classifica‡ao de OP\r\n---- Documentos:  Ordem de Produ‡ao\r\n---- GLPI ID: 7790\r\n---- GLPI ID Atualiza‡oes:\r\n-------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027202\u0027) and (@transaction_type in (\u0027U\u0027))--\u0027202\u0027 = Ordem de Produ‡ao\r\nBEGIN\r\nDECLARE @OPStatus NVarchar(1) SET @OPStatus = (select Status From OWOR where DocEntry = @list_of_cols_val_tab_del)\r\n\r\nIF(@OPStatus = \u0027L\u0027)\r\nBEGIN\r\n\tIF EXISTS(select Status From OWOR where DocEntry = @list_of_cols_val_tab_del and (U_ClassOP is null or U_ClassOP =\u0027\u0027))\r\n\tBEGIN\r\n\t\tSET @error = -7790\r\n\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Classifica‡ao de OP, verifique!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND\r\n\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n-------------------------------------------------------------------------------------------------------------------------\r\n---- Author:\t\tHenrique Truyts \r\n---- Create date: 29/01/2018\r\n---- Update Date: 27/09/2019\r\n---- Description: Travar Documentos sem RA preenchido \r\n---- Documentos:  Solicita‡ao de Compra,Oferta de Compra, Saida de mercadorias\r\n---- GLPI ID: 6345\r\n---- GLPI ID Atualiza‡oes: 9451\r\n---- Description: Retirar a trava de RA dos documentos sa¡da de mercadoria e entrada de mercadoria em 13/09/2020\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u00271470000113\u0027) and (@transaction_type in (\u0027A\u0027))--\u00271470000113\u0027 = Solicita‡ao de Compra\r\n--BEGIN\r\n--\tIF EXISTS(SELECT * FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del AND (U_RAL_CadastroRA IS NULL OR  U_RAL_CadastroRA = \u0027\u0027))\r\n--\tBEGIN\r\n--\t\tSET @error = -6345\r\n--\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Cadastro RA, verifique!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\n--END\r\n------------------------------OFERTA DE COMPRA\r\n--IF (@object_type = \u0027540000006\u0027) and (@transaction_type in (\u0027A\u0027))--\u0027540000006\u0027 = Oferta de Compra\r\n--BEGIN\r\n--\tIF EXISTS(SELECT * FROM PQT1 WHERE DocEntry =@list_of_cols_val_tab_del  AND (U_RAL_CadastroRA IS NULL OR  U_RAL_CadastroRA = \u0027\u0027))\r\n--\tBEGIN\r\n--\t\tSET @error = -6345\r\n--\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Cadastro RA, verifique!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\n--END\r\n--------------------------------SAIDA DE MERCADORIAS\r\n--IF (@object_type = \u002760\u0027) and (@transaction_type in (\u0027A\u0027))--\u002760\u0027 = Saida de mercadorias\r\n--BEGIN\r\n--\tIF EXISTS(SELECT * FROM IGE1 WHERE BaseType \u003c\u003e202 AND DocEntry =@list_of_cols_val_tab_del  AND (U_RAL_CadastroRA IS NULL OR  U_RAL_CadastroRA = \u0027\u0027))\r\n--\tBEGIN\r\n--\t\tSET @error = -6345\r\n--\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Cadastro RA, verifique!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 31/01/2017\r\n-- Update date: 23/09/2019\r\n-- Update date: 15/05/2024\r\n-- Description:\tTravar Solicita‡oes de compras com data necessaria inferior ao prazo de solicita‡ao\r\n-- Bruno pediu para adicionar a a‡ao ao atualizar em 23/09/2019\r\n-- DescriptionUpdate: acrescentado nova regra para que o colaborador william (compras) nao caia na regra e consiga atualizar o campo de status da solicitacao\r\n-- Documentos: Solicita‡ao de Compras\r\n-- GLPI ID : 4768\r\n-- GLPI Update ID : 16926\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u00271470000113\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00271470000113\u0027 = Solicita‡ao de Compras\r\nBEGIN\r\nDECLARE @TotLinhas4768 Numeric SET @TotLinhas4768 =  (SELECT Count(*) FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Cont4768 Numeric = 0\r\nDECLARE @ReqDate4768 DATETIME = null\r\nDECLARE @PrazoDias Numeric = 0\r\nDECLARE @DataAtual Datetime SET @DataAtual = (SELECT GETDATE())\r\nDECLARE @Urgente Char(1) SET @Urgente =(SELECT U_Ral_Urgente FROM OPRQ WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @User16926 Varchar(254)\r\n\r\nSET @User16926 = (SELECT T0.UserSign2\r\n\t\t\t\t FROM OPRQ T0\r\n\t\t\t\t WHERE T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF (@User16926 \u003c\u003e 230)\r\n\tBEGIN\r\n\r\n\t\tIF(@Urgente = \u0027N\u0027)\r\n\t\tBEGIN\r\n\t\tWHILE(@Cont4768 \u003c@TotLinhas4768)\r\n\t\tBEGIN\r\n\t\t\tSET @ReqDate4768 = (SELECT PQTReqDate FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont4768)\r\n\t\t\r\n\t\t\tSET @PrazoDias = ISNULL(( SELECT U_RAL_Prazo FROM [@RAL_PrazoSolCompras] WHERE  U_RAL_GrupoItensID = \r\n\t\t\t\t(SELECT ITMsGrpCod FROM OITM WHERE ItemCode = \r\n\t\t\t\t\t(SELECT ItemCode FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont4768))),0)\r\n\r\n\t\t\t\r\n\t\t\t\t\tIF(@PrazoDias \u003e 0 AND (@ReqDate4768 \u003c(@DataAtual + @PrazoDias)))\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @error = - 4768\r\n\t\t\t\t\t\tSET @error_message = \u0027O prazo m¡nimo para data necess ria ‚ \u0027+Convert(Nvarchar,((@DataAtual + @PrazoDias)+1),103)+\u0027. Verifique.\u0027\r\n\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\tEND\r\n\t\t\tSET @Cont4768 = @Cont4768  +1\r\n\t\tEND--END WHILE\r\n\t\tEND--END IF\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 19/01/2017\r\n-- Update date: 17/08/2019\r\n-- Description:\tAtualizar o campo Classifica‡ao na Linha da NF Com ORIGEM ENTREGA\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002713\u0027 = Nota Fiscal \r\n\r\n--BEGIN\r\n--\tDECLARE @ContadorEnt int = 0\t\r\n--\tDECLARE @ClassificacaoEnt nvarchar (255)\r\n--\tDECLARE @DocEntryEnt int = @list_of_cols_val_tab_del\r\n--\tDECLARE @QtyLinesEnt  int = (SELECT MAX(LineNum) FROM INV1 WHERE DocEntry = @DocEntryEnt)\t\r\n--\tDECLARE @BaseTypeENT int = (SELECT BaseType FROM INV1 WHERE DocEntry= @DocEntryEnt GROUP BY  BaseType)\r\n\r\n--IF(@BaseTypeENT = 15)\r\n--BEGIN\r\n--\tWHILE(@ContadorEnt \u003c @QtyLinesEnt+1)\r\n--\t\tBEGIN\r\n--\t\t\tSET @ClassificacaoEnt = (SELECT [dbo].RAL_CLASSIFICACAO_ENTREGA(@DocEntryEnt,@ContadorEnt))\r\n\r\n--\t\t\tif  EXISTS(select *from inv1 WHERE DocEntry = @DocEntryEnt AND LineNum =  @ContadorEnt and (U_SKILL_InfAdItem is null OR Convert(nvarchar(max),U_SKILL_InfAdItem)=\u0027 / LT:\u0027))\r\n--\t\t\tBEGIN\r\n--\t\t\t\tif (@ClassificacaoEnt is not null AND @ClassificacaoEnt \u003c\u003e \u0027\u0027)\r\n--\t\t\t\tBEGIN\r\n\t\t\t\t\r\n--\t\t\t\t\tUPDATE INV1\tSET U_SKILL_InfAdItem = @ClassificacaoEnt WHERE DocEntry = @DocEntryEnt AND LineNum =  @ContadorEnt\t\t\t\t\t\r\n\t\t\t\t\t\r\n--\t\t\t\tEND;\r\n--\t\t\tEND\r\n\r\n\t\t\r\n\t\t\r\n--\t\t\tSET @ContadorEnt = @ContadorEnt + 1\r\n--\t\tEND;\r\n--END--END IF\t\t\r\n--END;--END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 13/01/2017\r\n-- Update Date: 13/08/2018\r\n-- Description:\tAtualizar o campo Classifica‡ao na Linha da NF\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002713\u0027 = Nota Fiscal \r\n\r\n--BEGIN\r\n--\tDECLARE @Contador1 int = 0\t\r\n--\tDECLARE @Classificacao nvarchar (255)\r\n--\tDECLARE @DocEntry1 int = @list_of_cols_val_tab_del\r\n--\tDECLARE @QtyLinesS  int = (SELECT MAX(LineNum) FROM INV1 WHERE DocEntry = @DocEntry1)\t\r\n--\tDECLARE @BaseType int = (SELECT BaseType FROM INV1 WHERE DocEntry= @DocEntry1 GROUP BY  BaseType)\r\n\r\n--IF(@BaseType\u003c\u003e15)\r\n--BEGIN\r\n\r\n--\tWHILE(@Contador1 \u003c @QtyLinesS+1)\r\n--\t\tBEGIN\r\n--\t\t\tSET @Classificacao = \r\n--\t\t\t(\r\n--\t\t\tSELECT  \r\n--\tCOALESCE(\r\n--\t\t(SELECT \r\n\t\t\t\t\r\n--\t\t CONCAT (\u0027 \u0027,CL0.Name,\u0027-\u0027,CL2.U_MW_TIPO,\u0027-\u0027,CL2.U_MW_CLASSE,\u0027- LT:\u0027,CL1.U_MW_LOTE,\u0027- T:\u0027,CL2.U_MW_TIPO) as class\r\n\t\t\t\t\r\n--\t\t\tFROM\r\n--\t\t\t\tINV1 NFL\r\n--\t\t\t\tINNER JOIN IBT1 LL ON  NFL.DocEntry = LL.BaseEntry\r\n--\t\t\t\tAND NFL.LineNum  = LL.BaseLinNum       \r\n--\t\t\t\tAND NFL.ItemCode = LL.ItemCode\r\n--\t\t\t\tAND NFL.WhsCode  = LL.WhsCode\r\n--\t\t\t\tAND LL.BaseType  = NFL.ObjType\r\n--\t\t\t\tINNER JOIN OBTN L ON LL.BatchNum = L.DistNumber AND LL.ItemCode = L.ItemCode\r\n--\t\t\t\tINNER JOIN [@MW_CLASS] CL0 ON L.U_MW_CLASSIFICACAO = CL0.Name\r\n--\t\t\t\tINNER JOIN [@MW_CLAS1] CL1 ON CL0.Code = CL1.Code \r\n--\t\t\t\tINNER JOIN [@MW_CLAS2] CL2 ON CL1.Code = CL2.Code\r\n--\t\t\tWHERE CL1.U_MW_VALIDADE \u003e= GETDATE() AND NFL.DocEntry = @DocEntry1 and NFL.LineNum = @Contador1\r\n--\t\t FOR XML PATH(\u0027\u0027), TYPE).value(\u0027.[1]\u0027, \u0027VARCHAR(MAX)\u0027), \u0027\u0027) AS Classificacao\r\n--FROM (\r\n--SELECT \t\tnfl.ItemCode,\t\t\t\r\n--\t\t CONCAT (CL0.Name,\u0027-\u0027,CL2.U_MW_TIPO,\u0027-\u0027,CL2.U_MW_CLASSE,\u0027- LT:\u0027,CL1.U_MW_LOTE,\u0027- T:\u0027,CL2.U_MW_TIPO) as class\r\n\t\t\t\t\r\n--\t\t\tFROM\r\n--\t\t\t\tINV1 NFL\r\n--\t\t\t\tINNER JOIN IBT1 LL ON  NFL.DocEntry = LL.BaseEntry\r\n--\t\t\t\tAND NFL.LineNum  = LL.BaseLinNum       \r\n--\t\t\t\tAND NFL.ItemCode = LL.ItemCode\r\n--\t\t\t\tAND NFL.WhsCode  = LL.WhsCode\r\n--\t\t\t\tAND LL.BaseType  = NFL.ObjType\r\n--\t\t\t\tINNER JOIN OBTN L ON LL.BatchNum = L.DistNumber AND LL.ItemCode = L.ItemCode\r\n--\t\t\t\tINNER JOIN [@MW_CLASS] CL0 ON L.U_MW_CLASSIFICACAO = CL0.Name\r\n--\t\t\t\tINNER JOIN [@MW_CLAS1] CL1 ON CL0.Code = CL1.Code \r\n--\t\t\t\tINNER JOIN [@MW_CLAS2] CL2 ON CL1.Code = CL2.Code\r\n--\t\t\tWHERE CL1.U_MW_VALIDADE \u003e= GETDATE() AND NFL.DocEntry = @DocEntry1 and NFL.LineNum = @Contador1\r\n--)AS C\r\n--Group by ItemCode\r\n\r\n--\t\t\t)\r\n\r\n--\t\t\tif (@Classificacao is not null AND @Classificacao \u003c\u003e \u0027\u0027)\r\n--\t\t\t\tBEGIN\r\n\t\t\t\t\r\n--\t\t\t\t\tUPDATE INV1\tSET U_SKILL_InfAdItem = @Classificacao WHERE DocEntry = @DocEntry1 AND LineNum =  @Contador1\t\t\t\t\t\r\n\t\t\t\t\t\r\n--\t\t\t\tEND;\r\n\t\t\r\n--\t\t\tSET @Contador1 = @Contador1 + 1\r\n--\t\tEND;\r\n--END--end if\t\t\r\n--END;--END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 02/01/2017\r\n-- Update Date: 07/08/2019\r\n-- Description:\tAtualizar os campos Macro, Micro,Desconto financeiro,Detalhes de entrega e Cidade com Base no cadastro de PN\r\n-- Houve acrescimo do campo U_DescFinBP para ajustar o desconto financeiro no bankplus\r\n-- GLPI ID:\r\n-- GLPI ID Atualiza‡oes: 6708, 6468, 7373\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\tDECLARE @CardCodeFromOrder NVarchar (20)\r\n\tDECLARE @Macro NVARCHAR (255)\r\n\tDECLARE @Micro NVARCHAR (255)\r\n\tDECLARE @Cidade NVARCHAR (255)\r\n\tDECLARE @DescontoFinanceiro Decimal(10,2) SET @DescontoFinanceiro = 0\r\n\tDECLARE @R_EntregaAgendada CHAR (1) SET @R_EntregaAgendada = \u0027N\u0027\r\n\tDECLARE @R_Encarte  CHAR (1) SET @R_Encarte = \u0027N\u0027\r\n\tDECLARE @DetalhesEntrega NVARCHAR (MAX)\r\n\tDECLARE @Paletizada  CHAR (1) SET @Paletizada = \u0027N\u0027\r\n\tDECLARE @Batida  CHAR (1) SET @Batida = \u0027N\u0027\r\n\tDECLARE @U_RAL_Reentrega  CHAR (1) SET @U_RAL_Reentrega = \u0027N\u0027\r\n\tDECLARE @U_RAL_Retira  CHAR (1) SET @U_RAL_Retira = \u0027N\u0027\r\n\tDECLARE @CaracteristicasEntregaPN NVARCHAR(MAX)\r\n\r\n\tSET @CardCodeFromOrder  = (SELECT CardCode FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tSET @Macro = (SELECT U_MW_MACRO FROM OCRD WHERE CardCode = @CardCodeFromOrder)\r\n\tSET @Micro = (SELECT U_MW_MICRO FROM OCRD WHERE CardCode = @CardCodeFromOrder)\r\n\tSET @Cidade = (SELECT U_MW_CIDADE FROM OCRD WHERE CardCode = @CardCodeFromOrder)\r\n\tSET @DescontoFinanceiro = (SELECT U_MW_DESFIN FROM OCRD WHERE CardCode = @CardCodeFromOrder)\r\n\tSET @Paletizada = (SELECT QryGroup22 FROM OCRD WHERE CardCode = @CardCodeFromOrder)\r\n \tSET @Batida  = (SELECT QryGroup23 FROM OCRD WHERE CardCode = @CardCodeFromOrder)\r\n\r\n\tSET @R_Encarte = (SELECT U_R_Encarte FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tSET @R_EntregaAgendada = (SELECT U_R_EntregaAgendada FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tSET @U_RAL_Reentrega = (SELECT U_RAL_Reentrega FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\t\r\n\tSET @U_RAL_Retira = (SELECT U_RAL_Retira FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tSET @CaracteristicasEntregaPN = (select [dbo].[NomedasCaracteristicasPN](@CardCodeFromOrder) )\r\n\r\n\tIF(@R_EntregaAgendada = \u0027Y\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @DetalhesEntrega = \u0027AGENDADA \u0027\r\n\t\tEND\r\n\tIF(@R_Encarte = \u0027Y\u0027)\r\n\t\tBEGIN\t\t\r\n\t\t\tSET @DetalhesEntrega = concat(@DetalhesEntrega,\u0027ENCARTE \u0027)\r\n\t\tEND\r\n\tIF(@U_RAL_Reentrega = \u0027Y\u0027)\r\n\t\tBEGIN\t\t\r\n\t\t\tSET @DetalhesEntrega = concat(@DetalhesEntrega,\u0027REENTREGA \u0027)\r\n\t\tEND\r\n\tIF(@U_RAL_Retira = \u0027Y\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @DetalhesEntrega = concat(@DetalhesEntrega,\u0027RETIRA \u0027)\r\n\t\tEND\r\n\tIF(@Batida = \u0027Y\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @DetalhesEntrega = concat(@DetalhesEntrega,\u0027CARGA BATIDA \u0027)\r\n\t\tEND\r\n\tIF(@Paletizada = \u0027Y\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @DetalhesEntrega = concat(@DetalhesEntrega,\u0027CARGA PALETIZADA \u0027)\r\n\t\tEND\r\n\tIF(@CaracteristicasEntregaPN is NOT null AND @CaracteristicasEntregaPN \u003c\u003e \u0027\u0027)\r\n\tBEGIN\r\n\t\tSET @DetalhesEntrega = concat(@DetalhesEntrega,@CaracteristicasEntregaPN)\r\n\tEND\t\r\n\r\n\t\tBEGIN\t\t\t\r\n\t\t\tUPDATE ORDR \r\n\t\t\t\tSET  U_MW_MICRO = @Micro, U_MW_MACRO = @Macro, U_MW_CIDADE = @Cidade,\r\n\t\t\t\t U_DescFinBP  = @DescontoFinanceiro,U_MW_DESCONTO  = @DescontoFinanceiro, U_RA_DetalhesEntrega = @DetalhesEntrega  WHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\tEND \r\n\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 22/07/2019\r\n-- Update Date: \r\n-- Description: Bloquear Fun‡ao Copiar para Pedido a partir da cota‡ao\r\n-- Documento: Pedido de Vendas\r\n-- GLPI ID: 7321\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @UserSign27321 Nvarchar(10) = (SELECT  UserSign2 FROM ORDR where docentry = @list_of_cols_val_tab_del)\r\n\r\nDECLARE @Dep7321 int SET @Dep7321 = (SELECT Department FROM OUSR WHERE USERID = @UserSign27321)\r\n\r\nIF EXISTS (SELECT BaseEntry FROM RDR1 WHERE DocEntry = @list_of_cols_val_tab_del AND BaseEntry IS NOT NULL)\r\nBEGIN\r\n\tIF(@Dep7321 = 1)--Departamento de vendas\r\n\tBEGIN\r\n\t\tSET @error = -7321\r\n\t\tSET @error_message = \u0027A a‡ao \"Copiar para Pedido\" nao ‚ permitida!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\t\t\t\t\r\n\t\t\t\r\nEND--END IF EXISTS\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n------------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 27/06/2019\r\n-- Update date: 07/10/2020\r\n-- Description:\tGravar o Pre‡o de Lista do PN ao adicionar o pedido\r\n-- GLPI ID:7208\r\n-- GLPI ID Atualiza‡oes:9608 - Aplicar desconto no Pre‡o de Lista\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002714\u0027 = Dev NF de saida\r\n\r\nBEGIN\r\n\t\r\nDECLARE @PrecoDeListaDev Numeric(10,2) = 0\r\nDECLARE @CodigoItemDev NVARCHAR(10)\r\nDECLARE @TotalLinhasDev Numeric = (SELECT Count(LineNum) FROM RIN1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @ContDev Numeric = 0\r\nDECLARE @PrecoExistenteDev Numeric = 0\r\nDECLARE @DescontoDev NUMERIC = 0\r\n\r\nWHILE(@ContDev \u003c @TotalLinhasDev + 1)\r\n\tBEGIN\r\n\t\tIF EXISTS( SELECT *FROM RIN1 WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @ContDev)\r\n\t\tBEGIN\r\n\t\t\tSELECT \r\n\t\t\t@CodigoItemDev = T1.ItemCode,\r\n\t\t\t@PrecoDeListaDev  = T5.price, \r\n\t\t\t@PrecoExistenteDev = (case when T1.U_PrecoDeLista is null then 0 else T1.U_PrecoDeLista end),\r\n\t\t\t@DescontoDev = T1.DiscPrcnt\r\n\t\t\tFROM ORIN T0\r\n\t\t\tINNER JOIN RIN1 T1 ON T0.DocEntry = T1.DocEntry \r\n\t\t\tINNER JOIN OCRD T3 ON T0.CardCode = T3.CardCode\r\n\t\t\tINNER JOIN OPLN T4 ON T3.ListNum = T4.ListNum\r\n\t\t\tINNER JOIN ITM1 T5 ON T4.ListNum = T5.PriceList AND T1.ItemCode = T5.ItemCode\r\n\t\t\tWHERE  T0.DocEntry = @list_of_cols_val_tab_del AND T1.LineNum = @ContDev\r\n\r\n\t\t\tIF ( (@CodigoItemDev  is not null AND @CodigoItemDev \u003c\u003e \u0027\u0027)\r\n\t\t\t\t\t AND (@PrecoDeListaDev is not null AND @PrecoDeListaDev \u003e 0)\r\n\t\t\t\t\t\tAND (@PrecoExistenteDev is null OR @PrecoExistenteDev = 0))\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE RIN1\tSET U_PrecoDeLista = @PrecoDeListaDev - (@PrecoDeListaDev * @DescontoDev / 100)\r\n\t\t\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del AND ItemCode = @CodigoItemDev AND LineNum =  @ContDev\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\r\n\t\tEND \r\n\t\tSET @ContDev = @ContDev + 1\r\n\tEND;\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n-----------------------------------------------------------------------------------------------------------------------------\r\n------ Author: Henrique Truyts \r\n------ Create date: 17/06/2019\r\n------ Documentos:  Cota‡ao de vendas\r\n------ GLPI ID: 6734\r\n------ GLPI ID Atualiza‡oes: \r\n-- Description:\tBloquear cota‡ao de vendas sem  C¢digo de imposto\r\n---------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Cota‡ao\r\n\r\nBEGIN\t\t\r\n\t--C¢digo de imposto\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tOQUT O\r\n\t\t\t    INNER JOIN QUT1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @list_of_cols_val_tab_del AND OL.TaxCode IS NULL)\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Cota‡ao de Venda - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 17/06/2019\r\n-- Update Date: \r\n-- Description: Trava para evitar altera‡ao de DocEntry da OC\r\n-- Documento: Ordem de Carga\r\n-- GLPI ID:7147\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027BIM_ORDEMCARGA\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00272\u0027 = Ordem de Carga\r\nBEGIN\t\r\n\tIF EXISTS (\r\n\tSELECT DocNum FROM [@BIM_ORDEMCARGA]  WHERE DocEntry = @list_of_cols_val_tab_del AND DocNum\u003c\u003eDocEntry\r\n\t)\r\n\tBEGIN\r\n\t\tSET @error = -7147\r\n\t\tSET @error_message =  \u0027N£mero da Ordem de Carga nao pode ser modificado.Verifique!\u0027+ \u0027 - \u0027 +\r\n\t\tConvert(nvarchar,@list_of_cols_val_tab_del)\r\n\t\tSELECT @error, @error_message\r\n\tEND\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 11/06/2019\r\n-- Update Date: \r\n-- Description: Vendedor s¢ pode cadastrar clientes pelo APP caso o cliente seja Lead\r\n-- Documento: Parceiro de Negocios\r\n-- GLPI ID:6942\r\n-- GLPI IG Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u00272\u0027) and (@transaction_type in (\u0027A\u0027))--\u00272\u0027 = Parceiro de NEgocios\r\nBEGIN\r\n\r\nDECLARE @UserSign6942 int = (SELECT UserSign FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @CardTypeL char = (SELECT CardType FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @Series80 int = (SELECT Series FROM OCRD WHERE CardCode = @list_of_cols_val_tab_del)\r\nDECLARE @Dep6942 int SET @Dep6942 = (SELECT Department FROM OUSR WHERE USERID = @UserSign6942)\r\nDECLARE @UserPortal6942 INT\r\nSET @UserPortal6942 = (SELECT T1.Department\r\n\t\t\t\t\t\t\tFROM OUSR T1\r\n\t\t\t\t\t\t\tWHERE T1.USER_CODE IN(SELECT T0.U_AHS_SapUserCode\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tFROM OCRD T0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = @list_of_cols_val_tab_del))\r\n\r\nIF(@UserPortal6942 \u003c\u003e 17) ----EQUIPE DE COMPRAS(SUPRIMENTO)\r\nBEGIN\r\n\tIF(@Dep6942 = 1 AND ( @Series80 \u003c\u003e 80 OR @CardTypeL \u003c\u003e \u0027L\u0027))\t\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6942\r\n\t\t\tSET @error_message = \u0027S¢ ‚ permitido o cadastramento de cliente potencial. Verifique!.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 10/06/2019\r\n-- Update Date: \r\n-- Description:\tTrava para Clientes Bloqueados (caracteristica 24) Esbo‡o\r\n-- Documents: Pedido de Vendas e Cota‡ao de vendas\r\n-- GLPI ID: \r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas (DepCB = departamentos Clientes Bloqueados\r\nBEGIN\r\n\r\nDECLARE @DepCBEsb int SET @DepCBEsb = (SELECT u.Department From ODRF O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.ObjType = 17 AND O.DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @ObjTypeEsb int = 0\r\nSET @ObjTypeEsb = (SELECT Distinct ObjType FROM ODRF WHERE ObjType = 17 AND DocEntry = @list_of_cols_val_tab_del )\r\n\r\n IF(@DepCBEsb = 1 AND @ObjTypeEsb = 17)\t\r\n\tBEGIN\r\n\t\tIF  EXISTS (\r\n\t\tSELECT\r\n\t\tt0.QryGroup25,T0.CardCode\r\n\t\tFROM OCRD T0\r\n\t\tWHERE T0.QryGroup25 = \u0027N\u0027 AND T0.QryGroup24 = \u0027Y\u0027 \r\n\t\tAND T0.CardCode  = ( SELECT Distinct CardCode FROM ODRF WHERE ObjType = 17 AND DocEntry =  @list_of_cols_val_tab_del )\r\n\t\t\r\n\t\t) BEGIN\t\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Cliente Bloqueado, nao ‚ poss¡vel adicionar o Pedido. Entrar em contato com o setor de Cr‚dito e Cobran‡a ou Adm. de Vendas!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t  END;\r\n\t\r\n\tEND;\r\nEND;--END PRINCIPAL\r\n-------------------------COTA€AO DE VENDAS--------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002723\u0027 = Cota‡ao de Vendas (DepCB = departamentos Clientes Bloqueados\r\nBEGIN\r\n\r\nDECLARE @DepCBQEsb int SET @DepCBQEsb = (SELECT u.Department From ODRF O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.ObjType = 23 AND O.DocNum = @list_of_cols_val_tab_del)\r\nDECLARE @ObjTypeEsbQ int = 0\r\nSET @ObjTypeEsbQ = (SELECT Distinct ObjType FROM ODRF WHERE ObjType = 23 AND DocEntry = @list_of_cols_val_tab_del )\r\n\r\n IF(@DepCBQEsb = 1 AND @ObjTypeEsbQ = 23)\t\r\n\tBEGIN\r\n\t\tIF  EXISTS (\r\n\t\tSELECT\r\n\t\tt0.QryGroup25,T0.CardCode\r\n\t\tFROM OCRD T0\r\n\t\tWHERE T0.QryGroup25 = \u0027N\u0027 AND T0.QryGroup24 = \u0027Y\u0027 \r\n\t\tAND T0.CardCode  = ( SELECT Distinct CardCode FROM ODRF WHERE ObjType = 23 AND DocEntry =  @list_of_cols_val_tab_del )\r\n\t\t\r\n\t\t) BEGIN\t\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Cliente Bloqueado, nao ‚ poss¡vel adicionar a Cota‡ao. Entrar em contato com o setor de Cr‚dito e Cobran‡a ou Adm. de Vendas!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t  END;\r\n\t\r\n\tEND;\r\nEND;--END PRINCIPAL\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n------------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 04/04/2019\r\n-- Update date: 07/10/2020\r\n-- Description:\tGravar o Pre‡o de Lista do PN ao adicionar a cota‡ao\r\n-- GLPI ID: 6659\r\n-- GLPI ID Atualiza‡oes: 9608 - Aplicar desconto no Pre‡o de Lista\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002723\u0027 = Cota‡ao de Vendas\r\n\r\nBEGIN\r\n\t\r\nDECLARE @PrecoDeListaQ Numeric(10,2) = 0\r\nDECLARE @CodigoItem6659Q NVARCHAR(10)\r\nDECLARE @TotalLinhas6659Q Numeric = (SELECT Count(LineNum) FROM QUT1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Cont6659Q Numeric = 0\r\nDECLARE @PrecoExistenteQ Numeric = 0\r\nDECLARE @DescontoQ NUMERIC = 0\r\n\r\nWHILE(@Cont6659Q \u003c @TotalLinhas6659Q + 1)\r\n\tBEGIN\r\n\t\tIF EXISTS( SELECT *FROM QUT1 WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont6659Q)\r\n\t\tBEGIN\r\n\t\t\tSELECT \r\n\t\t\t@CodigoItem6659Q = T1.ItemCode,\r\n\t\t\t@PrecoDeListaQ  = T5.price, \r\n\t\t\t@PrecoExistenteQ = (case when T1.U_PrecoDeLista is null then 0 else T1.U_PrecoDeLista end),\r\n\t\t\t@DescontoQ = T1.DiscPrcnt\r\n\t\t\tFROM OQUT T0\r\n\t\t\tINNER JOIN QUT1 T1 ON T0.DocEntry = T1.DocEntry \r\n\t\t\tINNER JOIN OCRD T3 ON T0.CardCode = T3.CardCode\r\n\t\t\tINNER JOIN OPLN T4 ON T3.ListNum = T4.ListNum\r\n\t\t\tINNER JOIN ITM1 T5 ON T4.ListNum = T5.PriceList AND T1.ItemCode = T5.ItemCode\r\n\t\t\tWHERE  T0.DocEntry = @list_of_cols_val_tab_del AND T1.LineNum = @Cont6659Q\r\n\r\n\t\t\tIF ( (@CodigoItem6659Q  is not null AND @CodigoItem6659Q \u003c\u003e \u0027\u0027)\r\n\t\t\t\t\t AND (@PrecoDeListaQ is not null AND @PrecoDeListaQ \u003e 0)\r\n\t\t\t\t\t\tAND (@PrecoExistenteQ is null OR @PrecoExistenteQ = 0))\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE QUT1\tSET U_PrecoDeLista = @PrecoDeListaQ - (@PrecoDeListaQ * @DescontoQ / 100)\r\n\t\t\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del AND ItemCode = @CodigoItem6659Q AND LineNum =  @Cont6659Q\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\r\n\t\tEND \r\n\t\tSET @Cont6659Q = @Cont6659Q + 1\r\n\tEND;\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 03/07/2018\r\n-- Update Date: 07/05/2019\r\n-- Description: Bloquear atualiza‡ao e cancelamento Se todas as linhas do PV estiverem com vinculo em OC (campo N£mero OC preenchido)\r\n-- Documento: Pedido de Vendas\r\n-- GLPI ID:5046\r\n-- GLPI IG Atualiza‡ao:41118,6908\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027U\u0027,\u0027C\u0027,\u0027L\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\nDECLARE @TotaldeLinhasLog int = (SELECT COUNT(*)FROM (SELECT  LineNum from ADO1  WHERE ObjType = 17 AND DocEntry = @list_of_cols_val_tab_del GROUP BY LineNum)A )\r\nDECLARE @TotalLinhascomOC int = (SELECT COUNT(*) FROM RDR1 WHERE DocEntry=@list_of_cols_val_tab_del AND (U_OC_num IS NOT NULL AND U_OC_num \u003c\u003e \u0027\u0027))\r\n\r\nDECLARE @Status5046 Nvarchar (10) = ( SELECT DocStatus FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\nDECLARE @UserSign2 Nvarchar(10) = (SELECT  UserSign2 FROM ORDR where docentry = @list_of_cols_val_tab_del)\r\n\r\nDECLARE @Dep5046 int SET @Dep5046 = (SELECT Department FROM OUSR WHERE USERID = @UserSign2)\r\n\r\nIF( @Status5046 IN(\u0027O\u0027,\u0027C\u0027))\r\nBEGIN\r\n\tIF(@Dep5046 = 1 OR @Dep5046 = 2)\t\r\n\tBEGIN\r\n\t\tIF(@TotaldeLinhasLog = @TotalLinhascomOC)\t\t\t\r\n\t\tBEGIN\t\r\n\t\t\tSET @error = -5046\r\n\t\t\tSET @error_message = \u0027Nao ‚ poss¡vel modifica‡ao do PV pois o mesmo tem vinculo na OC do processo log¡stico.\u0027\t\t\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\t\r\nEND\r\n\r\nEND \r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n-----------------------------------------------------------------------------------------------------------------------------\r\n------ Author: Henrique Truyts \r\n------ Create date: 25/02/2019\r\n------ Documentos:Saida de Mercadoria\r\n------ GLPI ID: 6313\r\n------ GLPI ID Atualiza‡oes: \r\n---------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002760\u0027) and (@transaction_type in (\u0027A\u0027))--\u002760\u0027 = Saida de Mercadoria (SM)\r\nBEGIN\r\n-------------------------------------------------------------------------------------------------------------------------\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a saida - Padrao /Especial / Desmontagem\r\n--Peso do Item do cabe‡alho da OP deve bater com a somatoria da quantidade base das linhas da op (IGNORAR EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @PesoItemOpSM Numeric(10,3) SET @PesoItemOpSM = (\r\n\t\t\t\t\t\tSELECT T1.SWeight1 FROM OWOR T0 \r\n\t\t\t\t\t\tINNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode\r\n\t\t\t\t\t\tWHERE T0.DocEntry = (\r\n\t\t\t\t\t\t\t\tSELECT DISTINCT BaseEntry FROM IGE1 WHERE DocEntry = @list_of_cols_val_tab_del\t)\t)\r\n\r\nDECLARE @QtdeBaseOpSM Numeric(10,3) SET @QtdeBaseOpSM = (\r\n\t\t\t\t\t\t\t\tSELECT SUM(T1.SWeight1*T0.BaseQty) FROM WOR1 T0 \r\n\t\t\t\t\t\t\t\tINNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode\r\n\t\t\t\t\t\t\t\tWHERE SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND T0.DocEntry =\t(\r\n\t\t\t\t\t\t\t\t\tSELECT DISTINCT BaseEntry FROM IGE1 WHERE DocEntry = @list_of_cols_val_tab_del\t)\t)\r\n\r\nDECLARE @TotalPesoMinimoSM Numeric(10,3) = @PesoItemOpSM - ((@PesoItemOpSM*1)/100)\r\n\r\nDECLARE @TotalPesoMaximoSM Numeric(10,3) = @PesoItemOpSM + ((@PesoItemOpSM*1)/100)\r\n\r\nIF(@QtdeBaseOpSM \u003e @TotalPesoMaximoSM OR @QtdeBaseOpSM \u003c @TotalPesoMinimoSM)\r\nBEGIN\r\n\tSET @error = -6313\t\r\n\tSET @error_message = \u0027Nao foi possivel salvar a OP, quantidade base menor/Maior em 1% em rela‡ao ao peso do produto principal na Ordem de Produ‡ao\u0027\r\n\tSELECT @error, @error_message\r\nEND\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a saida - Padrao /Especial \r\n--A somatoria das quantidades das linhas das saidas existentes nao pode superar a quantidade planejada das linhas da OP (IGNORAR EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @TypeOpSM Char (1)= (SELECT Type FROM OWOR WHERE DocEntry = \r\n\t\t\t\t\t\t\t(SELECT DISTINCT BaseEntry FROM IGE1 WHERE DocEntry = @list_of_cols_val_tab_del\t))\r\n\r\n\t\t\t\t\t\t\t\r\n--IF ( @TypeOpSM \u003c\u003e \u0027D\u0027)\r\n--\tBEGIN\r\n--\tIF EXISTS(\r\n--\t\tSELECT *FROM (\r\n--\t\tSELECT T0.ItemCode \u0027ItemCodeSaida\u0027,SUM(T0.Quantity)\u0027QtdSaida\u0027,T1.ItemCode \u0027ItemCodeLinhaOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n--\t\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n--\t\tFROM IGE1 T0\r\n--\t\tINNER JOIN WOR1 T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n--\t\tWHERE T1.DocEntry = (SELECT Distinct BaseEntry FROM IGE1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\n--\t\tAND SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND SUBSTRING( T1.ItemCode,1,2) \u003c\u003e \u0027EM\u0027\r\n--\t\tGROUP BY T0.ItemCode,T1.ItemCode,T1.PlannedQty\r\n--\t\t)A\r\n--\t\tWHERE QtdSaida \u003e QtdPlanejadaMaxima\r\n--\t\t)\r\n--\t\tBEGIN\r\n--\t\t\tSET @error = -6313\r\n--\t\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das sa¡das ‚ maior em 1% que a quantidade planejada indicada nas linhas da OP\u0027\r\n--\t\t\tSELECT @error, @error_message\r\n--\t\tEND\r\n--\tEND\r\n---------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a saida - Desmontagem\r\n--A somatoria das quantidades das linhas das saidas existentes nao pode superar a quantidade planejada do cabe‡alho da OP \r\n-------------------------------------------------------------------------------------------------------------------------\r\n\tIF ( @TypeOpSM = \u0027D\u0027)\r\n\tBEGIN\r\n\t\tIF EXISTS(\r\n\t\tSELECT *FROM (\r\n\t\tSELECT SUM(T0.Quantity) \u0027QtdEntrada\u0027,T1.ItemCode\u0027ItemCodeOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n\t\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n\t\tFROM IGE1 T0\r\n\t\tINNER JOIN OWOR T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n\t\t\tWHERE T1.DocEntry = (SELECT Distinct  BaseEntry FROM IGE1 WHERE DocEntry = @list_of_cols_val_tab_del) \r\n\t\tGROUP BY T1.ItemCode,T1.PlannedQty\t)\tA\r\n\t\tWHERE QtdEntrada \u003e QtdPlanejadaMaxima\r\n\t\t)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6313\r\n\t\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das sa¡das ‚ maior em 1% que a quantidade planejada na OP\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\r\n\tEND\r\n\r\nEND\r\n---------------------------------------------------------------------------------------------------------------------------\r\n----END\r\n---------------------------------------------------------------------------------------------------------------------------\r\n---------------------------------------------------------------------------------------------------------------------------\r\n------ Author: Henrique Truyts \r\n------ Create date: 25/02/2019\r\n------ Documentos:Entrada de Produto acabado\r\n------ GLPI ID: 6313\r\n------ GLPI ID Atualiza‡oes:\r\n---------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002759\u0027) and (@transaction_type in (\u0027A\u0027))--\u002759\u0027 = Entrada de Produto acabado (EPA)\r\nBEGIN\r\n-------------------------------------------------------------------------------------------------------------------------\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a entrada - Padrao /Especial / Desmontagem\r\n--Peso do Item do cabe‡alho da OP deve bater com a somatoria da quantidade base das linhas da op (IGNORAR EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @PesoItemOpEPA Numeric(10,3) SET @PesoItemOpEPA = (\r\n\t\t\t\t\t\tSELECT T1.SWeight1 FROM OWOR T0 \r\n\t\t\t\t\t\tINNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode\r\n\t\t\t\t\t\tWHERE T0.DocEntry = (\r\n\t\t\t\t\t\t\t\tSELECT DISTINCT BaseEntry FROM IGN1 WHERE DocEntry = @list_of_cols_val_tab_del\t)\t)\r\n\r\nDECLARE @QtdeBaseOpEpa Numeric(10,3) SET @QtdeBaseOpEpa = (\r\n\t\t\t\t\t\t\t\tSELECT SUM(T1.SWeight1*T0.BaseQty) FROM WOR1 T0 \r\n\t\t\t\t\t\t\t\tINNER JOIN OITM T1 ON T0.ItemCode = T1.ItemCode\r\n\t\t\t\t\t\t\t\tWHERE SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND T0.DocEntry =\t(\r\n\t\t\t\t\t\t\t\t\tSELECT DISTINCT BaseEntry FROM IGN1 WHERE DocEntry = @list_of_cols_val_tab_del\t)\t)\r\n\r\nDECLARE @TotalPesoMinimo Numeric(10,3) = @PesoItemOpEPA - ((@PesoItemOpEPA*1)/100)\r\n\r\nDECLARE @TotalPesoMaximo Numeric(10,3) = @PesoItemOpEPA + ((@PesoItemOpEPA*1)/100)\r\n\r\nIF(@QtdeBaseOpEpa \u003e @TotalPesoMaximo OR @QtdeBaseOpEpa \u003c @TotalPesoMinimo)\r\nBEGIN\r\n\tSET @error = -6313\t\r\n\tSET @error_message = \u0027Nao foi possivel salvar a OP, quantidade base menor/Maior em 1% em rela‡ao ao peso do produto principal na Ordem de Produ‡ao\u0027\r\n\tSELECT @error, @error_message\r\nEND\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a entrada - Padrao /Especial \r\n--A somatoria das quantidades das linhas das entradas existentes nao pode superar a quantidade planejada do cabe‡alho da OP\r\n-------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @TypeOpEPA Char (1)= (SELECT Type FROM OWOR WHERE DocEntry = \r\n\t\t\t\t\t\t\t(SELECT DISTINCT BaseEntry FROM IGN1 WHERE DocEntry = @list_of_cols_val_tab_del\t))\r\n\r\n\t\t\t\t\t\t\t\r\n--IF ( @TypeOpEPA \u003c\u003e \u0027D\u0027)\r\n--\tBEGIN\r\n--\t\tIF EXISTS(\r\n--\t\tSELECT *FROM (\r\n--\t\tSELECT SUM(T0.Quantity) \u0027QtdEntrada\u0027,T1.ItemCode\u0027ItemCodeOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n--\t\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n--\t\tFROM IGN1 T0\r\n--\t\tINNER JOIN OWOR T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n--\t\t\tWHERE T1.DocEntry = (SELECT Distinct BaseEntry FROM IGN1 WHERE DocEntry = @list_of_cols_val_tab_del) \r\n--\t\tGROUP BY T1.ItemCode,T1.PlannedQty\t)\tA\r\n--\t\tWHERE QtdEntrada \u003e QtdPlanejadaMaxima\r\n--\t\t)\r\n--\t\tBEGIN\r\n--\t\t\tSET @error = -6313\r\n--\t\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das entradas ‚ maior em 1% que a quantidade planejada na OP\u0027\r\n--\t\t\tSELECT @error, @error_message\r\n--\t\tEND\r\n\t\r\n--\tEND\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a entrada - Desmontagem\r\n--A somatoria das quantidades das linhas das entradas existentes nao pode superar a quantidade planejada das linhas da OP (IGNORAR EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\n\tIF ( @TypeOpEPA = \u0027D\u0027)\r\n\tBEGIN\r\n\tIF  EXISTS(\r\n\t\tSELECT *FROM (\r\n\t\tSELECT T0.ItemCode \u0027ItemCodeSaida\u0027,SUM(T0.Quantity)\u0027QtdSaida\u0027,T1.ItemCode \u0027ItemCodeLinhaOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n\t\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n\t\tFROM IGN1 T0\r\n\t\tINNER JOIN WOR1 T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n\t\tWHERE T1.DocEntry = (SELECT Distinct  BaseEntry FROM IGN1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\tAND SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND SUBSTRING( T1.ItemCode,1,2) \u003c\u003e \u0027EM\u0027\r\n\t\tGROUP BY T0.ItemCode,T1.ItemCode,T1.PlannedQty\r\n\t\t)A\r\n\t\tWHERE QtdSaida \u003e QtdPlanejadaMaxima\r\n\t\t)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6313\r\n\t\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das Entradas ‚ maior em 1% que a quantidade planejada indicada nas linhas da OP\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\n\t\r\n\r\n\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--Ao adicionar a entrada e se a op tiver itens negativos\r\n--A somatoria das quantidades das linhas das entradas existentes nao pode superar a quantidade planejada das linhas da OP (IGNORAR EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--IF EXISTS(\r\n--\tSELECT *FROM (\r\n--\t\tSELECT T0.ItemCode \u0027ItemCodeSaida\u0027,SUM(T0.Quantity)\u0027QtdSaida\u0027,T1.ItemCode \u0027ItemCodeLinhaOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n--\t\t(T1.PlannedQty - ((T1.PlannedQty*1)/100))*-1\u0027QtdPlanejadaMinima\u0027,(T1.PlannedQty + ((T1.PlannedQty*1)/100))*-1\u0027QtdPlanejadaMaxima\u0027\r\n--\t\tFROM IGN1 T0\r\n--\t\tINNER JOIN WOR1 T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n--\t\tWHERE T1.DocEntry = (SELECT Distinct  BaseEntry FROM IGN1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\n--\t\tAND SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND SUBSTRING( T1.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND\r\n--\t\tT1.PlannedQty \u003c 0\r\n--\t\tGROUP BY T0.ItemCode,T1.ItemCode,T1.PlannedQty\r\n--\t\t)A\r\n--\t\tWHERE QtdSaida \u003e QtdPlanejadaMaxima\r\n\r\n--\t)\r\n--\tBEGIN\r\n--\t\tSET @error = -6313\r\n--\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das Entradas ‚ maior em 1% que a quantidade planejada indicada nas linhas da OP\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\nEnd\r\n---------------------------------------------------------------------------------------------------------------------------\r\n----END\r\n---------------------------------------------------------------------------------------------------------------------------\r\n---------------------------------------------------------------------------------------------------------------------------\r\n------ Author: Henrique Truyts \r\n------ Create date: 25/02/2019\r\n------ Documentos:Ordem de Produ‡ao Padrao, Especial e Desmontagem\r\n------ GLPI ID: 6313\r\n------ GLPI ID Atualiza‡oes:\r\n---------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027202\u0027) and (@transaction_type in (\u0027U\u0027))--\u0027202\u0027 = Ordem de Produ‡ao\r\nBEGIN\r\n------------------------------------------------VARIAVEIS GERAIS---------------------------------------------------------\r\nDECLARE @StatusOP NVARCHAR SET @StatusOP = (\r\n\t\t\t\t\t\t\tSELECT Status FROM OWOR WHERE DocEntry = @list_of_cols_val_tab_del\t)\r\n\r\nDECLARE @TypeOP Char (1)= (\r\n\t\t\t\t\tSELECT Type FROM OWOR WHERE DocEntry = @list_of_cols_val_tab_del\t)\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--FECHAMENTO DA OP (ESPECIAL E PADRAO) - SAIDA\r\n--Verificar a somatoria das saidas (Linhas campo quantidade) que deve ser igual a quantidade planejada na linha da op (IGNORAR O EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\n\t--IF (@StatusOP = \u0027L\u0027 AND @TypeOP \u003c\u003e \u0027D\u0027)\r\n\t--BEGIN\r\n\t--\tIF NOT EXISTS(\r\n\t--\tSELECT *FROM (\r\n\t--\tSELECT T0.ItemCode \u0027ItemCodeSaida\u0027,SUM(T0.Quantity)\u0027QtdSaida\u0027,T1.ItemCode \u0027ItemCodeLinhaOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n\t--\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n\t--\tFROM IGE1 T0\r\n\t--\tINNER JOIN WOR1 T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n\t--\tWHERE T1.DocEntry = @list_of_cols_val_tab_del \r\n\t--\tAND SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND SUBSTRING( T1.ItemCode,1,2) \u003c\u003e \u0027EM\u0027\r\n\t--\tGROUP BY T0.ItemCode,T1.ItemCode,T1.PlannedQty\r\n\t--\t)A\r\n\t--\tWHERE QtdSaida \u003e= QtdPlanejadaMinima AND QtdSaida \u003c=QtdPlanejadaMaxima\r\n\t--\t)\r\n\t--\tBEGIN\r\n\t--\t\tSET @error = -6313\r\n\t--\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das sa¡das ‚ maior/menor em 1% que a quantidade planejada indicada nas linhas da OP\u0027\r\n\t--\t\tSELECT @error, @error_message\r\n\t--\tEND\r\n\t--END\r\n\t\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--FECHAMENTO DA OP  (ESPECIAL E PADRAO) - ENTRADA\r\n--Verificar a somatoria das entradas (Linhas campo quantidade) que deve ser igual a quantidade planejada no cabe‡alho da op\r\n-------------------------------------------------------------------------------------------------------------------------\r\n\t--IF (@StatusOP = \u0027L\u0027 AND @TypeOP \u003c\u003e \u0027D\u0027)\r\n\t--BEGIN\r\n\t--\tIF NOT EXISTS(\r\n\t--\tSELECT *FROM (\r\n\t--\tSELECT SUM(T0.Quantity) \u0027QtdEntrada\u0027,T1.ItemCode\u0027ItemCodeOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n\t--\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n\t--\tFROM IGN1 T0\r\n\t--\tINNER JOIN OWOR T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n\t--\tWHERE T1.DocEntry = @list_of_cols_val_tab_del\r\n\t--\tGROUP BY T1.ItemCode,T1.PlannedQty\t)\tA\r\n\t--\tWHERE QtdEntrada \u003e= QtdPlanejadaMinima AND QtdEntrada \u003c=QtdPlanejadaMaxima\r\n\t--\t)\r\n\t--\tBEGIN\r\n\t--\t\tSET @error = -6313\r\n\t--\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das entradas ‚ maior/menor em 1% que a quantidade planejada na OP\u0027\r\n\t--\t\tSELECT @error, @error_message\r\n\t--\tEND\r\n\t\r\n\t--END\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--FECHAMENTO DA OP (Desmontagem) - SAIDA\r\n--Verificar a somatoria das saidas(Linhas campo quantidade) que deve ser igual a quantidade planejada no cabe‡alho da op\r\n-------------------------------------------------------------------------------------------------------------------------\r\n\tIF (@StatusOP = \u0027L\u0027 AND @TypeOP = \u0027D\u0027)\r\n\tBEGIN\r\n\tIF NOT EXISTS(\r\n\t\tSELECT *FROM (\r\n\t\tSELECT SUM(T0.Quantity) \u0027QtdEntrada\u0027,T1.ItemCode\u0027ItemCodeOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n\t\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n\t\tFROM IGE1 T0\r\n\t\tINNER JOIN OWOR T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n\t\tWHERE T1.DocEntry = @list_of_cols_val_tab_del\r\n\t\tGROUP BY T1.ItemCode,T1.PlannedQty\t)\tA\r\n\t\tWHERE QtdEntrada \u003e= QtdPlanejadaMinima AND QtdEntrada \u003c=QtdPlanejadaMaxima\r\n\t\t)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6313\r\n\t\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das Saidas ‚ maior/menor em 1% que a quantidade planejada na OP\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--FECHAMENTO DA OP (Desmontagem) - Entrada\r\n--Verificar a somatoria das entradas (Linhas campo quantidade) que deve ser igual a quantidade planejada na linha da op (IGNORAR O EM)\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--\tIF (@StatusOP = \u0027L\u0027 AND @TypeOP = \u0027D\u0027)\r\n--\tBEGIN\r\n--\tIF NOT EXISTS(\r\n--\t\tSELECT *FROM (\r\n--\t\tSELECT T0.ItemCode \u0027ItemCodeSaida\u0027,SUM(T0.Quantity)\u0027QtdSaida\u0027,T1.ItemCode \u0027ItemCodeLinhaOp\u0027,T1.PlannedQty\u0027QtdPlanejada\u0027,\r\n--\t\tT1.PlannedQty - ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMinima\u0027,T1.PlannedQty + ((T1.PlannedQty*1)/100)\u0027QtdPlanejadaMaxima\u0027\r\n--\t\tFROM IGN1 T0\r\n--\t\tINNER JOIN WOR1 T1 ON T0.BaseEntry = T1.DocEntry AND T0.ItemCode = T1.ItemCode\r\n--\t\tWHERE T1.DocEntry = @list_of_cols_val_tab_del \r\n--\t\tAND SUBSTRING( T0.ItemCode,1,2) \u003c\u003e \u0027EM\u0027 AND SUBSTRING( T1.ItemCode,1,2) \u003c\u003e \u0027EM\u0027\r\n--\t\tGROUP BY T0.ItemCode,T1.ItemCode,T1.PlannedQty\r\n--\t\t)A\r\n--\t\tWHERE QtdSaida \u003e= QtdPlanejadaMinima AND QtdSaida \u003c= QtdPlanejadaMaxima\r\n--\t\t)\r\n--\t\tBEGIN\r\n--\t\t\tSET @error = -6313\r\n--\t\t\tSET @error_message = \u0027Nao foi possivel salvar a OP, a soma das Entradas ‚ maior/menor em 1% que a quantidade planejada indicada nas linhas da OP\u0027\r\n--\t\t\tSELECT @error, @error_message\r\n--\t\tEND\r\n--\tEND\r\nEND\r\n---------------------------------------------------------------------------------------------------------------------------\r\n----END\r\n---------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 26/02/2017\r\n-- Update Date: 22/02/2019\r\n-- Description: Trava NF ENTRADA e Solicita‡ao de compra - Aquisi‡oes para Projeto Ativo Fixo\r\n-- Documentos: NF ENTRADA e Solicita‡ao de compra\r\n-- GLPI ID : 4572\r\n---- GLPI ID Atualiza‡oes:6527\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------NF ENTRADA--------------------------------------------------------------\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002718\u0027 = NF ENTRADA\r\nBEGIN\r\nDECLARE @Linhas4572E int = (SELECT MAX(LineNum)FROM PCH1  WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Cont4572E int = 0\r\nDECLARE @Deposito4572E Nvarchar (10)\r\nDECLARE @Util4572E int\r\nDECLARE @ProjetoE NVarchar (100) = null\r\nWHILE(@Cont4572E \u003c  @Linhas4572E + 1) -- percorrendo todas as linhas do Pedido\r\n  BEGIN\r\n  \r\n   SET @Deposito4572E = (SELECT WhsCode FROM PCH1 WHERE LineNum = @Cont4572E AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @Util4572E = (SELECT Usage FROM PCH1 WHERE LineNum = @Cont4572E AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @ProjetoE = (SELECT rtrim(ltrim(Project)) FROM PCH1 WHERE LineNum = @Cont4572E AND DocEntry = @list_of_cols_val_tab_del)-- pegando projeto de cada linha\r\n\r\n\t\t\r\n\t\tIF(@ProjetoE IS NOT NULL AND \t@ProjetoE\u003c\u003e\u0027\u0027)\r\n\t\tBEGIN\r\n\r\n\t\t\tIF( @Deposito4572E \u003c\u003e \u002702.98\u0027 AND @Deposito4572E \u003c\u003e \u002702.94\u0027  )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4572\r\n\t\t\t\tSET @error_message = \u0027Obrigatorio dep¢sito 02.98 ou 02.94!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t--32 = Compra de Ativo ST 31- Compra de Ativo 45 - Compra Servi‡o ISS\r\n\t\t\tELSE IF(@Util4572E \u003c\u003e 32 AND @Util4572E \u003c\u003e 31 AND @Util4572E \u003c\u003e 45)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4572\r\n\t\t\t\tSET @error_message = \u0027O campo utiliza‡ao nao pode ser diferente de compra de ativo, compra ativo st ou compra servi‡o iss quando dep¢sito for = 02.98!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t\r\n\t\tEND\r\n\t\t\r\n\tSet @Cont4572E =  @Cont4572E + 1\r\n  END--END while\r\nEND\r\n\r\n--------------------------SOLICITA€AO DE COMPRA--------------------------------------------------------------\r\nIF (@object_type = \u00271470000113\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00271470000113\u0027 = SOLICITA€AO DE COMPRA\r\nBEGIN\r\nDECLARE @Linhas4572S int = (SELECT MAX(LineNum)FROM PRQ1   WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Cont4572S int = 0\r\nDECLARE @Deposito4572S Nvarchar (10)\r\nDECLARE @Util4572S int\r\nDECLARE @ProjetoS NVarchar (100) = null\r\nWHILE(@Cont4572S \u003c  @Linhas4572S + 1) -- percorrendo todas as linhas do Pedido\r\n  BEGIN\r\n  \r\n   SET @Deposito4572S = (SELECT WhsCode FROM PRQ1 WHERE LineNum = @Cont4572S AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @Util4572S = (SELECT Usage FROM PRQ1 WHERE LineNum = @Cont4572S AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @ProjetoS = (SELECT (rtrim(ltrim(Project))) FROM PRQ1 WHERE LineNum = @Cont4572S AND DocEntry = @list_of_cols_val_tab_del)-- pegando projeto de cada linha\r\n\r\n\t\tIF(@ProjetoS IS NOT NULL AND \t@ProjetoS\u003c\u003e\u0027\u0027)\r\n\t\tBEGIN\r\n\r\n\t\t\tIF( @Deposito4572S \u003c\u003e \u002702.98\u0027 AND @Deposito4572S \u003c\u003e \u002702.94\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4572\r\n\t\t\t\tSET @error_message = \u0027Obrigatorio dep¢sito 02.98 ou 02.94!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t--32 = Compra de Ativo ST 31- Compra de Ativo 45 - Compra Servi‡o ISS\r\n\t\t\tELSE IF(@Util4572S \u003c\u003e 32 AND @Util4572S \u003c\u003e 31 AND @Util4572S \u003c\u003e 45)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4572\r\n\t\t\t\tSET @error_message = \u0027O campo utiliza‡ao nao pode ser diferente de compra de ativo, compra ativo st ou compra servi‡o iss quando dep¢sito for = 02.98!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t\r\n\t\tEND\r\n\t\t\r\n\tSet @Cont4572S =  @Cont4572S + 1\r\n  END--END while\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 18/02/2019\r\n-- Update Date:\r\n-- Description:\tTravar adicionar linhas com cidades duplicadas na macro regiao\r\n-- GLPI ID: 6500\r\n-- GLPI ID Atualiza‡oes:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027CadMacroRegiao\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--CadMacroRegiao\r\nBEGIN\r\n\r\nIF EXISTS(\r\nSELECT *FROM(\r\nSELECT A.U_Estado,COUNT(A.U_MUNICIPIO)\u0027cidades\u0027 FROM(\r\n SELECT T0.U_Estado, LineId,T0.U_Municipio FROM [@RAL_MACROREGIAO1] T0 \r\n INNER JOIN [@RAL_MACROREGIAO] T1 ON T1.DocEntry= T0.DocEntry \r\n WHERE T0.DocEntry = @list_of_cols_val_tab_del\r\n ) A\r\n GROUP BY A.U_ESTADO,A.U_Municipio) B WHERE cidades \u003e 1 )\r\n BEGIN\r\n\tSET @error = -6500\r\n\tSET @error_message = \u0027Existe duplicidade de cidades, Verifique!\u0027\r\n\tSELECT @error, @error_message\r\n\r\n END\r\n END;\r\n --------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n-------------------------------------------------------------------------------------------------------------------------\r\n---- Author:\t\tHenrique Truyts \r\n---- Create date: 15/02/2019\r\n---- Description: Travar Documentos sem RA preenchido  - ESBO€O\r\n---- Documentos:  Solicita‡ao de Compra,Oferta de Compra, Saida de mercadorias\r\n---- GLPI ID: 6345\r\n---- GLPI ID Atualiza‡oes: 9451\r\n---- Description: Retirar a trava de RA dos documentos sa¡da de mercadoria e entrada de mercadoria em 13/09/2020\r\n-------------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027))--N\u0027112\u0027 = ESBO€O\r\n--BEGIN\r\n\r\n--\tIF EXISTS(SELECT * FROM DRF1 WHERE ObjType=\u00271470000113\u0027 \r\n--\t\tAND (U_RAL_CadastroRA IS NULL OR  U_RAL_CadastroRA = \u0027\u0027) AND DocEntry = @list_of_cols_val_tab_del  )\r\n--\tBEGIN\r\n--\t\tSET @error = -6345\r\n--\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Cadastro RA, verifique!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\n------------------------------OFERTA DE COMPRA\r\n--IF EXISTS(SELECT * FROM DRF1 WHERE ObjType=\u0027540000006\u0027 \r\n--\t\tAND (U_RAL_CadastroRA IS NULL OR  U_RAL_CadastroRA = \u0027\u0027) AND DocEntry = @list_of_cols_val_tab_del  )\r\n--\tBEGIN\r\n--\t\tSET @error = -6345\r\n--\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Cadastro RA, verifique!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\n--------------------------------SAIDA DE MERCADORIAS\r\n--IF EXISTS(SELECT * FROM DRF1 WHERE ObjType=\u002760\u0027 \r\n--\t\tAND (U_RAL_CadastroRA IS NULL OR  U_RAL_CadastroRA = \u0027\u0027) AND DocEntry = @list_of_cols_val_tab_del  )\r\n--\tBEGIN\r\n--\t\tSET @error = -6345\r\n--\t\tSET @error_message = \u0027 obrigat¢rio o preenchimento do campo Cadastro RA, verifique!\u0027\r\n--\t\tSELECT @error, @error_message\r\n--\tEND\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Henrique Truyts\r\n-- Create date: 04/01/2018\r\n-- Update Date: 07/05/2018\r\n-- Description:\tBloquear OP caso o produto da lista nao exista no cadastro de base de produtos\r\n-- Documentos: Ordem de Produ‡ao\r\n-- GLPI ID: 4012\r\n-- GLPI ID Atualiza‡oes:5115\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u0027202\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u0027202\u0027 = Ordem de Produ‡ao - OWOR\r\n--BEGIN\r\n--\tDECLARE @ItemCode4012 NVARCHAR (20)  = (SELECT ItemCode FROM OWOR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n--\tDECLARE @TotalProdutos4012 INT = (SELECT Count(DISTINCT ItemCode) FROM WOR1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\n--\tDECLARE @ProdExistentesBase INT = (\r\n--\t--se o total de linhas desse select for menor que a conta de itens da wor1 tem q bloquear\r\n--\t\t\t SELECT COUNT(DISTINCT U_ItemCode) FROM [@RAL_BASEPRODUTOS1] WHERE Code \r\n--\t\t\t IN(SELECT Code FROM [@RAL_BASEPRODUTOS] WHERE  U_ItemCode =  @ItemCode4012 )\r\n--\t\t\t AND U_ItemCode IN(SELECT ItemCode FROM WOR1 WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\r\n--\t--OP ESPECIAL (TYPE =\u0027P\u0027 nao passa pela valida‡ao)\r\n--\tDECLARE @OPType CHAR (1) = (SELECT  Type FROM OWOR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n--\tIF(@OPType \u003c\u003e \u0027P\u0027)\r\n--\tBEGIN\r\n--\t\tIF(@ProdExistentesBase \u003c @TotalProdutos4012)\r\n--\t\tBEGIN\r\n--\t\t\tSET @error = -1\r\n--\t\t\tSET @error_message = \u0027Estrutura inv lida, verifique os componentes da OP!\u0027\r\n--\t\t\tSELECT @error, @error_message\r\n--\t\tEND\r\n--\tEND\r\n--END;--END GERAL\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 07/01/2019\r\n-- Update Date:\r\n-- Description:\tTravar Pedidos de Vendas com condi‡ao de pagamento diferente da condi‡ao do pn \r\n-- GLPI ID: 6271\r\n-- GLPI ID Atualiza‡oes:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @Dep6271 int SET @Dep6271 = (SELECT u.Department From ORDR O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\nDECLARE @CondPagtoPN Int = (SELECT GroupNum FROM OCRD WHERE CardCode = \r\n\t(SELECT O.CardCode FROM ORDR O WHERE O.DocNum = @list_of_cols_val_tab_del))\r\n\r\nDECLARE @CondPagtoPedido Int = (SELECT O.GroupNum FROM ORDR O WHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n IF(@Dep6271 = 1 AND @CondPagtoPN \u003c\u003e@CondPagtoPedido)\t\r\n\tBEGIN\r\n\t\tSET @error = -6271\r\n\t\tSET @error_message = \u0027Nao ‚ possivel atualizar o pedido, a condi‡ao de pagamento do pedido diverge da condi‡ao de pagamento cadastrada no parceiro!\u0027\r\n\t\tSELECT @error, @error_message\r\n\r\n\tEND;\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 16/11/2018\r\n-- Update date: 30/04/2022\r\n-- Description:\tTravar Pedido caso a data de entrega coincida com agendamento de Bloqueio\r\n-- Documentos:  Pedido de Vendas\r\n-- GLPI ID: 5915\r\n-- GLPI ID Atualiza‡oes:\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @DataEntregaAGBloq DATETIME SET @DataEntregaAGBloq = (SELECT DocDueDate FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\r\nDECLARE @CodigoPNAGBloq nvarchar(10) =(SELECT CardCode FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\r\nDECLARE @Filial5915 Numeric = (SELECT BPLId FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\nIF EXISTS(\r\nSELECT  U_RAL_CardCode,U_RAL_CardName,U_RAL_DataInicial,U_RAL_DataFinal\t\r\nFROM [@RAL_AGENDACLIENTES]\r\nWHERE U_BPLId = @Filial5915 AND U_RAL_StatusEntrega = \u0027Bloqueada\u0027  AND \r\n(@DataEntregaAGBloq between U_RAL_DataInicial AND U_RAL_DataFinal ) \r\nAND \r\n(@DataEntregaAGBloq between U_RAL_DataInicial AND U_RAL_DataFinal ) \r\nAND U_RAL_CardCode = @CodigoPNAGBloq\r\n)\r\nBEGIN\r\n\tSET @error = -1\r\n\tSET @error_message = \u0027Nao foi possivel salvar o pedido, existe um bloqueio para a data de entrega :\u0027+\r\n\treplace(convert(char(11),@DataEntregaAGBloq,113),\u0027 \u0027,\u0027-\u0027)\r\n\tSELECT @error, @error_message\r\nEND\r\nEND\r\n\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 16/11/2018\r\n-- Update date: 30/04/2022\r\n-- Description:\tTravar Pedido caso a data de entrega coincida com feriado e nao possua agendamento de autoriza‡ao\r\n-- Documentos:  Pedido de Vendas\r\n-- GLPI ID: 5915\r\n-- GLPI ID Atualiza‡oes:\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @Pais nvarchar(30)\r\nDECLARE @Estado nvarchar(30)\r\nDECLARE @Municipio nvarchar(30)\r\nDECLARE @Mes INT =  (SELECT DATEPART ( MONTH ,(SELECT DocDueDate FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)) )\r\nDECLARE @Dia INT = (SELECT DATEPART ( DAY ,(SELECT DocDueDate FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)) )\r\nDECLARE @DataEntrega DATETIME SET @DataEntrega = (SELECT DocDueDate FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\r\nDECLARE @CodigoPN nvarchar(10) =(SELECT CardCode FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\r\nDECLARE @Filial5915A Numeric = (SELECT BPLId FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n--primeiro tem que pegar os dados do local de entrega(Pais, estado, municipio)\r\nSELECT \r\n@Municipio = (CASE WHEN T8.U_Municipio IS NULL OR T8.U_Municipio = \u0027\u0027 THEN T3.Name ELSE T8.U_Municipio END) ,\r\n@Estado = (CASE WHEN T8.U_Estado IS NULL OR T8.U_Estado = \u0027\u0027 THEN T3.State ELSE T8.U_Estado END),\r\n@Pais=T3.Country\r\nFROM OCRD T0 \r\nINNER JOIN OCRG T1 ON T0.GroupCode = T1.GroupCode\r\nINNER JOIN CRD1 T2 ON T0.CardCode = T2.CardCode\r\nINNER JOIN OCNT T3 ON T2.County = T3.AbsId\r\nLEFT JOIN [@RAL_MACROREGIAO1] T4 ON T4.U_Municipio = T3.Name\r\nLEFT JOIN [@RAL_MACROREGIAO] T5 ON T5.DocEntry= T4.DocEntry \r\nLEFT JOIN ORDR T6 ON T6.CardCode = T0.CardCode \r\nLEFT JOIN [@RAL_LOCALENTREGA] T7 on T6.U_LocalEntregaId = T7.DocEntry  AND t7.U_BPLId = T6.BPLId\r\nLEFT JOIN [@RAL_LOCALENTREGA1] T8 on T8.DocEntry = T7.DocEntry \r\nWHERE T2.Address=\u0027FATURAMENTO\u0027 AND T0.CardCode = @CodigoPN\r\nAND T6.DocEntry = @list_of_cols_val_tab_del\r\n\r\n\r\n--Depois deve-se verificar com base nos dados do local de entrega, se existe algum feriado nacional, estadual ou municipal\r\nIF EXISTS(\r\n--Verificar apenas feriados nacionais\r\nSELECT T0.DocEntry,T1.U_RAL_Mes,T1.U_RAL_Dia,T1.U_RAL_Descricao,\u0027Nacional\u0027 as \u0027Tipo\u0027 FROM [@RAL_FERIADOS] T0 \r\nINNER JOIN [@RAL_FERIADOS1] T1 ON T0.DocEntry = T1.DocEntry \r\nWHERE T0.U_BPLId = @Filial5915A AND T0.U_RAL_Pais = @Pais AND T0.U_RAL_Estado IS NULL AND T0.U_RAL_Municipio IS NULL \r\nAND (T1.U_RAL_Dia \u003e= @Dia AND T1.U_RAL_Dia \u003c= @Dia )AND( T1.U_RAL_Mes\u003e= @Mes AND T1.U_RAL_Mes\u003c= @Mes) \r\nUNION\r\n--Verificar apenas feriados estaduais\r\nSELECT T0.DocEntry,T1.U_RAL_Mes,T1.U_RAL_Dia,T1.U_RAL_Descricao,\u0027Estadual\u0027 as \u0027Tipo\u0027 FROM [@RAL_FERIADOS] T0 \r\nINNER JOIN [@RAL_FERIADOS1] T1 ON T0.DocEntry = T1.DocEntry\r\nWHERE T0.U_BPLId = @Filial5915A AND T0.U_RAL_Pais = @Pais AND T0.U_RAL_Estado =@Estado  AND T0.U_RAL_Municipio IS NULL \r\nAND (T1.U_RAL_Dia \u003e= @Dia AND T1.U_RAL_Dia \u003c= @Dia )AND( T1.U_RAL_Mes\u003e=@Mes AND T1.U_RAL_Mes\u003c=@Mes) \r\nUNION \r\n--verificar apenas feriados municipais\r\nSELECT T0.DocEntry,T1.U_RAL_Mes,T1.U_RAL_Dia,T1.U_RAL_Descricao,\u0027Municipal\u0027 as \u0027Tipo\u0027 FROM [@RAL_FERIADOS] T0 \r\nINNER JOIN [@RAL_FERIADOS1] T1 ON T0.DocEntry = T1.DocEntry \r\nWHERE T0.U_BPLId = @Filial5915A AND T0.U_RAL_Pais = @Pais AND T0.U_RAL_Estado =@Estado AND T0.U_RAL_Municipio = @Municipio \r\nAND (T1.U_RAL_Dia \u003e= @Dia AND T1.U_RAL_Dia \u003c= @Dia )AND( T1.U_RAL_Mes\u003e=@Mes AND T1.U_RAL_Mes\u003c=@Mes)\r\n)\r\n--caso exista algum feriado, deve verificar se existe agendamento de autoriza‡ao\r\nBEGIN\r\n\t--se nao existe agendamento de autoriza‡ao , o sistema trava a entrada do pedido\r\n\tIF NOT EXISTS(\r\n\t\t\tSELECT  U_RAL_CardCode,U_RAL_CardName,U_RAL_DataInicial,U_RAL_DataFinal\t,U_RAL_StatusEntrega\r\n\t\t    FROM [@RAL_AGENDACLIENTES]\r\n\t\t    WHERE U_BPLId = @Filial5915A AND U_RAL_StatusEntrega = \u0027Autorizada\u0027 AND\r\n\t\t    (@DataEntrega between U_RAL_DataInicial AND U_RAL_DataFinal )\r\n\t\t    AND \r\n\t\t    (@DataEntrega between U_RAL_DataInicial AND U_RAL_DataFinal ) \r\n\t\t    AND U_RAL_CardCode = @CodigoPN\r\n\t)\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Nao foi possivel salvar o pedido, existe um feriado que coincide com a data de entrega :\u0027+\r\n\t\treplace(convert(char(11),@DataEntrega,113),\u0027 \u0027,\u0027-\u0027)\r\n\t\tSELECT @error, @error_message\r\n\t\t \r\n\tEND\r\n\t\r\nEND\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 16/11/2018\r\n-- Update date: 30/04/2022\r\n-- Description:\tTravar cota‡ao caso a data de entrega coincida com agendamento de Bloqueio\r\n-- Documentos:  Cota‡ao\r\n-- GLPI ID: 5915\r\n-- GLPI ID Atualiza‡oes:\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027))--\u002723\u0027 = Cota‡ao de Vendas\r\n--BEGIN\r\n\r\n--DECLARE @DataEntregaAGBloqCOT DATETIME SET @DataEntregaAGBloqCOT = (SELECT DocDueDate FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n--DECLARE @CodigoPNAGBloqCOT nvarchar(10) =(SELECT CardCode FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n--DECLARE @Filial5915COT Numeric = (SELECT BPLId FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n--IF EXISTS(\r\n--SELECT  U_RAL_CardCode,U_RAL_CardName,U_RAL_DataInicial,U_RAL_DataFinal\t\r\n--FROM [@RAL_AGENDACLIENTES]\r\n--WHERE U_BPLId = @Filial5915COT AND U_RAL_StatusEntrega = \u0027Bloqueada\u0027  AND \r\n--(@DataEntregaAGBloqCOT between U_RAL_DataInicial AND U_RAL_DataFinal ) \r\n--AND \r\n--(@DataEntregaAGBloqCOT between U_RAL_DataInicial AND U_RAL_DataFinal ) \r\n--AND U_RAL_CardCode = @CodigoPNAGBloqCOT\r\n--)\r\n--BEGIN\r\n--\tSET @error = -5915\r\n--\tSET @error_message = \u0027Nao foi possivel salvar o pedido, existe um bloqueio para a data de entrega :\u0027+\r\n--\treplace(convert(char(11),@DataEntregaAGBloqCOT,113),\u0027 \u0027,\u0027-\u0027)\r\n--\tSELECT @error, @error_message\r\n--END\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-----------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 16/11/2018\r\n-- Update date: 30/04/2022\r\n-- Description:\tTravar Cota‡ao caso a data de entrega coincida com feriado e nao possua agendamento de autoriza‡ao\r\n-- Documentos:  Cota‡ao de Vendas\r\n-- GLPI ID: 5915\r\n-- GLPI ID Atualiza‡oes: --comentei a trava em 11/10/2023 para evitar que bloqueie pedidos do edi\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--IF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027))--\u002723\u0027 = Cota‡ao de Vendas\r\n--BEGIN\r\n\r\n--DECLARE @PaisCOT nvarchar(30)\r\n--DECLARE @EstadoCOT nvarchar(30)\r\n--DECLARE @MunicipioCOT nvarchar(30)\r\n--DECLARE @MesCOT INT =  (SELECT DATEPART ( MONTH ,(SELECT DocDueDate FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del)) )\r\n--DECLARE @DiaCOT INT = (SELECT DATEPART ( DAY ,(SELECT DocDueDate FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del)) )\r\n--DECLARE @DataEntregaCOT DATETIME SET @DataEntregaCOT = (SELECT DocDueDate FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n--DECLARE @CodigoPNCOT nvarchar(10) =(SELECT CardCode FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n--DECLARE @Filial5915COTB Numeric = (SELECT BPLId FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n----primeiro tem que pegar os dados do local de entrega(Pais, estado, municipio)\r\n--SELECT \r\n--@MunicipioCOT = (CASE WHEN T8.U_Municipio IS NULL OR T8.U_Municipio = \u0027\u0027 THEN T3.Name ELSE T8.U_Municipio END) ,\r\n--@EstadoCOT = (CASE WHEN T8.U_Estado IS NULL OR T8.U_Estado = \u0027\u0027 THEN T3.State ELSE T8.U_Estado END),\r\n--@PaisCOT=T3.Country\r\n--FROM OCRD T0 \r\n--INNER JOIN OCRG T1 ON T0.GroupCode = T1.GroupCode\r\n--INNER JOIN CRD1 T2 ON T0.CardCode = T2.CardCode\r\n--INNER JOIN OCNT T3 ON T2.County = T3.AbsId\r\n--LEFT JOIN [@RAL_MACROREGIAO1] T4 ON T4.U_Municipio = T3.Name\r\n--LEFT JOIN [@RAL_MACROREGIAO] T5 ON T5.DocEntry= T4.DocEntry \r\n--LEFT JOIN OQUT T6 ON T6.CardCode = T0.CardCode \r\n--LEFT JOIN [@RAL_LOCALENTREGA] T7 on T6.U_LocalEntregaId = T7.DocEntry AND t7.U_BPLId = T6.BPLId\r\n--LEFT JOIN [@RAL_LOCALENTREGA1] T8 on T8.DocEntry = T7.DocEntry \r\n--WHERE T2.Address=\u0027FATURAMENTO\u0027 AND T0.CardCode = @CodigoPNCOT\r\n--AND T6.DocEntry = @list_of_cols_val_tab_del\r\n\r\n\r\n----Depois deve-se verificar com base nos dados do local de entrega, se existe algum feriado nacional, estadual ou municipal\r\n--IF EXISTS(\r\n----Verificar apenas feriados nacionais\r\n--SELECT T0.DocEntry,T1.U_RAL_Mes,T1.U_RAL_Dia,T1.U_RAL_Descricao,\u0027Nacional\u0027 as \u0027Tipo\u0027 FROM [@RAL_FERIADOS] T0 \r\n--INNER JOIN [@RAL_FERIADOS1] T1 ON T0.DocEntry = T1.DocEntry \r\n--WHERE T0.U_BPLId = @Filial5915COTB AND T0.U_RAL_Pais = @PaisCOT AND T0.U_RAL_Estado IS NULL AND T0.U_RAL_Municipio IS NULL \r\n--AND (T1.U_RAL_Dia \u003e= @DiaCOT AND T1.U_RAL_Dia \u003c= @DiaCOT )AND( T1.U_RAL_Mes\u003e= @MesCOT AND T1.U_RAL_Mes\u003c= @MesCOT) \r\n--UNION\r\n----Verificar apenas feriados estaduais\r\n--SELECT T0.DocEntry,T1.U_RAL_Mes,T1.U_RAL_Dia,T1.U_RAL_Descricao,\u0027Estadual\u0027 as \u0027Tipo\u0027 FROM [@RAL_FERIADOS] T0 \r\n--INNER JOIN [@RAL_FERIADOS1] T1 ON T0.DocEntry = T1.DocEntry\r\n--WHERE T0.U_BPLId = @Filial5915COTB AND T0.U_RAL_Pais = @PaisCOT AND T0.U_RAL_Estado =@EstadoCOT AND T0.U_RAL_Municipio IS NULL \r\n--AND (T1.U_RAL_Dia \u003e= @DiaCOT AND T1.U_RAL_Dia \u003c= @DiaCOT )AND( T1.U_RAL_Mes\u003e=@MesCOT AND T1.U_RAL_Mes\u003c=@MesCOT) \r\n--UNION \r\n----verificar apenas feriados municipais\r\n--SELECT T0.DocEntry,T1.U_RAL_Mes,T1.U_RAL_Dia,T1.U_RAL_Descricao,\u0027Municipal\u0027 as \u0027Tipo\u0027 FROM [@RAL_FERIADOS] T0 \r\n--INNER JOIN [@RAL_FERIADOS1] T1 ON T0.DocEntry = T1.DocEntry \r\n--WHERE T0.U_BPLId = @Filial5915COTB AND T0.U_RAL_Pais = @PaisCOT AND T0.U_RAL_Estado =@EstadoCOT AND T0.U_RAL_Municipio = @MunicipioCOT \r\n--AND (T1.U_RAL_Dia \u003e= @DiaCOT AND T1.U_RAL_Dia \u003c= @DiaCOT )AND( T1.U_RAL_Mes\u003e=@MesCOT AND T1.U_RAL_Mes\u003c=@MesCOT)\r\n--)\r\n----caso exista algum feriado, deve verificar se existe agendamento de autoriza‡ao\r\n--BEGIN\r\n--\t--se nao existe agendamento de autoriza‡ao , o sistema trava a entrada do pedido\r\n--\tIF NOT EXISTS(\r\n--\t\t\tSELECT  U_RAL_CardCode,U_RAL_CardName,U_RAL_DataInicial,U_RAL_DataFinal\t,U_RAL_StatusEntrega\r\n--\t\t    FROM [@RAL_AGENDACLIENTES]\r\n--\t\t    WHERE U_BPLId = @Filial5915COTB AND U_RAL_StatusEntrega = \u0027Autorizada\u0027 AND\r\n--\t\t    (@DataEntregaCOT between U_RAL_DataInicial AND U_RAL_DataFinal )\r\n--\t\t    AND \r\n--\t\t    (@DataEntregaCOT between U_RAL_DataInicial AND U_RAL_DataFinal ) \r\n--\t\t    AND U_RAL_CardCode = @CodigoPNCOT\r\n--\t)\r\n--\tBEGIN\r\n--\t\tSET @error = -5915\r\n--\t\tSET @error_message = \u0027Nao foi possivel salvar a cota‡ao, existe um feriado que coincide com a data de entrega :\u0027+\r\n--\t\treplace(convert(char(11),@DataEntregaCOT,113),\u0027 \u0027,\u0027-\u0027)\r\n--\t\tSELECT @error, @error_message\r\n\t\t \r\n--\tEND\r\n\t\r\n--END\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 08/11/2018\r\n-- Update Date: \r\n-- Description: Trava P/ Recebimento de mercadorias sem imposto\r\n-- Documento: Recebimento de Mercadorias\r\n-- GLPI ID:6038\r\n-- GLPI ID Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002720\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--Recebimento de mercadorias\r\nBEGIN \r\n\t\tIF EXISTS(SELECT *FROM  PDN1 WHERE (TaxCode IS NULL  OR TaxCode = \u0027\u0027)\r\n\t\t\t\tAND DocEntry = @list_of_cols_val_tab_del)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6038\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio o preenchimento do campo C¢digo de Imposto na linha do documento\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 06/11/2018\r\n-- Update Date: \r\n-- Description: Trava P/ Cancelamento de notas fiscais - Restrito ao Grupo Cont bil/Fiscal\r\n-- Documento: Entrega,Devolu‡ao,NF de Sa¡da e Dev. NF de Sa¡da\r\n-- Recebimento de Mercadorias,Devolu‡ao de Mercadorias,Nota Fiscal de Entrada,Dev. NF de Entrada,NF Recebimento Futuro\r\n-- GLPI ID:5953\r\n-- GLPI ID Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--Nota Fiscal de Sa¡da\r\nBEGIN \r\nDECLARE @Canceled5953NFS varchar (10) =(SELECT CANCELED FROM OINV WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953NFS int = (SELECT SeqCode FROM OINV WHERE DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953NFS int SET @Dep5953NFS = (SELECT u.Department From OINV O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953NFS \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953NFS = \u0027C\u0027 AND @TipoNF5953NFS = 27) --27 = Nfe\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--ENTREGA\r\nBEGIN \r\nDECLARE @Canceled5953ENT varchar (10) =(SELECT CANCELED FROM ODLN WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953ENT int = (SELECT SeqCode FROM ODLN WHERE  DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953ENT int SET @Dep5953ENT = (SELECT u.Department From ODLN O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953ENT \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953ENT = \u0027C\u0027 AND (@TipoNF5953ENT = 27 OR @TipoNF5953ENT = -2 )) --27 = Nfe -2 externo\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002716\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--DEVOLU€AO\r\nBEGIN \r\nDECLARE @Canceled5953DEV varchar (10) =(SELECT CANCELED FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953DEV int = (SELECT SeqCode FROM ORDN WHERE  DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953DEV int SET @Dep5953DEV = (SELECT u.Department From ORDN O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953DEV \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953DEV = \u0027C\u0027 AND (@TipoNF5953DEV = 29 OR @TipoNF5953DEV = -2 )) --29 = NFe_ENT -2 = externo\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--DEVOLU€AO NOTA FISCAL DE SAIDA\r\nBEGIN \r\nDECLARE @Canceled5953DEVNFS varchar (10) =(SELECT CANCELED FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953DEVNFS int = (SELECT SeqCode FROM ORIN WHERE  DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953DEVNFS int SET @Dep5953DEVNFS = (SELECT u.Department From ORIN O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953DEVNFS \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953DEVNFS = \u0027C\u0027 AND (@TipoNF5953DEVNFS = 29 OR @TipoNF5953DEVNFS = -2 )) --29 = NFe_ENT -2 = externo\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002720\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--Recebimento de mercadorias\r\nBEGIN \r\nDECLARE @Canceled5953RM varchar (10) =(SELECT CANCELED FROM OPDN WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953RM int = (SELECT SeqCode FROM OPDN WHERE DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953RM int SET @Dep5953RM = (SELECT u.Department From OPDN O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\nDECLARE @Modelo5953 int = (SELECT Model FROM OPDN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tIF(@Dep5953RM \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953RM = \u0027C\u0027 AND (@TipoNF5953RM = -2 OR @TipoNF5953RM = 29 OR @TipoNF5953RM = 28 ) \r\n\t\tAND (@Modelo5953 != NULL AND @Modelo5953 \u003e0)\t\t) --2=externo | --28=NFE_IMP | 29=NFE_Ent\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002721\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--Devolu‡ao de mercadorias\r\nBEGIN \r\nDECLARE @Canceled5953DM varchar (10) =(SELECT CANCELED FROM ORPD WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953DM int = (SELECT SeqCode FROM ORPD WHERE DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953DM int SET @Dep5953DM = (SELECT u.Department From ORPD O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953DM \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953DM = \u0027C\u0027 AND (@TipoNF5953DM = -2 OR @TipoNF5953DM = 27)) --2=externo | --27=Nfe\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--Nota Fiscal de Entrada | NF Receb Futuro\r\nBEGIN \r\nDECLARE @Canceled5953NFRF varchar (10) =(SELECT CANCELED FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953NFRF int = (SELECT SeqCode FROM OPCH WHERE DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953NFRF int SET @Dep5953NFRF = (SELECT u.Department From OPCH O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953NFRF \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953NFRF = \u0027C\u0027 AND (@TipoNF5953NFRF = -2 OR @TipoNF5953NFRF = 29 OR @TipoNF5953NFRF = 28))--2=externo | --28=NFE_IMP | 29=NFE_En\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002719\u0027) and (@transaction_type in (\u0027U\u0027,\u0027A\u0027))--dev nota fiscal de entrada\r\nBEGIN \r\nDECLARE @Canceled5953DVNFE varchar (10) =(SELECT CANCELED FROM ORPC WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @TipoNF5953DVNFE int = (SELECT SeqCode FROM ORPC WHERE DocEntry= @list_of_cols_val_tab_del)\r\nDECLARE @Dep5953DVNFE int SET @Dep5953DVNFE = (SELECT u.Department From ORPC O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@Dep5953DVNFE \u003c\u003e8) --8 ‚ o departamento contabil fiscal\r\n\tBEGIN\r\n\t-- -2 tipo NF campo seq code externo\r\n\t\tIF(@Canceled5953DVNFE = \u0027C\u0027 AND (@TipoNF5953DVNFE = -2 OR @TipoNF5953DVNFE = 27 ))--2=externo | --27=Nfe\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5953\r\n\t\t\tSET @error_message = \u0027Apenas colaboradores do setor Cont bil/Fiscal possuem autoriza‡ao para fazer o cancelamento desta NF\u0027\r\n\t\t\tSELECT @error, @error_message\t\t\r\n\t\tEND\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 20/10/2017\r\n-- Update Date: 26/10/2017\r\n-- Description:\tTRAVA DE DEPOSITO PARA DEVOLU€AO DE NF DE SAIDA DE ACORDO COM O GRUPO DO PRODUTO E TIPO  DE NFE - ID 3812\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027))--\u002714\u0027 = DEVOLU€AO DE NF DE SAIDA \r\nBEGIN\r\nDECLARE @Linhas int set @Linhas = (SELECT MAX(LineNum)FROM RIN1  WHERE DOCENTRY = @list_of_cols_val_tab_del)\r\nDECLARE @Cont1 int = 0\r\nDECLARE @GrupoProduto Nvarchar(255)\r\nDECLARE @TipoNFe Nvarchar(255) SET @TipoNFe = (SELECT SeqCode FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del) \r\nDECLARE @Deposito Nvarchar(255)\r\nDECLARE @SimplesNacional Nvarchar (10) SET @SimplesNacional = (SELECT  U_RA_SimplesNacional FROM OCRD WHERE\r\n\t\t\t\t\t\t\t\t\tCardCode = (SELECT CardCode FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\r\nWHILE(@Cont1 \u003c  @Linhas+1) -- percorrendo todas as linhas da nf\r\n  BEGIN\r\n\r\n  SET @GrupoProduto = (SELECT ItmsGrpCod FROM OITM WHERE ItemCode = (\r\n\t\t\t\t\t\tSELECT ItemCode FROM RIN1  WHERE LineNum = @Cont1 AND DOCENTRY = @list_of_cols_val_tab_del)) -- pegando grupo de cada produto de cada linha\r\n\r\n  SET @Deposito = (SELECT WhsCode FROM RIN1 WHERE LineNum = @Cont1 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n\r\n\tIF(@GrupoProduto = 106 OR @GrupoProduto = 116 OR @GrupoProduto = 117 OR @GrupoProduto = 118 )--if principal\r\n\tBEGIN\r\n\t\tIF(@SimplesNacional = \u0027S\u0027)\r\n\t\tBEGIN\r\n\t\t\tIF(29 = @TipoNFe AND \u002702.04\u0027 != @Deposito)--NFe Ent = 29\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Devolu‡ao com NF de cliente o dep¢sito deve ser = 02.04 em caso de cliente SIMPLES NACIONAL verificar parceiro de neg¢cios!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tEND -- END IF SIMPLES NACIONAL\r\n\t\tELSE\r\n\t\tBEGIN\r\n\t\t\tIF(-2 = @TipoNFe AND \u002702.04\u0027 != @Deposito)-- Externo = -2\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Devolu‡ao com NF de cliente o dep¢sito deve ser = 02.04 em caso de cliente SIMPLES NACIONAL verificar parceiro de neg¢cios!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\tIF(29 = @TipoNFe AND (\u002702.03\u0027 != @Deposito AND \u002702.19\u0027!= @Deposito AND \u002702.35\u0027!= @Deposito))--NFe Ent = 29\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Retorno com NF pr¢pria o dep¢sito deve ser = 02.03, 02.19 ou 02.35!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tEND -- END ELSE IF SIMPLES NACIONAL\r\n\tEND-- end if principal\r\n\tSet @Cont1 = @Cont1 +1\r\n  END--END while\r\nEND; -- END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 25/04/2018\r\n-- Update Date: 30/04/2022\r\n-- Description:\tPreencher os campos de usu rio: Local de Entrega id, Line local id.\r\n-- Documentos:  Pedido de Venda\r\n-- GLPI ID: 4644\r\n-- GLPI ID Atualiza‡oes:5771\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Venda \r\nBEGIN\r\nDECLARE @LocalEntregaID  Numeric = 0\r\nDECLARE @LineLocalEntregaID NUmeric = 0\r\nDECLARE @U_RAL_LocalEntrega NVarchar (254)\r\nDECLARE @U_LocalEntrega Nvarchar (254)\r\nDECLARE @U_CardCode NVARCHAR (254)\r\nDECLARE @Filial4644 Numeric = (SELECT BPLId FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\tSET @U_RAL_LocalEntrega = (SELECT U_RAL_LocalEntrega FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tSET @U_CardCode = (SELECT CardCode FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@U_RAL_LocalEntrega IS NOT NULL AND @U_RAL_LocalEntrega \u003c\u003e \u0027\u0027)\r\n\tBEGIN\r\n\t\t\t--id local entrega \r\n\t\t\tSET @LocalEntregaID = (SELECT T1.DocEntry\r\n\t\t\tFROM [@RAL_LOCALENTREGA1] T0\r\n\t\t\tINNER JOIN  [@RAL_LOCALENTREGA] T1 ON T0.DocEntry = T1.DocEntry\r\n\t\t\tWHERE T1.U_BPLId = @Filial4644 AND T0.U_IDEndereco = @U_RAL_LocalEntrega AND  T1.U_CardCode = @U_CardCode)\r\n\t\t\t--id linha local entrega\r\n\t\t\tSET  @LineLocalEntregaID =(SELECT T0.LineId\tFROM [@RAL_LOCALENTREGA1] T0\r\n\t\t\tINNER JOIN  [@RAL_LOCALENTREGA] T1 ON T0.DocEntry = T1.DocEntry\r\n\t\t\tWHERE T1.U_BPLId = @Filial4644 AND T0.U_IDEndereco = @U_RAL_LocalEntrega AND  T1.U_CardCode = @U_CardCode )\r\n\r\n\t\t\t--Munic¡pio local entrega \r\n\t\t\tSET @U_LocalEntrega = (SELECT T0.U_Municipio\r\n\t\t\tFROM [@RAL_LOCALENTREGA1] T0\r\n\t\t\tINNER JOIN  [@RAL_LOCALENTREGA] T1 ON T0.DocEntry = T1.DocEntry\r\n\t\t\tWHERE T1.U_BPLId = @Filial4644 AND T0.U_IDEndereco = @U_RAL_LocalEntrega AND  T1.U_CardCode = @U_CardCode)\r\n\r\n\t\t\r\n\r\n\t\t\tUPDATE ORDR SET U_LineLocalId = Convert(nvarchar,@LineLocalEntregaID) , U_LocalEntregaId = Convert(NVarchar,@LocalEntregaID)\r\n\t\t\t,U_LocalEntregaLabel = @U_RAL_LocalEntrega, U_LocalEntrega = @U_LocalEntrega,U_RAL_LocalEntrega=@U_RAL_LocalEntrega,\r\n\t\t\tU_MacroRegiaoId = @U_LocalEntrega\r\n\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del;\r\n\t\t\t\t\r\n\tEND\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 25/04/2018\r\n-- Update Date: 30/04/2022\r\n-- Description:\tPreencher os campos de usu rio: Local de Entrega id, Line local id.\r\n-- Documentos:  Cota‡ao de Venda\r\n-- GLPI ID: 4644\r\n-- GLPI ID Atualiza‡oes:5771\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002723\u0027) and (@transaction_type in (N\u0027A\u0027,N\u0027U\u0027))--\u002723\u0027 = Cota‡ao de Venda\r\nBEGIN\r\nDECLARE @LocalEntregaIDQ  Numeric = 0\r\nDECLARE @LineLocalEntregaIDQ NUmeric = 0\r\nDECLARE @U_RAL_LocalEntregaQ NVarchar (254)\r\nDECLARE @U_LocalEntregaQ NVarchar (254)\r\nDECLARE @U_CardCodeQ NVARCHAR (254)\r\nDECLARE @Filial4644Q Numeric = (SELECT BPLId FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\tSET @U_RAL_LocalEntregaQ = (SELECT U_RAL_LocalEntrega FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\tSET @U_CardCodeQ = (SELECT CardCode FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@U_RAL_LocalEntregaQ IS NOT NULL AND @U_RAL_LocalEntregaQ \u003c\u003e \u0027\u0027)\r\n\tBEGIN\r\n\t\t\t--id local entrega \r\n\t\t\tSET @LocalEntregaIDQ = (SELECT T1.DocEntry\r\n\t\t\tFROM [@RAL_LOCALENTREGA1] T0\r\n\t\t\tINNER JOIN  [@RAL_LOCALENTREGA] T1 ON T0.DocEntry = T1.DocEntry\r\n\t\t\tWHERE T1.U_BPLId = @Filial4644Q AND T0.U_IDEndereco = @U_RAL_LocalEntregaQ AND  T1.U_CardCode = @U_CardCodeQ)\r\n\t\t\t--id linha local entrega\r\n\t\t\tSET  @LineLocalEntregaIDQ =(SELECT T0.LineId\tFROM [@RAL_LOCALENTREGA1] T0\r\n\t\t\tINNER JOIN  [@RAL_LOCALENTREGA] T1 ON T0.DocEntry = T1.DocEntry\r\n\t\t\tWHERE T1.U_BPLId = @Filial4644Q AND T0.U_IDEndereco = @U_RAL_LocalEntregaQ AND  T1.U_CardCode = @U_CardCodeQ)\r\n\r\n\t\t\t--Munic¡pio local entrega \r\n\t\t\tSET @U_LocalEntregaQ = (SELECT T0.U_Municipio\r\n\t\t\tFROM [@RAL_LOCALENTREGA1] T0\r\n\t\t\tINNER JOIN  [@RAL_LOCALENTREGA] T1 ON T0.DocEntry = T1.DocEntry\r\n\t\t\tWHERE T1.U_BPLId = @Filial4644Q AND T0.U_IDEndereco = @U_RAL_LocalEntregaQ AND  T1.U_CardCode = @U_CardCodeQ)\r\n\r\n\t\t\t\r\n\t\t\tUPDATE OQUT SET U_LineLocalId = Convert(nvarchar,@LineLocalEntregaIDQ) , U_LocalEntregaId = Convert(NVarchar,@LocalEntregaIDQ)\r\n\t\t\t,U_LocalEntregaLabel = @U_RAL_LocalEntregaQ, U_LocalEntrega = @U_LocalEntregaQ,U_RAL_LocalEntrega=@U_RAL_LocalEntregaQ,\r\n\t\t\tU_MacroRegiaoId = @U_LocalEntregaQ\r\n\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del;\r\n\t\t\t\t\r\n\tEND\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 04/09/2018\r\n-- Update Date: \r\n-- Description: Validar o Munic¡pio na Linha como obrigat¢rio.\r\n-- Documento: Picking \r\n-- GLPI ID:5724\r\n-- GLPI ID Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u0027CadLocalEntrega\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))-- Local de Entrega\r\nBEGIN \r\n\tDECLARE @Municipio5724 nvarchar (255) \r\n\tDECLARE @Cont5724 INT = 1\r\n\tDECLARE @Linhas5724 INT = (SELECT Max(LineId) FROM  [@RAL_LOCALENTREGA1] WHERE  DocEntry = @list_of_cols_val_tab_del )\r\n\t\r\n\tWHILE(@Cont5724 \u003c=@Linhas5724)\r\n\t\tBEGIN\r\n\t\t\tSET @Municipio5724 = (SELECT U_Municipio FROM  [@RAL_LOCALENTREGA1] \r\n\t\t\t\t\t\tWHERE LineId = @Cont5724 AND DocEntry = @list_of_cols_val_tab_del)--@list_of_cols_val_tab_del)\r\n\t\t\tIF(@Municipio5724 IS NULL OR @Municipio5724 = \u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5724\r\n\t\t\t\tSET @error_message = \u0027 obrigatorio o preenchimento do campo munic¡pio!.\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\r\n\t\t\tSET @Cont5724 = @Cont5724 + 1\r\n\t\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 21/12/2017\r\n-- Update Date: 15/08/2018\r\n-- Description:\tBloqueio de NF em Duplicidade\r\n-- Documentos: NF de entrada,DEVOLU€AO NOTA FISCAL DE SAIDA\r\n-- GLPI ID:4194\r\n-- GLPI ID Atualiza‡ao:5505,5633\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027))--\u002718\u0027 = NF DE ENTRADA\r\nBEGIN\r\n\t--Se Nø NF for Externo\r\n\tIF((SELECT SeqCode FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del) = -2)\r\n\tBEGIN\t\t\r\n\t\tIF EXISTS(SELECT * FROM [dbo].[RAL_Opch] WHERE CardCode = (SELECT CardCode FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\t  AND Serial  = (SELECT Serial FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del) \r\n\t\t  AND DoCentry \u003c\u003e @list_of_cols_val_tab_del AND Canceled=\u0027N\u0027 \r\n\t\t  AND Model =  (SELECT model FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\t  AND SeriesStr =   (SELECT [dbo].[SeriesStrOPCH]( @list_of_cols_val_tab_del)) )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -4194\r\n\t\t\tSET @error_message = \u0027NF ENTRADA - Nao foi poss¡vel concluir. N£mero de NF j  existente para esse parceiro.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\n\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- DEVOLU€AO NOTA FISCAL DE SAIDA \r\n---------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027))--\u002714\u0027 = DEVOLU€AO NOTA FISCAL DE SAIDA\r\nBEGIN\r\n\t--Se Nø NF for Externo\r\n\tIF((SELECT SeqCode FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del) = -2)\r\n\tBEGIN\t\t\r\n\t\tIF EXISTS(SELECT * FROM [dbo].[RAL_Orin] WHERE CardCode = (SELECT CardCode FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\t  AND Serial  = (SELECT Serial FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del) \r\n\t\t  AND DoCentry \u003c\u003e @list_of_cols_val_tab_del AND Canceled=\u0027N\u0027 \r\n\t\t  AND Model =  (SELECT model FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\t  AND SeriesStr =  (SELECT [dbo].[SeriesStrORIN]( @list_of_cols_val_tab_del)))\r\n\t\tBEGIN\r\n\t\t\tSET @error = -5505\r\n\t\t\tSET @error_message = \u0027DEV NF SAIDA - Nao foi poss¡vel concluir. N£mero de NF j  existente para esse parceiro.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\n\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- AuthorUpdate:leonardo do Prado Gomes\r\n-- Create date: 20/06/2018\r\n-- Update Date: 26/04/2024\r\n-- Description:  Adi‡ao e altera‡ao de registro de Lista de Picking\r\n-- DescriptionUpdate: Melhoria na Contagem de OC, aplicado CASE para tratar valor Nulo.\r\n-- Documento: Picking \r\n-- GLPI ID:5261\r\n-- GLPI ID Atualiza‡ao:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027156\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u0027156\u0027 = Picking\r\nBEGIN\r\nDECLARE @OCNum Nvarchar (10) = 0\r\n\r\nDECLARE @U_Veiculo_Placa  Nvarchar (10)\r\nDECLARE @U_Transportadora  Nvarchar (max)\r\nDECLARE @U_Valor_Frete  Numeric\r\nDECLARE @U_Tipo_Veiculo_Nome  Nvarchar (max)\r\nDECLARE @U_Itinerario_Nome  Nvarchar (max)\r\nDECLARE @U_Peso_Estimado numeric\r\nDECLARE @U_Peso_Pedidos numeric\r\nDECLARE @U_Quantidade_Entrega numeric\r\nDECLARE @U_Valor_Seguro numeric(10,3)\r\nDECLARE @U_Valor_Total_Frete numeric (10,3)\r\nDECLARE @U_TotalTaxaEntrega numeric (10,3)\r\n\r\n\tIF((SELECT COUNT(U_OC_num) FROM (\r\n\t\t\t\tSELECT CASE \r\n\t\t\t\t\t\t\tWHEN T1.U_OC_num IS NULL THEN 1  -----MELHORIA APLICADA NESTE BLOCO\r\n\t\t\t\t\t\t\tELSE T1.U_OC_num \r\n\t\t\t\t\t  END AS \u0027U_OC_num\u0027\r\n\t\t\t\tFROM PKL1 T0\r\n\t\t\t\tINNER JOIN RDR1 T1 ON T0.OrderEntry = T1.DocEntry AND T0.OrderLine = T1.LineNum\r\n\t\t\t\tWHERE AbsEntry = @list_of_cols_val_tab_del\t\t\t\r\n\t\t\t\tGroup by T1.U_OC_num)A) = 1 ) --Se s¢ houver 1 oc entra no if\r\n\tBEGIN\r\n\tSET @OCNum = (SELECT T1.U_OC_num FROM PKL1 T0\r\n\t\t\t\tINNER JOIN RDR1 T1 ON T0.OrderEntry = T1.DocEntry AND T0.OrderLine = T1.LineNum\r\n\t\t\t\tWHERE AbsEntry = @list_of_cols_val_tab_del\t\r\n\t\t\t\tGroup by T1.U_OC_num) \r\n\r\n\r\n\t\tSET @U_Veiculo_Placa = (SELECT U_Veiculo_Placa FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Transportadora = (SELECT U_Transportadora FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Valor_Frete = (SELECT U_Valor_Frete FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Tipo_Veiculo_Nome = (SELECT U_Tipo_Veiculo_Nome FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Itinerario_Nome = (SELECT U_Itinerario_Nome FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Peso_Estimado = (SELECT U_Peso_Estimado FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Peso_Pedidos = (SELECT U_Peso_Estimado - U_Peso_Estimado_Pallets FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Quantidade_Entrega = (SELECT U_Quantidade_Entrega FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Valor_Seguro = (SELECT U_Valor_Seguro FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_TotalTaxaEntrega = (SELECT  U_Valor_Taxa_entrega FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\t\tSET @U_Valor_Total_Frete = (SELECT U_Valor_Total_Frete FROM [@BIM_ORDEMCARGA] WHERE DocEntry = @OCNum)\r\n\r\n\t\tUpdate OPKL SET U_PlacaVeiculo = @U_Veiculo_Placa,U_Transportadora = @U_Transportadora,\r\n\t\tU_ValorFrete =  @U_Valor_Frete,U_TipoVeiculo = @U_Tipo_Veiculo_Nome,U_Itinerario = @U_Itinerario_Nome,\r\n\t\tU_PesoSuportado = @U_Peso_Estimado, U_PesoPedidos = @U_Peso_Pedidos,U_Entrega = @U_Quantidade_Entrega,\r\n\t\tU_TaxaEntrega = @U_Valor_Seguro, U_TotalTaxaEntrega= @U_TotalTaxaEntrega, U_ValorTotalFrete = @U_Valor_Total_Frete \r\n\t\tWHERE AbsEntry = @list_of_cols_val_tab_del;\t\t\r\n\r\n\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 20/06/2018\r\n-- Update Date: \r\n-- Description: Atualizar dados da OC ao cancelar o Picking\r\n-- Documento: Picking\r\n-- GLPI ID:5261 item 2\r\n-- GLPI ID Atualiza‡oes:\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027156\u0027) and (@transaction_type in (\u0027U\u0027))--\u0027156\u0027 = Picking\r\nBEGIN\r\nDECLARE @PKCancelado char(1) = (SELECT U_RAL_Cancelado FROM OPKL WHERE AbsEntry = @list_of_cols_val_tab_del )\r\n\r\n\tIF(@PKCancelado = \u0027Y\u0027)\r\n\tBEGIN\r\n\t\tIF((SELECT U_Num_picking FROM [@BIM_ORDEMCARGA]  \r\n\t\tWHERE DocEntry IN(\r\n\t\t\tSELECT\tdistinct T1.U_OC_num FROM PKL1 T0 \r\n\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\r\n\t\t\tINNER JOIN [@BIM_ORDEMCARGA] T2 ON T2.DocEntry = T1.U_OC_num\r\n\t\t\tWHERE T0.AbsEntry = @list_of_cols_val_tab_del AND  T2.U_piking_checkbox = \u0027Y\u0027)) = @list_of_cols_val_tab_del )\r\n\r\n\r\n\t\tBEGIN\r\n\t\tUPDATE [@BIM_ORDEMCARGA] SET U_Num_picking = null, U_RAL_NumPick = (SELECT dbo.PickingsdaOCCancelamento(@list_of_cols_val_tab_del))\r\n\t\tWHERE DocEntry IN(\r\n\t\t\tSELECT\tdistinct T1.U_OC_num FROM PKL1 T0 \r\n\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\r\n\t\t\tINNER JOIN [@BIM_ORDEMCARGA] T2 ON T2.DocEntry = T1.U_OC_num\r\n\t\t\tWHERE T0.AbsEntry = @list_of_cols_val_tab_del AND  T2.U_piking_checkbox = \u0027Y\u0027);\r\n\t\tEND\r\n\tELSE \r\n\t\tBEGIN\r\n\t\t\tUPDATE [@BIM_ORDEMCARGA] SET U_RAL_NumPick = (SELECT dbo.PickingsdaOCCancelamento(@list_of_cols_val_tab_del))\r\n\t\tWHERE DocEntry IN(\r\n\t\t\tSELECT\tdistinct T1.U_OC_num FROM PKL1 T0 \r\n\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\r\n\t\t\tINNER JOIN [@BIM_ORDEMCARGA] T2 ON T2.DocEntry = T1.U_OC_num\r\n\t\t\tWHERE T0.AbsEntry = @list_of_cols_val_tab_del AND  T2.U_piking_checkbox = \u0027Y\u0027);\r\n\t\tEND\r\n\tEND--END IF\r\nEND--END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 24/01/2018\r\n-- Update Date: 20/06/2018\r\n-- Description: Valida‡ao de Picking\r\n-- Documento: Picking \r\n-- GLPI ID:4243\r\n-- GLPI IG Atualiza‡ao:5261\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027156\u0027) and (@transaction_type in (\u0027A\u0027))--\u0027156\u0027 = Picking\r\nBEGIN\r\n\tIF EXISTS(SELECT * FROM [@BIM_ORDEMCARGA] WHERE U_piking_checkbox=\u0027N\u0027 AND DocEntry in (\r\n\t\t\tSELECT\tT1.U_OC_num FROM PKL1 T0 \r\n\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\r\n\t\t\tINNER JOIN [@BIM_ORDEMCARGA] T2 ON T2.DocEntry = T1.U_OC_num\r\n\t\t\tWHERE T0.AbsEntry =  @list_of_cols_val_tab_del ))  \r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Existe OC sem libera‡ao para Picking. Verifique.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\tELSE \r\n\tBEGIN\r\n\t\tUPDATE [@BIM_ORDEMCARGA] SET U_Num_picking = @list_of_cols_val_tab_del, U_RAL_NumPick = (SELECT dbo.PickingsdaOC(@list_of_cols_val_tab_del)) WHERE DocEntry IN(\r\n\t\t\tSELECT\tdistinct T1.U_OC_num FROM PKL1 T0 \r\n\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\r\n\t\t\tINNER JOIN [@BIM_ORDEMCARGA] T2 ON T2.DocEntry = T1.U_OC_num\r\n\t\t\tWHERE T0.AbsEntry = @list_of_cols_val_tab_del AND  T2.U_piking_checkbox = \u0027Y\u0027);\r\n\r\n\t\t\t\tUPDATE OPKL SET Remarks = \u0027OC \u0027+(\tSELECT STUFF((SELECT Distinct\t\u0027,\u0027 + CONVERT(nvarchar,T1.U_OC_num) FROM PKL1 T0 \r\n\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\r\n\t\t\tINNER JOIN [@BIM_ORDEMCARGA] T2 ON T2.DocEntry = T1.U_OC_num\r\n\t\t\tWHERE T0.AbsEntry = @list_of_cols_val_tab_del AND  T2.U_piking_checkbox = \u0027Y\u0027\r\n\t\tFOR XML PATH(\u0027\u0027)), 1, 1, \u0027\u0027) ) WHERE AbsEntry = @list_of_cols_val_tab_del;\r\n\r\n\tEND \r\nEND\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 26/10/2017\r\n-- Update Date: 10/05/2018\r\n-- Description: TRAVA DE MODELO E CHAVE DE ACESSO NF ENTRADA, DEVOLU€AO E DEV DE NF DE SAIDA - Chamado 3811\r\n-- GLPI ID:3811\r\n-- GLPI ID Atualiza‡ao:5041\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @Model int\r\nDECLARE @ChaveAcesso NVARCHAR(100)\r\nDECLARE @SqCode int = 0\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002713\u0027 = NOTA FISCAL DE ENTRADA\r\nBEGIN\r\n\tSET @SqCode = (SELECT SeqCode FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\tIF(@SqCode = -2)\r\n\tBEGIN\r\n\t\t--VALIDA€AO MODELO DA NF\r\n\t\tSET @Model = (SELECT Model FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\t\tIF(@Model = 0)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -3811\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o modelo da NF!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND--END IF\r\n\t\tELSE IF (@Model = 39 OR @Model = 44 OR @Model = 45)--NFE e Modelo CTe\r\n\t\tBEGIN\r\n\t\t\t--VALIDA€AO CHAVE DE ACESSO\r\n\t\t\tSET @ChaveAcesso = (SELECT U_chaveacesso FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\tIF (@ChaveAcesso IS NULL OR len(@ChaveAcesso)\u003c\u003e44 )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -3811\r\n\t\t\t\tSET @error_message = \u0027Chave de Acesso incorreta!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t--VALIDA€AO DA SERIE\r\n\t\t\tIF((SELECT SeriesStr FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del) IS  NULL OR \r\n\t\t\t   (SELECT SeriesStr FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del) =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tIF((SELECT convert(Numeric,substring(@ChaveAcesso,23,3))) \u003c\u003e0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -5041\r\n\t\t\t\t\tSET @error_message = \u0027Necess rio o preenchimento do campo Serie da NF!\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND\r\n\t\t\tELSE IF( (SELECT convert(Numeric,substring(@ChaveAcesso,23,3))) \u003c\u003e\r\n\t\t\t\t\t (SELECT SeriesStr FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5041\r\n\t\t\t\tSET @error_message = \u0027Serie difere da Chave de Acesso!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t----VALIDA€AO DO NUMERO DA NF\r\n\t\t\tIF((SELECT convert(Numeric,substring(@ChaveAcesso,26,9))) \u003c\u003e\r\n\t\t\t(SELECT Serial FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5041\r\n\t\t\t\tSET @error_message = \u0027N£mero da NF difere da Chave de Acesso!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND \r\n\t\tEND--END ELSE\r\n\tEND -- IF SEQ CODE\r\nEND;-- END GERAL\r\n----DEVOLU€AO DE NOTA FISCAL DE SAIDA----------------------------------------------------------------\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = DEVOLU€AO DE NOTA FISCAL DE SAIDA\r\nBEGIN\r\n\tSET @SqCode = (SELECT SeqCode FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\tIF(-2 = @SqCode)\r\n\tBEGIN\r\n\t\t--VALIDA€AO MODELO DA NF\r\n\t\tSET @Model = (SELECT Model FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\t\tIF(@Model = 0)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -3811\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o modelo da NF!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND--END IF\r\n\t\tELSE IF (@Model = 39 OR @Model = 44 OR @Model = 45)--NFE e Modelo CTe\r\n\t\tBEGIN\r\n\t\t\t--VALIDA€AO CHAVE DE ACESSO\r\n\t\t\tSET @ChaveAcesso = (SELECT U_chaveacesso FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\tIF (@ChaveAcesso IS NULL OR len(@ChaveAcesso)\u003c\u003e44 )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -3811\r\n\t\t\t\tSET @error_message = \u0027Chave de Acesso incorreta!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t--VALIDA€AO DA SERIE\r\n\t\t\tIF((SELECT SeriesStr FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del) IS  NULL OR \r\n\t\t\t   (SELECT SeriesStr FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del) =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tIF((SELECT convert(Numeric,substring(@ChaveAcesso,23,3))) \u003c\u003e0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -5041\r\n\t\t\t\t\tSET @error_message = \u0027Necess rio o preenchimento do campo Serie da NF!\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND\r\n\t\t\tELSE IF( (SELECT convert(Numeric,substring(@ChaveAcesso,23,3))) \u003c\u003e\r\n\t\t\t\t\t (SELECT SeriesStr FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5041\r\n\t\t\t\tSET @error_message = \u0027Serie difere da Chave de Acesso!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t--VALIDA€AO DO NUMERO DA NF\r\n\t\t\tIF((SELECT convert(Numeric,substring(@ChaveAcesso,26,9))) \u003c\u003e\r\n\t\t\t(SELECT Serial FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5041\r\n\t\t\t\tSET @error_message = \u0027N£mero da NF difere da Chave de Acesso!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND \r\n\t\tEND--END ELSE\r\n\tEND -- IF SEQ CODE\r\nEND;-- END GERAL\r\n----DEVOLU€AO----------------------------------------------------------------------------------------\r\nIF (@object_type = \u002716\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = DEVOLU€AO\r\nBEGIN\r\n\tSET @SqCode = (SELECT SeqCode FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\tIF(-2 = @SqCode)\r\n\tBEGIN\r\n\t\t--VALIDA€AO MODELO DA NF\r\n\t\tSET @Model = (SELECT Model FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\t\tIF(@Model = 0)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -3811\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o modelo da NF!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND--END IF\r\n\t\tELSE IF (@Model = 39 OR @Model = 44 OR @Model = 45)--NFE e Modelo CTe\r\n\t\tBEGIN\r\n\t\t\t--VALIDA€AO CHAVE DE ACESSO\r\n\t\t\tSET @ChaveAcesso = (SELECT U_chaveacesso FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\tIF (@ChaveAcesso IS NULL OR len(@ChaveAcesso)\u003c\u003e44 )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -3811\r\n\t\t\t\tSET @error_message = \u0027Chave de Acesso incorreta!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\r\n\t\t\t--VALIDA€AO DA SERIE\r\n\t\t\tIF((SELECT SeriesStr FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del) IS  NULL OR \r\n\t\t\t   (SELECT SeriesStr FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del) =\u0027\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tIF((SELECT convert(Numeric,substring(@ChaveAcesso,23,3))) \u003c\u003e0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -5041\r\n\t\t\t\t\tSET @error_message = \u0027Necess rio o preenchimento do campo Serie da NF!\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND\r\n\t\t\tELSE IF( (SELECT convert(Numeric,substring(@ChaveAcesso,23,3))) \u003c\u003e\r\n\t\t\t\t\t (SELECT SeriesStr FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5041\r\n\t\t\t\tSET @error_message = \u0027Serie difere da Chave de Acesso!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\t--VALIDA€AO DO NUMERO DA NF\r\n\t\t\t\tIF((SELECT convert(Numeric,substring(@ChaveAcesso,26,9))) \u003c\u003e\r\n\t\t\t(SELECT Serial FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del))\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -5041\r\n\t\t\t\tSET @error_message = \u0027N£mero da NF difere da Chave de Acesso!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND \r\n\t\tEND--END ELSE\r\n\tEND -- IF SEQ CODE\r\nEND;-- END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 01/02/2018\r\n-- Update Date: 08/05/2018 \r\n-- Description: Valida‡ao de Gera‡ao Picking\r\n-- Documento: Picking\r\n-- GLPI ID:4430\r\n-- GLPI ID Atualiza‡oes:5128\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027156\u0027) and (@transaction_type in (\u0027A\u0027))--\u0027156\u0027 = Picking\r\nBEGIN\r\n\tDECLARE @LinhasPicking Numeric = ( SELECT count(*) From pkl1 WHERE AbsEntry =  @list_of_cols_val_tab_del)\r\n\tDECLARE @Cont4430 numeric = 0 \r\n\tDECLARE @QuantidadeOC Numeric = 0 \r\n\tDECLARE @RelQtty4430 Numeric = 0\r\n\r\n\tWHILE(@Cont4430 \u003c @LinhasPicking)\r\n\tBEGIN\r\n\t\tSET @QuantidadeOC = (\r\n\t\t\t\t\tSELECT  CASE WHEN T1.U_Qtde_OC IS NULL THEN 0 ELSE  T1.U_Qtde_OC END\r\n\t\t\t\t\tFROM PKL1 T0 \r\n\t\t\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\t\r\n\t\t\t\t\tAND (T1.U_Qtde_OC = T0.RelQtty OR T1.U_Qtde_OC= T0.PickQtty)\t-- adicionei essa linha dia 20/03\r\n\t\t\t\t\tINNER JOIN OPKL T2 ON T2.ABSENTRY =T0.AbsEntry\r\n\t\t\t\t\tWHERE T0.AbsEntry =  @list_of_cols_val_tab_del AND T0.PickEntry = @Cont4430 \r\n\t\t\t\t\tAND T2.Status \u003c\u003e \u0027C\u0027\t) \r\n\t\tSET @RelQtty4430 = (\r\n\t\tSELECT  T0.RelQtty\r\n\t\t\t\t\tFROM PKL1 T0 \r\n\t\t\t\t\tINNER JOIN RDR1 T1 ON T1.DocEntry = T0.OrderEntry AND T1.LineNum = T0.OrderLine\t\r\n\t\t\t\t\tAND (T1.U_Qtde_OC = T0.RelQtty OR T1.U_Qtde_OC= T0.PickQtty)\t-- adicionei essa linha dia 20/03\r\n\t\t\t\t\tINNER JOIN OPKL T2 ON T2.ABSENTRY =T0.AbsEntry\r\n\t\t\t\t\tWHERE T0.AbsEntry =  @list_of_cols_val_tab_del AND T0.PickEntry = @Cont4430 \r\n\t\t\t\t\tAND T2.Status \u003c\u003e \u0027C\u0027\t) \r\n\r\n\t\tIF(@QuantidadeOC \u003e 0)\r\n\t\t\tBEGIN\r\n\t\t\t\tIF(\t@RelQtty4430 \u003c\u003e @QuantidadeOC ) \r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -4430\r\n\t\t\t\t\tSET @error_message = \u0027 - A libera‡ao (\u0027+convert(nvarchar,@RelQtty4430  )+\u0027) nao pode ser diferente da quantidade da OC (\u0027+\r\n\t\t\t\t\tconvert(nvarchar,@QuantidadeOC  )+\u0027). Verifique\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\t\r\n\t\t\t\tEND\r\n\t\t\tEND\r\n\r\n\tSET @Cont4430 = @Cont4430 +1\r\n\tEND\r\nEND\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 25/04/2018\r\n-- Update date: 30/04/2022\r\n-- Description:\tTravar Pedido caso o PN tenha Local de Entrega Obrigatorio\r\n-- Documentos:  Pedido de Venda\r\n-- GLPI ID: 4644 Item D\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002717\u0027) and (@transaction_type in (N\u0027A\u0027,N\u0027U\u0027))--\u002717\u0027 = Pedido de Venda \r\nBEGIN\r\nDECLARE @ObrigatorioPV  Char(1)\r\nDECLARE @Filial4644D Numeric = (SELECT BPLId FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\tSET @ObrigatorioPV = (SELECT U_ObrigatorioPV FROM  [@RAL_LOCALENTREGA] WHERE U_BPLId = @Filial4644D AND U_CardCode = \r\n\t\t\t\t\t\t\t(SELECT CardCode FROM ORDR WHERE DocEntry =  @list_of_cols_val_tab_del))\r\n\r\n\tIF(@ObrigatorioPV IS NOT NULL AND @ObrigatorioPV = \u0027Y\u0027)\r\n\tBEGIN\r\n\t\tIF EXISTS(\r\n\t\t\tSELECT U_RAL_LocalEntrega, U_LocalEntregaId,U_LineLocalId FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del AND\r\n\t\t\t( (U_RAL_LocalEntrega is NULL OR  U_RAL_LocalEntrega =\u0027\u0027) AND (U_LocalEntregaId IS NULL OR U_LocalEntregaId =\u0027\u0027)) )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4644\r\n\t\t\t\tSET @error_message = \u0027 obrigat¢rio definir o Local de Entrega para este PN. Verifique.\u0027\r\n\t\t\t\tSELECT @error, @error_message\t\r\n\t\t\tEND\r\n\tEND\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 25/04/2018\r\n-- Update date: 30/04/2022\r\n-- Description:\tTravar Cota‡ao caso o PN tenha Local de Entrega Obrigatorio\r\n-- Documentos:  Cota‡ao de Vendas\r\n-- GLPI ID: 4644 Item D\r\n-- GLPI ID Atualiza‡oes:\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002723\u0027) and (@transaction_type in (N\u0027A\u0027,N\u0027U\u0027))--\u002723\u0027 = Cota‡ao de Vendas\r\nBEGIN\r\n\r\nDECLARE @ObrigatorioPVQ  Char(1)\r\nDECLARE @Filial4644QD Numeric = (SELECT BPLId FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\tSET @ObrigatorioPVQ = (SELECT U_ObrigatorioPV FROM  [@RAL_LOCALENTREGA] WHERE U_BPLId = @Filial4644QD AND U_CardCode = \r\n\t\t\t\t\t\t\t(SELECT CardCode FROM OQUT WHERE DocEntry =  @list_of_cols_val_tab_del))\r\n\r\n\tIF(@ObrigatorioPVQ IS NOT NULL AND @ObrigatorioPVQ = \u0027Y\u0027)\r\n\tBEGIN\r\n\t\tIF EXISTS(\r\n\t\t\tSELECT U_RAL_LocalEntrega, U_LocalEntregaId,U_LineLocalId FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del AND\r\n\t\t\t( (U_RAL_LocalEntrega is NULL OR  U_RAL_LocalEntrega =\u0027\u0027) AND (U_LocalEntregaId IS NULL OR U_LocalEntregaId =\u0027\u0027)) )\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4644\r\n\t\t\t\tSET @error_message = \u0027 obrigat¢rio definir o Local de Entrega para este PN. Verifique.\u0027\r\n\t\t\t\tSELECT @error, @error_message\t\r\n\t\t\tEND\r\n\tEND\r\nEND\r\n-----------------------------------------------------------------------------------------------------------------------\r\n--END\r\n-----------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 12/03/2017\r\n-- Update Date: 29/08/2023\r\n-- Description: Trava solicita‡ao de compras,Pedido de Compra e NF de Entrada \r\n-- Documentos: solicita‡ao de compras e NF de Entrada \r\n-- GLPI ID : 4596\r\n-- GLPI ID Atualiza‡oes:15772\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u00271470000113\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u00271470000113\u0027 = Solicita‡ao de Compra\r\nBEGIN\r\nDECLARE @Linhas4596S Numeric = (SELECT Count(*)FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del) \r\nDECLARE @Cont4596S Numeric = 0\r\nDECLARE @BlpID4596S Numeric = (SELECT BPLId FROM OPRQ WHERE DocEntry = @list_of_cols_val_tab_del) \r\n\r\n--verificar se a filial for jacarei, a trava s¢ ir  atuar na filial jacarei\r\nIF(@BlpID4596S = 2)\r\nBEGIN\r\n\tWHILE(@Cont4596S \u003c @Linhas4596S)\r\n\tBEGIN\r\n\t\tIF EXISTS (SELECT T0.ItemCode,T0.Project ,T1.ItmsGrpCod\r\n\t\t\t\tFROM PRQ1 T0\r\n\t\t\t\tINNER JOIN OITM T1 ON T1.ItemCode = T0.ItemCode\r\n\t\t\t\tWHERE T0.ItemCode LIKE \u0027CG%\u0027 AND (T0.Project IS Null OR T0.Project =\u0027\u0027 )AND\r\n\t\t\t\tT1.ItmsGrpCod IN(164,125,141,127,129,126,128,157,135,136,131,137,133,159,138,\r\n\t\t\t\t130,146,147,174,123,156) AND T0.DocEntry = @list_of_cols_val_tab_del AND T0.LineNum = @Cont4596S)\r\n\t\tBEGIN\r\n\t\r\n\t\t--Se o centro de custo come‡ar com 01 o dep¢sito tem que ser 02.97 \r\n\t\tIF EXISTS (SELECT DocEntry , OcrCode,WhsCode FROM PRQ1 \r\n\t\tWHERE OcrCode LIKE\u002701.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del   AND WhsCode \u003c\u003e \u002702.97\u0027 AND LineNum = @Cont4596S)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.97!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--Se o centro de custo come‡ar com 02 o dep¢sito tem que ser 02.99 \r\n\t\tIF EXISTS (SELECT  DocEntry , OcrCode,WhsCode FROM PRQ1 \r\n\t\tWHERE OcrCode LIKE\u002702.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del   AND WhsCode \u003c\u003e \u002702.99\u0027 AND LineNum = @Cont4596S)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.99!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--Se o centro de custo come‡ar com 03 o dep¢sito tem que ser 02.95 \r\n\t\tIF EXISTS (SELECT DocEntry , OcrCode,WhsCode FROM PRQ1\r\n\t\tWHERE OcrCode LIKE\u002703.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del  AND WhsCode \u003c\u003e \u002702.95\u0027 AND LineNum = @Cont4596S)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.95!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--Se o centro de custo come‡ar com 04 o dep¢sito tem que ser 02.96 \r\n\t\tIF EXISTS (SELECT DocEntry , OcrCode,WhsCode FROM PRQ1 \r\n\t\tWHERE OcrCode LIKE\u002704.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del  AND WhsCode \u003c\u003e \u002702.96\u0027 AND LineNum = @Cont4596S)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.96!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tEND--END IF EXISTS\r\n\t\tSET @Cont4596S = @Cont4596S +1\r\n\tEND --END WHILE\r\n\r\nEND--END IF\r\nEND --END GERAL \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-----------------------------------------------------Nota Fiscal Entrada--------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002718\u0027 = Nota Fiscal Entrada\r\nBEGIN\r\nDECLARE @Linhas4596E Numeric = (SELECT Count(*)FROM PCH1 WHERE DocEntry = @list_of_cols_val_tab_del) \r\nDECLARE @Cont4596E Numeric = 0\r\nDECLARE @BlpID4596E Numeric = (SELECT BPLId FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del) \r\n\r\n--verificar se a filial for jacarei, a trava s¢ ir  atuar na filial jacarei\r\nIF(@BlpID4596E = 2)\r\nBEGIN\r\nWHILE(@Cont4596E \u003c @Linhas4596E)\r\n\tBEGIN\r\n\t\tIF EXISTS (\r\n\t\t\tSELECT T0.ItemCode,T0.Project ,T1.ItmsGrpCod\r\n\t\t\tFROM PCH1 T0\r\n\t\t\tINNER JOIN OITM T1 ON T1.ItemCode = T0.ItemCode\r\n\t\t\tWHERE T0.ItemCode LIKE \u0027CG%\u0027 AND (T0.Project IS Null OR T0.Project =\u0027\u0027 ) AND\r\n\t\t\tT1.ItmsGrpCod IN(164,125,141,127,129,126,128,157,135,136,131,137,133,159,138,\r\n\t\t\t130,146,147,174,123,156) AND T0.DocEntry =  @list_of_cols_val_tab_del AND T0.LineNum = @Cont4596E)\r\n\t\tBEGIN\r\n\t\r\n\t\t--Se o centro de custo come‡ar com 01 o dep¢sito tem que ser 02.97 \r\n\t\tIF EXISTS (SELECT DocEntry , OcrCode,WhsCode FROM PCH1 \r\n\t\tWHERE OcrCode LIKE\u002701.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del  AND WhsCode \u003c\u003e \u002702.97\u0027 AND LineNum = @Cont4596E)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.97!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--Se o centro de custo come‡ar com 02 o dep¢sito tem que ser 02.99 \r\n\t\tIF EXISTS (SELECT  DocEntry , OcrCode,WhsCode FROM PCH1\r\n\t\tWHERE OcrCode LIKE\u002702.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del  AND WhsCode \u003c\u003e \u002702.99\u0027 AND LineNum = @Cont4596E)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.99!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--Se o centro de custo come‡ar com 03 o dep¢sito tem que ser 02.95 \r\n\t\tIF EXISTS (SELECT DocEntry , OcrCode,WhsCode FROM PCH1 \r\n\t\tWHERE OcrCode LIKE\u002703.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del  AND WhsCode \u003c\u003e \u002702.95\u0027 AND LineNum = @Cont4596E)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.95!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--Se o centro de custo come‡ar com 04 o dep¢sito tem que ser 02.96 \r\n\t\tIF EXISTS (SELECT DocEntry , OcrCode,WhsCode FROM PCH1\r\n\t\tWHERE OcrCode LIKE\u002704.%\u0027 AND DocEntry =  @list_of_cols_val_tab_del  AND WhsCode \u003c\u003e \u002702.96\u0027 AND LineNum = @Cont4596E)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -4596\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.96!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\t\tEND--END IF EXISTS\r\n\t\tSET @Cont4596E = @Cont4596E +1\r\n\tEND --END WHILE\r\nEND--END IF\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts \r\n-- Create date: 07/03/2018\r\n-- Update date: 19/03/2018\r\n-- Description:\tApagar quantidade OC pedido de venda quando adicionar nota fiscal de sa¡da (vinculada ao pedido).\r\n-- Documentos: Nota fiscal\r\n-- GLPI ID: 4661\r\n-----------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002713\u0027) and (@transaction_type in (N\u0027A\u0027,N\u0027U\u0027))--\u002713\u0027 = Nota Fiscal \r\nBEGIN\r\n\r\nDECLARE @LinhasNF Numeric = 0\r\nDECLARE @BaseLineNF Numeric = 0\r\nDECLARE @Cont4661 Numeric = 0\r\nDECLARE @CANCEL4661 CHAR(1) SET @CANCEL4661 = (SELECT CANCELED FROM OINV WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @NumeroPedido Numeric =0 \r\nDECLARE @U_Qtde_OC Numeric = 0\r\nDECLARE @U_OC_num  Numeric = 0\r\nDECLARE @U_dtPrevEntregaInicial Datetime \r\nDECLARE @U_dtPrevEntregaFinal Datetime\r\nDECLARE @U_STATUS NVARCHAR (255)\r\n\r\nSET @LinhasNF =  (SELECT MAX(LineNum)FROM INV1  WHERE DocEntry = 26153 )\r\n\tWHILE(@Cont4661 \u003c  @LinhasNF+1) -- percorrendo todas as linhas 26018\r\n\tBEGIN\t\r\n\t\t\r\n\t\t\tIF((SELECT U_qtde_OC FROM INV1 WHERE DocEntry =@list_of_cols_val_tab_del  AND LineNum = @Cont4661) IS NOT NUll AND \r\n\t\t\t\t(SELECT U_qtde_OC FROM INV1 WHERE DocEntry =@list_of_cols_val_tab_del  AND LineNum = @Cont4661) \u003e 0)\r\n\t\t\tBEGIN\r\n\r\n\t\t\t\tSET @NumeroPedido = (SELECT dbo.DocEntryPedido(@list_of_cols_val_tab_del, @Cont4661) )\r\n\r\n\t\t\t\tIF((SELECT baseType FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum = @Cont4661 ) = 15)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @BaseLineNF = (SELECT BaseLine FROM DLN1 WHERE DocEntry = (\r\n\t\t\t\t\tSELECT BaseRef FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\t\tAND LineNum = (SELECT BaseLine FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661))\r\n\t\t\t\tEND\r\n\t\t\t\tELSE IF((SELECT baseType FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661 ) = 17)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @BaseLineNF = (SELECT BaseLine FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\tEND\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tIF(@CANCEL4661 = \u0027Y\u0027)\r\n\t\t\t\tBEGIN \t\t\r\n\t\t\t\t\r\n\t\t\t\t\tSET @U_Qtde_OC = (SELECT U_qtde_OC FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\t\tSET @U_OC_num  = (SELECT U_OC_num FROM INV1 WHERE DocEntry  = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\t\tSET @U_dtPrevEntregaInicial =  (SELECT U_dtPrevEntregaInicial FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\t\tSET @U_dtPrevEntregaFinal = (SELECT U_dtPrevEntregaFinal FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\t\tSET @U_STATUS = (SELECT U_Status FROM INV1 WHERE DocEntry = @list_of_cols_val_tab_del  AND LineNum = @Cont4661)\r\n\t\t\t\t\tUPDATE  RDR1 SET U_Qtde_OC = @U_Qtde_OC, U_OC_num = @U_OC_num , \r\n\t\t\t\t\t\tU_dtPrevEntregaInicial = @U_dtPrevEntregaInicial, U_dtPrevEntregaFinal = @U_dtPrevEntregaFinal,\r\n\t\t\t\t\t\tU_Status = @U_STATUS\r\n\t\t\t\t\t\tWHERE DocEntry = @NumeroPedido AND LineNum = @BaseLineNF\r\n\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\tBEGIN\t\r\n\t\t\t\t\tUPDATE  RDR1 SET U_Qtde_OC = null, U_OC_num = null , \r\n\t\t\t\t\tU_dtPrevEntregaInicial = null, U_dtPrevEntregaFinal = null , U_Status= null\r\n\t\t\t\t\tWHERE DocEntry = @NumeroPedido AND LineNum = @BaseLineNF\r\n\t\t\t\tEND \r\n\t\t\tEND\r\n\t\t\t\r\n\t\tSET @Cont4661 = @Cont4661 +1\r\n\tEND\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 26/02/2017\r\n-- Update Date: \r\n-- Description: Travar entrega com pedidos diferentes nas linhas\r\n-- Documentos: ENTREGA\r\n-- GLPI ID : 4738\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027A\u0027))--\u002715\u0027 = entrega\r\nBEGIN\r\n\tIF((SELECT  Count(distinct BaseEntry) FROM DLN1 WHERE DocEntry =  @list_of_cols_val_tab_del) \u003e1)\r\n\tBEGIN\r\n\t\tSET @error = -4738\r\n\t\tSET @error_message = \u0027Nao ‚ poss¡vel adicionar o documento pois uma ou mais linhas estao relacionadas a Pedidos de Venda diferentes.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 12/03/2017\r\n-- Update Date: \r\n-- Description: Limpar dados OC ao adicionar pedido\r\n-- Documentos: Pedido de Vendas\r\n-- GLPI ID : 4732\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\t\r\n\tIF Exists (\r\n\t\tSELECT U_OC_num,U_dtPrevEntregaInicial,U_dtPrevEntregaFinal,U_Status,U_Qtde_OC\r\n\t\tFROM RDR1 T1\r\n\t\tWHERE (U_OC_num IS NOT NULL OR U_dtPrevEntregaInicial IS NOT NULL OR\r\n\t\tU_dtPrevEntregaFinal IS NOT NULL OR U_Status IS NOT NULL OR U_Qtde_OC IS NOT NULL)\r\n\t\tAND DocEntry = @list_of_cols_val_tab_del)\r\n\tBEGIN\r\n\t\tUPDATE RDR1 SET U_OC_num = NULL, U_dtPrevEntregaInicial =NULL,U_dtPrevEntregaFinal = NULL,U_Status = NULL,U_Qtde_OC = NULL\r\n\t\tWHERE DocEntry = @list_of_cols_val_tab_del;\r\n\tEND\r\n\r\n\t--IF Exists(SELECT header, U_RAL_LocalEntrega FROM ORDR \r\n\t--\tWHERE DocEntry = @list_of_cols_val_tab_del AND (header IS NOT NULL OR U_RAL_LocalEntrega IS NOT NULL ))\r\n\t--BEGIN\r\n\t--\tUPDATE ORDR Set --header = null, \r\n\t--\tU_RAL_LocalEntrega = null WHERE  DocEntry = @list_of_cols_val_tab_del;\r\n\t--END\r\n\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 17/11/2017\r\n-- Update Date: 16/02/2018\r\n-- Description: ESBO€O - TRAVA DE MODELO E CHAVE DE ACESSO NF ENTRADA, DEVOLU€AO E DEV DE NF DE SAIDA - Chamado 3811 \r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027))--N\u0027112\u0027 = ESBO€O\r\nBEGIN\r\nDECLARE @EModel int\r\nDECLARE @EChaveAcesso NVARCHAR(100)\r\nDECLARE @ESqCode int = 0\r\nDECLARE @ESObjType int = 0\r\nSET @ESObjType = (SELECT ObjType FROM ODRF WHERE DocEntry = @list_of_cols_val_tab_del )\r\n------DEVOLU€AO DE NOTA FISCAL DE SAIDA----------------------------------------------------------------\r\n\tIF(@ESObjType = 14)\r\n\tBEGIN\r\n\tSET @ESqCode = (SELECT SeqCode FROM ODRF WHERE ObjType = 14 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\r\n\t\tIF(-2 = @ESqCode)\r\n\t\tBEGIN\r\n\t\t\tSET @EModel = (SELECT Model FROM ODRF WHERE ObjType = 14 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\tIF(@EModel = 0)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o modelo da NF!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF\r\n\t\t\tELSE IF (@EModel = 39 OR @EModel = 44)--NFE e Modelo CTe\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @EChaveAcesso = (SELECT U_chaveacesso FROM ODRF WHERE ObjType = 14 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\t\tIF (@EChaveAcesso IS NULL OR len(@EChaveAcesso)\u003c\u003e44 )\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027Chave de Acesso incorreta!\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND--END ELSE\r\n\t\t\tEND\r\n\t\tEND\r\n\tEND\t\r\n\t\r\n\r\n------DEVOLU€AO----------------------------------------------------------------------------------------\r\n\tIF(@ESObjType = 16)--\u002716\u0027 = DEVOLU€AO\r\n\tBEGIN\r\n\tSET @ESqCode = (SELECT SeqCode FROM ODRF WHERE ObjType = 16 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\tIF(-2 = @ESqCode)\r\n\t\tBEGIN\r\n\t\t\tSET @EModel = (SELECT Model FROM ODRF WHERE ObjType = 16 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\tIF(@EModel = 0)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o modelo da NF!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF\r\n\t\t\tELSE IF (@EModel = 39 OR @EModel = 44)--NFE e Modelo CTe\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @EChaveAcesso = (SELECT U_chaveacesso FROM ODRF WHERE ObjType = 16 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\t\tIF (@EChaveAcesso IS NULL OR len(@EChaveAcesso)\u003c\u003e44 )\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027Chave de Acesso incorreta!\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND--END ELSE\r\n\t\tEND -- IF SEQ CODE\r\n\tEND\r\n-----NF ENTRADA ---------------------------------------------------------------------------------------------------------------\r\n\tIF(@ESObjType = 18)--\u002718\u0027 = NF ENTRADA\r\n\tBEGIN\r\n\tSET @ESqCode = (SELECT SeqCode FROM ODRF WHERE ObjType = 18 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\tIF(-2 = @ESqCode)\r\n\t\tBEGIN\r\n\t\tSET @EModel = (SELECT Model FROM ODRF WHERE ObjType = 18 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\tIF(@EModel = 0)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio preencher o modelo da NF!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND--END IF\r\n\t\t\tELSE IF (@EModel = 39 OR @EModel = 44 OR @EModel = 45)--NFE e Modelo CTe\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @EChaveAcesso = (SELECT U_chaveacesso FROM ODRF WHERE ObjType = 18 AND DocEntry = @list_of_cols_val_tab_del )\r\n\t\t\t\tIF (@EChaveAcesso IS NULL OR len(@EChaveAcesso)\u003c\u003e44 )\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027Chave de Acesso incorreta!\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND--END ELSE\r\n\tEND\r\nEND;\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 05/02/2018\r\n-- Update Date: 26/07/2023\r\n-- Description: Nao permitir utiliza‡oes diferentes na mesma entrega\r\n-- Documentos: Entrega\r\n-- GLPI ID:4454\r\n-- GLPI ID atualiza‡ao:15618 - por conta da venda de macarrao, que possui cfop diferente, precisamos\r\n-- ajustar a trava para passar a preencher os cfops concatenados de ambas opera‡oes\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027A\u0027))--\u002715\u0027 = ENTREGA\r\nBEGIN\r\n\t\tIF((SELECT COUNT(*)FROM(SELECT DocEntry FROM DLN1 WHERE DocEntry = @list_of_cols_val_tab_del GROUP BY Usage,DocEntry)A) \u003e 1)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -4454\r\n\t\t\tSET @error_message = \u0027Nao ‚ permitido utiliza‡oes diferentes na mesma entrega.Verifique.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tELSE\r\n\t\tBEGIN\r\n\t\t\t --UPDATE ODLN SET U_MW_CFOP = (SELECT Descrip FROM OCFP WHERE Code =\r\n\t\t\t\t--(SELECT CFOPCode FROM DLN1 WHERE DocEntry = @list_of_cols_val_tab_del GROUP BY CFOPCode) ) \r\n\t\t\t\t--WHERE DocEntry = @list_of_cols_val_tab_del\r\n\r\n\t\tUPDATE ODLN SET U_MW_CFOP = ( \r\n             SELECT STUFF((SELECT \u0027,\u0027 + CONVERT(nvarchar(max),Descrip) \r\n\t\t\t FROM OCFP WHERE Code in(SELECT CFOPCode FROM DLN1 \r\n\t\t\t\t\t\t\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del GROUP BY CFOPCode)\r\n\t\t\t\tFOR XML PATH(\u0027\u0027)), 1, 1, \u0027\u0027)\r\n\t\t\t\t ) \r\n\t\t\t\tWHERE DocEntry = @list_of_cols_val_tab_del\r\n\t\tEND\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:Henrique Truyts\r\n-- Create date: 22/01/2018\r\n-- Update Date: 30-04-2022\r\n-- Description: Valida‡ao de Peso Maximo\r\n-- Documento: Pedido de Vendas\r\n-- GLPI ID:4102\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = PEDIDO DE VENDA\r\nBEGIN\r\n\tDECLARE @TotalLinhas4102 NUMERIC = (SELECT COUNT(*) FROM RDR1 WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\tDECLARE @Contador4102 NUMERIC = 0\r\n\tDECLARE @Peso4102 NUMERIC  = 0\t\r\n\tDECLARE @NumeroFilial Numeric = (SELECT BPLId FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\tDECLARE @PesoMaximo NUMERIC = (SELECT MAX(U_Capacidade_Max) FROM [@BIM_TPO_VEICULO] WHERE U_BPLId = @NumeroFilial  AND U_Prioridade =1)\r\n\r\n\tWHILE(@Contador4102 \u003c @TotalLinhas4102)\r\n\t\tBEGIN\r\n\t\tSET @Peso4102 = (SELECT Weight1 FROM RDR1 WHERE VisOrder = @Contador4102 AND  DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\t\tIF((SELECT dbo.PesoLinhaPedido(@Peso4102,@NumeroFilial)) = 1)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -4102\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ poss¡vel adicionar ou atualizar. O peso de uma ou mais linhas ultrapassa a capacidade m xima de cargas da log¡stica, que ‚ de \u0027\r\n\t\t\t\t+CONVERT(NVARCHAR, (SELECT dbo.PesoMaximo(@PesoMaximo,@NumeroFilial)))+  \u0027KG . Crie mais linhas no PV para redistribuir as quantidades!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tSET @Contador4102 = @Contador4102 +1\r\n\t\tEND\r\nEND;--END GERAL\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 04/01/2018\r\n-- Update Date: \r\n-- Description:\tTrava de Dep¢sito por utiliza‡ao\r\n-- Documentos: Devolu‡ao de Mercadorias, ENTREGA\r\n-- GLPI ID:4222\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @Usage4222 NUMERIC \r\nDECLARE @Linhas4222 NUMERIC =0\r\nDECLARE @Cont4222 NUMERIC = 0\r\nDECLARE @Deposito4222 Nvarchar(255)\r\nIF (@object_type = \u002721\u0027) and (@transaction_type in (\u0027A\u0027))--\u002721\u0027 = Dev de mercadoria\r\nBEGIN\r\n\tSET @Linhas4222 =  (SELECT MAX(LineNum)FROM RPD1 WHERE DocEntry =  @list_of_cols_val_tab_del )\r\n\tWHILE(@Cont4222 \u003c  @Linhas4222+1) -- percorrendo todas as linhas\r\n\tBEGIN\r\n\t\tSET @Usage4222 = ( SELECT Usage FROM RPD1 WHERE LineNum = @Cont4222 AND DocEntry = @list_of_cols_val_tab_del)\r\n\t\tSET @Deposito4222 = (SELECT WhsCode FROM RPD1 WHERE LineNum = @Cont4222 AND DocEntry = @list_of_cols_val_tab_del)\r\n\t\t--7 = REM INDUST ENCOME | 15 = REM CONSERTO | 39 = OUTRAS ENTRADAS\r\n\t\tIF((@Usage4222 = 7 OR @Usage4222 = 15 OR @Usage4222 = 39 ) AND @Deposito4222 \u003c\u003e \u002702.99\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.99 para as utiliza‡oes REM INDUST ENCOME,REM CONSERTO e OUTRAS ENTRADAS!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tSET @Cont4222 = @Cont4222 +1\r\n\tEND\r\n\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n---ALTERADO NA DATA DE 22/12/2025 ACRESCENTADO NULLIF PARA TRATAR CAMPOS VAZIOS E NAO NULOS\r\nIF (@object_type = \u002715\u0027) AND (@transaction_type IN (\u0027A\u0027,\u0027U\u0027))--\u002715\u0027 = entrega\r\nBEGIN\r\nSET @Cont4222 = 0\r\nSET @Linhas4222  = (SELECT MAX(LineNum)FROM DLN1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @U_SKILL_cEnq NUMERIC = 0\r\nSET @Deposito4222 = null\r\n\r\n\t\tWHILE(@Cont4222 \u003c  @Linhas4222+1) -- percorrendo todas as linhas\r\n\t\tBEGIN\r\n\t\t\tSET @Usage4222 = ( SELECT Usage FROM DLN1 WHERE LineNum = @Cont4222 AND DocEntry = @list_of_cols_val_tab_del)\r\n\t\t\tSET @Deposito4222 = (SELECT WhsCode FROM DLN1 WHERE LineNum = @Cont4222 AND DocEntry = @list_of_cols_val_tab_del)\r\n\t\t\tSET @U_SKILL_cEnq = (SELECT NULLIF(U_SKILL_cEnq,0) FROM DLN1 WHERE LineNum = @Cont4222 AND DocEntry = @list_of_cols_val_tab_del)\r\n\t\t\t----16 = REM ARMAZANAGEM\r\n\t\t\tIF(@Usage4222 = 16)\r\n\t\t\tBEGIN\r\n\t\t\t\tIF(\u002702.99\u0027 \u003c\u003e @Deposito4222 )\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.99 para a utiliza‡ao REM ARMAZENAGEM e C¢d de Enquadramento de IPI - 103\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\t\tIF(@U_SKILL_cEnq IS NULL OR @U_SKILL_cEnq \u003c\u003e 103)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.99 para a utiliza‡ao REM ARMAZENAGEM e C¢d de Enquadramento de IPI - 103\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\tEND\r\n\t\t----11 = REM Vazilh Saca\r\n\t\tIF(@Usage4222 = 11  AND @Deposito4222 \u003c\u003e \u002702.99\u0027 )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio dep¢sito 02.99 para a utiliza‡ao REM VASILH SACARIA!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tSET @Cont4222 = @Cont4222 + 1\r\n\t\tEND\t \r\nEND\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 14/12/2017\r\n-- Update Date: \r\n-- Description: TRAVA DE DEPOSITO NF TRANSBORDO\r\n-- Documents: RECEBIMENTOS DE MERCADORIAS\r\n--GLPI ID:4168\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002720\u0027) and (@transaction_type in (\u0027A\u0027))--\u002720\u0027 = recebimento de mercadorias\r\nBEGIN\r\nDECLARE @Linhas4168 int set @Linhas4168 = (SELECT MAX(LineNum)FROM INV1  WHERE DOCENTRY = @list_of_cols_val_tab_del)\r\nDECLARE @Cont4168 int = 0\r\nDECLARE @Deposito4168 Nvarchar(255)\r\nDECLARE @Util4168 Nvarchar (255)\r\n\r\nWHILE(@Cont4168 \u003c  @Linhas4168+1) -- percorrendo todas as linhas da nf\r\n  BEGIN\r\n  \r\n   SET @Deposito4168 = (SELECT WhsCode FROM PDN1 WHERE LineNum = @Cont4168 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @Util4168 = (SELECT Usage FROM PDN1 WHERE LineNum = @Cont4168 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n\r\n\t\t--USAGE = NF transbordo\r\n\t\tIF( \u002702.99\u0027 != @Deposito4168 AND @Util4168 = 49)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027NF de Transbordo - utilizar dep¢sito 02.99\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t--USAGE NF FILHA\r\n\t\tIF( \u002702.02\u0027 != @Deposito4168 AND @Util4168 = 40)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027NF Filha - utilizar dep¢sito 02.02\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\tSet @Cont4168=  @Cont4168 + 1\r\n  END--END while\r\nEND; -- END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author: Henrique Truyts\r\n-- Create date: 14/12/2017\r\n-- Update Date: \r\n-- Description:\tPreencher os campos Data Entrada/Sa¡da e Hora Entrada e Sa¡da NF-e\r\n-- Documentos: ENTREGA; DEVOLU€AO; NF DE SAIDA; DEVOLU€AO DE NF DE SAIDA; \r\n-- RECEBIMENTO DE MERCADORIAS; DEVOLU€AO DE MERCADORIAS; NF DE ENTRADA; DEVOLU€AO DE NF DE ENTRADA; NF RECEBIMENTO FUTURO; \r\n-- GLPI ID: 3528\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @SeqCode3825 int = 0\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002715\u0027 = ENTREGA - ODLN\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM ODLN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE ODLN SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002716\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002716\u0027 =  DEVOLU€AO - ORDN\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM ORDN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE ORDN SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002713\u0027 =  NF DE SAIDA - OINV\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM OINV WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE OINV SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002714\u0027 =  DEVOLU€AO DE NF DE SAIDA - ORIN\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM ORIN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE ORIN SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002720\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002720\u0027 = RECEBIMENTO DE MERCADORIAS - OPDN\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM OPDN WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE OPDN SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002721\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002721\u0027 =  DEVOLU€AO DE MERCADORIAS - ORPD\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM ORPD WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE ORPD SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002718\u0027 =  NF DE ENTRADA E  NF RECEBIMENTO FUTURO - OPCH\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM OPCH WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE OPCH SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\nIF (@object_type = \u002719\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002719\u0027 =  DEVOLU€AO DE NF DE ENTRADA - ORPC\r\nBEGIN\r\n\tSET @SeqCode3825 = (SELECT SeqCode FROM ORPC WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\r\n\tIF(@SeqCode3825 =29 OR @SeqCode3825 =28 OR @SeqCode3825 = 27 OR @SeqCode3825 = 44) -- NFE_ENT,NFE_IMP,NFE,NFENT_RJ\r\n\tBEGIN \r\n\t\tUPDATE ORPC SET U_SKILL_DtSaida = SMALLDATETIMEFROMPARTS(DATEPART(YEAR,GETDATE()),DATEPART(MONTH,GETDATE()),DATEPART(DAY,GETDATE()),0,0), \r\n\t\tU_SKILL_HrSaida= ((DATEPART(HOUR,GETDATE()) *100)+ DATEPART(MINUTE,GETDATE())) WHERE DocEntry = @list_of_cols_val_tab_del\r\n\tEND\r\nEND;--END GERAL\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 04/07/2017\r\n-- Update Date: 11/12/2017\r\n-- Description:\tTrava para Clientes Bloqueados (caracteristica 24)\r\n-- Documents: Pedido de Vendas e Cota‡ao de vendas\r\n-- GLPI ID: 4129 (OBS esse nao ‚ o chamado que deu origem … essa valida‡ao)\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas (DepCB = departamentos Clientes Bloqueados\r\nBEGIN\r\n\r\nDECLARE @DepCB int SET @DepCB = (SELECT u.Department From ORDR O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n IF(@DepCB = 1)\t\r\n\tBEGIN\r\n\t\tIF  EXISTS (\r\n\t\tSELECT\r\n\t\tt0.QryGroup25,T0.CardCode\r\n\t\tFROM OCRD T0\r\n\t\tWHERE T0.QryGroup25 = \u0027N\u0027 AND T0.QryGroup24 = \u0027Y\u0027 \r\n\t\tAND T0.CardCode  = ( SELECT CardCode FROM ORDR WHERE DocNum =  @list_of_cols_val_tab_del )\r\n\t\t\r\n\t\t) BEGIN\t\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ poss¡vel adicionar o Pedido. Entrar em contato com o setor de Cr‚dito e Cobran‡a ou Adm. de Vendas!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t  END;\r\n\t\r\n\tEND;\r\nEND;--END PRINCIPAL\r\n-------------------------COTA€AO DE VENDAS--------------------------------------------------------------------------------------\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002723\u0027 = Cota‡ao de Vendas (DepCB = departamentos Clientes Bloqueados\r\nBEGIN\r\n\r\nDECLARE @DepCBQ int SET @DepCBQ = (SELECT u.Department From OQUT O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n IF(@DepCBQ = 1)\t\r\n\tBEGIN\r\n\t\tIF  EXISTS (\r\n\t\tSELECT\r\n\t\tt0.QryGroup25,T0.CardCode\r\n\t\tFROM OCRD T0\r\n\t\tWHERE T0.QryGroup25 = \u0027N\u0027 AND T0.QryGroup24 = \u0027Y\u0027 \r\n\t\tAND T0.CardCode  = ( SELECT CardCode FROM OQUT WHERE DocEntry =  @list_of_cols_val_tab_del )\r\n\t\t\r\n\t\t) BEGIN\t\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ poss¡vel adicionar a Cota‡ao. Entrar em contato com o setor de Cr‚dito e Cobran‡a ou Adm. de Vendas!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t  END;\r\n\t\r\n\tEND;\r\nEND;--END PRINCIPAL\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 17/11/2017\r\n-- Update Date: \r\n-- Description:\tPreencher o campo Grupo de Itens na linha da solicita‡ao, para que apare‡a o grupo de itens no relatorio\r\n-- de solicita‡ao de compras - chamado ID 3991\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u00271470000113\u0027) and (@transaction_type in (\u0027A\u0027))--\u00271470000113\u0027 = Solicita‡ao de Compra\r\nBEGIN\r\nDECLARE @QtdLinhasSol INT SET @QtdLinhasSol = (SELECT Count(*) FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del )\r\nDECLARE @ContadorSol INT = 0\r\nDECLARE @GrupoItens INT = 0\r\n\r\n\tWHILE(@ContadorSol \u003c @QtdLinhasSol)\r\n\tBEGIN\r\n\t\tSET @GrupoItens = (SELECT U_RAL_GrupoItens FROM OITM WHERE ItemCode = \r\n\t\t\t\t\t\t\t(SELECT ItemCode FROM PRQ1 WHERE DocEntry = @list_of_cols_val_tab_del AND VisOrder = @ContadorSol))\r\n\t\tIF(@GrupoItens is not null OR @GrupoItens \u003e 0)\r\n\t\tBEGIN\r\n\t\t\tUPDATE PRQ1 SET U_RAL_GrupoItens = @GrupoItens WHERE DocEntry = @list_of_cols_val_tab_del AND VisOrder = @ContadorSol\r\n\t\tEND--END IF\r\n\tSET @ContadorSol = @ContadorSol + 1\r\n\tEND--END WHILE\r\nEND;--END GERAL\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 20/11/2017\r\n-- Update Date: \r\n-- Description:\tTRAVA DE CODIGO DE IMPOSTO E CFOP - ESBO€O ADIANTAMENTOS - ID 3805\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--N\u0027112\u0027 = ESBO€O\r\nBEGIN\r\nDECLARE @ESAdObjType int = 0\r\nSET @ESAdObjType = (SELECT ObjType FROM ODRF WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n--ADIANTAMENTO FORNECEDOR\r\n\tIF (@ESAdObjType = 204)--\u0027204\u0027 = ADIANTAMENTO DE FORNECEDOR\r\n\tBEGIN\r\n\r\n\t\tIF NOT EXISTS( SELECT   T1.TaxCode FROM DRF1 T1\tWHERE (T1.TaxCode IS NOT NULL AND T1.TaxCode\u003c\u003e\u0027\u0027 ) AND T1.DocEntry = @list_of_cols_val_tab_del )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio colocar o C¢digo de Imposto!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\r\n\t\tIF NOT EXISTS( SELECT  T1.CFOPCode FROM DRF1 T1 WHERE  ( T1.CFOPCode IS NOT NULL AND  T1.CFOPCode \u003c\u003e \u0027\u0027) AND T1.DocEntry = @list_of_cols_val_tab_del )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio colocar o CFOP!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND;\r\n\r\n--ADIANTAMENTO CLIENTE\r\n\tIF (@ESAdObjType =  \u0027203\u0027) --\u0027203\u0027 = ADIANTAMENTO DE CLIENTE\r\n\tBEGIN\r\n\r\n\t\tIF NOT EXISTS( SELECT   T1.TaxCode FROM DRF1 T1\tWHERE (T1.TaxCode IS NOT NULL AND T1.TaxCode\u003c\u003e\u0027\u0027 ) AND T1.DocEntry = @list_of_cols_val_tab_del )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio colocar o C¢digo de Imposto!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF NOT EXISTS( SELECT  T1.CFOPCode FROM DRF1 T1 WHERE ( T1.CFOPCode IS NOT NULL AND  T1.CFOPCode \u003c\u003e \u0027\u0027) AND T1.DocEntry =  @list_of_cols_val_tab_del )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio colocar o CFOP!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND;\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 24/10/2017\r\n-- Update Date: 09/11/2017\r\n-- Description:\tTRAVA DE DOCUMENTO REFERENCIADO - ID 3649\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @Usage int \r\nDECLARE @RefDocEntr int \r\nDECLARE @SeqCodes int\r\n\r\n--TRANSBORDO - RECEBIMENTO DE MERCADORIA\r\nIF (@object_type = \u002720\u0027) and (@transaction_type in (\u0027A\u0027))--\u002720\u0027 = RECEBIMENTO DE MERCADORIA\r\nBEGIN\r\nSET @Usage = (SELECT Distinct USAGE FROM PDN1 WHERE USAGE = 49 AND DocEntry = @list_of_cols_val_tab_del )\r\nSET @RefDocEntr =\r\n\t(SELECT\tCOUNT(T2.RefDocEntr) FROM  OPDN T0 \r\n\t\tINNER JOIN PDN1 T1 ON T1.DocEntry = T0.DocEntry\r\n\t\tINNER JOIN PDN21 T2 ON T2.DocEntry = T0.DocEntry\r\n\t\tWHERE T1.Usage = 49 AND T0.DocEntry = @list_of_cols_val_tab_del)\r\n-- usage Transbordo\r\nIF (49 = @Usage)\r\nBEGIN\r\n\tIF(@RefDocEntr \u003c 1)\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Obrigat¢rio colocar a referˆncia do pedido de compras!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND\r\nEND;\r\n--FRETE DE COMPRAS - NF ENTRADA\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027))--\u002718\u0027 = Nota Fiscal de Entrada\r\nBEGIN\r\nDECLARE @CG02043 Bit SET @CG02043 = (SELECT DISTINCT  CASE WHEN itemCode = \u0027CG02043\u0027 THEN 1 ElSE 0 END FROM PCH1 WHERE DocEntry = @list_of_cols_val_tab_del)\r\nSET @RefDocEntr = (\r\n\tSELECT\tCOUNT(T2.RefDocEntr) FROM  OPCH T0 \r\n\t\tINNER JOIN PCH1 T1 ON T1.DocEntry = T0.DocEntry\r\n\t\tINNER JOIN PCH21 T2 ON T2.DocEntry = T0.DocEntry\r\n\t\tWHERE T1.itemCode = \u0027CG02043\u0027 AND T0.DocEntry = @list_of_cols_val_tab_del\r\n)\r\n\r\nIF (1 = @CG02043)\r\nBEGIN\r\n\tIF(@RefDocEntr \u003c 1)\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Obrigat¢rio colocar a referˆncia da NF de origem!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND\r\nEND;\r\n\r\n--NOTAS COMPLEMENTARES - NF DE ENTRADA\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027))--\u002718\u0027 = Nota Fiscal de Entrada\r\nBEGIN\r\nSET @Usage = (SELECT Distinct USAGE FROM PCH1 WHERE USAGE = 51 AND DocEntry =  @list_of_cols_val_tab_del)\r\n\r\nSET @RefDocEntr = (\r\nSELECT\tCOUNT(DISTINCT T2.RefDocEntr) FROM  OPCH T0 \r\n\t\tINNER JOIN PCH1 T1 ON T1.DocEntry = T0.DocEntry\r\n\t\tINNER JOIN PCH21 T2 ON T2.DocEntry = T0.DocEntry\r\n\t\tWHERE T1.usage = 51 AND T0.DocEntry = @list_of_cols_val_tab_del\r\n)\r\n--usage compra complementar\r\n\tIF (51 = @Usage)\r\n\tBEGIN\r\n\t\tIF(@RefDocEntr \u003c 2)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Obrigat¢rio colocar a referˆncia do Pedido e NF de origem!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\t\t\r\n\tEND\r\nEND;\r\n\r\n--Devolu‡ao de Nota Fiscal de Entrada\r\nIF (@object_type = \u002719\u0027) and (@transaction_type in (\u0027A\u0027))--\u002719\u0027 = Devolu‡ao de Nota Fiscal de Entrada\r\nBEGIN\r\n\tSET @Usage = (\tSELECT CASE WHEN\t(SELECT Distinct USAGE FROM RPC1 WHERE USAGE = 22 AND DocEntry =   @list_of_cols_val_tab_del ) is  null then \r\n\t\t\t\t\t0 else (SELECT Distinct USAGE FROM RPC1 WHERE USAGE = 22 AND  DocEntry =   @list_of_cols_val_tab_del) end  )\r\n\tSET @SeqCodes = (SELECT DISTINCT SeqCode FROM ORPC WHERE DocEntry = @list_of_cols_val_tab_del)\r\n\t\r\n\t\r\n\tSET @RefDocEntr = (\r\n\t\tSELECT\tCOUNT(DISTINCT T2.RefDocEntr) FROM  ORPC T0 \r\n\t\t\tINNER JOIN RPC1 T1 ON T1.DocEntry = T0.DocEntry\r\n\t\t\tINNER JOIN RPC21 T2 ON T2.DocEntry = T0.DocEntry\r\n\t\t\tWHERE  T0.DocEntry = @list_of_cols_val_tab_del)\r\n\r\n-- usage BAIXA ESTOQUE nao deve passar pela valida‡ao\r\n\tIF(@Usage \u003c\u003e 22 )\r\n\tBEGIN\r\n\t\tIF(@SeqCodes = 27 )\r\n\t\tBEGIN\r\n\t\t\tIF(@RefDocEntr \u003c 2)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Obrigat¢rio colocar a referˆncia do Pedido e NF de origem!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\t\t\r\n\t\tEND\r\n\tEND\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 25/10/2017\r\n-- Update Date: \r\n-- Description: TRAVA DE DEPOSITO PARA UTILIZA€AO DOA€AO NF DE SAIDA\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027))--\u002713\u0027 = Nota Fiscal de sa¡da\r\nBEGIN\r\nDECLARE @LLinhas int set @LLinhas = (SELECT MAX(LineNum)FROM INV1  WHERE DOCENTRY = @list_of_cols_val_tab_del)\r\nDECLARE @CCont1 int = 0\r\nDECLARE @DDeposito Nvarchar(255)\r\nDECLARE @UUtil Nvarchar (255)\r\n\r\nWHILE(@CCont1 \u003c  @LLinhas+1) -- percorrendo todas as linhas da nf\r\n  BEGIN\r\n  \r\n   SET @DDeposito = (SELECT WhsCode FROM INV1 WHERE LineNum = @CCont1 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @UUtil = (SELECT Usage FROM INV1 WHERE LineNum = @CCont1 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n\r\n\r\n\t\tIF( \u002702.19\u0027 != @DDeposito AND @UUtil = 52)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Para utiliza‡ao DOA€AO/SAC o dep¢sito deve ser 02.19\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\tSet @CCont1=  @CCont1 + 1\r\n  END--END while\r\nEND; -- END GERAL\r\n----PEDIDO DE VENDA\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Nota Fiscal de sa¡da\r\nBEGIN\r\nset @LLinhas = (SELECT MAX(LineNum)FROM rdr1  WHERE DOCENTRY = @list_of_cols_val_tab_del)\r\nSet @CCont1 = 0\r\n\r\nWHILE(@CCont1 \u003c  @LLinhas+1) -- percorrendo todas as linhas da nf\r\n  BEGIN\r\n  \r\n   SET @DDeposito = (SELECT WhsCode FROM rdr1 WHERE LineNum = @CCont1 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n   SET @UUtil = (SELECT Usage FROM rdr1 WHERE LineNum = @CCont1 AND DocEntry = @list_of_cols_val_tab_del)-- pegando deposito de cada linha\r\n\r\n\r\n\t\tIF( \u002702.19\u0027 != @DDeposito AND @UUtil = 52)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo dep¢sito nas linhas de cada item deve ser = 02.19!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\tSet @CCont1=  @CCont1 + 1\r\n  END--END while\r\nEND; -- END GERAL\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 24/10/2017\r\n-- Update Date: \r\n-- Description:\tTRAVA DE CODIGO DE IMPOSTO E CFOP - ADIANTAMENTOS - ID 3805\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--ADIANTAMENTO FORNECEDOR\r\nIF (@object_type = \u0027204\u0027) and (@transaction_type in (\u0027A\u0027))--\u0027204\u0027 = ADIANTAMENTO DE FORNECEDOR\r\nBEGIN\r\n\r\n\tIF NOT EXISTS( SELECT   T1.TaxCode FROM DPO1 T1\tWHERE (T1.TaxCode IS NOT NULL AND T1.TaxCode\u003c\u003e\u0027\u0027 ) AND T1.DocEntry = @list_of_cols_val_tab_del )\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Obrigat¢rio colocar o C¢digo de Imposto!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\r\n\tIF NOT EXISTS( SELECT  T1.CFOPCode FROM DPO1 T1 WHERE  ( T1.CFOPCode IS NOT NULL AND  T1.CFOPCode \u003c\u003e \u0027\u0027) AND T1.DocEntry = @list_of_cols_val_tab_del )\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Obrigat¢rio colocar o CFOP!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND;\r\n\r\n--ADIANTAMENTO CLIENTE\r\nIF (@object_type = \u0027203\u0027) and (@transaction_type in (\u0027A\u0027))--\u0027203\u0027 = ADIANTAMENTO DE CLIENTE\r\nBEGIN\r\n\r\n\tIF NOT EXISTS( SELECT   T1.TaxCode FROM DPI1 T1\tWHERE (T1.TaxCode IS NOT NULL AND T1.TaxCode\u003c\u003e\u0027\u0027 ) AND T1.DocEntry = @list_of_cols_val_tab_del )\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Obrigat¢rio colocar o C¢digo de Imposto!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\r\n\tIF NOT EXISTS( SELECT   T1.CFOPCode FROM DPI1 T1 WHERE ( T1.CFOPCode IS NOT NULL AND  T1.CFOPCode \u003c\u003e \u0027\u0027) AND T1.DocEntry =  @list_of_cols_val_tab_del )\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Obrigat¢rio colocar o CFOP!\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 21/09/2017\r\n-- Update Date: \r\n-- Description:\tatualizar Observa‡oes adicionais da nf com o valor do funrural\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027))--\u002718\u0027 = Nota Fiscal de Entrada\r\nBEGIN\r\n\r\nDECLARE @ContHeader int set @ContHeader = (\r\nSELECT count(*) FROM OPCH WHERE Header LIKE \u0027%FUNRURAL%\u0027 AND DocEntry = @list_of_cols_val_tab_del\r\n)\r\n\r\nDECLARE @Funrural nvarchar (200)  set @Funrural = \r\n\t\t\t\t\t\t\t\t\t(SELECT LTRIM(RTRIM(WTName)) FROM PCH5 T0\r\n\t\t\t\t\t\t\t\t\tINNER JOIN OPCH T1 ON T0.AbsEntry = T1.DocEntry\r\n\t\t\t\t\t\t\t\t\tINNER JOIN OWHT T2 ON T2.WTCode = T0.WTCode\r\n\t\t\t\t\t\t\t\t\tWHERE T0.WTCode = 16 AND T1.DocEntry = @list_of_cols_val_tab_del  )\r\n\tIF(@Funrural = \u0027FUNRURAL\u0027)\r\n\tBEGIN\r\n\t\t\tIF (@ContHeader \u003c 1)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027INFORMAR VALOR DO FUNRURAL NOS DADOS ADCIONAIS!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\t\r\n\tEND\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 15/09/2017\r\n-- Update Date: \r\n-- Description:\tTravar NFS sem data e hora de entrada/saida\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nDECLARE @SeqCode int = 0\r\nDECLARE @DtSaida datetime= NULL\r\nDECLARE @HrSaida smallint = NULL\r\n\r\nIF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027))--\u002713\u0027 = Nota Fiscal de sa¡da\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM OINV WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM OINV WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM OINV WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002715\u0027) and (@transaction_type in (\u0027A\u0027))--\u002715\u0027 = entrega\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM ODLN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM ODLN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM ODLN WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002716\u0027) and (@transaction_type in (\u0027A\u0027))--\u002716\u0027 = Devolu‡ao\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM ORDN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM ORDN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM ORDN WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027))--\u002714\u0027 = DEV Nota Fiscal de Sa¡da\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM ORIN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM ORIN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM ORIN WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002720\u0027) and (@transaction_type in (\u0027A\u0027))--\u002720\u0027 = Recebimento de Mercadoria\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM OPDN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM OPDN WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM OPDN WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002721\u0027) and (@transaction_type in (\u0027A\u0027))--\u002721\u0027 = Dev de mercadoria\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM ORPD WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM ORPD WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM ORPD WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027))--\u002718\u0027 = Nota Fiscal de Entrada/NF Recebimento futuro\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM OPCH WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM OPCH WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM OPCH WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\nIF (@object_type = \u002719\u0027) and (@transaction_type in (\u0027A\u0027))--\u002719\u0027 = Dev Nota Fiscal de entrada\r\nBEGIN\r\nSET @SeqCode = ( SELECT SeqCode FROM ORPC WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @DtSaida = ( SELECT U_SKILL_DtSaida FROM ORPC WHERE DocNum = @list_of_cols_val_tab_del)\r\nSET @HrSaida = ( SELECT U_SKILL_HrSaida FROM ORPC WHERE DocNum = @list_of_cols_val_tab_del)\r\n\r\n\t-- 27 = NFe | 28 = NFe_IMP | 29 = NFE_ENT\r\n\tIF(@SeqCode = 27 OR @SeqCode = 28 OR @SeqCode = 29)\r\n\tBEGIN\r\n\t\tIF(@DtSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Data de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\tIF(@HrSaida IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027O campo Hora de Entrada/Saida ‚ de preenchimento obrigat¢rio!!\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 31/01/2017\r\n-- Update Date: 30/08/2017\r\n-- Description:\tTravar Pedidos de Vendas com ITENS EM ABERTO (APENAS ATUALIZAR) \r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @DepUPV int SET @DepUPV = (SELECT u.Department From ORDR O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n IF(@DepUPV = 1)\t\r\n\tBEGIN\r\n\t\tIF  EXISTS (\r\n\t\t\tSELECT \r\n\t\t\t\t* \r\n\t\t\tFROM \r\n\t\t\t\tOJDT T0  \r\n\t\t\tINNER JOIN JDT1 T1 ON T0.[TransId] = T1.[TransId] \r\n\t\t\tINNER JOIN OACT T2 ON T1.[Account] = T2.[AcctCode] \r\n\t\t\tINNER JOIN OCRD T3 ON T3.CardCode = t1.ShortName\r\n\t\t\t\r\n\t\t\tWHERE \r\n\t\t\t\tT2.[LocManTran] = \u0027Y\u0027 AND \r\n\t\t\t\tT1.[BalDueDeb] \u003c\u003e 0   AND  T3.QryGroup25 = \u0027N\u0027 AND\r\n\t\t\t\tT1.[DueDate] \u003c  CONVERT(DATETIME, FLOOR(CONVERT(FLOAT(24), GETDATE())))  AND \r\n\t\t\t\tT1.[ShortName] = ( SELECT CardCode FROM ORDR WHERE DocNum =  @list_of_cols_val_tab_del )\r\n\t\t\t\t\r\n\t\t\r\n\t\t) BEGIN\t\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ possivel adicionar esse pedido, cliente possui t¡tulos vencidos!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t  END;\r\n\t\r\n\r\n\tEND;\t\t\r\n\t\t\r\n\r\nEND;\r\n\r\n------------------------------------------------------------------------------------------------------------------------------\r\n--END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 31/01/2017\r\n-- Update Date: 30/08/2017\r\n-- Description:\tTravar Pedidos de Vendas com ITENS EM ABERTO  (APENAS ADICIONAR)\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\nDECLARE @DepCR int SET @DepCR = (SELECT u.Department From ORDR O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n IF(@DepCR = 1)\t\r\n\tBEGIN\r\n\t\tIF  EXISTS (\r\n\t\t\tSELECT \r\n\t\t\t\t* \r\n\t\t\tFROM \r\n\t\t\t\tOJDT T0  \r\n\t\t\tINNER JOIN JDT1 T1 ON T0.[TransId] = T1.[TransId] \r\n\t\t\tINNER JOIN OACT T2 ON T1.[Account] = T2.[AcctCode] \r\n\t\t\tINNER JOIN OCRD T3 ON T3.CardCode = t1.ShortName\r\n\t\t\tWHERE \r\n\t\t\t\tT2.[LocManTran] = \u0027Y\u0027 AND \r\n\t\t\t\tT1.[BalDueDeb] \u003c\u003e 0   AND   T3.QryGroup25 = \u0027N\u0027 AND\r\n\t\t\t\tT1.[DueDate] \u003c  CONVERT(DATETIME, FLOOR(CONVERT(FLOAT(24), GETDATE())))  AND \r\n\t\t\t\tT1.[ShortName] = ( SELECT CardCode FROM ORDR WHERE DocNum =  @list_of_cols_val_tab_del )\r\n\t\t\t\r\n\t\t) BEGIN\t\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ possivel adicionar esse pedido, cliente possui t¡tulos vencidos!\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t  END;\r\n\r\n\t\r\n\tEND;\t\t\r\n\t\t\r\n\r\nEND;\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 23/08/2017\r\n-- Update Date: \r\n-- Description:\tBloquear ESBO€O de Pedidos com deposito bloqueado\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--N\u0027112\u0027 = ESBO€O\r\n\r\nBEGIN\r\n\tIF EXISTS(\r\n\t\tSELECT \r\n\t\t\tA.DocNum \u0027Nø do Esbo‡o\u0027,\r\n\t\t\tA.CardCode +\u0027-\u0027+ A.CardName \u0027Parceiro\u0027,\r\n\t\t\tI.ItemCode +\u0027-\u0027+ I.ItemName \u0027Produto\u0027,\r\n\t\t\tA.DocDueDate \u0027Data de Entrega\u0027\t,IW.Locked\r\n\t\tFROM \r\n\t\t\tODRF A \r\n\t\tINNER JOIN DRF1 AL ON AL.DocEntry = A.DocEntry\r\n\t\tINNER JOIN OITM I ON AL.ItemCode = I.ItemCode\r\n\t\tINNER JOIN OITW IW ON IW.ItemCode = I.ItemCode AND IW.WhsCode = Al.WhsCode\r\n\t\tWHERE \r\n\t\t\tA.ObjType = 17 AND A.DocEntry = @list_of_cols_val_tab_del AND IW.Locked = \u0027Y\u0027 )\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Dep¢sito selecionado est  bloqueado para o Item\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 13/01/2017\r\n-- UPdate Date: 06/07/2017\r\n-- Description:\tTravar Pedidos de Vendas com Data de Validade Menor que a data atual + 2 DDL (APENAS AO ADICIONAR)\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\n\tDECLARE @DocDueDate DATETIME SET @DocDueDate = (SELECT DocDueDate FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DocDate DATETIME SET @DocDate = (SELECT DocDate FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DDL INT  SET @DDL =2\r\n\tDECLARE @HoraAtual INT =  (SELECT DATEPART ( Hour , GETDATE() )  )\r\n\tDECLARE @MinutoAtual INT = (SELECT DATEPART ( MINUTE , GETDATE() )  )\r\n\tDECLARE @Desconto Float SET @Desconto =  (SELECT DiscPrcnt FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n\tDECLARE @diasemana INT = Convert(int,(select DatePart(WEEKDAY,GETDATE())))\r\n\t\r\n\t\r\nIF (@diasemana = 1) --DOMINGO\r\n\tBEGIN\r\n\t\tSET @DDL =3\r\n\tEND\r\nELSE IF(@diasemana between 2 AND 3) -- SEGUNDA E TER€A\r\n\tBEGIN\r\n\t\tIF (@HoraAtual between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtual = 11) AND (@MinutoAtual \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDL =3 \r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDL =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtual between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDL =3\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemana = 4) -- QUARTA-FEIRA\r\n\tBEGIN\r\n\t\tIF (@HoraAtual between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtual = 11) AND (@MinutoAtual \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDL =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDL =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtual between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDL =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemana between 5 AND 6) -- QUINTA E SEXTA\r\n\tBEGIN\r\n\t\tIF (@HoraAtual between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtual = 11) AND (@MinutoAtual \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDL =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDL =4\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtual between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDL =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemana = 7) --SABADO\r\n\tBEGIN\r\n\t\tSET @DDL =4\r\n\tEND\r\n\r\n\tDECLARE @dateDiff INT SET @dateDiff = (SELECT DATEDIFF(DAY,@DocDate+@DDL,@DocDueDate))\r\n\t\r\n\tDECLARE @Dep int SET @Dep = (SELECT u.Department From ORDR O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\t\t\t\t\t\t\t\t \r\n\tDECLARE @GroupNumBP INT SET @GroupNumBP = (SELECT GroupNum FROM OCRD WHERE CardCode = (SELECT CardCode FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del ))\r\n\tDECLARE @GroupNumPV INT SET @GroupNumPV = (SELECT GroupNum FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\r\n\r\nIF ((@dateDiff \u003c 0) AND @Dep NOT IN (2, 18, 12, 20))\r\nBEGIN\r\n    SET @error = -1\r\n    SET @error_message = \u0027A validade deve ter no m¡nimo \u0027 + CONVERT(VARCHAR, @DDL) + \u0027 dias\u0027\r\n    SELECT @error, @error_message\r\nEND\r\n\r\nIF ((@GroupNumBP \u003c\u003e @GroupNumPV) AND @Dep NOT IN (2, 18, 20))\r\nBEGIN\r\n    SET @error = -1\r\n    SET @error_message = \u0027Nao ‚ permitido modificar a Condi‡ao de Pagamento do PN\u0027\r\n    SELECT @error, @error_message\r\nEND\r\n\r\nIF ((@Desconto \u003e 0) AND @Dep NOT IN (2, 18, 20))\r\nBEGIN\r\n    SET @error = -1\r\n    SET @error_message = \u0027Nao ‚ permitido definir esse tipo de desconto no Pedido\u0027\r\n    SELECT @error, @error_message\r\nEND\r\n\r\nEND;\r\n\r\n\r\n\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n---- END\r\n-----------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 31/01/2017\r\n-- Update date: 06/07/2017\r\n-- Description:\tTravar Pedidos de Vendas com Data de Validade Menor que a data atual + 2 DDL(APENAS AO ATUALIZAR)\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\nBEGIN\r\n\r\n\tDECLARE @DocDueDateU DATETIME SET @DocDueDateU = (SELECT DocDueDate FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DocDateU DATETIME SET @DocDateU = (SELECT DocDate FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DDLU INT  SET @DDLU =2\r\n\tDECLARE @HoraAtualU INT =  (SELECT DATEPART ( Hour , GETDATE() )  )\r\n\tDECLARE @MinutoAtualU INT = (SELECT DATEPART ( MINUTE , GETDATE() )  )\r\n\tDECLARE @DescontoU Float SET @DescontoU =  (SELECT DiscPrcnt FROM ORDR WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n\tDECLARE @diasemanaU INT = Convert(int,(select DatePart(WEEKDAY,GETDATE())))\r\n\r\n\tIF (@diasemanaU = 1) --DOMINGO\r\n\tBEGIN\r\n\t\tSET @DDLU =3\r\n\tEND\r\nELSE IF(@diasemanaU between 2 AND 3) -- SEGUNDA E TER€A\r\n\tBEGIN\r\n\t\tIF (@HoraAtualU between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualU = 11) AND (@MinutoAtualU \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLU =3 \r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLU =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualU between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLU =3\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaU = 4) -- QUARTA-FEIRA\r\n\tBEGIN\r\n\t\tIF (@HoraAtualU between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualU = 11) AND (@MinutoAtualU \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLU =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLU =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualU between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLU =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaU between 5 AND 6) -- QUINTA E SEXTA\r\n\tBEGIN\r\n\t\tIF (@HoraAtualU between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualU = 11) AND (@MinutoAtualU \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLU =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLU =4\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualU between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLU =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaU = 7) --SABADO\r\n\tBEGIN\r\n\t\tSET @DDLU =4\r\n\tEND\r\n\tDECLARE @dateDiffU INT SET @dateDiffU = (SELECT DATEDIFF(DAY,@DocDateU+@DDLU,@DocDueDateU))\r\n\t\r\n\tDECLARE @DepU int SET @DepU = (SELECT u.Department From ORDR O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\t\t\t\t\t\t\t\t \r\n\tDECLARE @GroupNumBPU INT SET @GroupNumBPU = (SELECT GroupNum FROM OCRD WHERE CardCode = (SELECT CardCode FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del ))\r\n\tDECLARE @GroupNumPVU INT SET @GroupNumPVU = (SELECT GroupNum FROM ORDR WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\t\r\n\tIF ((@dateDiffU \u003c 0) AND @DepU NOT IN (1, 2, 18, 12, 20))\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027A validade deve ter no m¡nimo \u0027 + convert(Varchar,@DDLU) + \u0027 dias\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF ((@GroupNumBPU \u003c\u003e @GroupNumPVU) AND @DepU NOT IN (1, 2, 18, 20))\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ permitido modificar a Condi‡ao de Pagamento do PN\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF ((@DescontoU \u003e 0) AND @DepU NOT IN (1, 2, 18, 20))\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ permitido definir esse tipo de desconto no Pedido\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\nEND;\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 01/02/2017\r\n-- Update date: 06/07/2017\r\n-- Description:\tTravar Cota‡ao de Vendas com Data de Validade Menor que a data atual + 2 DDL (APENAS AO ADICIONAR)\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027A\u0027))--\u002723\u0027 = cota‡ao de Vendas\r\nBEGIN\r\n\r\n\tDECLARE @DocDueDateADDQ DATETIME SET @DocDueDateADDQ = (SELECT DocDueDate FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DocDateADDQ DATETIME SET @DocDateADDQ = (SELECT DocDate FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DDLADDQ INT  SET @DDLADDQ =2\r\n\tDECLARE @HoraAtualADDQ INT =  (SELECT DATEPART ( Hour , GETDATE() )  )\r\n\tDECLARE @MinutoAtualADDQ INT = (SELECT DATEPART ( MINUTE , GETDATE() )  )\r\n\tDECLARE @DescontoADDQ Float SET @DescontoADDQ =  (SELECT DiscPrcnt FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n\tDECLARE @diasemanaADDQ INT = Convert(int,(select DatePart(WEEKDAY,GETDATE())))\r\n\r\n\t\r\nIF (@diasemanaADDQ = 1) --DOMINGO\r\n\tBEGIN\r\n\t\tSET @DDLADDQ =3\r\n\tEND\r\nELSE IF(@diasemanaADDQ between 2 AND 3) -- SEGUNDA E TER€A\r\n\tBEGIN\r\n\t\tIF (@HoraAtualADDQ between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualADDQ = 11) AND (@MinutoAtualADDQ \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLADDQ =3 \r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLADDQ =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualADDQ between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLADDQ =3\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaADDQ = 4) -- QUARTA-FEIRA\r\n\tBEGIN\r\n\t\tIF (@HoraAtualADDQ between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualADDQ = 11) AND (@MinutoAtualADDQ \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLADDQ =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLADDQ =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualADDQ between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLADDQ =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaADDQ between 5 AND 6) -- QUINTA E SEXTA\r\n\tBEGIN\r\n\t\tIF (@HoraAtualADDQ between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualADDQ = 11) AND (@MinutoAtualADDQ \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLADDQ =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLADDQ =4\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualADDQ between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLADDQ =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaADDQ = 7) --SABADO\r\n\tBEGIN\r\n\t\tSET @DDLADDQ =4\r\n\tEND\r\n\r\n\tDECLARE @dateDiffADDQ INT SET @dateDiffADDQ = (SELECT DATEDIFF(DAY,@DocDateADDQ+@DDLADDQ,@DocDueDateADDQ))\r\n\t\r\n\tDECLARE @DepADDQ int SET @DepADDQ = (SELECT u.Department From OQUT O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\t\t\t\t\t\t\t\t \r\n\tDECLARE @GroupNumBPADDQ INT SET @GroupNumBPADDQ = (SELECT GroupNum FROM OCRD WHERE CardCode = (SELECT CardCode FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del ))\r\n\tDECLARE @GroupNumPVADDQ INT SET @GroupNumPVADDQ = (SELECT GroupNum FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\t\r\n\tIF ((@dateDiffADDQ \u003c 0) AND @DepADDQ = 1)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027A validade deve ter no m¡nimo \u0027+convert(Varchar,@DDLADDQ)+\u0027 dias\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF ((@GroupNumBPADDQ \u003c\u003e @GroupNumPVADDQ) AND @DepADDQ = 1)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ permitido modificar a Condi‡ao de Pagamento do PN\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF ((@DescontoADDQ \u003e 0) AND @DepADDQ = 1)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ permitido definir esse tipo de desconto no Pedido\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\nEND;\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n*/\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 01/02/2017\r\n-- Update date: 06/07/2017\r\n-- Description:\tTravar Cota‡ao de Vendas com Data de Validade Menor que a data atual + 2 DDL(APENAS AO ATUALIZAR)\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n/*\r\nIF (@object_type = \u002723\u0027) and (@transaction_type in (\u0027U\u0027))--\u002723\u0027 = Cota‡ao de Vendas\r\nBEGIN\r\n\r\n\tDECLARE @DocDueDateUQ DATETIME SET @DocDueDateUQ = (SELECT DocDueDate FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DocDateUQ DATETIME SET @DocDateUQ = (SELECT DocDate FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\t\r\n\tDECLARE @DDLUQ INT  SET @DDLUQ =2\r\n\tDECLARE @HoraAtualUQ INT =  (SELECT DATEPART ( Hour , GETDATE() )  )\r\n\tDECLARE @MinutoAtualUQ INT = (SELECT DATEPART ( MINUTE , GETDATE() )  )\r\n\tDECLARE @DescontoUQ Float SET @DescontoUQ =  (SELECT DiscPrcnt FROM OQUT WHERE (DocEntry = @list_of_cols_val_tab_del))\r\n\tDECLARE @diasemanaUQ INT = Convert(int,(select DatePart(WEEKDAY,GETDATE())))\r\n\r\nIF (@diasemanaUQ = 1) --DOMINGO\r\n\tBEGIN\r\n\t\tSET @DDLUQ =3\r\n\tEND\r\nELSE IF(@diasemanaUQ between 2 AND 3) -- SEGUNDA E TER€A\r\n\tBEGIN\r\n\t\tIF (@HoraAtualUQ between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualUQ = 11) AND (@MinutoAtualUQ \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLUQ =3 \r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLUQ =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualUQ between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLUQ =3\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaUQ = 4) -- QUARTA-FEIRA\r\n\tBEGIN\r\n\t\tIF (@HoraAtualUQ between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualUQ = 11) AND (@MinutoAtualUQ \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLUQ =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLUQ =2\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualUQ between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLUQ =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaUQ between 5 AND 6) -- QUINTA E SEXTA\r\n\tBEGIN\r\n\t\tIF (@HoraAtualUQ between 0 and 11)\r\n\t\tBEGIN\r\n\t\t\tIF(@HoraAtualUQ = 11) AND (@MinutoAtualUQ \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DDLUQ =5\r\n\t\t\t\tEND \r\n\t\t\tELSE\r\n\t\t\t\tSET @DDLUQ =4\r\n\t\tEND\r\n\t\tELSE IF(@HoraAtualUQ between 11 and 24)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @DDLUQ =5\r\n\t\t\tEND\r\n\tEND\r\nELSE IF (@diasemanaUQ = 7) --SABADO\r\n\tBEGIN\r\n\t\tSET @DDLUQ =4\r\n\tEND\r\n\t\r\n\t\r\n\tDECLARE @dateDiffUQ INT SET @dateDiffUQ = (SELECT DATEDIFF(DAY,@DocDateUQ+@DDLUQ,@DocDueDateUQ))\r\n\t\r\n\tDECLARE @DepUQ int SET @DepUQ = (SELECT u.Department From OQUT O \r\n\t\t\t\t\t\t\t\tINNER JOIN OUSR U ON O.UserSign2 = U.USERID\r\n\t\t\t\t\t\t\t\tWHERE O.DocNum = @list_of_cols_val_tab_del)\r\n\t\t\t\t\t\t\t\t \r\n\tDECLARE @GroupNumBPUQ INT SET @GroupNumBPUQ = (SELECT GroupNum FROM OCRD WHERE CardCode = (SELECT CardCode FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del ))\r\n\tDECLARE @GroupNumPVUQ INT SET @GroupNumPVUQ = (SELECT GroupNum FROM OQUT WHERE DocEntry = @list_of_cols_val_tab_del )\r\n\r\n\t\r\n\tIF ((@dateDiffUQ \u003c 0) AND @DepUQ = 1)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027A validade deve ter no m¡nimo \u0027+convert(nvarchar,@DDLUQ)+\u0027 dias\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF ((@GroupNumBPUQ \u003c\u003e @GroupNumPVUQ) AND @DepUQ = 1)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ permitido modificar a Condi‡ao de Pagamento do PN\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\n\t\tIF ((@DescontoUQ \u003e 0) AND @DepUQ = 1)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Nao ‚ permitido definir esse tipo de desconto no Pedido\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\nEND;\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n*/\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create Date: 23/05/2017\r\n-- Update Date: \r\n-- Description:\tValida‡oes de atualiza‡oes campos Rendimento\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027Rendimento\u0027) and (@transaction_type in (\u0027U\u0027))-- RENDIMENTOS\r\nBEGIN \r\n\t--VALIDAR NUMERO RECEBIMENTO\r\n\tDECLARE @NRecebU NVARCHAR (15) SET @NRecebU =(SELECT U_DocNum\tFROM [@RA_RENDIMENTO] \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE Code  = @list_of_cols_val_tab_del)\r\n\tIF NOT Exists(\r\n\tSELECT *FROM OPDN \r\n\tWHERE DocNum = @NRecebU AND DocStatus IN (\u0027O\u0027,\u0027C\u0027))\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Recebimento nao encontrado ou cancelado. Nao ‚ poss¡vel adicionar.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\r\n\t--VALIDAR NUMERO DO ITEM\r\n\tDECLARE @NProdU NVARCHAR (15) SET @NProdU =(SELECT U_ItemCode\tFROM [@RA_RENDIMENTO] \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE Code  = @list_of_cols_val_tab_del)\r\n\tIF NOT Exists(\r\n\tSELECT *FROM OITM WHERE validFor = \u0027Y\u0027 AND ItemCode = @NProdU )\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Item nao encontrado ou inativo. Nao ‚ poss¡vel adicionar.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\r\n\tDECLARE @RendNomeU NVARCHAR (30)\r\n\t\r\n\t--PREENCHIMENTO AUTOMATICO DO NOME\r\n\tSET @RendNomeU =(SELECT CONCAT(U_DocNum,\u0027 - \u0027,U_ItemCode) \r\n\t\t\t\t\t\t\tFROM [@RA_RENDIMENTO] WHERE Code  = @list_of_cols_val_tab_del )\r\n\tIF(@RendNomeU is not Null)\r\n\t\tBEGIN\r\n\t\t\tUPDATE [@RA_RENDIMENTO] SET NAME = @RendNomeU WHERE Code = @list_of_cols_val_tab_del\r\n\t\tEND\r\n\r\n\t--VALIDAR NOME\r\n\tSET @RendNomeU = (SELECT Name FROM [@RA_RENDIMENTO] \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE Code  = @list_of_cols_val_tab_del)\r\n\tIF Exists(\r\n\tSELECT Name FROM [@RA_RENDIMENTO]\tWHERE Name = @RendNomeU AND Code \u003c\u003e@list_of_cols_val_tab_del)\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Rendimento j  cadastrado. Nao ‚ poss¡vel adicionar\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 09/05/2017\r\n-- Description:\tAtualizar Quantidade Real\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u002720\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002720\u0027 = Recebimento de Mercadoria\r\n\r\nBEGIN\r\nDECLARE @QRealCab int = (SELECT U_MW_QuantReal FROM OPDN WHERE DocNum =  @list_of_cols_val_tab_del )\r\nDECLARE @StatusImp Varchar (20) = (SELECT U_MW_STATUSIMP FROM OPDN WHERE DocNum =  @list_of_cols_val_tab_del )\r\n\r\n\tIF(@StatusImp = \u0027RECEBIDO\u0027 AND (@QRealCab IS NULL OR @QRealCab = 0))\r\n\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027Informar Quantidade Real\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\tEND \r\n\r\n\tIF(@QRealCab IS NOT NULL AND @QRealCab \u003e 0)\r\n\tBEGIN\r\n\t\tIF(@StatusImp = \u0027RECEBIDO\u0027)\r\n\t\tBEGIN\r\n\t\t\tUPDATE  PDN1 SET U_MW_QUANTIREAL = @QRealCab WHERE DocEntry = @list_of_cols_val_tab_del;\r\n\t\tEND \r\n\t\tELSE\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Verificar Status Importa‡ao\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\tEND \r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create Date: 18/04/2017\r\n-- Update Date: \r\n-- Description:\tBloquear campos Rendimento\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u0027Rendimento\u0027) and (@transaction_type in (\u0027A\u0027))-- RENDIMENTOS\r\nBEGIN \r\n\t--VALIDAR NUMERO RECEBIMENTO\r\n\tDECLARE @NReceb NVARCHAR (15) SET @NReceb =(SELECT U_DocNum\tFROM [@RA_RENDIMENTO] \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE Code  = @list_of_cols_val_tab_del)\r\n\tIF NOT Exists(\r\n\tSELECT *FROM OPDN \r\n\tWHERE DocNum = @NReceb AND DocStatus IN (\u0027O\u0027,\u0027C\u0027))\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Recebimento nao encontrado ou cancelado. Nao ‚ poss¡vel adicionar.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\r\n\t--VALIDAR NUMERO DO ITEM\r\n\tDECLARE @NProd NVARCHAR (15) SET @NProd =(SELECT U_ItemCode\tFROM [@RA_RENDIMENTO] \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE Code  = @list_of_cols_val_tab_del)\r\n\tIF NOT Exists(\r\n\tSELECT *FROM OITM WHERE validFor = \u0027Y\u0027 AND ItemCode = @NProd )\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Item nao encontrado ou inativo. Nao ‚ poss¡vel adicionar.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\r\n\tDECLARE @RendNome NVARCHAR (30)\r\n\t\r\n\t--PREENCHIMENTO AUTOMATICO DO NOME\r\n\tSET @RendNome =(SELECT CONCAT(U_DocNum,\u0027 - \u0027,U_ItemCode) \r\n\t\t\t\t\t\t\tFROM [@RA_RENDIMENTO] WHERE Code  = @list_of_cols_val_tab_del )\r\n\tIF(@RendNome is not Null)\r\n\t\tBEGIN\r\n\t\t\tUPDATE [@RA_RENDIMENTO] SET NAME = @RendNome WHERE Code = @list_of_cols_val_tab_del\r\n\t\tEND\r\n\r\n\t--VALIDAR NOME\r\n\tSET @RendNome = (SELECT Name FROM [@RA_RENDIMENTO] \r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE Code  = @list_of_cols_val_tab_del)\r\n\tIF Exists(\r\n\tSELECT Name FROM [@RA_RENDIMENTO]\tWHERE Name = @RendNome AND Code \u003c\u003e@list_of_cols_val_tab_del)\r\n\tBEGIN\r\n\t\tSET @error = -1\r\n\t\tSET @error_message = \u0027Rendimento j  cadastrado. Nao ‚ poss¡vel adicionar\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\t\r\nEND\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 12/04/2017\r\n-- Update Date: \r\n-- Description:\tBloquear Dev NF de Sa¡da sem Regra de Distribui‡ao,Utiliza‡ao e C¢digo de imposto\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002714\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002714\u0027 = DEV NF DE SAIDA\r\n\r\nBEGIN\r\n\tDECLARE @DocEntryDNFS int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeDNFS char = (SELECT DocType FROM ORIN  WHERE DocEntry = @DocEntryDNFS)\r\n\r\n\t--Utiliza‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tORIN O\r\n\t\t\t    INNER JOIN RIN1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryDNFS AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\tIF( @DocTypeDNFS = \u0027I\u0027)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027Dev NF de Sa¡da - Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\tEND\r\n\r\n\t\t--C¢digo de imposto\r\n\t\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tORIN O\r\n\t\t\t    INNER JOIN RIN1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryDNFS AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\t\tSET @error = -1\r\n\t\t\t\tSET @error_message = \u0027Dev NF de Sa¡da - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\t\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 12/04/2017\r\n-- Update Date: \r\n-- Description:\tBloquear DEV NF ENTRADA sem Regra de Distribui‡ao,Utiliza‡ao e C¢digo de imposto\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002719\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002719\u0027 = DEV NF DE ENTRADA\r\n\r\nBEGIN\r\n\tDECLARE @DocEntryDNFE int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeDNFE char = (SELECT DocType FROM ORPC WHERE DocEntry = @DocEntryDNFE)\r\n\t--Utiliza‡ao\r\n\tIF EXISTS (\r\n\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tORPC O\r\n\t\t\t    INNER JOIN RPC1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryDNFE AND OL.OcrCode IS NULL)\t\t\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tif (@DocTypeDNFE = \u0027I\u0027)\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\t\tSET @error_message = \u0027DEV NF ENTRADA - Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\r\n\t\t--C¢digo de imposto\r\n\t\tIF EXISTS (\r\n\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tORPC O\r\n\t\t\t    INNER JOIN RPC1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryDNFE AND OL.OcrCode IS NULL)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\tSET @error_message = \u0027DEV NF ENTRADA - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 12/04/2017\r\n-- Update Date: \r\n-- Description:\tBloquear NF ENTRADA sem Regra de Distribui‡ao,Utiliza‡ao e C¢digo de imposto\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002718\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002718\u0027 = NF DE ENTRADA\r\n\r\nBEGIN\r\n\tDECLARE @DocEntryNFE int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeNFE char = (SELECT DocType FROM OPCH WHERE DocEntry = @DocEntryNFE)\r\n\t--C¢digo de imposto\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tOPCH O\r\n\t\t\t    INNER JOIN PCH1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryNFE AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -1\r\n\t\t\tSET @error_message = \u0027NF ENTRADA - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 12/04/2017\r\n-- Update Date: \r\n-- Description:\tBloquear NF de Sa¡da sem Regra de Distribui‡ao,Utiliza‡ao e C¢digo de imposto\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002713\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002713\u0027 = NF DE SAIDA\r\n\r\nBEGIN\r\n\t\r\n\tDECLARE @DocEntryNFS int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeNFS char = (SELECT DocType FROM OINV WHERE DocEntry = @DocEntryNFS)\r\n\r\n\t--Utiliza‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tOINV O\r\n\t\t\t    INNER JOIN INV1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryNFS AND OL.OcrCode IS NULL)\r\n\t\t\t\tBEGIN\r\n\t\t\t\tif (@DocTypeNFS = \u0027I\u0027)\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @error = -1\r\n\t\t\t\t\t\tSET @error_message = \u0027Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\r\n\t--C¢digo de imposto\r\n\t--IF EXISTS(\r\n\t--\t\tSELECT \r\n\t--\t\t\tOL.TaxCode\r\n\t--\t\tFROM \r\n\t--\t\t\tOINV O\r\n\t--\t\t    INNER JOIN INV1 OL ON O.DocEntry = ol.DocEntry\r\n\t--\t\tWHERE o.DocEntry = @DocEntryNFS AND OL.OcrCode IS NULL AND )\r\n\t--\t\t\tBEGIN\r\n\t--\t\t\t\tSET @error = -1\r\n\t--\t\t\t\tSET @error_message = \u0027Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t--\t\t\t\tSELECT @error, @error_message\r\n\t--\t\t\tEND\r\n\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 03/01/2017\r\n-- Description:\tAtualizar o campo Regra de Distribui‡ao nas Linhas do Pedido (ESBO€O)\r\n-- OBS:UPDATE IRREGULAR AUTORIZADO PELO ROBSON VIA CHAMADO 2271\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\tDECLARE @ContEsb int = 0\t\r\n\tDECLARE @CentroCustosEsb NVarchar (255)\r\n\t--DECLARE @IDPedido int = @list_of_cols_val_tab_del\r\n\tDECLARE @TotalLinhasEsb  int = (SELECT MAX(LineNum) FROM DRF1 WHERE ObjType = 17 AND DocEntry = @list_of_cols_val_tab_del)\t\r\n\r\n\tWHILE(@ContEsb \u003c @TotalLinhasEsb+1)\r\n\t\tBEGIN\r\n\t\t\tSET @CentroCustosEsb= (\r\n\t\t\t\r\n\t\t\tSELECT  \r\n\t\t\t\tI.[U_MW_CENTRO]\r\n\t\tFROM\r\n\t\tDRF1 T1\t\t\r\n\t\tINNER JOIN OITM I ON T1.ItemCode = I.ItemCode\r\n\t\tWHERE  T1.ObjType = 17 AND T1.DocEntry = @list_of_cols_val_tab_del AND T1.LineNum = @ContEsb)\r\n\t\t\r\n\r\n\t\t\tif ( @CentroCustosEsb  is not null AND @CentroCustosEsb \u003c\u003e \u0027\u0027)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE DRF1\tSET OcrCode = @CentroCustosEsb, CogsOcrCod = @CentroCustosEsb \r\n\t\t\t\t\tWHERE ObjType = 17 AND DocEntry = @list_of_cols_val_tab_del AND LineNum =  @ContEsb\r\n\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\t\t\r\n\t\t\tSET @ContEsb = @ContEsb + 1\r\n\t\tEND;\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 16/03/2017\r\n-- update date: \r\n-- Description:\tAtualizar o campo Regra de Distribui‡ao nas Linhas do Pedido de Compra \r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002722\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002722\u0027 = Pedido de compra frete\r\n\r\nBEGIN\r\n\tDECLARE @ContOPOR int = 0\t\r\n\tDECLARE @CentroCustosOPOR NVarchar (255)\r\n\t--DECLARE @IDPedido int = @list_of_cols_val_tab_del\r\n\tDECLARE @TotalLinhasOPOR  int = (SELECT MAX(LineNum) FROM POR1 WHERE DocEntry = @list_of_cols_val_tab_del)\t\r\n\r\n\tWHILE(@ContOPOR \u003c @TotalLinhasOPOR+1)\r\n\t\tBEGIN\r\n\t\t\tSET @CentroCustosOPOR = (\r\n\t\t\t\r\n\t\t\tSELECT  \r\n\t\t\t\tI.[U_MW_CENTRO]  \r\n\t\t\tFROM \r\n\t\t\t\tOITM I\r\n\t\t\t\tINNER JOIN POR1 T1 ON I.ItemCode = T1.ItemCode\r\n\t\t\tWHERE T1.DocEntry = @list_of_cols_val_tab_del AND T1.LineNum = @ContOPOR)\r\n\t\t\r\n\r\n\t\t\tif ( @CentroCustosOPOR  is not null AND @CentroCustosOPOR \u003c\u003e \u0027\u0027)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE POR1\tSET OcrCode = @CentroCustosOPOR, CogsOcrCod = @CentroCustosOPOR WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum =  @ContOPOR\r\n\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\t\t\r\n\t\t\tSET @ContOPOR = @ContOPOR+ 1\r\n\t\tEND;\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 03/01/2017\r\n-- update date: 15/03/2017\r\n-- Description:\tAtualizar o campo Regra de Distribui‡ao nas Linhas do Pedido\r\n-- OBS:UPDATE IRREGULAR AUTORIZADO PELO ROBSON VIA CHAMADO 2271\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\tDECLARE @Cont int = 0\t\r\n\tDECLARE @CentroCustos NVarchar (255)\r\n\t--DECLARE @IDPedido int = @list_of_cols_val_tab_del\r\n\tDECLARE @TotalLinhas  int = (SELECT MAX(LineNum) FROM rdr1 WHERE DocEntry = @list_of_cols_val_tab_del)\t\r\n\r\n\tWHILE(@Cont \u003c @TotalLinhas+1)\r\n\t\tBEGIN\r\n\t\t\tSET @CentroCustos = (\r\n\t\t\t\r\n\t\t\tSELECT  \r\n\t\t\t\tI.[U_MW_CENTRO]\r\n\t\t\tFROM \r\n\t\t\t\tOITM I\r\n\t\t\t\tINNER JOIN RDR1 T1 ON I.ItemCode = T1.ItemCode\r\n\t\t\tWHERE T1.DocEntry = @list_of_cols_val_tab_del AND T1.LineNum = @Cont)\r\n\t\t\r\n\r\n\t\t\tif ( @CentroCustos  is not null AND @CentroCustos \u003c\u003e \u0027\u0027)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE RDR1\tSET OcrCode = @CentroCustos, CogsOcrCod = @CentroCustos WHERE DocEntry = @list_of_cols_val_tab_del AND LineNum =  @Cont\r\n\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\t\t\r\n\t\t\tSET @Cont = @Cont + 1\r\n\t\tEND;\r\n\t\t\r\nEND;\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n-----------------------------------------------------------------------------------------------------------------------------\r\n------ Author: Henrique Truyts \r\n------ Create date: 02/04/2019\r\n------ Update date: 14/08/2019\r\n------ Documentos:  Pedido de Venda, Solicita‡ao de Compra,Pedido de Compra, Oferta de Compra E Esbo‡os\r\n------ GLPI ID: 6734\r\n------ GLPI ID Atualiza‡oes: 8927 - Sa¡da de mercadorias sendo adicionadas sem regra de distribui‡ao\r\n------ GLPI ID Atualiza‡oes: 13866 - Almoxarifado pode adicionar solicita‡ao de compra sem o preenchimento dos campos\r\n-- Description:\tBloquear Documentos sem Regra de Distribui‡ao,Utiliza‡ao e C¢digo de imposto\r\n\r\n---------------------------------------------------------------------------------------------------------------------------\r\n\r\n------------------------------------------------ Pedido de Venda------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\t\r\n\tDECLARE @DocEntryPV int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypePV char = (SELECT DocType FROM ORDR WHERE DocEntry = @DocEntryPV)\r\n\r\n\t--Regra de Distribui‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.OcrCode \r\n\t\t\tFROM \r\n\t\t\t\tORDR O\r\n\t\t\t    INNER JOIN RDR1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryPV AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6734\r\n\t\t\tSET @error_message = \u0027Pedidos de Venda - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\t--Utiliza‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tORDR O\r\n\t\t\t    INNER JOIN RDR1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryPV AND OL.OcrCode IS NULL)\r\n\tBEGIN\r\n\t\tIF ( @DocTypePV = \u0027I\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6734\r\n\t\t\tSET @error_message = \u0027Pedidos de Venda - Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\tEND\r\n\r\n\t--C¢digo de imposto\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tORDR O\r\n\t\t\t    INNER JOIN RDR1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryPV AND OL.OcrCode IS NULL)\r\n\tBEGIN\r\n\t\tSET @error = -6734\r\n\t\tSET @error_message = \u0027Pedidos de Venda - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\tSELECT @error, @error_message\r\n\tEND\r\n\t\t\r\nEND;\r\n------------------------------------------------ Solicita‡ao de Compra ------------------------------------------------\r\nIF (@object_type = \u00271470000113\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Solicita‡ao de Compra\r\n\r\nDECLARE @UserSign6734SC int = (SELECT UserSign2 FROM OPRQ WHERE DocEntry = @list_of_cols_val_tab_del)\r\nDECLARE @Dep6734SC int SET @Dep6734SC = (SELECT Department FROM OUSR WHERE USERID = @UserSign6734SC)\r\n\r\nIF(@Dep6734SC NOT IN (22))\r\nBEGIN\r\n\r\nBEGIN \r\n IF (SELECT \r\n\t\tCOUNT(*) \r\n\t FROM\r\n\t\tPRQ1 SC\r\n\t\tWHERE \r\n\t\t(SC.DocEntry = @list_of_cols_val_tab_del) AND (SC.OcrCode = \u0027\u0027 OR SC.OcrCode IS NULL)) \u003e 0\r\n BEGIN\r\n  SET @error = -6734\r\n  SET @error_message = \u0027Solicita‡ao de Compra - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n  SELECT @error, @error_message\r\n   \r\n END;\r\n --Utiliza‡ao obrigatoria\r\n IF (SELECT \r\n\t\tCOUNT(*)\r\n\t FROM\r\n\t\tPRQ1 SC\r\n\tWHERE \r\n\t\t(SC.DocEntry = @list_of_cols_val_tab_del) AND (SC.usage = \u0027\u0027 OR SC.usage IS NULL)) \u003e 0\r\n BEGIN \r\n  SET @error = -6734\r\n  SET @error_message = \u0027Solicita‡ao de Compra - Nao foi poss¡vel concluir.  necess rio definir a Utiliza‡ao.\u0027\r\n  SELECT @error, @error_message\r\n\r\n END;\r\nEND;\r\nEND\r\n\r\n------------------------------------------------ Pedido de Compra ------------------------------------------------\r\nIF (@object_type = \u002722\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002722\u0027 = Pedido de Compras\r\n\r\nBEGIN\r\n\r\n\tDECLARE @DocEntryPC int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypePC char = (SELECT DocType FROM OPOR WHERE DocEntry = @DocEntryPC)\r\n\r\n\t--Regra de Distribui‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.OcrCode \r\n\t\t\tFROM \r\n\t\t\t\tOPOR O\r\n\t\t\t    INNER JOIN POR1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryPC AND OL.OcrCode IS NULL)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -6734\r\n\t\t\t\t\tSET @error_message = \u0027Pedidos de Compra - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\r\n\t--Utiliza‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tOPOR O\r\n\t\t\t    INNER JOIN POR1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryPC AND OL.OcrCode IS NULL)\r\n\t\t\tBEGIN\r\n\t\t\t\tif (@DocTypePC = \u0027I\u0027)\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @error = -6734\r\n\t\t\t\t\t\tSET @error_message = \u0027Pedidos de Compra - Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\tEND\r\n\t\t\tEND\r\n\r\n\t\t--C¢digo de imposto\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tOPOR O\r\n\t\t\t    INNER JOIN POR1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryPC AND OL.OcrCode IS NULL)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -6734\r\n\t\t\t\t\tSET @error_message = \u0027Pedidos de Compra - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\r\n\t\t\r\nEND;\r\n------------------------------------------------ Oferta de Compra 540000006\r\nIF (@object_type = \u0027540000006\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u0027 540000006\u0027 = Oferta de Compras\r\n\r\nBEGIN\r\n\r\n\tDECLARE @DocEntryOFC int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeOFC char = (SELECT DocType FROM OPQT WHERE DocEntry = @DocEntryOFC)\r\n\r\n\t--Regra de Distribui‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.OcrCode \r\n\t\t\tFROM \r\n\t\t\t\tOPQT O\r\n\t\t\t    INNER JOIN PQT1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryOFC AND OL.OcrCode IS NULL)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -6734\r\n\t\t\t\t\tSET @error_message = \u0027Oferta de Compra - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\r\n\t\t\r\n\t--Utiliza‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tOPQT O\r\n\t\t\t    INNER JOIN PQT1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryOFC AND OL.OcrCode IS NULL)\r\n\t\t\tBEGIN\r\n\t\t\t\tif (@DocTypeOFC = \u0027I\u0027)\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tSET @error = -6734\r\n\t\t\t\t\t\tSET @error_message = \u0027Oferta de Compra - Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\t\tEND\r\n\t\t\tEND\r\n\r\n\t\t--C¢digo de imposto\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tOPQT O\r\n\t\t\t    INNER JOIN PQT1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntryOFC AND OL.OcrCode IS NULL)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @error = -6734\r\n\t\t\t\t\tSET @error_message = \u0027OFerta de Compra - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\t\t\t\tSELECT @error, @error_message\r\n\t\t\t\tEND\t\t\r\nEND;\r\n\r\n------------------------------------------------ Sa¡da de mercadorias ------------------------------------------------\r\nIF (@object_type = \u002760\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002760\u0027 = Sa¡da de mercadorias\r\n\r\nBEGIN\r\n\t\r\n\tDECLARE @DocEntrySM int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeSM char = (SELECT DocType FROM OIGE WHERE DocEntry = @DocEntrySM)\r\n\r\n\t--Regra de Distribui‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.OcrCode \r\n\t\t\tFROM \r\n\t\t\t\tOIGE O\r\n\t\t\t    INNER JOIN IGE1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.DocEntry = @DocEntrySM AND (OL.OcrCode IS NULL OR OL.OcrCode = \u0027\u0027) AND (OL.AcctCode LIKE \u00274%\u0027 OR OL.AcctCode LIKE \u00275%\u0027))\r\n\t\tBEGIN\r\n\t\t\tSET @error = 6734\r\n\t\t\tSET @error_message = \u0027Sa¡da de mercadorias - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\r\nEND;\r\n\r\n------------------------------------------------ Esbo‡os Todos os Documentos acima\r\nIF (@object_type = N\u0027112\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--N\u0027112\u0027 = ESBO€O\r\n\r\nBEGIN\r\n\tDECLARE @DocEntryESB int = @list_of_cols_val_tab_del\r\n\tDECLARE @DocTypeESB char = (SELECT DocType FROM ODRF \r\n\t\t\t\t\t\t\tWHERE objtype in (17,1470000113,22,540000006,60) AND DocEntry = @DocEntryESB)\r\n\r\n\t--Regra de Distribui‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.OcrCode \r\n\t\t\tFROM \r\n\t\t\t\tODRF O\r\n\t\t\t    INNER JOIN DRF1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.objtype in (17,1470000113,22,540000006,60) AND o.DocEntry = @DocEntryESB AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6734\r\n\t\t\tSET @error_message = \u0027Esbo‡o - Nao foi poss¡vel concluir.  necess rio definir a Regra de Distribui‡ao.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\r\n\t--Utiliza‡ao\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.Usage \r\n\t\t\tFROM \r\n\t\t\t\tODRF O\r\n\t\t\t    INNER JOIN DRF1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.objtype in (17,1470000113,22,540000006) AND o.DocEntry = @DocEntryESB AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\tIF(@DocTypeESB = \u0027I\u0027)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @error = -6734\r\n\t\t\t\tSET @error_message = \u0027Esbo‡o - Nao foi poss¡vel concluir.  necess rio definir uma Utiliza‡ao.\u0027\r\n\t\t\t\tSELECT @error, @error_message\r\n\t\t\tEND\r\n\t\tEND\r\n\r\n\t--C¢digo de imposto\r\n\tIF EXISTS(\r\n\t\t\tSELECT \r\n\t\t\t\tOL.TaxCode\r\n\t\t\tFROM \r\n\t\t\t\tODRF O\r\n\t\t\t    INNER JOIN DRF1 OL ON O.DocEntry = ol.DocEntry\r\n\t\t\tWHERE o.objtype in (17,1470000113,22,540000006) AND o.DocEntry = @DocEntryESB AND OL.OcrCode IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @error = -6734\r\n\t\t\tSET @error_message = \u0027Esbo‡o - Nao foi poss¡vel concluir.  necess rio definir o C¢digo de Imposto.\u0027\r\n\t\t\tSELECT @error, @error_message\r\n\t\tEND\r\n\t\t\t\r\nEND;\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- Author:\t\tHenrique Truyts\r\n-- Create date: 03/01/2017\r\n-- Update Date: 16/02/2017\r\n-- Description:\tAtualizar o campo Comissao na Linha do Pedido Com base no cadastro de comissao do vendedor\r\n--------------------------------------------------------------------------------------------------------------------------------\r\nIF (@object_type = \u002717\u0027) and (@transaction_type in (\u0027A\u0027,\u0027U\u0027))--\u002717\u0027 = Pedido de Vendas\r\n\r\nBEGIN\r\n\tDECLARE @Contador int = 0\t\r\n\tDECLARE @Comissao float = 0\r\n\tDECLARE @DocEntry int = @list_of_cols_val_tab_del\r\n\tDECLARE @CardCodeComission Nvarchar (20) = (SELECT CardCode FROM ORDR WHERE DocEntry = @DocEntry)\r\n\tDECLARE @ComissaoEspecial float = 0\r\n\tDECLARE @QtyLines  int = (SELECT MAX(LineNum) FROM rdr1 WHERE DocEntry = @DocEntry)\t\r\n\r\n\r\n\tSet @ComissaoEspecial = (SELECT U_RA_Comissao_Especial FROM OCRD WHERE CardCode = @CardCodeComission)\r\n\t\t\r\n\tWHILE(@Contador \u003c @QtyLines+1)\r\n\t\tBEGIN\r\n\t\t\tIF(@ComissaoEspecial is not null AND @ComissaoEspecial \u003e0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @Comissao = @ComissaoEspecial\r\n\t\t\t\tEND\r\n\t\t\tELSE \r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @Comissao = (\r\n\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\tc.U_MW_PRCT\r\n\t\t\t\t\t\tFROM\t\r\n\t\t\t\t\t\t\t[@MW_CDV1] C\r\n\t\t\t\t\t\tINNER JOIN [@MW_CDV0] C0 ON C0.Code = C.Code\r\n\t\t\t\t\t\tINNER JOIN OSLP V ON V.SlpName = C0.U_MW_SlpCode\r\n\t\t\t\t\t\tINNER JOIN ORDR O ON O.SlpCode = v.SlpCode\r\n\t\t\t\t\t\tINNER JOIN RDR1 OL ON OL.DocEntry = o.DocEntry AND c.U_MW_ItemCode = ol.ItemCode\r\n\t\t\t\t\t\tWHERE o.DocNum = @DocEntry AND ol.LineNum = @Contador)\r\n\t\t\t\tEND\r\n\r\n\t\t\tif (@Comissao \u003e 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tUPDATE RDR1\tSET U_MW_PCOM = @Comissao WHERE DocEntry = @DocEntry AND LineNum =  @Contador\r\n\t\t\t\t\t\r\n\t\t\t\tEND;\r\n\t\t\r\n\t\t\tSET @Contador = @Contador + 1\r\n\t\tEND;\r\n\t\t\r\nEND;\r\n\r\n\r\n\r\n\r\n-----------------------------------------------------------------------------------------------------------\r\n---- SPS CONSULTORIA\r\n---- BLOQUEIA ADICIONAR PEDIDO DE VENDA QUANDO O PN POSSUI BOLETOS EM ABERTO - BANKPLUS\r\n---- Description Update: Acrescentado mais um documento na trava, e atualizado AND com as datas.\r\n---- Criado: GISLAINE FERNANDES\r\n---- Atualizado: LEONARDO DO PRADO GOMES\r\n---- Data Cria‡ao:16/11/2023\r\n---- Data Update: 08/01/2024\r\n-----------------------------------------------------------------------------------------------------------\r\n/*\r\nIF  @object_type in (\u002717\u0027, \u002723\u0027) AND @Transaction_type in (\u0027A\u0027)\r\nBEGIN \r\n\tDECLARE @CardCode NVARCHAR (20)\r\n\tSET @CardCode = (select CardCode From ORDR where DocEntry = @list_of_cols_val_tab_del)\r\n\tDECLARE @BolAti INT \r\n\r\n\tIF @object_type = 17 \r\n\t\tBEGIN \r\n\t\t\tset @BolAti = (  \r\n\t\t\t\t\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t\t\t\tCOUNT (*)\r\n\t\t\t\t\t\t\t\t\t\t\t\tFROM OINV T0\r\n\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [IV_IB_BillOfExchange] T1 ON T0.Serial = T1.Document\r\n\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN INV6 T2 ON T0.DocEntry = T2.DocEntry\r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = @CardCode\r\n\t\t\t\t\t\t\t\t\t\t\t\t  AND T1.DocType = 13 \r\n\t\t\t\t\t\t\t\t\t\t\t\t  AND T2.InstlmntID = T1.InstallmentID\r\n\t\t\t\t\t\t\t\t\t\t\t\t  AND T1.Status in (1,3) AND T0.CANCELED = \u0027N\u0027  \r\n\t\t\t\t\t\t\t\t\t\t\t\t  --AND t1.DueDate \u003c GETDATE()\r\n\t\t\t\t\t\t\t\t\t\t\t\t  AND CONVERT(DATE, T1.DueDate) \u003c CONVERT(DATE, GETDATE())\r\n\t\t\t\t\t\t\t\t\t\t\t  )\r\n\t\t\t\t\t  IF @BolAti \u003e 0\r\n\r\n\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\tSET @error = 1\r\n\t\t\t\t\t\t\tSET @error_message = N\u0027SPS PEDIDO DE VENDAS - EXISTEM BOLETOS EM ABERTO PARA ESTE CLIENTE, GENTILEZA PROCURAR CRDITO E COBRAN€A!\u0027\r\n\t\t\t\t\t\tEND;  \r\n\t\t\tEND;\r\n\tELSE \r\n\t   BEGIN\r\n\r\n\t\t   set @BolAti = (  \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tCOUNT (*)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tFROM OINV T0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [IV_IB_BillOfExchange] T1 ON T0.Serial = T1.Document\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN INV6 T2 ON T0.DocEntry = T2.DocEntry\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE T0.CardCode = @CardCode\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t  AND T1.DocType = 13 \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t  AND T2.InstlmntID = T1.InstallmentID\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t  AND T1.Status in (1,3) AND T0.CANCELED = \u0027N\u0027  \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t  --AND t1.DueDate \u003c GETDATE()\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t  AND CONVERT(DATE, T1.DueDate) \u003c CONVERT(DATE, GETDATE())\r\n\t\t\t\t\t\t\t\t\t\t\t\t  )\r\n\t\t\t\t\t\t  IF @BolAti \u003e 0\r\n\r\n\t\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\t\tSET @error = 1\r\n\t\t\t\t\t\t\t\tSET @error_message = N\u0027SPS COTA€AO DE VENDAS - EXISTEM BOLETOS EM ABERTO PARA ESTE CLIENTE, GENTILEZA PROCURAR CRDITO E COBRAN€A!\u0027\r\n\t\t\t\t\t\t\tEND;  \r\n\t   END \r\n    \r\nEND;    \r\n\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------------------------------\r\n-- END\r\n---------------------------------------------------------------------------------------------------------------------------------\r\n*/\r\n\r\n\r\n\r\n\r\n\r--Start IntegrationBank\nDECLARE @companyDbIntBank nvarchar(128)\r\nSET @companyDbIntBank =  (SELECT DB_NAME())\r\nEXEC [IV_IB_TransNotificationValidateIntBank] @companyDbIntBank, @companyDbIntBank, \u0027IV_IB_Setting\u0027, \u0027IV_IB_BillOfExchange\u0027, \u0027IV_IB_BillOfExchangeInstallment\u0027, \u0027IV_IB_CompanyLocal\u0027, @object_type, @transaction_type, @list_of_cols_val_tab_del, @error OUTPUT, @error_message OUTPUT\r\n--End IntegrationBank--Start BankPlus\nDECLARE @BancoDeDados nvarchar(128)\r\nSET @BancoDeDados =  (SELECT DB_NAME())\r\nEXEC [IV_IB_TransacaoValidacaoPagamentoBankPlus] @BancoDeDados, @object_type, @transaction_type, @list_of_cols_val_tab_del, @error OUTPUT, @error_message OUTPUT\r\n--End BankPlus\n-- Select the return values\r\n\r\n\r\nselect @error, @error_message\r\n\r\nend\r\n"}
