
<!DOCTYPE html>
<html>
<head>
    <title>Relatório EDI por Grupo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        
        /* Summary Card with Doughnut */
        .summary-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; max-width: 900px; margin: 0 auto 30px auto; gap: 50px; }
        
        .chart-container-doughnut { width: 250px; height: 250px; }
        
        .metrics-container { display: flex; flex-direction: column; justify-content: center; gap: 15px; text-align: left; }
        .metric-row { font-size: 16px; color: #555; }
        .metric-value { font-weight: bold; font-size: 20px; }
        .metric-large { font-size: 24px; font-weight: bold; border-top: 1px solid #eee; padding-top: 10px; margin-top: 5px; }
        
        /* Accordion Styles */
        .group-container { max-width: 1000px; margin: 0 auto; }
        .group-card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; overflow: hidden; }
        .group-header { padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ddd; transition: background 0.2s; }
        .group-header:hover { background-color: #f9f9f9; }
        .group-header.has-error { border-left-color: #FF6384; }
        .group-header.all-success { border-left-color: #4BC0C0; }
        
        .group-info h3 { margin: 0 0 5px 0; font-size: 18px; }
        .group-stats { font-size: 14px; color: #555; }
        .toggle-icon { font-size: 20px; color: #999; transition: transform 0.3s; }
        .group-card.active .toggle-icon { transform: rotate(180deg); }
        
        .group-content { display: none; padding: 20px; border-top: 1px solid #eee; background-color: #fafafa; position: relative; }
        .group-card.active .group-content { display: block; }
        
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .btn-load { background-color: #36A2EB; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px; display: none; }
        .btn-load:hover { background-color: #2481BA; }
        
        /* Tooltip for Errors */
        .error-detail-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            max-width: 300px;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .error-detail-header { font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #555; padding-bottom: 3px; }
        .error-item { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .error-count { font-weight: bold; color: #FF6384; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Relatório de Análise EDI (Agrupado)</h1>
    </div>

    <div class="summary-card">
        <div class="chart-container-doughnut">
            <canvas id="doughnutChart"></canvas>
        </div>
        <div class="metrics-container">
            <div class="metric-row">Total de Transações: <span class="metric-value">0</span></div>
            <div class="metric-row">Sucessos: <span class="metric-value" style="color: #4BC0C0;">0</span></div>
            <div class="metric-row">Erros Únicos: <span class="metric-value" style="color: #FF6384;">0</span></div>
            <div class="metric-row" style="font-size: 12px; color: #999;">(Erros Totais com Retentativas: 0)</div>
            <div class="metric-large">Taxa de Sucesso: 0.00%</div>
        </div>
    </div>

    <div class="group-container" id="groupsContainer">
        <!-- JS will render groups here -->
    </div>
    
    <!-- Global Tooltip Container -->
    <div id="customTooltip" class="error-detail-tooltip"></div>

    <script>
        const groupsData = [];
        const PAGE_SIZE = 10;
        
        // --- Doughnut Chart ---
        new Chart(document.getElementById('doughnutChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Sucesso', 'Erros'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['#4BC0C0', '#FF6384'],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
        
        // Render Group List
        const container = document.getElementById('groupsContainer');
        const tooltip = document.getElementById('customTooltip');
        
        groupsData.forEach((grp, index) => {
            const card = document.createElement('div');
            card.className = 'group-card ' + (grp.totalError > 0 ? 'active-border' : ''); // Optional Logic
            
            // Border Color Logic handled by class binding above slightly modified
            const borderClass = grp.totalError > 0 ? 'has-error' : 'all-success';
            
            card.innerHTML = `
                <div class="group-header ${borderClass}" onclick="toggleGroup(${index})">
                    <div class="group-info">
                        <h3>${grp.groupName}</h3>
                        <div class="group-stats">
                            Sucesso: <b>${grp.totalSuccess}</b> | Erros: <b style="color: ${grp.totalError > 0 ? '#FF6384' : '#666'}">${grp.totalError}</b>
                        </div>
                    </div>
                    <div class="toggle-icon">▼</div>
                </div>
                <div class="group-content" id="content-${index}">
                    <div class="chart-wrapper">
                        <canvas id="chart-${index}"></canvas>
                    </div>
                    <button class="btn-load" id="btn-${index}" onclick="loadMore(${index})">Carregar Mais (10)</button>
                </div>
            `;
            container.appendChild(card);
            
            // Initialize runtime state for pagination
            grp.visualIndex = 0;
            grp.chartInstance = null;
        });

        function toggleGroup(index) {
            const content = document.getElementById(`content-${index}`);
            const card = content.parentElement;
            
            if (content.style.display === 'block') {
                content.style.display = 'none';
                card.classList.remove('active');
            } else {
                content.style.display = 'block';
                card.classList.add('active');
                
                // Init Chart if first time
                const grp = groupsData[index];
                if (!grp.chartInstance) {
                    initChart(index);
                    loadMore(index); // Load initial batch
                }
            }
        }

        function initChart(index) {
            const ctx = document.getElementById(`chart-${index}`).getContext('2d');
            groupsData[index].chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Sucessos', data: [], backgroundColor: '#4BC0C0' },
                        { label: 'Erros', data: [], backgroundColor: '#FF6384' }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } },
                    plugins: { 
                        legend: { position: 'bottom' },
                        tooltip: {
                            enabled: false, // Disable default tooltip
                            external: function(context) {
                                // Tooltip Element
                                const tooltipEl = document.getElementById('customTooltip');

                                // Hide if no tooltip
                                const tooltipModel = context.tooltip;
                                if (tooltipModel.opacity === 0) {
                                    tooltipEl.style.display = 'none';
                                    return;
                                }

                                // Set Text
                                if (tooltipModel.body) {
                                    const dataIndex = tooltipModel.dataPoints[0].dataIndex;
                                    const datasetIndex = tooltipModel.dataPoints[0].datasetIndex;
                                    
                                    // Identify Client
                                    const grp = groupsData[index];
                                    const client = grp.clients[dataIndex];
                                    
                                    if (datasetIndex === 1 && client.error > 0) { // Is Error Bar
                                        let innerHtml = `<div class="error-detail-header">${client.label}</div>`;
                                        innerHtml += `<div style="margin-bottom:5px; color:#FF6384; font-weight:bold;">Erros: ${client.error}</div>`;
                                        
                                        for (const [msg, count] of Object.entries(client.error_types)) {
                                            innerHtml += `
                                                <div class="error-item">
                                                    <span style="width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block;">${msg}</span>
                                                    <span class="error-count">${count}</span>
                                                </div>`;
                                        }
                                        tooltipEl.innerHTML = innerHtml;
                                    } else {
                                        // Standard Success Tooltip
                                         tooltipEl.innerHTML = `
                                            <div class="error-detail-header">${client.label}</div>
                                            <div>Sucessos: ${client.success}</div>
                                        `;
                                    }
                                }

                                // Position
                                const position = context.chart.canvas.getBoundingClientRect();
                                
                                tooltipEl.style.display = 'block';
                                tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
                                tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
                            }
                        }
                    },
                    onClick: (e) => {
                        // Optional: Keep tooltip open on click or do something else
                        // For now hover is sufficient as requested "Ao clicar... expandir e detalhar"
                        // But since chart.js tooltips are hover-based, let's implement a 'sticky' 
                        // behavior or just rely on the custom tooltip we just built which is quite detailed.
                    }
                }
            });
        }

        function loadMore(index) {
            const grp = groupsData[index];
            const nextBatch = grp.clients.slice(grp.visualIndex, grp.visualIndex + PAGE_SIZE);
            
            if (nextBatch.length === 0) return;
            
            const chart = grp.chartInstance;
            
            nextBatch.forEach(client => {
                chart.data.labels.push(client.label);
                chart.data.datasets[0].data.push(client.success);
                chart.data.datasets[1].data.push(client.error);
            });
            
            grp.visualIndex += nextBatch.length;
            chart.update();
            
            // Resize logic
            const newHeight = grp.visualIndex * 40 + 50; // 40px per bar + padding
            if (newHeight > 300) {
                document.querySelector(`#content-${index} .chart-wrapper`).style.height = newHeight + 'px';
            }
            
            // Toggle Button
            const btn = document.getElementById(`btn-${index}`);
            if (grp.visualIndex < grp.clients.length) {
                btn.style.display = 'inline-block';
            } else {
                btn.style.display = 'none';
            }
        }
    </script>
</body>
</html>
    